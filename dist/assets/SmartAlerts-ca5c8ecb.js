import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{ar as r,u as s,C as a,j as n,k as l,l as i,B as d,w as o,at as c,F as m,a0 as u,aS as p,aZ as x,_ as h,s as g,M as f}from"./index-3a8dc84c.js";import{u as j}from"./globalStore-4b1adbba.js";import{B as b}from"./bell-847606c7.js";import{P as y}from"./package-557fa287.js";import{F as N}from"./file-text-861b9f90.js";import{P as w}from"./pill-2f66511d.js";import"./pdf-991f41f6.js";import"./utils-ec524415.js";import"./charts-b4389b44.js";function v(e){try{if(!e)return"غير محدد";const t="string"==typeof e?new Date(e):e;if(isNaN(t.getTime()))return"تاريخ غير صحيح";const r=new Date,s=Math.floor((r.getTime()-t.getTime())/1e3);if(s<60)return"منذ لحظات";if(s<3600){return`منذ ${Math.floor(s/60)} دقيقة`}if(s<86400){return`منذ ${Math.floor(s/3600)} ساعة`}if(s<2592e3){return`منذ ${Math.floor(s/86400)} يوم`}return`منذ ${Math.floor(s/2592e3)} شهر`}catch(t){return console.error("Error formatting time distance:",t),"خطأ في التاريخ"}}function A(e){try{if(!e)return"--";const t="string"==typeof e?new Date(e):e;if(isNaN(t.getTime()))return"--";const r=t.getDate().toString().padStart(2,"0"),s=(t.getMonth()+1).toString().padStart(2,"0");return`${r}/${s}/${t.getFullYear()}`}catch(t){return console.error("Error formatting date:",t),"--"}}function k({maxVisible:k=5,showHeader:R=!0,compact:$=!1,onAlertClick:D,showReadAlerts:C=!1}){const{alerts:S,unreadAlertsCount:E,isLoadingAlerts:M,loadAlerts:T,markAlertAsRead:z}=j();!function(){const{loadAlerts:e}=j(),r=t.useRef(new Map),s=t.useRef(null),a=t.useRef(null),n=t.useRef(!1),l=t.useCallback(()=>{console.log("🔄 useRealTimeAlerts: refreshAlerts triggered"),s.current&&(console.log("🔄 useRealTimeAlerts: Clearing previous timeout"),clearTimeout(s.current)),a.current&&cancelAnimationFrame(a.current),n.current=!0,a.current=requestAnimationFrame(()=>{a.current=null,s.current=setTimeout(()=>{n.current&&(console.log("🔄 useRealTimeAlerts: Executing loadAlerts..."),e(),n.current=!1),s.current=null},300)})},[e]);t.useEffect(()=>{console.log("🔔 Setting up real-time alerts listeners...");const e=e=>{const t=e?.type||e?.detail?.event||"unknown";console.log("📡 Data changed, refreshing alerts...",t),l()};r.current.set("handleDataChanged",e);const t=["patient-added","patient-updated","patient-deleted","patient-changed","appointment-added","appointment-updated","appointment-deleted","appointment-changed","payment-added","payment-updated","payment-deleted","payment-changed","treatment-added","treatment-updated","treatment-deleted","treatment-changed","prescription-added","prescription-updated","prescription-deleted","prescription-changed","inventory-added","inventory-updated","inventory-deleted","inventory-changed"];return t.forEach(t=>{window.addEventListener(t,e)}),()=>{if(console.log("🔔 Cleaning up real-time alerts listeners..."),s.current&&(clearTimeout(s.current),s.current=null),a.current&&(cancelAnimationFrame(a.current),a.current=null),r.current.has("handleDataChanged")){const e=r.current.get("handleDataChanged");t.forEach(t=>{window.removeEventListener(t,e)})}r.current.clear(),n.current=!1}},[l])}();const{isDarkMode:I}=r(),{toast:F}=s(),[U,L]=t.useState(C),[P,_]=t.useState(0),[B,q]=t.useState(!1),[H,V]=t.useState(!0);t.useEffect(()=>{console.log("🔔 SmartAlerts: Initial load"),T();const e=setInterval(()=>{console.log("🔄 SmartAlerts: Normal refresh (every 30s)"),T()},3e4),t=setInterval(()=>{E>0&&(console.log("🚨 SmartAlerts: Urgent refresh (every 10s)"),T())},1e4);return()=>{clearInterval(e),clearInterval(t)}},[T,E]),t.useEffect(()=>{L(C)},[C]),t.useEffect(()=>{if(E>P&&0!==P){const e=E-P;F({title:"🔔 تنبيهات جديدة",description:`تم إضافة ${e} تنبيه جديد${e>1?"ة":""}`,duration:4e3}),q(!0),setTimeout(()=>q(!1),2e3)}_(E)},[E,P,F]);const W=S.filter(e=>!e.isDismissed).filter(e=>{if(e.snoozeUntil){return new Date(e.snoozeUntil)<=new Date}return!0}).filter(e=>!!U||(!H||!e.isRead)),Y=H||!U?W.slice(0,k):W,Z=S.filter(e=>e.isRead&&!e.isDismissed).length,G=S.filter(e=>!e.isDismissed).length,J=t=>{switch(t.type){case"appointment":return e.jsx(f,{className:"w-4 h-4"});case"payment":return e.jsx(g,{className:"w-4 h-4"});case"treatment":return e.jsx(h,{className:"w-4 h-4"});case"prescription":return e.jsx(w,{className:"w-4 h-4"});case"follow_up":return e.jsx(p,{className:"w-4 h-4"});case"lab_order":return e.jsx(N,{className:"w-4 h-4"});case"inventory":return e.jsx(y,{className:"w-4 h-4"});default:return e.jsx(b,{className:"w-4 h-4"})}},K=e=>{switch(e){case"high":return I?"text-red-400 bg-red-900/20 border-red-800/50":"text-red-500 bg-red-50 border-red-200";case"medium":return I?"text-yellow-400 bg-yellow-900/20 border-yellow-800/50":"text-yellow-500 bg-yellow-50 border-yellow-200";case"low":return I?"text-blue-400 bg-blue-900/20 border-blue-800/50":"text-blue-500 bg-blue-50 border-blue-200";default:return I?"text-gray-400 bg-gray-900/20 border-gray-800/50":"text-gray-500 bg-gray-50 border-gray-200"}},O=e=>{switch(e){case"high":return"عاجل";case"medium":return"متوسط";case"low":return"منخفض";default:return e}};return M?e.jsxs(a,{className:$?"shadow-sm":"",children:[R&&e.jsx(n,{className:"pb-3",children:e.jsxs(l,{className:"text-lg flex items-center gap-2",children:[e.jsx(b,{className:"w-5 h-5"}),"التنبيهات الذكية"]})}),e.jsx(i,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"})})})]}):e.jsx("div",{className:"space-y-4 md:space-y-5 lg:space-y-6 animate-fade-in "+(B?"animate-pulse":""),dir:"rtl","data-alerts-component":!0,children:e.jsxs(a,{className:`${$?"shadow-sm":""} bg-card border-border hover:shadow-lg dark:hover:shadow-xl transition-all duration-200 ${E>0?"ring-2 ring-primary/20 ring-offset-2":""} ${B?"shadow-2xl scale-105":""}`,children:[R&&e.jsxs(n,{className:"p-4 md:p-5 lg:p-6 pb-3 md:pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsxs(l,{className:"text-lg md:text-xl lg:text-2xl flex items-center gap-2 font-tajawal",children:[e.jsx(b,{className:"w-5 h-5 md:w-6 md:h-6 "+(E>0?"animate-bounce":"")}),"التنبيهات الذكية",E>0&&e.jsx(d,{variant:"destructive",className:"text-xs px-2 py-1 bg-destructive/10 text-destructive border-destructive/20 animate-pulse",children:E})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(o,{variant:"outline",size:"sm",onClick:()=>{console.log("🔄 Manual refresh triggered"),T()},className:"h-8 px-3",disabled:M,children:e.jsx(c,{className:"w-4 h-4 "+(M?"animate-spin":"")})}),Z>0&&e.jsx(o,{variant:"outline",size:"sm",onClick:()=>L(!U),className:"h-8 px-3 text-xs",children:U?"إخفاء المقروء":"عرض المقروء"}),e.jsx(o,{variant:"outline",size:"sm",onClick:()=>V(!H),className:"h-8 px-3 text-xs",children:H?"عرض الكل":"غير المقروء فقط"})]})]}),e.jsx("div",{className:"text-xs md:text-sm text-muted-foreground mt-2 md:mt-3 font-tajawal",children:e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("span",{children:["المجموع: ",e.jsx("strong",{children:G})]}),e.jsxs("span",{children:["غير مقروءة: ",e.jsx("strong",{className:"text-primary",children:E})]}),e.jsxs("span",{children:["مقروءة: ",e.jsx("strong",{children:Z})]}),S.filter(e=>"high"===e.priority&&!e.isRead).length>0&&e.jsxs("span",{className:"text-red-500",children:["عاجلة: ",e.jsx("strong",{children:S.filter(e=>"high"===e.priority&&!e.isRead).length})]})]})})]}),e.jsxs(i,{className:(R?"":"pt-6")+" p-4 md:p-5 lg:p-6",children:[Y.filter(e=>"high"===e.priority&&!e.isRead).length>0&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-800 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{className:"w-4 h-4 text-red-500"}),e.jsxs("span",{className:"text-sm font-medium text-red-700 dark:text-red-300",children:[Y.filter(e=>"high"===e.priority&&!e.isRead).length," تنبيه عاجل يتطلب انتباهك فوراً"]})]})}),0===Y.length?e.jsxs("div",{className:"text-center py-6 md:py-8 text-muted-foreground",children:[e.jsx(u,{className:"w-8 h-8 md:w-12 md:h-12 mx-auto mb-2 md:mb-4 opacity-50"}),e.jsx("p",{className:"text-sm md:text-base font-tajawal",children:U?0===G?"لا توجد تنبيهات":"لا توجد تنبيهات في هذا العرض":H?"لا توجد تنبيهات غير مقروءة":"لا توجد تنبيهات"}),!U&&H&&Z>0&&e.jsx("div",{className:"mt-3",children:e.jsxs(o,{variant:"outline",size:"sm",onClick:()=>L(!0),className:"text-xs",children:["عرض التنبيهات المقروءة (",Z,")"]})})]}):e.jsx("div",{className:"space-y-3 md:space-y-4",children:Y.map((t,r)=>e.jsxs("div",{children:[e.jsx("div",{className:"p-3 md:p-4 rounded-lg border cursor-pointer transition-all duration-200 hover:shadow-md "+(t.isRead?I?"bg-muted/10 border-muted/30 hover:bg-muted/20 hover:border-muted/50":"bg-muted/20 border-muted/40 hover:bg-muted/30 hover:border-muted/60":I?`${K(t.priority)} hover:opacity-90 hover:shadow-md`:`${K(t.priority)} hover:opacity-85 hover:shadow-lg`),onClick:()=>(async e=>{e.isRead||await z(e.id),console.log("🔔 Alert clicked:",{title:e.title,description:e.description,type:e.type,priority:e.priority,patientName:e.patientName,relatedData:e.relatedData}),D?.(e)})(t),role:"button",tabIndex:0,"aria-label":`تنبيه: ${t.title} - ${O(t.priority)}`,children:e.jsxs("div",{className:"flex items-start gap-3",dir:"rtl",children:[e.jsx("div",{className:"p-2 md:p-3 rounded-full shrink-0 "+(I?`${K(t.priority)} bg-opacity-20 border border-current border-opacity-30`:`${K(t.priority)} bg-opacity-10 border border-current border-opacity-20`),children:J(t)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 md:mb-2",children:[e.jsx("h4",{className:"font-medium text-sm md:text-base truncate font-tajawal",children:t.title}),e.jsx(d,{variant:"outline",className:"text-xs px-2 py-1 border-primary/20 text-primary",children:O(t.priority)}),!t.isRead&&e.jsx("div",{className:"w-2 h-2 bg-primary rounded-full","aria-label":"تنبيه غير مقروء"})]}),e.jsx("p",{className:"text-xs md:text-sm text-muted-foreground mb-2 md:mb-3 line-clamp-2",children:t.description}),t.patientName&&e.jsxs("p",{className:"text-xs md:text-sm font-medium text-primary mb-2 flex items-center gap-1",children:[e.jsx(p,{className:"w-3 h-3 md:w-4 md:h-4"}),t.patientName]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs md:text-sm text-muted-foreground",children:v(t.createdAt)}),t.dueDate&&e.jsxs("span",{className:"text-xs md:text-sm text-muted-foreground",children:["📅 ",A(t.dueDate)]})]}),!t.isRead&&e.jsx("div",{className:"mt-2 md:mt-3",children:e.jsxs(o,{size:"sm",variant:"outline",className:"h-7 md:h-8 text-xs md:text-sm hover:bg-primary/10 hover:text-primary transition-all duration-200",onClick:e=>(async(e,t)=>{t.stopPropagation(),console.log("🔔 Mark as read button clicked for alert:",e);try{console.log("🔄 Calling markAlertAsRead..."),await z(e),console.log("✅ markAlertAsRead completed successfully"),console.log("🔄 Reloading alerts to update UI..."),await T(),console.log("✅ Alerts reloaded successfully"),F({title:"✅ تم التحديث",description:"تم تحديد الإشعار كمقروء",duration:2e3})}catch(r){console.error("❌ Error marking alert as read:",r),F({title:"❌ خطأ",description:"فشل في تحديث الإشعار",variant:"destructive"})}})(t.id,e),"aria-label":`تحديد التنبيه "${t.title}" كمقروء`,children:[e.jsx(u,{className:"w-3 h-3 md:w-4 md:h-4 mr-1 md:mr-2"}),"تحديد كمقروء"]})})]})]})}),r<Y.length-1&&e.jsx(x,{className:"my-2 md:my-3 "+(I?"bg-muted/30":"")})]},t.id))})]})]})})}export{k as default};
