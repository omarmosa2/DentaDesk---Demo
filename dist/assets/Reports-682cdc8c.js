import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{aj as s,aH as a,r as n,K as r,aI as l,aJ as i,q as c,aK as d,aL as o,B as m,at as x,u as h,aM as u,C as p,j as g,a3 as f,k as j,v as y,a4 as v,a5 as N,l as b,L as w,I as $,w as F,a6 as _,Z as D,S as k,m as A,n as C,o as S,aN as E,p as P,a8 as M,F as T,a9 as R,a0 as O,aO as I,aP as L,aQ as z,aR as B,Q as V,ar as q,b as Y,aS as K,aT as W,aU as H,aV as G,ag as U,aG as X,M as Z,c as J,$ as Q,a as ee,e as te,as as se,_ as ae,s as ne,R as re,aW as le,d as ie,aX as ce,aY as de,A as oe,aZ as me,a_ as xe}from"./index-3a8dc84c.js";import{T as he,a as ue,b as pe,c as ge}from"./tabs-952e3ebd.js";import{u as fe,a as je,e as ye,b as ve,c as Ne,v as be,d as we,f as $e,g as Fe,h as _e}from"./chartDataHelpers-a79b834e.js";import{u as De}from"./expensesStore-f3f1428b.js";import{u as ke,C as Ae}from"./clinicNeedsStore-c3c0792a.js";import{u as Ce}from"./labOrderStore-b969024d.js";import{g as Se,a as Ee}from"./cardStyles-c77ef46a.js";import{C as Pe}from"./currency-display-e01ebf49.js";import{E as Me}from"./excel-37615a09.js";import{C as Te,a as Re,b as Oe}from"./collapsible-d3d2b240.js";import{U as Ie}from"./unlock-51cfe0e8.js";import{P as Le}from"./pdfService-844f6d4e.js";import{E as ze}from"./exportService-1536567b.js";import{U as Be}from"./users-5a609aa2.js";import{D as Ve}from"./upload-4df8a268.js";import{P as qe}from"./pie-chart-ac153dee.js";import{R as Ye,P as Ke,a as We,C as He,T as Ge,B as Ue,b as Xe,X as Ze,Y as Je,d as Qe,A as et,e as tt,L as st,f as at,g as nt}from"./charts-b4389b44.js";import{B as rt}from"./bar-chart-3-2a89747c.js";import{T as lt}from"./trending-up-5cd3f2a0.js";import{T as it}from"./trending-down-0dc1e939.js";import{n as ct,X as dt,a as ot}from"./notificationService-09cb27cc.js";import{u as mt,T as xt}from"./useTimeFilteredStats-1c30c8be.js";import{P as ht}from"./package-557fa287.js";import{C as ut}from"./calculator-63fcb348.js";import{P as pt}from"./plus-1eab3b5b.js";import{Z as gt}from"./zap-6d3cd988.js";import{T as ft,a as jt,b as yt,c as vt,d as Nt,e as bt}from"./table-20957d0a.js";import{B as wt}from"./building-2-acc8549f.js";import{F as $t}from"./file-text-861b9f90.js";import{F as Ft}from"./filter-f006659c.js";import"./pdf-991f41f6.js";import"./utils-ec524415.js";import"./index-a46c293c.js";
/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _t=s("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]),Dt=s("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),kt=s("UserX",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]),At=s("WifiOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M8.5 16.5a5 5 0 0 1 7 0",key:"sej527"}],["path",{d:"M2 8.82a15 15 0 0 1 4.17-2.65",key:"11utq1"}],["path",{d:"M10.66 5c4.01-.36 8.14.9 11.34 3.76",key:"hxefdu"}],["path",{d:"M16.85 11.25a10 10 0 0 1 2.22 1.68",key:"q734kn"}],["path",{d:"M5 13a10 10 0 0 1 5.24-2.76",key:"piq4yl"}],["line",{x1:"12",x2:"12.01",y1:"20",y2:"20",key:"of4bc4"}]]),Ct=s("Wifi",[["path",{d:"M5 13a10 10 0 0 1 14 0",key:"6v8j51"}],["path",{d:"M8.5 16.5a5 5 0 0 1 7 0",key:"sej527"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["line",{x1:"12",x2:"12.01",y1:"20",y2:"20",key:"of4bc4"}]]);
/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */class St extends t.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){console.error("ReportsErrorBoundary caught an error:",{error:a(e),errorInfo:a(t),componentStack:a(t.componentStack)}),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?this.props.fallback||e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 bg-red-50 border border-red-200 rounded-lg",children:[e.jsx("div",{className:"text-red-600 text-lg font-semibold mb-4",children:"خطأ في تحميل التقرير"}),e.jsx("div",{className:"text-red-500 text-sm mb-4 text-center",children:"حدث خطأ أثناء تحميل هذا التقرير. يرجى المحاولة مرة أخرى."}),e.jsx("button",{onClick:()=>this.setState({hasError:!1,error:void 0,errorInfo:void 0}),className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors",children:"إعادة المحاولة"}),!1]}):this.props.children}}const Et=St;class Pt{static validatePaymentCalculations(e){const t=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},s=e.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,s)=>e+("partial"===s.status&&void 0!==s.amount_paid?t(s.amount_paid):t(s.amount)),0),a=e.filter(e=>"completed"===e.status).reduce((e,s)=>e+t(s.amount),0),n=e.filter(e=>"partial"===e.status).reduce((e,s)=>e+(void 0!==s.amount_paid?t(s.amount_paid):t(s.amount)),0),r=e.filter(e=>"pending"===e.status).reduce((e,s)=>{const a=t(s.amount),n=t(s.total_amount_due);return e+(0===a&&n>0?n:a)},0),l=e.filter(e=>{if("pending"!==e.status)return!1;const t=new Date(e.payment_date),s=new Date;return s.setDate(s.getDate()-30),t<s}).reduce((e,s)=>{const a=t(s.amount),n=t(s.total_amount_due);return e+(0===a&&n>0?n:a)},0),i=a+n;return Math.abs(s-i)>.01&&console.warn("Payment calculation mismatch:",{totalRevenue:s,calculatedTotal:a+n,completedAmount:a,partialAmount:n,difference:s-i}),{totalRevenue:Math.round(100*s)/100,completedAmount:Math.round(100*a)/100,partialAmount:Math.round(100*n)/100,pendingAmount:Math.round(100*r)/100,overdueAmount:Math.round(100*l)/100,isValid:Math.abs(s-i)<=.01}}static validateAppointmentStats(e){const t=e.length,s=e.filter(e=>"completed"===e.status).length,a=e.filter(e=>"cancelled"===e.status).length,n=e.filter(e=>"no-show"===e.status).length,r=e.filter(e=>"scheduled"===e.status).length,l=s+a+n+r,i=t-l;0!==i&&console.warn("Appointment status calculation mismatch:",{total:t,calculatedTotal:l,otherStatuses:i,statusBreakdown:{completed:s,cancelled:a,noShow:n,scheduled:r}});return{total:t,completed:s,cancelled:a,noShow:n,scheduled:r,attendanceRate:t>0?Math.round(s/t*100):0,isValid:0===i}}static validateInventoryStats(e){const t=e.length,s=e.reduce((e,t)=>e+(t.unit_price||0)*(t.quantity||0),0),a=e.filter(e=>(e.quantity||0)<=(e.minimum_stock||0)&&(e.quantity||0)>0).length,n=e.filter(e=>0===(e.quantity||0)).length,r=e.filter(e=>(e.quantity||0)>(e.minimum_stock||0)).length,l=a+n+r;return l!==t&&console.warn("Inventory calculation mismatch:",{totalItems:t,calculatedTotal:l,breakdown:{lowStockItems:a,outOfStockItems:n,inStockItems:r}}),{totalItems:t,totalValue:Math.round(100*s)/100,lowStockItems:a,outOfStockItems:n,inStockItems:r,isValid:l===t}}static validateAllData(e){const t=this.validatePaymentCalculations(e.payments),s=this.validateAppointmentStats(e.appointments),a=this.validateInventoryStats(e.inventory),n=t.isValid&&s.isValid&&a.isValid;return n||console.error("Data validation failed:",{payments:t.isValid,appointments:s.isValid,inventory:a.isValid}),{payments:t,appointments:s,inventory:a,isAllValid:n}}static compareFilteredData(e,t,s){const a=e.length,n=t.length,r=a>0?n/a*100:0;return console.log(`Filter comparison for ${s}:`,{original:a,filtered:n,ratio:`${Math.round(r)}%`,isFiltered:n<a}),{originalCount:a,filteredCount:n,filterRatio:Math.round(r),isFiltered:n<a}}}const Mt={all:"جميع البيانات",today:"اليوم",yesterday:"أمس",this_week:"هذا الأسبوع",last_week:"الأسبوع الماضي",this_month:"هذا الشهر",last_month:"الشهر الماضي",this_quarter:"هذا الربع",last_quarter:"الربع الماضي",this_year:"هذا العام",last_year:"العام الماضي",last_30_days:"آخر 30 يوم",last_90_days:"آخر 90 يوم",custom:"فترة مخصصة"};class Tt{static calculateFinancialStats(e,t,s,a,n){const r=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},l=Array.isArray(e)?e.filter(e=>e&&"object"==typeof e):[],i=Array.isArray(t)?t.filter(e=>e&&"object"==typeof e):[],c=Array.isArray(s)?s.filter(e=>e&&"object"==typeof e):[],d=Array.isArray(a)?a.filter(e=>e&&"object"==typeof e):[],o=Array.isArray(n)?n.filter(e=>e&&"object"==typeof e):[];console.log("🔍 calculateFinancialStats called with validated data:",{paymentsCount:l.length,labOrdersCount:i.length,clinicNeedsCount:c.length,inventoryItemsCount:d.length,expensesCount:o.length});const m=r(e.filter(e=>"completed"===e.status).reduce((e,t)=>e+r(t.amount),0)),x=r(e.filter(e=>"partial"===e.status).reduce((e,t)=>e+r(t.amount),0)),h=m+x,u=r(e.filter(e=>("partial"===e.status||"pending"===e.status)&&(e.treatment_remaining_balance||e.remaining_balance)).reduce((e,t)=>{const s=r(t.treatment_remaining_balance),a=r(t.remaining_balance);return e+(s||a)},0)),p=e.filter(e=>"pending"===e.status).reduce((e,t)=>{const s=r(t.amount),a=r(t.total_amount_due);let n=s;if(t.tooth_treatment_id){n=r(t.treatment_total_cost)||a}else 0===s&&a>0&&(n=a);return e+n},0);let g=0,f=0,j=0,y=0,v=0;t&&Array.isArray(t)&&(g=r(t.reduce((e,t)=>e+r(t.paid_amount||0),0)),f=r(t.reduce((e,t)=>e+r(t.remaining_balance||0),0))),s&&Array.isArray(s)&&(j=r(s.filter(e=>"received"===e.status||"ordered"===e.status).reduce((e,t)=>e+r(t.quantity)*r(t.price),0)),y=r(s.filter(e=>"pending"===e.status||"ordered"===e.status).reduce((e,t)=>e+r(t.quantity)*r(t.price),0))),a&&Array.isArray(a)&&(v=r(a.reduce((e,t)=>e+r(t.cost_per_unit||0)*r(t.quantity||0),0)));let N=0,b=[];if(o&&o.length>0){N=r(o.filter(e=>"paid"===e.status).reduce((e,t)=>e+r(t.amount),0));const e={salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"},t={};o.filter(e=>"paid"===e.status).forEach(e=>{const s=e.expense_type||"other",a=r(e.amount);t[s]=(t[s]||0)+a}),b=Object.entries(t).map(([t,s])=>({type:e[t]||t,amount:r(s),percentage:N>0?r(s)/N*100:0}))}const w=r(g+j+v+N),$=r(h-w),F=$>=0,_=h>0?r($/h*100):0;console.log("💰 Financial calculations verification:",{totalRevenue:r(h),totalExpenses:r(w),netProfit:r($),profitMargin:r(_),breakdown:{labOrdersTotal:r(g),clinicNeedsTotal:r(j),inventoryExpenses:r(v),clinicExpensesTotal:r(N)}});const D=new Date;return D.setDate(D.getDate()-30),{completedPayments:m,partialPayments:x,totalRevenue:h,remainingBalances:u,pendingAmount:p,labOrdersTotal:g,labOrdersRemaining:f,clinicNeedsTotal:j,clinicNeedsRemaining:y,inventoryExpenses:v,clinicExpensesTotal:N,expensesByType:b,totalExpenses:w,netProfit:F?$:0,lossAmount:F?0:Math.abs($),profitMargin:r(_),isProfit:F,totalTransactions:e.length,completedTransactions:e.filter(e=>"completed"===e.status).length,partialTransactions:e.filter(e=>"partial"===e.status).length,pendingTransactions:e.filter(e=>"pending"===e.status).length}}static filterAllDataByDateRange(e,t){const s=e=>{if(!e)return!1;const s=new Date(e);let a;return a=e.includes("T")||e.includes(" ")?s:new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0),a>=t.startDate&&a<=t.endDate};return{patients:e.patients,appointments:e.appointments.filter(e=>s(e.start_time)||s(e.created_at)),payments:e.payments.filter(e=>s(e.payment_date)||s(e.created_at)),inventory:e.inventory.filter(e=>s(e.created_at)||s(e.updated_at)),treatments:e.treatments?.filter(e=>s(e.start_date||"")||s(e.created_at||""))||[],prescriptions:e.prescriptions?.filter(e=>s(e.created_at))||[],labOrders:e.labOrders?.filter(e=>s(e.order_date)||s(e.created_at))||[],clinicNeeds:e.clinicNeeds?.filter(e=>s(e.created_at))||[]}}static calculateAllAspectsStats(e,t){const s=this.calculateFinancialStats(e.payments,e.labOrders,e.clinicNeeds,e.inventory,e.expenses),a=this.calculateDetailedAppointmentStats(e.appointments),r=this.calculateTreatmentStats(e.treatments),l=this.calculatePrescriptionStats(e.prescriptions),i=this.calculateLabOrderStats(e.labOrders),c=this.calculateClinicNeedsStats(e.clinicNeeds),d=this.calculateInventoryStats(e.inventory);return{dateRange:{start:n(t.startDate.toISOString()),end:n(t.endDate.toISOString()),period:`${n(t.startDate.toISOString())} - ${n(t.endDate.toISOString())}`},totalPatients:e.patients.length,totalAppointments:e.appointments.length,totalPayments:e.payments.length,totalTreatments:e.treatments.length,totalPrescriptions:e.prescriptions.length,totalLabOrders:e.labOrders.length,totalClinicNeeds:e.clinicNeeds.length,totalInventoryItems:e.inventory.length,...s,...a,...r,...l,...i,...c,...d}}static calculateAppointmentStats(e){const t=e.length,s=e.filter(e=>"completed"===e.status).length;return{total:t,completed:s,cancelled:e.filter(e=>"cancelled"===e.status).length,noShow:e.filter(e=>"no-show"===e.status).length,scheduled:e.filter(e=>"scheduled"===e.status).length,attendanceRate:t>0?Math.round(s/t*100):0}}static calculateDetailedAppointmentStats(e){const t=this.calculateAppointmentStats(e),s=e.reduce((e,t)=>{if(t.start_time){const s=new Date(t.start_time).getHours();e[s]=(e[s]||0)+1}return e},{}),a=Object.entries(s).reduce((e,[t,s])=>s>e.count?{hour:parseInt(t),count:s}:e,{hour:0,count:0}),n=e.reduce((e,t)=>{if(t.start_time){const s=["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"][new Date(t.start_time).getDay()];e[s]=(e[s]||0)+1}return e},{});return{...t,peakHour:a.hour?`${a.hour}:00 (${a.count} مواعيد)`:"غير محدد",dayDistribution:n,averagePerDay:e.length>0?Math.round(e.length/7):0}}static calculateTreatmentStats(e){const t=e.length,s=e.filter(e=>"completed"===e.treatment_status).length,a=e.filter(e=>"planned"===e.treatment_status).length,n=e.filter(e=>"in_progress"===e.treatment_status).length,r=e.filter(e=>"cancelled"===e.treatment_status).length,l=e.reduce((e,t)=>{const s=t.treatment_type||"غير محدد";return e[s]=(e[s]||0)+1,e},{}),i=e.reduce((e,t)=>{const s=t.tooth_number?.toString()||"غير محدد";return e[s]=(e[s]||0)+1,e},{});return{totalTreatments:t,completedTreatments:s,plannedTreatments:a,inProgressTreatments:n,cancelledTreatments:r,completionRate:t>0?Math.round(s/t*100):0,treatmentTypes:l,teethTreated:i,mostTreatedTooth:Object.entries(i).reduce((e,[t,s])=>s>e.count?{tooth:t,count:s}:e,{tooth:"غير محدد",count:0})}}static calculatePrescriptionStats(e){const t=e.length;e.reduce((e,t)=>e,{});const s=new Set(e.map(e=>e.patient_id)).size;return{totalPrescriptions:t,patientsWithPrescriptions:s,averagePrescriptionsPerPatient:s>0?Math.round(t/s*100)/100:0}}static calculateLabOrderStats(e){const t=e.length,s=e.filter(e=>"آجل"===e.status).length,a=e.filter(e=>"مكتمل"===e.status).length,n=e.filter(e=>"ملغي"===e.status).length,r=e.reduce((e,t)=>e+(t.cost||0),0),l=e.reduce((e,t)=>e+(t.paid_amount||0),0),i=e.reduce((e,t)=>e+(t.remaining_balance||0),0),c=e.reduce((e,t)=>{const s=t.lab?.name||"غير محدد";return e[s]=(e[s]||0)+1,e},{});return{totalLabOrders:t,pendingLabOrders:s,completedLabOrders:a,cancelledLabOrders:n,labOrdersCompletionRate:t>0?Math.round(a/t*100):0,totalLabCost:r,totalLabPaid:l,totalLabRemaining:i,labFrequency:c,mostUsedLab:Object.entries(c).reduce((e,[t,s])=>s>e.count?{lab:t,count:s}:e,{lab:"غير محدد",count:0})}}static calculateClinicNeedsStats(e){const t=e.length,s=e.filter(e=>"pending"===e.status).length,a=e.filter(e=>"ordered"===e.status).length,n=e.filter(e=>"received"===e.status).length,r=e.filter(e=>"cancelled"===e.status).length,l=e.reduce((e,t)=>e+(t.quantity||0)*(t.price||0),0),i=e.reduce((e,t)=>{const s=t.priority||"medium";return e[s]=(e[s]||0)+1,e},{}),c=e.reduce((e,t)=>{const s=t.category||"غير محدد";return e[s]=(e[s]||0)+1,e},{});return{totalClinicNeeds:t,pendingNeeds:s,orderedNeeds:a,receivedNeeds:n,cancelledNeeds:r,needsCompletionRate:t>0?Math.round(n/t*100):0,totalNeedsValue:l,priorityAnalysis:i,categoryAnalysis:c,urgentNeeds:i.urgent||0,highPriorityNeeds:i.high||0}}static validateAmount(e){const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100}static calculateInventoryStats(e){const t=e.length,s=e.reduce((e,t)=>{const s=t.category||"غير محدد";return e[s]=(e[s]||0)+1,e},{});return{totalInventoryItems:t,totalInventoryValue:e.reduce((e,t)=>e+this.validateAmount(t.cost_per_unit||0)*this.validateAmount(t.quantity||0),0),lowStockItems:e.filter(e=>(e.quantity||0)<=(e.minimum_quantity||0)).length,inventoryByCategory:s}}static groupByStatus(e,t){return e.reduce((e,s)=>{const a=s[t]||"غير محدد";return e[a]=(e[a]||0)+1,e},{})}static groupByMethod(e){return e.reduce((e,t)=>{const s=t.payment_method||"غير محدد";return e[s]=(e[s]||0)+1,e},{})}static groupByCategory(e){return e.reduce((e,t)=>{const s=t.category||"غير محدد";return e[s]=(e[s]||0)+1,e},{})}static generateComprehensiveCSV(e){const t=this.calculateFinancialStats(e.payments),s=this.calculateAppointmentStats(e.appointments),a=this.calculateInventoryStats(e.inventory);let i="\ufeff";if(i+="التقرير الشامل - عيادة الأسنان الحديثة\n",i+=`تاريخ التقرير,${this.formatGregorianDate(new Date)}\n`,i+=`وقت الإنشاء,${(new Date).toLocaleTimeString("ar-SA")}\n\n`,i+="معلومات الفلترة المطبقة\n",i+=`فلتر المواعيد,${e.filterInfo.appointmentFilter}\n`,i+=`فلتر المدفوعات,${e.filterInfo.paymentFilter}\n`,i+=`فلتر المخزون,${e.filterInfo.inventoryFilter}\n\n`,i+="إحصائيات المرضى\n",i+=`إجمالي المرضى,${e.patients.length}\n`,i+=`المرضى الجدد هذا الشهر,${this.getNewPatientsThisMonth(e.patients)}\n`,i+=`المرضى النشطون,${this.getActivePatients(e.patients,e.appointments)}\n`,i+=`متوسط عمر المرضى,${this.calculateAverageAge(e.patients)}\n`,i+=`توزيع الجنس,${this.getGenderDistribution(e.patients)}\n\n`,i+="إحصائيات المواعيد (مفلترة)\n",i+=`إجمالي المواعيد,${s.total}\n`,i+=`المواعيد المكتملة,${s.completed}\n`,i+=`المواعيد الملغية,${s.cancelled}\n`,i+=`المواعيد المجدولة,${s.scheduled}\n`,i+=`معدل الحضور,${s.attendanceRate}%\n\n`,i+="الإحصائيات المالية (مفلترة)\n",i+=`إجمالي الإيرادات,${r(t.totalRevenue)}\n`,i+=`المدفوعات المكتملة,${r(t.completedAmount)}\n`,i+=`المدفوعات الجزئية,${r(t.partialAmount)}\n`,i+=`المدفوعات الآجلة,${r(t.pendingAmount)}\n`,i+=`المدفوعات المتأخرة,${r(t.overdueAmount)}\n`,t.totalRemainingFromPartialPayments>0&&(i+=`المبالغ المتبقية من الدفعات الجزئية,${r(t.totalRemainingFromPartialPayments)}\n`),i+=`الرصيد المستحق الإجمالي,${r(t.outstandingBalance)}\n`,i+=`إجمالي المعاملات,${t.totalTransactions}\n`,i+=`إجمالي المصروفات,${r(t.totalExpenses||0)}\n`,i+=`صافي الربح,${r(t.netProfit||0)}\n`,i+=`هامش الربح,${(t.profitMargin||0).toFixed(2)}%\n`,i+=`حالة الربحية,${(t.netProfit||0)>=0?"ربح":"خسارة"}\n\n`,t.expensesByType&&t.expensesByType.length>0&&(i+="توزيع المصروفات حسب النوع\n",i+="نوع المصروف,المبلغ,النسبة المئوية\n",t.expensesByType.forEach(e=>{i+=`"${e.type}","${r(e.amount)}","${e.percentage.toFixed(2)}%"\n`}),i+="\n"),i+="توزيع طرق الدفع\n",i+="طريقة الدفع,المبلغ,عدد المعاملات\n",Object.entries(t.paymentMethodStats).forEach(([e,t])=>{i+=`"${e}","${r(t.amount)}","${t.count}"\n`}),i+="\n",i+="إحصائيات المخزون (مفلترة)\n",i+=`إجمالي العناصر,${a.totalItems}\n`,i+=`القيمة الإجمالية,${r(a.totalValue)}\n`,i+=`عناصر منخفضة المخزون,${a.lowStockItems}\n`,i+=`عناصر نفدت من المخزون,${a.outOfStockItems}\n`,i+=`عناصر منتهية الصلاحية,${a.expiredItems}\n`,i+=`عناصر قريبة الانتهاء (30 يوم),${a.nearExpiryItems}\n\n`,e.appointments.length>0&&(i+="تفاصيل المواعيد المفلترة\n",i+="التاريخ,الوقت,اسم المريض,عنوان الموعد,نوع العلاج,التكلفة,الحالة,ملاحظات\n",e.appointments.forEach(e=>{const t=n(e.start_time),s=new Date(e.start_time).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}),a=e.patient?.full_name||e.patient?.name||"غير محدد",l=e.title||"غير محدد",c=e.treatment_type||"غير محدد",d=e.cost?r(e.cost):"0",o=this.getStatusInArabic(e.status),m=e.notes||"";i+=`"${t}","${s}","${a}","${l}","${c}","${d}","${o}","${m}"\n`}),i+="\n"),e.payments.length>0&&(i+="تفاصيل المدفوعات المفلترة\n",i+="تاريخ الدفع,اسم المريض,الوصف,المبلغ,المبلغ المدفوع,الرصيد المتبقي,طريقة الدفع,الحالة,رقم الإيصال,ملاحظات\n",e.payments.forEach(e=>{const t=n(e.payment_date),s=e.patient?.full_name||e.patient?.name||"غير محدد",a=e.description||"غير محدد";let c,d,o;if("partial"===e.status){const t=Number(e.total_amount_due||e.amount)||0,s=Number(e.amount_paid||e.amount)||0;c=r(t),d=r(s),o=r(Math.max(0,t-s))}else e.appointment_id&&e.treatment_total_cost?(c=r(Number(e.treatment_total_cost)||0),d=r(Number(e.treatment_total_paid||e.amount)||0),o=r(Number(e.treatment_remaining_balance||0))):(c=r(Number(e.amount)||0),d=r(Number(e.amount)||0),o=r(0));const m=this.getPaymentMethodInArabic(e.payment_method),x=l(e.status),h=e.receipt_number||"",u=e.notes||"";i+=`"${t}","${s}","${a}","${c}","${d}","${o}","${m}","${x}","${h}","${u}"\n`}),i+="\n"),e.inventory.length>0&&(i+="تفاصيل المخزون المفلتر\n",i+="اسم الصنف,الوصف,الفئة,الكمية,الوحدة,الحد الأدنى,تكلفة الوحدة,القيمة الإجمالية,المورد,تاريخ الانتهاء,الحالة,تاريخ الإنشاء\n",e.inventory.forEach(e=>{const t=e.name||"غير محدد",s=e.description||"غير محدد",a=e.category||"غير محدد",l=e.quantity||0,c=e.unit||"قطعة",d=e.minimum_stock||0,o=r(e.cost_per_unit||0),m=r((e.cost_per_unit||0)*(e.quantity||0)),x=e.supplier||"غير محدد",h=e.expiry_date?n(e.expiry_date):"غير محدد",u=this.getInventoryStatusInArabic(e.quantity||0,e.minimum_stock||0),p=n(e.created_at);i+=`"${t}","${s}","${a}","${l}","${c}","${d}","${o}","${m}","${x}","${h}","${u}","${p}"\n`}),i+="\n"),e.patients.length>0){i+="تفاصيل المرضى (أحدث 50 مريض)\n",i+="#,الاسم الكامل,رقم الهاتف,العمر,الجنس,الحالة الطبية,الحساسية,البريد الإلكتروني,العنوان,تاريخ التسجيل,آخر موعد,إجمالي المواعيد,إجمالي المدفوعات,الرصيد المتبقي,ملاحظات\n";[...e.patients].sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime()).slice(0,50).forEach(t=>{const s=t.serial_number||"غير محدد",a=t.full_name||t.name||"غير محدد",l=t.phone||"غير محدد",c=t.age||"غير محدد",d="male"===t.gender?"ذكر":"female"===t.gender?"أنثى":"غير محدد",o=t.patient_condition||"غير محدد",m=t.allergies||"لا يوجد",x=t.email||"غير محدد",h=t.address||"غير محدد",u=n(t.created_at),p=t.notes||"لا يوجد",g=e.appointments.filter(e=>e.patient_id===t.id),f=e.payments.filter(e=>e.patient_id===t.id),j=g.length>0?n(g.sort((e,t)=>new Date(t.start_time).getTime()-new Date(e.start_time).getTime())[0].start_time):"لا يوجد",y=g.length;let v=0,N=0,b=0,w=0;g.forEach(e=>{if(e.cost){const t=f.filter(t=>t.appointment_id===e.id).reduce((e,t)=>e+(t.amount||0),0);b+=e.cost,w+=t}});f.filter(e=>!e.appointment_id).forEach(e=>{w+=e.amount||0,e.total_amount_due&&(b+=e.total_amount_due)}),v+=w,N+=Math.max(0,b-w),i+=`"${s}","${a}","${l}","${c}","${d}","${o}","${m}","${x}","${h}","${u}","${j}","${y}","${r(v)}","${r(N)}","${p}"\n`}),i+="\n"}i+="ملخص إضافي للطبيب\n",i+=`متوسط قيمة الموعد,${s.total>0?r(t.totalRevenue/s.total):"0"}\n`,i+=`متوسط المدفوعات اليومية,${this.calculateDailyAverage(e.payments,t.totalRevenue)}\n`,i+=`نسبة المدفوعات المكتملة,${t.totalTransactions>0?Math.round(t.completedTransactions/t.totalTransactions*100):0}%\n`,i+=`نسبة المدفوعات الجزئية,${t.totalTransactions>0?Math.round(t.partialTransactions/t.totalTransactions*100):0}%\n`,i+=`نسبة الإلغاء,${s.total>0?Math.round(s.cancelled/s.total*100):0}%\n`,i+=`متوسط عدد المواعيد لكل مريض,${e.patients.length>0?Math.round(s.total/e.patients.length*100)/100:0}\n`,i+=`متوسط الإيرادات لكل مريض,${e.patients.length>0?r(t.totalRevenue/e.patients.length):"0"}\n\n`,i+="تحليلات متقدمة\n";const c=e.appointments.reduce((e,t)=>e+(t.cost||0),0),d=c>0?Math.round(t.totalRevenue/c*100):0;i+=`معدل التحصيل,${d}%\n`;const o=this.analyzeTreatmentTypes(e.appointments);i+=`أكثر أنواع العلاج طلباً,${o.mostCommon}\n`,i+=`أعلى أنواع العلاج قيمة,${o.highestValue}\n`;const m=this.analyzeAppointmentTimes(e.appointments);i+=`أكثر الأوقات ازدحاماً,${m.peakHour}\n`,i+=`أكثر الأيام ازدحاماً,${m.peakDay}\n`;const x=this.analyzePatients(e.patients,e.appointments,e.payments);return i+=`أكثر المرضى زيارة,${x.mostFrequent}\n`,i+=`أعلى المرضى إنفاقاً,${x.highestSpender}\n`,i+="\nتوصيات للطبيب\n",s.attendanceRate<80&&(i+=`توصية,تحسين معدل الحضور - النسبة الحالية ${s.attendanceRate}% منخفضة\n`),d<90&&(i+=`توصية,تحسين معدل التحصيل - النسبة الحالية ${d}% منخفضة\n`),t.partialTransactions>t.completedTransactions&&(i+=`توصية,متابعة المدفوعات الجزئية - ${t.partialTransactions} معاملة جزئية مقابل ${t.completedTransactions} مكتملة\n`),a.lowStockItems>0&&(i+=`توصية,تجديد المخزون - ${a.lowStockItems} صنف منخفض المخزون\n`),a.expiredItems>0&&(i+=`توصية,إزالة المواد المنتهية الصلاحية - ${a.expiredItems} صنف منتهي الصلاحية\n`),a.nearExpiryItems>0&&(i+=`توصية,استخدام المواد قريبة الانتهاء - ${a.nearExpiryItems} صنف ينتهي خلال 30 يوم\n`),s.cancelled>.2*s.completed&&(i+=`توصية,تقليل معدل الإلغاء - ${s.cancelled} موعد ملغي من أصل ${s.total}\n`),t.overdueAmount>.1*t.totalRevenue&&(i+=`توصية,متابعة المدفوعات المتأخرة - ${r(t.overdueAmount)} مبلغ متأخر\n`),i}static getStatusInArabic(e){return{scheduled:"مجدول",completed:"مكتمل",cancelled:"ملغي","no-show":"لم يحضر",confirmed:"مؤكد",pending:"آجل"}[e]||e}static getPaymentMethodInArabic(e){return{cash:"نقدي",bank_transfer:"تحويل بنكي",credit_card:"بطاقة ائتمان",debit_card:"بطاقة خصم"}[e]||e}static getInventoryStatusInArabic(e,t){return 0===e?"نفد من المخزون":e<=t?"منخفض المخزون":"متوفر"}static calculateDailyAverage(e,t){if(0===e.length)return"0";const s=new Set(e.map(e=>e.payment_date.split("T")[0])).size;if(0===s)return"0";return r(t/s)}static calculateAge(e){try{const t=new Date(e),s=new Date;let a=s.getFullYear()-t.getFullYear();const n=s.getMonth()-t.getMonth();return(n<0||0===n&&s.getDate()<t.getDate())&&a--,a.toString()}catch(t){return"غير محدد"}}static calculateAverageAge(e){if(0===e.length)return"0";const t=e.reduce((e,t)=>e+("number"==typeof t.age?t.age:0),0)/e.length;return Math.round(t).toString()}static getGenderDistribution(e){if(0===e.length)return"لا يوجد بيانات";const t=e.filter(e=>"male"===e.gender).length,s=e.filter(e=>"female"===e.gender).length;return`ذكور: ${t} (${Math.round(t/e.length*100)}%) - إناث: ${s} (${Math.round(s/e.length*100)}%)`}static getNewPatientsThisMonth(e){const t=(new Date).toISOString().slice(0,7);return e.filter(e=>e.created_at.startsWith(t)).length}static getActivePatients(e,t){const s=new Date;s.setMonth(s.getMonth()-3);return new Set(t.filter(e=>new Date(e.start_time)>=s).map(e=>e.patient_id)).size}static analyzeTreatmentTypes(e){const t={};e.forEach(e=>{const s=e.title||e.treatment_type||"غير محدد",a=this.getTreatmentNameInArabic(s);t[a]||(t[a]={count:0,totalValue:0}),t[a].count++,t[a].totalValue+=e.cost||0});const s=Object.entries(t).sort((e,t)=>t[1].count-e[1].count),a=Object.entries(t).sort((e,t)=>t[1].totalValue-e[1].totalValue);return{mostCommon:s.length>0?`${s[0][0]} (${s[0][1].count} مرة)`:"لا يوجد",highestValue:a.length>0?`${a[0][0]} (${r(a[0][1].totalValue)})`:"لا يوجد"}}static analyzeAppointmentTimes(e){const t={},s={};e.forEach(e=>{const a=new Date(e.start_time),n=a.getHours(),r=a.toLocaleDateString("ar-SA",{weekday:"long"});t[n]=(t[n]||0)+1,s[r]=(s[r]||0)+1});const a=Object.entries(t).sort((e,t)=>t[1]-e[1])[0],n=Object.entries(s).sort((e,t)=>t[1]-e[1])[0];return{peakHour:a?`${a[0]}:00 (${a[1]} موعد)`:"لا يوجد",peakDay:n?`${n[0]} (${n[1]} موعد)`:"لا يوجد"}}static analyzePatients(e,t,s){const a={};e.forEach(e=>{const n=t.filter(t=>t.patient_id===e.id),r=s.filter(t=>t.patient_id===e.id).reduce((e,t)=>e+("partial"===t.status&&void 0!==t.amount_paid?Number(t.amount_paid):Number(t.amount)),0);a[e.id]={name:e.full_name||e.name||"غير محدد",appointmentCount:n.length,totalPayments:r}});const n=Object.values(a).sort((e,t)=>t.appointmentCount-e.appointmentCount),l=Object.values(a).sort((e,t)=>t.totalPayments-e.totalPayments);return{mostFrequent:n.length>0?`${n[0].name} (${n[0].appointmentCount} موعد)`:"لا يوجد",highestSpender:l.length>0?`${l[0].name} (${r(l[0].totalPayments)})`:"لا يوجد"}}static async exportComprehensiveReport(e){try{const t=function(e,t,s){const a=new Date,n=new Date(a.getFullYear(),a.getMonth(),a.getDate());switch(e){case"today":const e=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59,999);return{startDate:n,endDate:e};case"yesterday":const r=new Date(n.getFullYear(),n.getMonth(),n.getDate()-1),l=new Date(r.getFullYear(),r.getMonth(),r.getDate(),23,59,59,999);return{startDate:r,endDate:l};case"this_week":const i=new Date(n);return i.setDate(n.getDate()-n.getDay()),{startDate:i,endDate:a};case"last_week":const c=new Date(n);c.setDate(n.getDate()-n.getDay()-7);const d=new Date(c);return d.setDate(c.getDate()+6),d.setHours(23,59,59,999),{startDate:c,endDate:d};case"this_month":return{startDate:new Date(n.getFullYear(),n.getMonth(),1),endDate:a};case"last_month":const o=new Date(n.getFullYear(),n.getMonth()-1,1),m=new Date(n.getFullYear(),n.getMonth(),0);return m.setHours(23,59,59,999),{startDate:o,endDate:m};case"this_quarter":return{startDate:new Date(n.getFullYear(),3*Math.floor(n.getMonth()/3),1),endDate:a};case"last_quarter":const x=new Date(n.getFullYear(),3*Math.floor(n.getMonth()/3)-3,1),h=new Date(n.getFullYear(),3*Math.floor(n.getMonth()/3),0);return h.setHours(23,59,59,999),{startDate:x,endDate:h};case"this_year":return{startDate:new Date(n.getFullYear(),0,1),endDate:a};case"last_year":const u=new Date(n.getFullYear()-1,0,1),p=new Date(n.getFullYear()-1,11,31);return p.setHours(23,59,59,999),{startDate:u,endDate:p};case"last_30_days":return{startDate:new Date(n.getFullYear(),n.getMonth(),n.getDate()-30),endDate:new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59,999)};case"last_90_days":return{startDate:new Date(n.getFullYear(),n.getMonth(),n.getDate()-90),endDate:new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,59,999)};case"custom":return t&&s?{startDate:new Date(t+"T00:00:00"),endDate:new Date(s+"T23:59:59.999")}:{startDate:new Date(0),endDate:a};default:return{startDate:new Date(0),endDate:a}}}(e.timePeriod,e.customStartDate,e.customEndDate),s=this.filterAllDataByDateRange(e,t);e.expenses&&(s.expenses=e.expenses.filter(e=>{if(!e.payment_date)return!1;const s=new Date(e.payment_date);return s>=t.startDate&&s<=t.endDate}));const a=function(e){return console.log("🔍 Validating data before export..."),Pt.validateAllData(e).isAllValid?(console.log("✅ Data validation passed! Export will contain accurate values."),e.filterInfo&&console.log("📊 Filter information:",e.filterInfo),!0):(console.error("❌ Data validation failed! Export may contain incorrect values."),!1)}({payments:s.payments,appointments:s.appointments,inventory:s.inventory,filterInfo:{appointmentFilter:Mt[e.timePeriod],paymentFilter:Mt[e.timePeriod],inventoryFilter:Mt[e.timePeriod]}});if(!a)throw new Error("فشل في التحقق من صحة البيانات");const n=this.calculateAllAspectsStats(s,t);this.generateEnhancedComprehensiveCSV({patients:e.patients,appointments:s.appointments,payments:s.payments,inventory:s.inventory,treatments:s.treatments,prescriptions:s.prescriptions,labOrders:s.labOrders,clinicNeeds:s.clinicNeeds,timePeriod:e.timePeriod,stats:n});await this.exportComprehensiveReportToExcel({patients:e.patients,appointments:s.appointments,payments:s.payments,inventory:s.inventory,treatments:s.treatments,prescriptions:s.prescriptions,labOrders:s.labOrders,clinicNeeds:s.clinicNeeds,expenses:s.expenses||[],timePeriod:e.timePeriod,stats:n,dateRange:t})}catch(t){throw console.error("Error exporting comprehensive report:",t),new Error("فشل في تصدير التقرير الشامل")}}static calculateComprehensiveStats(e){const t=this.calculateFinancialStats(e.filteredPayments,e.labOrders,e.clinicNeeds,e.filteredInventory,e.expenses);return{totalPatients:e.patients.length,totalAppointments:e.filteredAppointments.length,totalPayments:e.filteredPayments.length,totalInventoryItems:e.filteredInventory.length,totalLabOrders:e.labOrders?.length||0,totalClinicNeeds:e.clinicNeeds?.length||0,...t,appointmentsByStatus:this.groupByStatus(e.filteredAppointments,"status"),paymentsByMethod:this.groupByMethod(e.filteredPayments),inventoryByCategory:this.groupByCategory(e.filteredInventory)}}static generateEnhancedComprehensiveCSV(e){let t="\ufeff";return t+="التقرير الشامل المفصل للعيادة - جميع الجوانب\n",t+=`تاريخ التقرير,${this.formatGregorianDate(new Date)}\n`,t+=`وقت التقرير,${(new Date).toLocaleTimeString("ar-SA")}\n`,t+=`الفترة الزمنية,${Mt[e.timePeriod]}\n`,e.stats.dateRange&&(t+=`نطاق التواريخ,${e.stats.dateRange.period}\n`),t+="\n",t+="=== ملخص عام شامل ===\n",t+=`إجمالي المرضى,${e.stats.totalPatients}\n`,t+=`إجمالي المواعيد (مفلترة),${e.stats.totalAppointments}\n`,t+=`إجمالي المدفوعات (مفلترة),${e.stats.totalPayments}\n`,t+=`إجمالي العلاجات (مفلترة),${e.stats.totalTreatments}\n`,t+=`إجمالي الوصفات (مفلترة),${e.stats.totalPrescriptions}\n`,t+=`إجمالي طلبات المخابر (مفلترة),${e.stats.totalLabOrders}\n`,t+=`إجمالي احتياجات العيادة (مفلترة),${e.stats.totalClinicNeeds}\n`,t+=`إجمالي عناصر المخزون,${e.stats.totalInventoryItems}\n\n`,t+="تحليل الأرباح والخسائر الشامل\n",t+="=================================\n\n",t+="الإيرادات\n",t+=`المدفوعات المكتملة,${r(e.stats.completedPayments||0)}\n`,t+=`المدفوعات الجزئية,${r(e.stats.partialPayments||0)}\n`,t+=`إجمالي الإيرادات,${r(e.stats.totalRevenue||0)}\n`,t+=`المبالغ المتبقية من المدفوعات الجزئية,${r(e.stats.remainingBalances||0)}\n`,t+=`المدفوعات الآجلة,${r(e.stats.pendingAmount||0)}\n\n`,t+="المصروفات\n",t+=`إجمالي المدفوعات للمخابر,${r(e.stats.labOrdersTotal||0)}\n`,t+=`إجمالي المتبقي للمخابر,${r(e.stats.labOrdersRemaining||0)}\n`,t+=`إجمالي المدفوعات للاحتياجات والمخزون,${r(e.stats.clinicNeedsTotal||0)}\n`,t+=`إجمالي المتبقي للاحتياجات,${r(e.stats.clinicNeedsRemaining||0)}\n`,t+=`قيمة المخزون الحالي,${r(e.stats.inventoryExpenses||0)}\n`,t+=`مصروفات العيادة المباشرة,${r(e.stats.clinicExpensesTotal||0)}\n`,t+=`إجمالي المصروفات,${r(e.stats.totalExpenses||0)}\n\n`,t+="النتيجة النهائية\n",e.stats.isProfit?(t+=`صافي الربح,${r(e.stats.netProfit||0)}\n`,t+=`نسبة الربح,${(e.stats.profitMargin||0).toFixed(2)}%\n`,t+="الحالة,ربح\n"):(t+=`إجمالي الخسارة,${r(e.stats.lossAmount||0)}\n`,t+=`نسبة الخسارة,${Math.abs(e.stats.profitMargin||0).toFixed(2)}%\n`,t+="الحالة,خسارة\n"),t+="\n",t+="تحليل المواعيد التفصيلي\n",t+="========================\n",t+=`إجمالي المواعيد,${e.stats.total||0}\n`,t+=`المواعيد المكتملة,${e.stats.completed||0}\n`,t+=`المواعيد الملغية,${e.stats.cancelled||0}\n`,t+=`المواعيد المجدولة,${e.stats.scheduled||0}\n`,t+=`المواعيد الغائبة,${e.stats.noShow||0}\n`,t+=`معدل الحضور,${e.stats.attendanceRate||0}%\n`,e.stats.peakHour&&(t+=`أكثر الأوقات ازدحاماً,${e.stats.peakHour}\n`),t+=`متوسط المواعيد يومياً,${e.stats.averagePerDay||0}\n\n`,t+="تحليل العلاجات التفصيلي\n",t+="========================\n",t+=`إجمالي العلاجات,${e.stats.totalTreatments||0}\n`,t+=`العلاجات المكتملة,${e.stats.completedTreatments||0}\n`,t+=`العلاجات المخططة,${e.stats.plannedTreatments||0}\n`,t+=`العلاجات قيد التنفيذ,${e.stats.inProgressTreatments||0}\n`,t+=`العلاجات الملغية,${e.stats.cancelledTreatments||0}\n`,t+=`معدل إنجاز العلاجات,${e.stats.completionRate||0}%\n`,e.stats.mostTreatedTooth&&(t+=`أكثر الأسنان علاجاً,السن رقم ${e.stats.mostTreatedTooth.tooth} (${e.stats.mostTreatedTooth.count} علاج)\n`),t+="\n",t+="توزيع أنواع العلاجات\n",e.stats.treatmentTypes&&"object"==typeof e.stats.treatmentTypes?Object.entries(e.stats.treatmentTypes).forEach(([e,s])=>{const a=this.getTreatmentNameInArabic(e);t+=`${a},${s}\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",t+="توزيع الأسنان المعالجة\n",e.stats.teethTreated&&"object"==typeof e.stats.teethTreated?Object.entries(e.stats.teethTreated).forEach(([e,s])=>{t+=`السن رقم ${e},${s} علاج\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",e.treatments&&e.treatments.length>0&&e.treatments.length<=100&&(t+="تفاصيل العلاجات الفردية\n",t+="المريض,رقم السن,نوع العلاج,الفئة,الحالة,تاريخ البداية,تاريخ الإكمال,التكلفة,ملاحظات\n",e.treatments.forEach(s=>{const a=e.patients.find(e=>e.id===s.patient_id),l=a?a.full_name||a.name||`${a.first_name||""} ${a.last_name||""}`.trim():"غير محدد",i=s.start_date?n(s.start_date):"غير محدد",c=s.completion_date?n(s.completion_date):"غير محدد",d=s.cost?r(s.cost):"غير محدد",o=(s.notes||"").replace(/,/g,"؛"),m=this.getTreatmentNameInArabic(s.treatment_type||"غير محدد"),x=this.getCategoryNameInArabic(s.treatment_category||"غير محدد"),h=this.getStatusLabelInArabic(s.treatment_status||"غير محدد");t+=`"${l}",${s.tooth_number||"غير محدد"},"${m}","${x}","${h}",${i},${c},${d},"${o}"\n`}),t+="\n"),t+="تحليل الوصفات\n",t+="===============\n",t+=`إجمالي الوصفات,${e.stats.totalPrescriptions||0}\n`,t+=`المرضى الذين لديهم وصفات,${e.stats.patientsWithPrescriptions||0}\n`,t+=`متوسط الوصفات لكل مريض,${e.stats.averagePrescriptionsPerPatient||0}\n\n`,e.prescriptions&&e.prescriptions.length>0&&e.prescriptions.length<=50&&(t+="تفاصيل الوصفات الفردية\n",t+="تاريخ الوصفة,المريض,الموعد,ملاحظات\n",e.prescriptions.forEach(s=>{const a=s.prescription_date?n(s.prescription_date):"غير محدد";let r=s.patient_name||"غير محدد",l=s.appointment_title||"غير محدد";if("غير محدد"===r){const t=e.patients.find(e=>e.id===s.patient_id);r=t?t.full_name||t.name||`${t.first_name||""} ${t.last_name||""}`.trim():"غير محدد"}if("غير محدد"===l){const t=e.appointments.find(e=>e.id===s.appointment_id);l=t?t.title||t.description||"موعد طبي":"غير محدد"}const i=(s.notes||"").replace(/,/g,"؛");t+=`${a},"${r}","${l}","${i}"\n`}),t+="\n"),t+="تحليل طلبات المخابر\n",t+="==================\n",t+=`إجمالي طلبات المخابر,${e.stats.totalLabOrders||0}\n`,t+=`الطلبات الآجلة,${e.stats.pendingLabOrders||0}\n`,t+=`الطلبات المكتملة,${e.stats.completedLabOrders||0}\n`,t+=`الطلبات الملغية,${e.stats.cancelledLabOrders||0}\n`,t+=`معدل إنجاز طلبات المخابر,${e.stats.labOrdersCompletionRate||0}%\n`,t+=`إجمالي تكلفة المخابر,${r(e.stats.totalLabCost||0)}\n`,t+=`إجمالي المدفوع للمخابر,${r(e.stats.totalLabPaid||0)}\n`,t+=`إجمالي المتبقي للمخابر,${r(e.stats.totalLabRemaining||0)}\n`,e.stats.mostUsedLab&&(t+=`أكثر المخابر استخداماً,${e.stats.mostUsedLab.lab} (${e.stats.mostUsedLab.count} طلب)\n`),t+="\n",t+="توزيع المخابر المستخدمة\n",e.stats.labFrequency&&"object"==typeof e.stats.labFrequency?Object.entries(e.stats.labFrequency).forEach(([e,s])=>{t+=`${e},${s} طلب\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",e.labOrders&&e.labOrders.length>0&&e.labOrders.length<=50&&(t+="تفاصيل طلبات المخابر الفردية\n",t+="تاريخ الطلب,المختبر,المريض,الحالة,التكلفة,المدفوع,المتبقي,ملاحظات\n",e.labOrders.forEach(s=>{const a=s.order_date?n(s.order_date):"غير محدد",l=s.lab_name||s.laboratory||"غير محدد",i=e.patients.find(e=>e.id===s.patient_id),c=i?i.full_name||i.name||`${i.first_name||""} ${i.last_name||""}`.trim():"غير محدد",d=s.status||"غير محدد",o=s.cost?r(s.cost):"غير محدد",m=s.paid_amount?r(s.paid_amount):"غير محدد",x=s.remaining_balance?r(s.remaining_balance):"غير محدد",h=(s.notes||"").replace(/,/g,"؛");t+=`${a},"${l}","${c}",${d},${o},${m},${x},"${h}"\n`}),t+="\n"),t+="تحليل احتياجات العيادة\n",t+="=====================\n",t+=`إجمالي الاحتياجات,${e.stats.totalClinicNeeds||0}\n`,t+=`الاحتياجات الآجلة,${e.stats.pendingNeeds||0}\n`,t+=`الاحتياجات المطلوبة,${e.stats.orderedNeeds||0}\n`,t+=`الاحتياجات المستلمة,${e.stats.receivedNeeds||0}\n`,t+=`الاحتياجات الملغية,${e.stats.cancelledNeeds||0}\n`,t+=`معدل إنجاز الاحتياجات,${e.stats.needsCompletionRate||0}%\n`,t+=`إجمالي قيمة الاحتياجات,${r(e.stats.totalNeedsValue||0)}\n`,t+=`الاحتياجات العاجلة,${e.stats.urgentNeeds||0}\n`,t+=`الاحتياجات عالية الأولوية,${e.stats.highPriorityNeeds||0}\n\n`,t+="توزيع الأولويات\n",e.stats.priorityAnalysis&&"object"==typeof e.stats.priorityAnalysis?Object.entries(e.stats.priorityAnalysis).forEach(([e,s])=>{t+=`${"urgent"===e?"عاجل":"high"===e?"عالي":"medium"===e?"متوسط":"low"===e?"منخفض":e},${s}\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",t+="توزيع فئات الاحتياجات\n",e.stats.categoryAnalysis&&"object"==typeof e.stats.categoryAnalysis?Object.entries(e.stats.categoryAnalysis).forEach(([e,s])=>{t+=`${e},${s}\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",e.clinicNeeds&&e.clinicNeeds.length>0&&e.clinicNeeds.length<=50&&(t+="تفاصيل احتياجات العيادة الفردية\n",t+="تاريخ الطلب,اسم الصنف,الفئة,الكمية,السعر,القيمة الإجمالية,الأولوية,الحالة,ملاحظات\n",e.clinicNeeds.forEach(e=>{const s=e.created_at?n(e.created_at):"غير محدد",a=e.item_name||"غير محدد",l=e.category||"غير محدد",i=e.quantity||0,c=e.price?r(e.price):"غير محدد",d=(e.quantity||0)*(e.price||0),o=r(d),m="urgent"===e.priority?"عاجل":"high"===e.priority?"عالي":"medium"===e.priority?"متوسط":"low"===e.priority?"منخفض":e.priority||"غير محدد",x="pending"===e.status?"آجل":"ordered"===e.status?"مطلوب":"received"===e.status?"مستلم":"cancelled"===e.status?"ملغي":e.status||"غير محدد",h=(e.notes||"").replace(/,/g,"؛");t+=`${s},"${a}","${l}",${i},${c},${o},"${m}","${x}","${h}"\n`}),t+="\n"),t+="توزيع المواعيد حسب الحالة\n",e.stats.appointmentsByStatus&&"object"==typeof e.stats.appointmentsByStatus?Object.entries(e.stats.appointmentsByStatus).forEach(([e,s])=>{t+=`${e},${s}\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",t+="توزيع المدفوعات حسب طريقة الدفع\n",e.stats.paymentsByMethod&&"object"==typeof e.stats.paymentsByMethod?Object.entries(e.stats.paymentsByMethod).forEach(([e,s])=>{t+=`${e},${s}\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",t+="توزيع المخزون حسب الفئة\n",e.stats.inventoryByCategory&&"object"==typeof e.stats.inventoryByCategory?Object.entries(e.stats.inventoryByCategory).forEach(([e,s])=>{t+=`${e},${s}\n`}):t+="لا توجد بيانات متاحة\n",t+="\n",e.payments.length>0&&(t+="تفاصيل المدفوعات المفلترة\n",t+="رقم الإيصال,المريض,المبلغ,طريقة الدفع,الحالة,تاريخ الدفع,الوصف\n",e.payments.forEach(s=>{const a=e.patients.find(e=>e.id===s.patient_id)?.full_name||"غير محدد";t+=`"${s.receipt_number||`#${s.id.slice(-6)}`}","${a}","${r(s.amount)}","${s.payment_method}","${s.status}","${n(s.payment_date)}","${s.description||"-"}"\n`}),t+="\n"),e.appointments.length>0&&(t+="تفاصيل المواعيد المفلترة\n",t+="المريض,العنوان,التاريخ,الوقت,الحالة,التكلفة\n",e.appointments.forEach(s=>{const a=e.patients.find(e=>e.id===s.patient_id)?.full_name||"غير محدد";t+=`"${a}","${s.title||"-"}","${n(s.start_time)}","${i(s.start_time)}","${s.status}","${r(s.cost||0)}"\n`}),t+="\n"),e.inventory.length>0&&(t+="تفاصيل المخزون المفلتر\n",t+="اسم المنتج,الفئة,الكمية,السعر,تاريخ الانتهاء,الحالة\n",e.inventory.forEach(e=>{t+=`"${e.name}","${e.category||"-"}","${e.quantity}","${r(e.price||0)}","${e.expiry_date?n(e.expiry_date):"-"}","${e.status||"-"}"\n`})),t}static getTreatmentNameInArabic(e){return c(e)}static getCategoryNameInArabic(e){return d(e)}static getStatusLabelInArabic(e){return o(e)}static formatGregorianDate(e){if(!e||isNaN(e.getTime()))return"غير محدد";return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`}static async exportComprehensiveReportToExcel(e){const t=new Me.Workbook;t.creator="نظام إدارة العيادة",t.created=new Date,t.modified=new Date,t.title="التقرير الشامل المفصل",t.description="تقرير شامل لجميع جوانب العيادة",await this.createSummarySheet(t,e),await this.createPatientsSheet(t,e),await this.createAppointmentsSheet(t,e),await this.createPaymentsSheet(t,e),await this.createInventorySheet(t,e),await this.createLabOrdersSheet(t,e),await this.createClinicNeedsSheet(t,e),await this.createExpensesSheet(t,e),await this.createProfitLossSheet(t,e);const s=`التقرير_الشامل_المفصل_${Mt[e.timePeriod]}_${(new Date).toISOString().split("T")[0]}`,a=await t.xlsx.writeBuffer(),n=new Blob([a],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),r=document.createElement("a"),l=URL.createObjectURL(n);r.setAttribute("href",l),r.setAttribute("download",`${s}.xlsx`),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l),console.log("✅ تم تصدير التقرير الشامل المفصل بنجاح")}static async createSummarySheet(e,t){try{console.log("Creating summary sheet with data:",t);const s=e.addWorksheet("الملخص العام");s.mergeCells("A1:H1");const a=s.getCell("A1");a.value="التقرير الشامل المفصل - عيادة الأسنان",a.font={size:18,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2E8B57"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"thick"},left:{style:"thick"},bottom:{style:"thick"},right:{style:"thick"}},s.getCell("A3").value=`تاريخ التقرير: ${n(new Date)}`,s.getCell("A3").font={size:12,italic:!0};const l=t.timePeriod&&Mt[t.timePeriod]?Mt[t.timePeriod]:t.timePeriod||"غير محدد";s.getCell("A4").value=`الفترة الزمنية: ${l}`,s.getCell("A4").font={size:12,italic:!0};let i=6;const c=Array.isArray(t.patients)?t.patients:[],d=Array.isArray(t.appointments)?t.appointments:[],o=Array.isArray(t.payments)?t.payments:[],m=Array.isArray(t.inventory)?t.inventory:[],x=Array.isArray(t.labOrders)?t.labOrders:[],h=Array.isArray(t.clinicNeeds)?t.clinicNeeds:[],u=Array.isArray(t.expenses)?t.expenses:[];console.log("Data arrays lengths:",{patients:c.length,appointments:d.length,payments:o.length,inventory:m.length,labOrders:x.length,clinicNeeds:h.length,expenses:u.length});const p=[["إجمالي المرضى",c.length],["إجمالي المواعيد",d.length],["إجمالي المدفوعات",o.length],["إجمالي عناصر المخزون",m.length],["إجمالي طلبات المختبرات",x.length],["إجمالي احتياجات العيادة",h.length],["إجمالي مصروفات العيادة",u.length]];s.getCell(`A${i}`).value="الإحصائيات الأساسية",s.getCell(`A${i}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},i+=2,Array.isArray(p)&&p.forEach(([e,t])=>{s.getCell(`A${i}`).value=e,s.getCell(`B${i}`).value=t,s.getCell(`A${i}`).font={bold:!0};["A","B"].forEach(e=>{const t=s.getCell(`${e}${i}`);t.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}},t.alignment={horizontal:"right",vertical:"middle"}}),i++}),i+=2,s.getCell(`A${i}`).value="الإحصائيات المالية",s.getCell(`A${i}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},i+=2;const g=t.stats||{},f=[["إجمالي الإيرادات",r(g.totalRevenue||0)],["المدفوعات المكتملة",r(g.completedPayments||0)],["المدفوعات الجزئية",r(g.partialPayments||0)],["المبالغ الآجلة",r(g.pendingAmount||0)],["إجمالي المصروفات",r(g.totalExpenses||0)],["صافي الربح/الخسارة",r(g.netProfit||0)]];Array.isArray(f)&&f.forEach(([e,t])=>{s.getCell(`A${i}`).value=e,s.getCell(`B${i}`).value=t,s.getCell(`A${i}`).font={bold:!0};["A","B"].forEach(e=>{const t=s.getCell(`${e}${i}`);t.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}},t.alignment={horizontal:"right",vertical:"middle"}}),i++}),s.getColumn("A").width=30,s.getColumn("B").width=20,console.log("Summary sheet created successfully")}catch(s){throw console.error("Error creating summary sheet:",s),s}}static async createPatientsSheet(e,t){const s=e.addWorksheet("المرضى");s.mergeCells("A1:G1");const a=s.getCell("A1");a.value="تقرير المرضى",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},a.alignment={horizontal:"center",vertical:"middle"};let r=3;const l=t.patients||[],i=[["إجمالي المرضى",l.length],["المرضى الذكور",l.filter(e=>"male"===e.gender).length],["المرضى الإناث",l.filter(e=>"female"===e.gender).length],["متوسط العمر",l.length>0?Math.round(l.reduce((e,t)=>e+(t.age||0),0)/l.length):0]];s.getCell(`A${r}`).value="إحصائيات المرضى",s.getCell(`A${r}`).font={size:14,bold:!0},r+=2,i.forEach(([e,t])=>{s.getCell(`A${r}`).value=e,s.getCell(`B${r}`).value=t,r++}),r+=2,s.getCell(`A${r}`).value="تفاصيل المرضى",s.getCell(`A${r}`).font={size:14,bold:!0},r+=2;["الرقم التسلسلي","الاسم الكامل","الجنس","العمر","الهاتف","البريد الإلكتروني","تاريخ التسجيل"].forEach((e,t)=>{const a=s.getCell(r,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),r++,l.forEach((e,t)=>{[e.serial_number||"",e.full_name||"","male"===e.gender?"ذكر":"female"===e.gender?"أنثى":"غير محدد",e.age||"",e.phone||"",e.email||"",e.created_at?n(e.created_at):""].forEach((e,a)=>{const n=s.getCell(r,a+1);n.value=e,n.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},n.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}})}),r++}),s.columns.forEach(e=>{e.width=15})}static async createAppointmentsSheet(e,t){const s=e.addWorksheet("المواعيد");s.mergeCells("A1:H1");const a=s.getCell("A1");a.value="تقرير المواعيد",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF8B5CF6"}},a.alignment={horizontal:"center",vertical:"middle"};let l=3;const i=Array.isArray(t.appointments)?t.appointments:[],c=[["إجمالي المواعيد",i.length],["المواعيد المكتملة",i.filter(e=>"completed"===e.status).length],["المواعيد الملغية",i.filter(e=>"cancelled"===e.status).length],["المواعيد المجدولة",i.filter(e=>"scheduled"===e.status).length]];s.getCell(`A${l}`).value="إحصائيات المواعيد",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2,c.forEach(([e,t])=>{s.getCell(`A${l}`).value=e,s.getCell(`B${l}`).value=t,l++}),l+=2,s.getCell(`A${l}`).value="تفاصيل المواعيد",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2;["التاريخ","الوقت","اسم المريض","نوع العلاج","التكلفة","الحالة","الطبيب","ملاحظات"].forEach((e,t)=>{const a=s.getCell(l,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF8B5CF6"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),l++,Array.isArray(i)&&i.forEach((e,t)=>{[e.start_time?n(e.start_time):"",e.start_time?new Date(e.start_time).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}):"",e.patient?.full_name||"غير محدد",e.title||"غير محدد",e.cost?r(e.cost):"0",this.getStatusInArabic(e.status),e.doctor_name||"غير محدد",e.notes||""].forEach((e,a)=>{const n=s.getCell(l,a+1);n.value=e,n.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},n.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}})}),l++}),s.columns.forEach(e=>{e.width=15})}static async createPaymentsSheet(e,t){const s=e.addWorksheet("المدفوعات");s.mergeCells("A1:I1");const a=s.getCell("A1");a.value="تقرير المدفوعات",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF10B981"}},a.alignment={horizontal:"center",vertical:"middle"};let l=3;const i=Array.isArray(t.payments)?t.payments:[],c=i.reduce((e,t)=>e+(t.amount||0),0),d=i.filter(e=>"completed"===e.status),o=i.filter(e=>"partial"===e.status),m=i.filter(e=>"pending"===e.status),x=[["إجمالي المدفوعات",i.length],["إجمالي الإيرادات",r(c)],["المدفوعات المكتملة",d.length],["المدفوعات الجزئية",o.length],["المدفوعات الآجلة",m.length]];s.getCell(`A${l}`).value="إحصائيات المدفوعات",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2,x.forEach(([e,t])=>{s.getCell(`A${l}`).value=e,s.getCell(`B${l}`).value=t,l++}),l+=2,s.getCell(`A${l}`).value="تفاصيل المدفوعات",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2;["تاريخ الدفع","اسم المريض","الوصف","المبلغ","المبلغ المدفوع","الرصيد المتبقي","طريقة الدفع","الحالة","رقم الإيصال"].forEach((e,t)=>{const a=s.getCell(l,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF10B981"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),l++,Array.isArray(i)&&i.forEach((e,t)=>{let a,i,c;"partial"===e.status?(a=Number(e.total_amount_due||e.amount)||0,i=Number(e.amount_paid||e.amount)||0,c=Math.max(0,a-i)):e.appointment_id&&e.appointment_total_cost?(a=Number(e.appointment_total_cost)||0,i=Number(e.appointment_total_paid||e.amount)||0,c=Number(e.appointment_remaining_balance||0)):(a=Number(e.amount)||0,i=Number(e.amount)||0,c=0);[e.payment_date?n(e.payment_date):"",e.patient?.full_name||"غير محدد",e.description||"غير محدد",r(a),r(i),r(c),e.payment_method||"غير محدد",this.getPaymentStatusInArabic(e.status),e.receipt_number||""].forEach((e,a)=>{const n=s.getCell(l,a+1);n.value=e,n.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},n.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),a>=3&&a<=5&&(n.font={bold:!0},n.fill||(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}}))}),l++}),s.columns.forEach(e=>{e.width=15})}static async createInventorySheet(e,t){const s=e.addWorksheet("المخزون");s.mergeCells("A1:F1");const a=s.getCell("A1");a.value="تقرير المخزون",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF59E0B"}},a.alignment={horizontal:"center",vertical:"middle"};let l=3;const i=Array.isArray(t.inventory)?t.inventory:[],c=i.reduce((e,t)=>e+(t.cost||0)*(t.quantity||0),0),d=i.filter(e=>(e.quantity||0)<=5).length,o=[["إجمالي العناصر",i.length],["القيمة الإجمالية",r(c)],["عناصر منخفضة المخزون",d],["عناصر نفدت من المخزون",i.filter(e=>0===(e.quantity||0)).length]];s.getCell(`A${l}`).value="إحصائيات المخزون",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2,o.forEach(([e,t])=>{s.getCell(`A${l}`).value=e,s.getCell(`B${l}`).value=t,l++}),l+=2,s.getCell(`A${l}`).value="تفاصيل المخزون",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2;["اسم المنتج","الفئة","الكمية","التكلفة","القيمة الإجمالية","تاريخ الانتهاء"].forEach((e,t)=>{const a=s.getCell(l,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF59E0B"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),l++,Array.isArray(i)&&i.forEach((e,t)=>{[e.name||"",e.category||"",e.quantity||0,r(e.cost||0),r((e.cost||0)*(e.quantity||0)),e.expiry_date?n(e.expiry_date):""].forEach((a,n)=>{const r=s.getCell(l,n+1);r.value=a,r.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},r.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),2===n&&(e.quantity||0)<=5&&(r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFECACA"}},r.font={bold:!0,color:{argb:"FFDC2626"}})}),l++}),s.columns.forEach(e=>{e.width=15})}static async createLabOrdersSheet(e,t){const s=e.addWorksheet("طلبات المختبرات");s.mergeCells("A1:H1");const a=s.getCell("A1");a.value="تقرير طلبات المختبرات",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF14B8A6"}},a.alignment={horizontal:"center",vertical:"middle"};let l=3;const i=Array.isArray(t.labOrders)?t.labOrders:[],c=i.reduce((e,t)=>e+(t.cost||0),0),d=i.reduce((e,t)=>e+(t.paid_amount||0),0),o=c-d,m=[["إجمالي الطلبات",i.length],["إجمالي التكلفة",r(c)],["إجمالي المدفوع",r(d)],["إجمالي المتبقي",r(o)]];s.getCell(`A${l}`).value="إحصائيات طلبات المختبرات",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2,m.forEach(([e,t])=>{s.getCell(`A${l}`).value=e,s.getCell(`B${l}`).value=t,l++}),l+=2,s.getCell(`A${l}`).value="تفاصيل طلبات المختبرات",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2;["تاريخ الطلب","المختبر","اسم المريض","الخدمة","التكلفة","المدفوع","المتبقي","الحالة"].forEach((e,t)=>{const a=s.getCell(l,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF14B8A6"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),l++,Array.isArray(i)&&i.forEach((e,a)=>{const i=(Array.isArray(t.patients)?t.patients:[]).find(t=>t.id===e.patient_id);[e.order_date?n(e.order_date):"",e.lab?.name||"غير محدد",i?.full_name||"غير محدد",e.service_name||"غير محدد",r(e.cost||0),r(e.paid_amount||0),r((e.cost||0)-(e.paid_amount||0)),e.status||"غير محدد"].forEach((e,t)=>{const n=s.getCell(l,t+1);n.value=e,n.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},n.alignment={horizontal:"right",vertical:"middle"},a%2==0&&(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),t>=4&&t<=6&&(n.font={bold:!0},n.fill||(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}}))}),l++}),s.columns.forEach(e=>{e.width=15})}static async createClinicNeedsSheet(e,t){const s=e.addWorksheet("احتياجات العيادة");s.mergeCells("A1:H1");const a=s.getCell("A1");a.value="تقرير احتياجات العيادة",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFEC4899"}},a.alignment={horizontal:"center",vertical:"middle"};let l=3;const i=t.clinicNeeds.reduce((e,t)=>e+(t.price||0)*(t.quantity||0),0),c=t.clinicNeeds.filter(e=>"urgent"===e.priority).length,d=t.clinicNeeds.filter(e=>"pending"===e.status).length,o=[["إجمالي الاحتياجات",t.clinicNeeds.length],["إجمالي التكلفة المتوقعة",r(i)],["الاحتياجات العاجلة",c],["الاحتياجات الآجلة",d]];s.getCell(`A${l}`).value="إحصائيات احتياجات العيادة",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2,o.forEach(([e,t])=>{s.getCell(`A${l}`).value=e,s.getCell(`B${l}`).value=t,l++}),l+=2,s.getCell(`A${l}`).value="تفاصيل احتياجات العيادة",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2;["تاريخ الطلب","اسم الصنف","الفئة","الكمية","السعر المتوقع","القيمة الإجمالية","الأولوية","الحالة"].forEach((e,t)=>{const a=s.getCell(l,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFEC4899"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),l++,t.clinicNeeds.forEach((e,t)=>{[e.created_at?n(e.created_at):"",e.name||"غير محدد",e.category||"غير محدد",e.quantity||0,r(e.price||0),r((e.price||0)*(e.quantity||0)),{urgent:"عاجل",high:"عالي",medium:"متوسط",low:"منخفض"}[e.priority]||e.priority||"غير محدد",{pending:"آجل",ordered:"تم الطلب",received:"تم الاستلام"}[e.status]||e.status||"غير محدد"].forEach((a,n)=>{const r=s.getCell(l,n+1);r.value=a,r.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},r.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),"urgent"===e.priority&&(r.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFECACA"}},r.font={bold:!0,color:{argb:"FFDC2626"}})}),l++}),s.columns.forEach(e=>{e.width=15})}static async createExpensesSheet(e,t){const s=e.addWorksheet("مصروفات العيادة");s.mergeCells("A1:G1");const a=s.getCell("A1");a.value="تقرير مصروفات العيادة",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFEF4444"}},a.alignment={horizontal:"center",vertical:"middle"};let l=3;const i=t.expenses.reduce((e,t)=>e+(t.amount||0),0),c=t.expenses.filter(e=>"paid"===e.status),d=t.expenses.filter(e=>"pending"===e.status),o=[["إجمالي المصروفات",t.expenses.length],["إجمالي المبلغ",r(i)],["المصروفات المدفوعة",c.length],["المصروفات الآجلة",d.length]];s.getCell(`A${l}`).value="إحصائيات مصروفات العيادة",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2,o.forEach(([e,t])=>{s.getCell(`A${l}`).value=e,s.getCell(`B${l}`).value=t,l++}),l+=2,s.getCell(`A${l}`).value="تفاصيل مصروفات العيادة",s.getCell(`A${l}`).font={size:14,bold:!0},l+=2;["تاريخ الدفع","اسم المصروف","النوع","المبلغ","طريقة الدفع","المورد","الحالة"].forEach((e,t)=>{const a=s.getCell(l,t+1);a.value=e,a.font={bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFEF4444"}},a.alignment={horizontal:"center",vertical:"middle"},a.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}}),l++,t.expenses.forEach((e,t)=>{[e.payment_date?n(e.payment_date):"",e.expense_name||"غير محدد",{salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"}[e.expense_type]||e.expense_type||"غير محدد",r(e.amount||0),{cash:"نقداً",bank_transfer:"تحويل بنكي",check:"شيك",credit_card:"بطاقة ائتمان"}[e.payment_method]||e.payment_method||"غير محدد",e.vendor||"غير محدد","paid"===e.status?"مدفوع":"آجل"].forEach((e,a)=>{const n=s.getCell(l,a+1);n.value=e,n.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},n.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),3===a&&(n.font={bold:!0},n.fill||(n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}}))}),l++}),s.columns.forEach(e=>{e.width=15})}static async createProfitLossSheet(e,t){const s=e.addWorksheet("الأرباح والخسائر");s.mergeCells("A1:H1");const a=s.getCell("A1");a.value="تقرير الأرباح والخسائر",a.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF7C3AED"}},a.alignment={horizontal:"center",vertical:"middle"};let n=3;const l=t.payments.reduce((e,t)=>e+(t.amount||0),0),i=t.labOrders.reduce((e,t)=>e+(t.cost||0),0),c=t.clinicNeeds.reduce((e,t)=>e+(t.price||0)*(t.quantity||0),0),d=t.inventory.reduce((e,t)=>e+(t.cost||0)*(t.quantity||0),0),o=t.expenses.reduce((e,t)=>e+(t.amount||0),0),m=i+c+d+o,x=l-m,h=x>=0,u=l>0?x/l*100:0;s.getCell(`A${n}`).value="ملخص الأرباح والخسائر",s.getCell(`A${n}`).font={size:14,bold:!0,color:{argb:"FF7C3AED"}},n+=2;[["إجمالي الإيرادات",r(l)],["إجمالي المصروفات",r(m)],["صافي الربح/الخسارة",r(Math.abs(x))],["نسبة الربح",`${u.toFixed(2)}%`],["الحالة المالية",h?"ربح":"خسارة"]].forEach(([e,t])=>{s.getCell(`A${n}`).value=e,s.getCell(`B${n}`).value=t,s.getCell(`A${n}`).font={bold:!0},"الحالة المالية"===e&&(s.getCell(`B${n}`).font={bold:!0,color:{argb:h?"FF10B981":"FFEF4444"}}),n++}),n+=2,s.getCell(`A${n}`).value="تفصيل الإيرادات",s.getCell(`A${n}`).font={size:14,bold:!0,color:{argb:"FF10B981"}},n+=2;const p=t.payments.filter(e=>"completed"===e.status),g=t.payments.filter(e=>"partial"===e.status),f=t.payments.filter(e=>"pending"===e.status);[["المدفوعات المكتملة",`${p.length} (${r(p.reduce((e,t)=>e+(t.amount||0),0))})`],["المدفوعات الجزئية",`${g.length} (${r(g.reduce((e,t)=>e+(t.amount||0),0))})`],["المدفوعات الآجلة",`${f.length} (${r(f.reduce((e,t)=>e+(t.amount||0),0))})`]].forEach(([e,t])=>{s.getCell(`A${n}`).value=e,s.getCell(`B${n}`).value=t,n++}),n+=2,s.getCell(`A${n}`).value="تفصيل المصروفات",s.getCell(`A${n}`).font={size:14,bold:!0,color:{argb:"FFEF4444"}},n+=2;[["تكاليف المختبرات",r(i)],["احتياجات العيادة",r(c)],["تكاليف المخزون",r(d)],["مصروفات مباشرة",r(o)]].forEach(([e,t])=>{s.getCell(`A${n}`).value=e,s.getCell(`B${n}`).value=t,n++}),s.getColumn("A").width=30,s.getColumn("B").width=20}static getPaymentStatusInArabic(e){return{completed:"مكتمل",partial:"جزئي",pending:"آجل",overdue:"متأخر",cancelled:"ملغي"}[e]||e}static filterByDateRange(e,t,s){if(!t||!t.start||!t.end)return e;const a=new Date(t.start),n=new Date(t.end);return n.setHours(23,59,59,999),e.filter(e=>{const t=new Date(e[s]);return t>=a&&t<=n})}}function Rt({isActive:s=!0,lastUpdate:a,className:n=""}){const[r,l]=t.useState(!1);t.useEffect(()=>{const e=()=>{l(!0),setTimeout(()=>l(!1),1e3)},t=["patient-added","patient-updated","patient-deleted","patient-changed","appointment-added","appointment-updated","appointment-deleted","appointment-changed","payment-added","payment-updated","payment-deleted","payment-changed","inventory-added","inventory-updated","inventory-deleted","inventory-changed"];return t.forEach(t=>{window.addEventListener(t,e)}),()=>{t.forEach(t=>{window.removeEventListener(t,e)})}},[]);return s?e.jsx(m,{variant:r?"default":"secondary",className:`flex items-center gap-1 ${n} ${r?"bg-green-500 text-white dark:bg-green-600":"bg-green-100 text-green-800 dark:bg-green-600/20 dark:text-green-400"}`,children:r?e.jsxs(e.Fragment,{children:[e.jsx(x,{className:"w-3 h-3 animate-spin"}),e.jsx("span",{className:"text-xs",children:"يتم التحديث..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ct,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs",children:a?(e=>{const t=(new Date).getTime()-e.getTime(),s=Math.floor(t/1e3),a=Math.floor(s/60),n=Math.floor(a/60);if(s<60)return"الآن";if(a<60)return`منذ ${a} دقيقة`;if(n<24)return`منذ ${n} ساعة`;return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`})(a):"متصل"})]})}):e.jsxs(m,{variant:"secondary",className:`flex items-center gap-1 ${n}`,children:[e.jsx(At,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs",children:"غير متصل"})]})}function Ot(){const{toast:s}=h(),[a,n]=t.useState(!1),[r,l]=t.useState(""),[i,c]=t.useState(""),[d,o]=t.useState(""),[m,x]=t.useState(""),[V,q]=t.useState(""),[Y,K]=t.useState(!1),[W,H]=t.useState(!1),[G,U]=t.useState(!1),[X,Z]=t.useState(!1),[J,Q]=t.useState(""),[ee,te]=t.useState(!1);t.useEffect(()=>{n(u())},[]);const se=()=>{l(""),c(""),o(""),x(""),q(""),Q(""),K(!1),H(!1),U(!1)},ae=async e=>{if(e.preventDefault(),!a||r.trim())if(i.trim())if(d.trim())if(a&&i===r)Q("كلمة المرور الجديدة يجب أن تكون مختلفة عن الحالية");else if(i===d)if(I(i)){Z(!0),Q("");try{let e=!1;if(a)e=await L(r.trim(),i.trim()),e&&s({title:"تم تغيير كلمة المرور بنجاح",description:"استخدم كلمة المرور الجديدة في المرات القادمة",variant:"default"});else{if(!m||!V.trim())return Q("يرجى اختيار سؤال أماني والإجابة عليه"),void Z(!1);const t=E.find(e=>e.id===m);if(!t)return Q("سؤال أماني غير صالح"),void Z(!1);const a={password:i.trim(),securityQuestion:t,securityAnswer:V.trim()};e=await z(a),e&&(s({title:"تم إعداد كلمة المرور بنجاح",description:"سيتم طلب كلمة المرور عند الوصول لقسم التقارير",variant:"default"}),n(!0))}e?se():Q(a?"فشل في تغيير كلمة المرور. تأكد من صحة كلمة المرور الحالية.":"فشل في إعداد كلمة المرور. يرجى المحاولة مرة أخرى.")}catch(t){Q(t.message||"حدث خطأ أثناء حفظ كلمة المرور")}finally{Z(!1)}}else Q("كلمة المرور ضعيفة. يجب أن تحتوي على 4 أحرف على الأقل وحرف أو رقم واحد");else Q("كلمات المرور غير متطابقة");else Q("يرجى تأكيد كلمة المرور الجديدة");else Q("يرجى إدخال كلمة مرور جديدة");else Q("يرجى إدخال كلمة المرور الحالية")};return e.jsx(p,{className:"w-full",dir:"rtl",children:e.jsxs(Te,{open:ee,onOpenChange:te,children:[e.jsx(Re,{asChild:!0,children:e.jsx(g,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center",children:a?e.jsx(f,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}):e.jsx(Ie,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx(j,{className:"text-lg",children:"إعدادات الأمان"}),e.jsx(y,{className:"text-right",children:a?"تغيير كلمة مرور قسم التقارير":"إعداد كلمة مرور لحماية قسم التقارير"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:ee?"إغلاق":"فتح"}),ee?e.jsx(v,{className:"w-4 h-4 text-muted-foreground"}):e.jsx(N,{className:"w-4 h-4 text-muted-foreground"})]})]})})}),e.jsx(Oe,{children:e.jsx(b,{children:e.jsxs("form",{onSubmit:ae,onKeyDown:e=>{"Enter"!==e.key||X||ae(e)},className:"space-y-4",children:[a&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"currentPassword",className:"text-right block",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"currentPassword",type:Y?"text":"password",value:r,onChange:e=>l(e.target.value),placeholder:"أدخل كلمة المرور الحالية",className:"pr-10 text-right",disabled:X}),e.jsx(F,{type:"button",variant:"ghost",size:"sm",className:"absolute left-2 top-1/2 -translate-y-1/2 h-auto p-1",onClick:()=>K(!Y),disabled:X,children:Y?e.jsx(_,{className:"w-4 h-4"}):e.jsx(D,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"newPassword",className:"text-right block",children:a?"كلمة المرور الجديدة":"كلمة المرور"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"newPassword",type:W?"text":"password",value:i,onChange:e=>c(e.target.value),placeholder:a?"أدخل كلمة مرور جديدة":"أدخل كلمة مرور",className:"pr-10 text-right",disabled:X}),e.jsx(F,{type:"button",variant:"ghost",size:"sm",className:"absolute left-2 top-1/2 -translate-y-1/2 h-auto p-1",onClick:()=>H(!W),disabled:X,children:W?e.jsx(_,{className:"w-4 h-4"}):e.jsx(D,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"confirmPassword",className:"text-right block",children:"تأكيد كلمة المرور"}),e.jsxs("div",{className:"relative",children:[e.jsx($,{id:"confirmPassword",type:G?"text":"password",value:d,onChange:e=>o(e.target.value),placeholder:"أعد إدخال كلمة المرور",className:"pr-10 text-right",disabled:X}),e.jsx(F,{type:"button",variant:"ghost",size:"sm",className:"absolute left-2 top-1/2 -translate-y-1/2 h-auto p-1",onClick:()=>U(!G),disabled:X,children:G?e.jsx(_,{className:"w-4 h-4"}):e.jsx(D,{className:"w-4 h-4"})})]})]}),!a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{className:"text-right block",children:"السؤال الأماني (لإعادة التعيين في حال نسيان كلمة المرور)"}),e.jsxs(k,{value:m,onValueChange:x,disabled:X,children:[e.jsx(A,{className:"text-right",children:e.jsx(C,{placeholder:"اختر سؤال أماني"})}),e.jsx(S,{children:E.map(t=>e.jsx(P,{value:t.id,className:"text-right",children:t.question},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"securityAnswer",className:"text-right block",children:"إجابة السؤال الأماني"}),e.jsx($,{id:"securityAnswer",type:"text",value:V,onChange:e=>q(e.target.value),placeholder:"أدخل إجابتك على السؤال المختار",className:"text-right",disabled:X})]})]}),J&&e.jsxs(M,{variant:"destructive",children:[e.jsx(T,{className:"h-4 w-4"}),e.jsx(R,{className:"text-right",children:J})]}),e.jsxs("div",{className:"text-xs text-muted-foreground text-right",children:[e.jsx("p",{className:"font-medium mb-1",children:"متطلبات كلمة المرور:"}),e.jsx("p",{children:"• على الأقل 4 أحرف"}),e.jsx("p",{children:"• حرف أو رقم واحد على الأقل"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 pt-4",children:[e.jsx(F,{type:"button",variant:"outline",onClick:se,disabled:X,className:"w-full sm:w-auto",children:"إعادة تعيين"}),a&&e.jsx(F,{type:"button",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف كلمة المرور؟ سيتم السماح بالوصول المباشر لقسم التقارير.")){Z(!0);try{B(),n(!1),se(),s({title:"تم حذف كلمة المرور",description:"يمكنك الآن الوصول لقسم التقارير مباشرة بدون كلمة مرور",variant:"default"})}catch(e){console.error("Error disabling password:",e),s({title:"خطأ",description:"فشل في حذف كلمة المرور",variant:"destructive"})}finally{Z(!1)}}},disabled:X,className:"w-full sm:w-auto",children:"حذف كلمة المرور"}),e.jsx(F,{type:"submit",disabled:X||!i.trim()||!d.trim()||(a?!r.trim():!m||!V.trim()),className:"w-full sm:w-auto",children:X?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4 ml-2"}),a?"حفظ التغييرات":"إعداد كلمة المرور"]})})]})]})})})]})})}function It(){const{patientReports:s,isLoading:a,isExporting:r,generateReport:l,exportReport:i,currentFilter:c,setFilter:d,clearCache:o}=fe(),{currency:u,settings:f}=V(),{toast:v}=h(),{isDarkMode:N}=q(),{patients:_,loadPatients:D}=Y(),[E,M]=t.useState(""),[T,R]=t.useState("all"),[O,I]=t.useState("all");t.useEffect(()=>{l("patients"),D()},[l,D]),je("patients");const L=({title:t,value:s,icon:a,color:n="blue",trend:r,description:l})=>e.jsxs(p,{className:Se(n),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:t}),e.jsx(a,{className:`h-4 w-4 ${Ee(n)}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:s}),r&&e.jsxs("div",{className:"text-xs flex items-center justify-end mt-1 "+(r.isPositive?"text-green-600":"text-red-600"),children:[e.jsxs("span",{className:"ml-1",children:[Math.abs(r.value),"%"]}),r.isPositive?e.jsx(lt,{className:"h-3 w-3"}):e.jsx(it,{className:"h-3 w-3"})]}),l&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 text-right",children:l})]})]}),z=s?.patientsList?.filter(e=>{const t=`${e.first_name} ${e.last_name}`.toLowerCase().includes(E.toLowerCase())||e.phone?.includes(E)||e.email?.toLowerCase().includes(E.toLowerCase()),s="all"===T||(()=>{if(!e.date_of_birth)return"unknown"===T;const t=(new Date).getFullYear()-new Date(e.date_of_birth).getFullYear();switch(T){case"child":return t<18;case"adult":return t>=18&&t<60;case"senior":return t>=60;default:return!0}})();return t&&s&&"all"===O})||[];return a?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Be,{className:"h-12 w-12 animate-pulse text-sky-600 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل تقارير المرضى..."})]})}):s?e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"تقارير المرضى"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"إحصائيات وتحليلات شاملة للمرضى"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{o(),await l("patients"),v({title:"تم التحديث بنجاح",description:"تم تحديث تقارير المرضى بأحدث البيانات"})}catch(e){console.error("Error refreshing patient reports:",e),v({title:"خطأ في التحديث",description:"فشل في تحديث التقارير. يرجى المحاولة مرة أخرى.",variant:"destructive"})}},disabled:a,children:[e.jsx(x,{className:"w-4 h-4 ml-2 "+(a?"animate-spin":"")}),a?"جاري التحديث...":"تحديث"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{if(_&&0!==_.length)try{await ze.exportPatientsToExcel(_),v({title:"تم التصدير بنجاح",description:`تم تصدير تقرير المرضى كملف Excel مع التنسيق الجميل (${_.length} مريض)`})}catch(e){console.error("Error exporting Excel:",e),v({title:"خطأ في التصدير",description:"فشل في تصدير التقرير. يرجى المحاولة مرة أخرى.",variant:"destructive"})}else v({title:"لا توجد بيانات",description:"لا توجد بيانات مرضى للتصدير",variant:"destructive"})},disabled:r,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير اكسل"]}),e.jsxs(F,{variant:"default",size:"sm",onClick:async()=>{try{if(!_||0===_.length)return void v({title:"لا توجد بيانات",description:"لا توجد بيانات مرضى للتصدير",variant:"destructive"});const e=_.length,t=new Date,s=new Date(t.getFullYear(),t.getMonth(),1),a=_.filter(e=>new Date(e.created_at)>=s).length,n={children:0,teens:0,adults:0,seniors:0},r={male:0,female:0};let l=0,i=0;_.forEach(e=>{if(e.age&&"number"==typeof e.age&&e.age>0){const t=e.age;l+=t,i++,t<13?n.children++:t<20?n.teens++:t<60?n.adults++:n.seniors++}"male"===e.gender?r.male++:"female"===e.gender&&r.female++});const c={totalPatients:e,newPatientsThisMonth:a,activePatients:e,averageAge:i>0?Math.round(l/i):0,patients:_,ageDistribution:[{ageGroup:"أطفال (0-12)",count:n.children},{ageGroup:"مراهقون (13-19)",count:n.teens},{ageGroup:"بالغون (20-59)",count:n.adults},{ageGroup:"كبار السن (60+)",count:n.seniors}],genderDistribution:[{gender:"ذكور",count:r.male},{gender:"إناث",count:r.female}],registrationTrend:[],filterInfo:"جميع المرضى المسجلين",dataCount:e};await Le.exportPatientReport(c,f),v({title:"تم التصدير بنجاح",description:`تم تصدير تقرير المرضى كملف PDF (${e} مريض)`})}catch(e){console.error("Error exporting PDF:",e),v({title:"خطأ في التصدير",description:"فشل في تصدير التقرير كملف PDF. يرجى المحاولة مرة أخرى.",variant:"destructive"})}},disabled:r,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),r?"جاري التصدير...":"تصدير PDF"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",dir:"rtl",children:[e.jsx(L,{title:"إجمالي المرضى",value:s?.totalPatients||0,icon:Be,color:"blue",description:"العدد الكلي للمرضى المسجلين"}),e.jsx(L,{title:"المرضى الجدد",value:s?.newPatients||0,icon:Dt,color:"green",description:"المرضى المسجلين حديثاً"}),e.jsx(L,{title:"المرضى النشطين",value:s?.activePatients||0,icon:K,color:"emerald",description:"المرضى الذين لديهم مواعيد حديثة"}),e.jsx(L,{title:"المرضى غير النشطين",value:s?.inactivePatients||0,icon:kt,color:"red",description:"المرضى بدون مواعيد حديثة"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"التوزيع العمري"})]}),e.jsxs(y,{children:["توزيع المرضى حسب الفئات العمرية (",s.totalPatients," مريض إجمالي)"]})]}),e.jsxs(b,{children:[(()=>{const t=ye(s.ageDistribution);W("categorical",N),W("primary",N);const a=H("demographics",N,t.length),n=G(N);return 0===t.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات توزيع عمري متاحة"})]})}):e.jsx(Ye,{width:"100%",height:n.responsive.desktop.height,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:t,cx:"50%",cy:"50%",labelLine:!1,label:({ageGroup:e,count:t,percent:s})=>t>0?`${e}: ${t} (${(100*s).toFixed(0)}%)`:"",outerRadius:120,innerRadius:50,fill:"#8884d8",dataKey:"count",stroke:N?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:t.map((t,s)=>e.jsx(He,{fill:a[s%a.length]},`age-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[`${e} مريض`,"العدد"],labelFormatter:e=>`الفئة العمرية: ${e}`,contentStyle:n.tooltip})]})})})(),(()=>{const t=ye(s.ageDistribution),a=H("demographics",N,t.length);return t.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-2 text-sm",children:t.map((t,n)=>e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:a[n%a.length]}}),e.jsxs("span",{className:"text-muted-foreground",children:[t.ageGroup,": ",t.count," (",Math.round(t.count/s.totalPatients*100),"%)"]})]},`age-legend-${n}`))})})()]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"التوزيع حسب الجنس"})]}),e.jsxs(y,{children:["توزيع المرضى حسب الجنس (",s.totalPatients," مريض إجمالي)"]})]}),e.jsxs(b,{children:[(()=>{const t=ve(s.genderDistribution),a=H("demographics",N,2),n=W("primary",N),r=G(N);return 0===t.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(rt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات توزيع جنس متاحة"})]})}):e.jsx(Ye,{width:"100%",height:r.responsive.desktop.height,children:e.jsxs(Ue,{data:t,margin:{top:20,right:30,left:20,bottom:20},barCategoryGap:r.bar.barCategoryGap,children:[e.jsx(Xe,{strokeDasharray:r.grid.strokeDasharray,stroke:r.grid.stroke,strokeOpacity:r.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"gender",tick:{fontSize:14,fill:N?"#9ca3af":"#6b7280"},axisLine:{stroke:N?"#4b5563":"#d1d5db"},tickLine:{stroke:N?"#4b5563":"#d1d5db"}}),e.jsx(Je,{tick:{fontSize:14,fill:N?"#9ca3af":"#6b7280"},axisLine:{stroke:N?"#4b5563":"#d1d5db"},tickLine:{stroke:N?"#4b5563":"#d1d5db"},domain:[0,"dataMax + 1"],allowDecimals:!1,tickFormatter:e=>`${Math.round(e)} مريض`}),e.jsx(Ge,{formatter:(e,t)=>[`${e} مريض`,"العدد"],labelFormatter:e=>`الجنس: ${e}`,contentStyle:r.tooltip}),e.jsx(Qe,{dataKey:"count",fill:n[1],radius:[4,4,0,0],minPointSize:5,maxBarSize:100,children:t.map((t,s)=>e.jsx(He,{fill:a[s%a.length]},`cell-${s}`))})]})})})(),(()=>{const t=ve(s.genderDistribution);return t.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-4 text-sm",children:t.map((t,a)=>e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:t.gender}),e.jsxs("div",{className:"font-semibold",children:[t.count," مريض (",Math.round(t.count/s.totalPatients*100),"%)"]})]},`gender-summary-${a}`))})})()]})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(lt,{className:"w-5 h-5"}),e.jsx("span",{children:"اتجاه التسجيل"})]}),e.jsxs(y,{children:["عدد المرضى المسجلين شهرياً (",s.registrationTrend?.length||0," فترة)"]})]}),e.jsxs(b,{children:[(()=>{const t=s.registrationTrend||[],a=W("primary",N);H("medical",N,1);const n=G(N);return 0===t.length?e.jsx("div",{className:"flex items-center justify-center h-96 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(lt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات اتجاه تسجيل متاحة"})]})}):e.jsx(Ye,{width:"100%",height:n.responsive.large.height,children:e.jsxs(et,{data:t,margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(Xe,{strokeDasharray:n.grid.strokeDasharray,stroke:n.grid.stroke,strokeOpacity:n.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"period",tick:{fontSize:12,fill:N?"#9ca3af":"#6b7280"},axisLine:{stroke:N?"#4b5563":"#d1d5db"},tickLine:{stroke:N?"#4b5563":"#d1d5db"},interval:0,angle:-45,textAnchor:"end",height:60}),e.jsx(Je,{tick:{fontSize:12,fill:N?"#9ca3af":"#6b7280"},axisLine:{stroke:N?"#4b5563":"#d1d5db"},tickLine:{stroke:N?"#4b5563":"#d1d5db"},domain:[0,"dataMax + 1"],tickFormatter:e=>`${e} مريض`}),e.jsx(Ge,{formatter:(e,t)=>[`${e} مريض`,"عدد المسجلين"],labelFormatter:e=>`الفترة: ${e}`,contentStyle:n.tooltip}),e.jsx(tt,{type:"monotone",dataKey:"count",stroke:a[0],fill:a[0],fillOpacity:.3,strokeWidth:3,connectNulls:!1})]})})})(),(()=>{const t=s.registrationTrend||[];return t.length>0&&e.jsxs("div",{className:"mt-4 grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أعلى فترة"}),e.jsxs("div",{className:"font-semibold",children:[Math.max(...t.map(e=>e.count))," مريض"]})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"متوسط شهري"}),e.jsxs("div",{className:"font-semibold",children:[Math.round(t.reduce((e,t)=>e+t.count,0)/t.length)," مريض"]})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"إجمالي المسجلين"}),e.jsxs("div",{className:"font-semibold",children:[t.reduce((e,t)=>e+t.count,0)," مريض"]})]})]})})()]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-5 h-5"}),e.jsx("span",{children:"قائمة المرضى"})]}),e.jsx(y,{children:"قائمة تفصيلية بجميع المرضى"})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",dir:"rtl",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(w,{htmlFor:"search",children:"البحث"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx($,{id:"search",placeholder:"البحث بالاسم، الهاتف، أو البريد الإلكتروني...",value:E,onChange:e=>M(e.target.value),className:"pl-10",dir:"rtl"})]})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"age-filter",children:"الفئة العمرية"}),e.jsxs(k,{value:T,onValueChange:R,children:[e.jsx(A,{className:"w-40",dir:"rtl",children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(P,{value:"all",children:"جميع الأعمار"}),e.jsx(P,{value:"child",children:"أطفال (أقل من 18)"}),e.jsx(P,{value:"adult",children:"بالغين (18-59)"}),e.jsx(P,{value:"senior",children:"كبار السن (60+)"}),e.jsx(P,{value:"unknown",children:"غير محدد"})]})]})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"status-filter",children:"الحالة"}),e.jsxs(k,{value:O,onValueChange:I,children:[e.jsx(A,{className:"w-32",dir:"rtl",children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(P,{value:"all",children:"الكل"}),e.jsx(P,{value:"active",children:"نشط"}),e.jsx(P,{value:"inactive",children:"غير نشط"})]})]})]})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden",dir:"rtl",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full table-center-all",dir:"rtl",children:[e.jsx("thead",{className:"bg-muted/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"#"}),e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"الاسم"}),e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"الهاتف"}),e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"البريد الإلكتروني"}),e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"تاريخ التسجيل"}),e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"العمر"}),e.jsx("th",{className:"text-center p-3 font-medium arabic-enhanced",children:"الحالة"})]})}),e.jsx("tbody",{children:z.map((t,s)=>e.jsxs("tr",{className:"hover:bg-muted/50 "+(s%2==0?"bg-background":"bg-muted/30"),children:[e.jsx("td",{className:"p-3 font-medium text-center",children:s+1}),e.jsx("td",{className:"p-3 font-medium text-center table-cell-wrap-truncate-md",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 bg-primary rounded-full flex items-center justify-center text-primary-foreground text-sm font-medium",children:t.full_name?t.full_name.charAt(0):(t.first_name||"").charAt(0)}),e.jsx("span",{className:"arabic-enhanced",children:t.full_name||`${t.first_name||""} ${t.last_name||""}`.trim()})]})}),e.jsx("td",{className:"p-3 text-muted-foreground text-center arabic-enhanced table-cell-wrap-truncate-sm",children:t.phone||"-"}),e.jsx("td",{className:"p-3 text-muted-foreground text-center arabic-enhanced table-cell-wrap-truncate-lg",children:t.email||"-"}),e.jsx("td",{className:"p-3 text-muted-foreground text-center arabic-enhanced",children:n(t.created_at)}),e.jsx("td",{className:"p-3 text-muted-foreground text-center arabic-enhanced",children:t.age||(t.date_of_birth?(new Date).getFullYear()-new Date(t.date_of_birth).getFullYear():"-")}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(m,{variant:"secondary",className:"arabic-enhanced",children:"نشط"})})]},t.id))})]})}),0===z.length&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Be,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:"لا توجد نتائج مطابقة للبحث"})]})]})]})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Be,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"لا توجد بيانات"}),e.jsx("p",{className:"text-muted-foreground",children:"لم يتم العثور على بيانات المرضى"})]})}function Lt(){const{currency:s,settings:a}=V(),{inventoryReports:r,isLoading:l,isExporting:i,generateReport:c,exportReport:d,clearCache:o}=fe(),{isDarkMode:h}=q(),{items:u,loadItems:f}=X(),[v,N]=t.useState(""),[_,E]=t.useState("all"),[M,R]=t.useState("all"),O=mt({data:u,dateField:"created_at",initialFilter:{preset:"all",startDate:"",endDate:""}});je("inventory"),t.useEffect(()=>{c("inventory"),f()},[c,f]);const I=W("categorical",h),L=W("primary",h),z=G(h),B=({title:t,value:s,icon:a,color:n,trend:r,description:l})=>e.jsx(p,{className:Se(n),dir:"rtl",children:e.jsxs(b,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground text-right",children:t}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse justify-end",children:[e.jsx("p",{className:"text-2xl font-bold text-foreground",children:s}),r&&e.jsxs("div",{className:"flex items-center text-sm "+(r.isPositive?"text-green-600":"text-red-600"),children:[e.jsxs("span",{className:"ml-1",children:[Math.abs(r.value),"%"]}),r.isPositive?e.jsx(lt,{className:"w-4 h-4"}):e.jsx(it,{className:"w-4 h-4"})]})]})]}),e.jsx("div",{className:`p-3 rounded-full ${Ee(n)}`,children:e.jsx(a,{className:"w-6 h-6"})})]}),l&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1 text-right",children:l})]})}),Y=r?.stockAlerts?.filter(e=>{const t=e.name.toLowerCase().includes(v.toLowerCase())||e.category?.toLowerCase().includes(v.toLowerCase()),s="all"===_||e.category===_,a="all"===M||(()=>{const t=new Date,s=e.expiry_date&&new Date(e.expiry_date)<t,a=e.expiry_date&&(()=>{const s=new Date(e.expiry_date),a=Math.ceil((s.getTime()-t.getTime())/864e5);return a<=30&&a>0})(),n=e.quantity<=e.minimum_stock&&e.quantity>0,r=0===e.quantity;switch(M){case"low_stock":return n;case"out_of_stock":return r;case"expired":return s;case"expiring_soon":return a;default:return!0}})();return t&&s&&a})||[];r?.expiryAlerts?.filter(e=>{const t=e.name.toLowerCase().includes(v.toLowerCase())||e.category?.toLowerCase().includes(v.toLowerCase()),s="all"===_||e.category===_;return t&&s});const K=Array.from(new Set([...r?.stockAlerts?.map(e=>e.category).filter(Boolean)||[],...r?.expiryAlerts?.map(e=>e.category).filter(Boolean)||[]]));return l?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ht,{className:"h-12 w-12 animate-pulse text-sky-600 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل تقارير المخزون..."})]})}):r?e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"تقارير المخزون"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"إحصائيات وتحليلات شاملة للمخزون والتنبيهات"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{await c("inventory");const e=new CustomEvent("showToast",{detail:{title:"تم التحديث بنجاح",description:"تم تحديث تقارير المخزون",type:"success"}});window.dispatchEvent(e)}catch(e){const t=new CustomEvent("showToast",{detail:{title:"خطأ في التحديث",description:"فشل في تحديث التقارير",type:"error"}});window.dispatchEvent(t)}},disabled:l,children:[e.jsx(x,{className:"w-4 h-4 ml-2 "+(l?"animate-spin":"")}),"تحديث"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{const e=O.filteredData;if(0!==e.length)try{const t=e.reduce((e,t)=>e+(t.unit_price||t.cost_per_unit||0)*t.quantity,0),s=e.filter(e=>e.quantity<=e.minimum_stock&&e.quantity>0).length,a=e.filter(e=>!!e.expiry_date&&new Date(e.expiry_date)<new Date).length,r=e.filter(e=>0===e.quantity).length,l={"نطاق البيانات":O.timeFilter.startDate&&O.timeFilter.endDate?`من ${O.timeFilter.startDate} إلى ${O.timeFilter.endDate}`:"جميع البيانات","إجمالي العناصر":e.length,"القيمة الإجمالية":t,"عناصر منخفضة المخزون":s,"عناصر منتهية الصلاحية":a,"عناصر نفدت من المخزون":r,"تاريخ التقرير":n(new Date)},i="\ufeff"+["المؤشر,القيمة",...Object.entries(l).map(([e,t])=>`"${e}","${t}"`)].join("\n");await ExportService.convertCSVToExcel(i,"inventory",{format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"}),ct.exportSuccess(`تم تصدير تقرير المخزون بنجاح! (${e.length} عنصر)`)}catch(t){console.error("Error exporting CSV:",t),ct.exportError("فشل في تصدير تقرير المخزون")}else ct.noDataToExport("لا توجد بيانات مخزون للتصدير")},disabled:i,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير اكسل"]}),e.jsxs(F,{variant:"default",size:"sm",onClick:async()=>{try{const e=O.filteredData;if(0===e.length)return void ct.noDataToExport("لا توجد بيانات مخزون للتصدير");const t={...r,totalItems:e.length,totalValue:e.reduce((e,t)=>e+(t.unit_price||t.cost_per_unit||0)*t.quantity,0),lowStockItems:e.filter(e=>e.quantity<=e.minimum_stock&&e.quantity>0).length,expiredItems:e.filter(e=>!!e.expiry_date&&new Date(e.expiry_date)<new Date).length,outOfStockItems:e.filter(e=>0===e.quantity).length,inventoryItems:e,filterInfo:O.timeFilter.startDate&&O.timeFilter.endDate?`البيانات من ${O.timeFilter.startDate} إلى ${O.timeFilter.endDate}`:"جميع البيانات",dataCount:e.length};await Le.exportInventoryReport(t,a),ct.exportSuccess(`تم تصدير تقرير المخزون كملف PDF بنجاح (${e.length} عنصر)`)}catch(e){console.error("Error exporting PDF:",e),ct.exportError("فشل في تصدير التقرير كملف PDF")}},disabled:i,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير PDF"]})]})]}),e.jsx(xt,{value:O.timeFilter,onChange:O.handleFilterChange,onClear:O.resetFilter,title:"فلترة زمنية - المخزون",defaultOpen:!1}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",dir:"rtl",children:[e.jsx(B,{title:"إجمالي العناصر",value:O.filteredData.length,icon:ht,color:"blue",description:"العدد الكلي لعناصر المخزون في الفترة المحددة",trend:O.trend}),e.jsx(B,{title:"القيمة الإجمالية",value:e.jsx(Pe,{amount:O.filteredData.reduce((e,t)=>e+t.unit_price*t.quantity,0),currency:s}),icon:lt,color:"green",description:"القيمة الإجمالية للمخزون في الفترة المحددة"}),e.jsx(B,{title:"مخزون منخفض",value:O.filteredData.filter(e=>e.quantity<=e.minimum_stock&&e.quantity>0).length,icon:T,color:"yellow",description:"عناصر تحتاج إعادة تموين"}),e.jsx(B,{title:"منتهية الصلاحية",value:O.filteredData.filter(e=>!!e.expiry_date&&new Date(e.expiry_date)<new Date).length,icon:Z,color:"red",description:"عناصر منتهية الصلاحية"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"التوزيع حسب الفئة"})]}),e.jsx(y,{children:"توزيع عناصر المخزون حسب الفئات"})]}),e.jsx(b,{children:e.jsx(Ye,{width:"100%",height:z.responsive.desktop.height,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:r.itemsByCategory.filter(e=>e.count>0),cx:"50%",cy:"50%",labelLine:!1,label:({category:e,count:t,percent:s})=>t>0?`${e}: ${t} (${(100*s).toFixed(0)}%)`:"",outerRadius:120,innerRadius:50,fill:"#8884d8",dataKey:"count",stroke:h?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,isAnimationActive:!1,animationDuration:0,children:r.itemsByCategory.filter(e=>e.count>0).map((t,s)=>e.jsx(He,{fill:I[s%I.length]},`cell-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[e,"عدد العناصر"],labelFormatter:e=>`الفئة: ${e}`,contentStyle:z.tooltip})]})})})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"التوزيع حسب المورد"})]}),e.jsx(y,{children:"توزيع عناصر المخزون حسب الموردين"})]}),e.jsx(b,{children:e.jsx(Ye,{width:"100%",height:z.responsive.desktop.height,children:e.jsxs(Ue,{data:r.itemsBySupplier.filter(e=>e.count>0).slice(0,8),margin:{top:20,right:30,left:20,bottom:20},barCategoryGap:"20%",children:[e.jsx(Xe,{strokeDasharray:z.grid.strokeDasharray,stroke:z.grid.stroke,strokeOpacity:z.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"supplier",tick:{fontSize:14,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"},tickLine:{stroke:h?"#4b5563":"#d1d5db"},interval:0}),e.jsx(Je,{tick:{fontSize:14,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"},tickLine:{stroke:h?"#4b5563":"#d1d5db"},domain:[0,"dataMax + 1"]}),e.jsx(Ge,{formatter:(e,t)=>[e,"عدد العناصر"],labelFormatter:e=>`المورد: ${e}`,contentStyle:z.tooltip}),e.jsx(Qe,{dataKey:"count",fill:L[1],radius:[4,4,0,0],minPointSize:5,maxBarSize:100,isAnimationActive:!1,animationDuration:0})]})})})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(lt,{className:"w-5 h-5"}),e.jsx("span",{children:"اتجاه الاستخدام"})]}),e.jsx(y,{children:"معدل استخدام المخزون شهرياً"})]}),e.jsx(b,{children:e.jsx(Ye,{width:"100%",height:z.responsive.desktop.height,children:e.jsxs(et,{data:r.usageTrend,margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(Xe,{strokeDasharray:z.grid.strokeDasharray,stroke:z.grid.stroke,strokeOpacity:z.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"period",tick:{fontSize:12,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"}}),e.jsx(Je,{tick:{fontSize:12,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"}}),e.jsx(Ge,{formatter:(e,t)=>[e,"معدل الاستخدام"],labelFormatter:e=>`الفترة: ${e}`,contentStyle:z.tooltip}),e.jsx(tt,{type:"monotone",dataKey:"usage",stroke:L[3],fill:L[3],fillOpacity:.3,strokeWidth:3,isAnimationActive:!1,animationDuration:0})]})})})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(T,{className:"w-5 h-5"}),e.jsx("span",{children:"تنبيهات المخزون"})]}),e.jsx(y,{children:"العناصر التي تحتاج انتباهك"})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(w,{htmlFor:"search",children:"البحث"}),e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx($,{id:"search",placeholder:"البحث بالاسم أو الفئة...",value:v,onChange:e=>N(e.target.value),className:"pr-10"})]})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"category-filter",children:"الفئة"}),e.jsxs(k,{value:_,onValueChange:E,children:[e.jsx(A,{className:"w-40",children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(P,{value:"all",children:"جميع الفئات"}),K.map(t=>e.jsx(P,{value:t,children:t},t))]})]})]}),e.jsxs("div",{children:[e.jsx(w,{htmlFor:"alert-filter",children:"نوع التنبيه"}),e.jsxs(k,{value:M,onValueChange:R,children:[e.jsx(A,{className:"w-40",children:e.jsx(C,{})}),e.jsxs(S,{children:[e.jsx(P,{value:"all",children:"جميع التنبيهات"}),e.jsx(P,{value:"low_stock",children:"مخزون منخفض"}),e.jsx(P,{value:"out_of_stock",children:"نفد المخزون"}),e.jsx(P,{value:"expired",children:"منتهي الصلاحية"}),e.jsx(P,{value:"expiring_soon",children:"ينتهي قريباً"})]})]})]})]}),e.jsxs("div",{className:"border rounded-lg overflow-hidden",dir:"rtl",children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full table-center-all",children:[e.jsx("thead",{className:"bg-muted",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-center p-3 font-medium",children:"#"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"اسم العنصر"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"الفئة"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"الكمية الحالية"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"الحد الأدنى"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"تاريخ الانتهاء"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"نوع التنبيه"}),e.jsx("th",{className:"text-center p-3 font-medium",children:"الإجراءات"})]})}),e.jsx("tbody",{children:Y.map((t,s)=>{const a=new Date,r=t.expiry_date&&new Date(t.expiry_date)<a,l=t.expiry_date&&(()=>{const e=new Date(t.expiry_date),s=Math.ceil((e.getTime()-a.getTime())/864e5);return s<=30&&s>0})(),i=t.quantity<=t.minimum_stock&&t.quantity>0;let c="",d="";return 0===t.quantity?(c="نفد المخزون",d="destructive"):r?(c="منتهي الصلاحية",d="destructive"):i?(c="مخزون منخفض",d="warning"):l&&(c="ينتهي قريباً",d="warning"),e.jsxs("tr",{className:s%2==0?"bg-background":"bg-muted/50",children:[e.jsx("td",{className:"p-3 font-medium text-center",children:s+1}),e.jsx("td",{className:"p-3 font-medium text-center table-cell-wrap-truncate-md",children:t.name}),e.jsx("td",{className:"p-3 text-muted-foreground text-center table-cell-wrap-truncate-sm",children:t.category||"-"}),e.jsxs("td",{className:"p-3 text-muted-foreground text-center",children:[t.quantity," ",t.unit||"قطعة"]}),e.jsxs("td",{className:"p-3 text-muted-foreground text-center",children:[t.minimum_stock," ",t.unit||"قطعة"]}),e.jsx("td",{className:"p-3 text-muted-foreground text-center",children:t.expiry_date?n(t.expiry_date):"-"}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(m,{variant:d,children:c})}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(F,{variant:"ghost",size:"sm",children:e.jsx(D,{className:"w-4 h-4"})})})]},t.id)})})]})}),0===Y.length&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ht,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground",children:0===r?.stockAlerts?.length?"لا توجد تنبيهات للمخزون - جميع العناصر في حالة جيدة":"لا توجد تنبيهات مطابقة للبحث"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["إجمالي التنبيهات: ",r?.stockAlerts?.length||0]})]})]})]})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ht,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-foreground mb-2",children:"لا توجد بيانات"}),e.jsx("p",{className:"text-muted-foreground",children:"لم يتم العثور على بيانات المخزون"}),e.jsxs(F,{onClick:()=>c("inventory"),className:"mt-4",variant:"outline",children:[e.jsx(x,{className:"w-4 h-4 ml-2"}),"إعادة تحميل"]})]})}function zt(){const{appointmentReports:s,isLoading:a,isExporting:n,generateReport:r,clearCache:l}=fe(),{appointments:i,loadAppointments:c}=J(),{settings:d}=V(),{isDarkMode:o}=q(),m=mt({data:i,dateField:"start_time",initialFilter:{preset:"all",startDate:"",endDate:""}});je("appointments"),t.useEffect(()=>{r("appointments"),c()},[r,c]);const h=(()=>{const e=m.filteredData.length>0?m.filteredData:i,t=e.length,s=e.filter(e=>"completed"===e.status).length,a=e.filter(e=>"cancelled"===e.status).length,n=e.filter(e=>"scheduled"===e.status).length,r=e.filter(e=>"no_show"===e.status).length,l=t>0?Math.round(s/t*1e3)/10:0,c=t>0?Math.round(a/t*1e3)/10:0;return{total:t,completed:s,cancelled:a,pending:n,noShow:r,attendanceRate:l.toFixed(1),cancellationRate:c.toFixed(1),appointmentsByStatus:[],appointmentTrend:[]}})();W("categorical",o);const u=W("primary",o),f=H("status",o,8),v=G(o),N=(()=>{try{const e=[{name:"مكتمل",value:h.completed,color:f[0]},{name:"مجدول",value:h.pending,color:f[4]},{name:"ملغي",value:h.cancelled,color:f[2]},{name:"لم يحضر",value:h.noShow,color:f[3]}].map(e=>({...e,percentage:h.total>0?Math.round(e.value/h.total*100):0}));return Ne(e)}catch(e){return console.error("Appointment Reports: Error processing status data:",e),[]}})(),w=(()=>{try{if(s?.appointmentTrend&&s.appointmentTrend.length>0)return s.appointmentTrend.map(e=>({month:e.period,count:e.count,formattedCount:`${e.count} موعد`}));be(i,"start_time")||console.warn("Appointment Reports: Invalid date data detected");const e=i.reduce((e,t)=>{try{if(!t||!t.start_time)return e;const s=new Date(t.start_time);if(isNaN(s.getTime())||s.getFullYear()<1900||s.getFullYear()>2100)return console.warn("Invalid appointment start_time:",t.start_time),e;const a=s.getMonth(),n=s.getFullYear(),r=`${["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"][a]} ${n}`;return e[r]=(e[r]||0)+1,e}catch(s){return console.warn("Error processing appointment date:",t.start_time,s),e}},{}),t=Object.entries(e).map(([e,t])=>({month:["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"].find(t=>e.includes(t))||e.split(" ")[0],fullMonth:e,count:t,formattedCount:`${t} موعد`})).sort((e,t)=>{const s=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"],a=s.findIndex(t=>e.fullMonth.includes(t)),n=s.findIndex(e=>t.fullMonth.includes(e));if(a!==n)return a-n;return(parseInt(e.fullMonth.split(" ")[1])||0)-(parseInt(t.fullMonth.split(" ")[1])||0)}).filter(e=>e.count>0);return we(t)?t:(console.warn("Appointment Reports: Invalid monthly chart data"),[])}catch(e){return console.error("Appointment Reports: Error processing monthly data:",e),[]}})();return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"تقارير المواعيد"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"إحصائيات وتحليلات شاملة للمواعيد"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{l(),await r("appointments"),await c();const e=new CustomEvent("showToast",{detail:{title:"تم التحديث بنجاح",description:"تم تحديث تقارير المواعيد",type:"success"}});window.dispatchEvent(e)}catch(e){console.error("Error refreshing appointment reports:",e);const t=new CustomEvent("showToast",{detail:{title:"خطأ في التحديث",description:"فشل في تحديث التقارير",type:"error"}});window.dispatchEvent(t)}},disabled:a,children:[e.jsx(x,{className:"w-4 h-4 ml-2 "+(a?"animate-spin":"")}),"تحديث"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{const e=m.filteredData.length>0?m.filteredData:i;if(0!==e.length)try{const t=m.timeFilter.startDate&&m.timeFilter.endDate?`من ${m.timeFilter.startDate} إلى ${m.timeFilter.endDate}`:"جميع البيانات",s={};e.forEach(e=>{const t=e.treatment_name||"غير محدد";s[t]=(s[t]||0)+1});const a=Object.entries(s).map(([e,t])=>({treatment:e,count:t})).sort((e,t)=>t.count-e.count),n={totalAppointments:h.total,completedAppointments:h.completed,cancelledAppointments:h.cancelled,scheduledAppointments:h.pending,noShowAppointments:h.noShow,attendanceRate:parseFloat(h.attendanceRate),cancellationRate:parseFloat(h.cancellationRate),appointmentsByStatus:N.map(e=>({status:e.name,count:e.value,percentage:h.total>0?e.value/h.total*100:0})),appointmentsByTreatment:a,appointmentsByDay:[],appointmentsByHour:[],peakHours:[],appointmentTrend:[],appointmentsList:e,filterInfo:t,dataCount:e.length},r="\ufeff"+ze.generateAppointmentCSV(n,{format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"});await ze.convertCSVToExcel(r,"appointments",{format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"}),ct.exportSuccess(`تم تصدير تقرير المواعيد بنجاح! (${e.length} موعد)`)}catch(t){console.error("Error exporting CSV:",t),ct.exportError("فشل في تصدير تقرير المواعيد")}else ct.noDataToExport("لا توجد بيانات مواعيد للتصدير")},disabled:n,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير اكسل"]}),e.jsxs(F,{variant:"default",size:"sm",onClick:async()=>{try{const e=m.filteredData.length>0?m.filteredData:i;if(0===e.length)return void ct.noDataToExport("لا توجد بيانات مواعيد للتصدير");const t={totalAppointments:h.total,completedAppointments:h.completed,cancelledAppointments:h.cancelled,noShowAppointments:h.noShow,attendanceRate:parseFloat(h.attendanceRate),cancellationRate:parseFloat(h.cancellationRate),appointmentsByStatus:N.map(e=>({status:e.name,count:e.value,percentage:h.total>0?e.value/h.total*100:0})),peakHours:[],monthlyTrend:w,filterInfo:m.timeFilter.startDate&&m.timeFilter.endDate?`البيانات من ${m.timeFilter.startDate} إلى ${m.timeFilter.endDate}`:"جميع البيانات",dataCount:e.length};await Le.exportAppointmentReport(t,d),ct.exportSuccess(`تم تصدير تقرير المواعيد كملف PDF بنجاح (${e.length} موعد)`)}catch(e){console.error("Error exporting PDF:",e),ct.exportError("فشل في تصدير التقرير كملف PDF")}},disabled:n,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير PDF"]})]})]}),e.jsx(xt,{value:m.timeFilter,onChange:m.handleFilterChange,onClear:m.resetFilter,title:"فلترة زمنية - المواعيد",defaultOpen:!1}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6",dir:"rtl",children:[e.jsxs(p,{className:Se("purple"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"إجمالي المواعيد"}),e.jsx(Z,{className:`h-4 w-4 ${Ee("purple")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:i.length}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"إجمالي المواعيد المسجلة"})]})]}),e.jsxs(p,{className:Se("blue"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"all"===m.timeFilter.preset||!m.timeFilter.startDate&&!m.timeFilter.endDate?"المواعيد الحالية":"المواعيد المفلترة"}),e.jsx(Be,{className:`h-4 w-4 ${Ee("blue")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:"all"===m.timeFilter.preset||!m.timeFilter.startDate&&!m.timeFilter.endDate?i.length:m.filteredData.length}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"all"===m.timeFilter.preset||!m.timeFilter.startDate&&!m.timeFilter.endDate?"جميع المواعيد":"المواعيد في الفترة المحددة"}),m.trend&&e.jsxs("div",{className:"text-xs flex items-center justify-end mt-1 "+(m.trend.isPositive?"text-green-600":"text-red-600"),children:[e.jsxs("span",{className:"ml-1",children:[Math.abs(m.trend.changePercent),"%"]}),m.trend.isPositive?e.jsx(lt,{className:"h-3 w-3"}):e.jsx(it,{className:"h-3 w-3"})]})]})]}),e.jsxs(p,{className:Se("emerald"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"المواعيد المكتملة"}),e.jsx(O,{className:`h-4 w-4 ${Ee("emerald")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:h.completed}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:["معدل الحضور: ",h.attendanceRate,"%"]})]})]}),e.jsxs(p,{className:Se("orange"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"المواعيد الملغية"}),e.jsx(dt,{className:`h-4 w-4 ${Ee("orange")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:h.cancelled}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:["معدل الإلغاء: ",h.cancellationRate,"%"]})]})]}),e.jsxs(p,{className:Se("cyan"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"المواعيد المجدولة"}),e.jsx(Q,{className:`h-4 w-4 ${Ee("cyan")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:h.pending}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"في انتظار التنفيذ"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع حالات المواعيد"})]}),e.jsxs(y,{children:["توزيع المواعيد حسب الحالة (",h.total," موعد إجمالي)"]})]}),e.jsxs(b,{children:[0===N.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات مواعيد متاحة"})]})}):e.jsx(Ye,{width:"100%",height:v.responsive.desktop.height,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:N,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,innerRadius:50,fill:"#8884d8",dataKey:"value",stroke:o?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:N.map((t,s)=>e.jsx(He,{fill:t.color},`appointment-status-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[`${e} موعد`,"العدد"],labelFormatter:e=>`الحالة: ${e}`,contentStyle:v.tooltip})]})}),N.length>0&&e.jsxs("div",{className:"mt-6 flex flex-col items-center space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground mb-2",children:"تفاصيل التوزيع"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-md",children:N.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-center space-x-2 space-x-reverse bg-muted/30 rounded-lg p-3",children:[e.jsx("div",{className:"w-4 h-4 rounded-full flex-shrink-0",style:{backgroundColor:t.color}}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-foreground",children:t.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[t.value," موعد (",t.percentage,"%)"]})]})]},`status-legend-${s}`))})]})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"المواعيد الشهرية"})]}),e.jsxs(y,{children:["عدد المواعيد حسب الشهر (",w.length," شهر)"]})]}),e.jsxs(b,{children:[0===w.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(rt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات مواعيد شهرية متاحة"})]})}):e.jsx(Ye,{width:"100%",height:v.responsive.desktop.height,children:e.jsxs(Ue,{data:w,margin:{top:20,right:30,left:20,bottom:70},barCategoryGap:v.bar.barCategoryGap,children:[e.jsx(Xe,{strokeDasharray:v.grid.strokeDasharray,stroke:v.grid.stroke,strokeOpacity:v.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"month",tick:{fontSize:12,fill:o?"#9ca3af":"#6b7280"},axisLine:{stroke:o?"#4b5563":"#d1d5db"},tickLine:{stroke:o?"#4b5563":"#d1d5db"},interval:0,angle:-45,textAnchor:"end",height:100,dy:15}),e.jsx(Je,{tick:{fontSize:14,fill:o?"#9ca3af":"#6b7280"},axisLine:{stroke:o?"#4b5563":"#d1d5db"},tickLine:{stroke:o?"#4b5563":"#d1d5db"},domain:[0,"dataMax + 1"],tickFormatter:e=>`${e} موعد`}),e.jsx(Ge,{formatter:(e,t)=>[`${e} موعد`,"العدد"],labelFormatter:e=>`الشهر: ${e}`,contentStyle:v.tooltip}),e.jsx(Qe,{dataKey:"count",fill:u[1],radius:[4,4,0,0],minPointSize:5,maxBarSize:100})]})}),w.length>0&&e.jsxs("div",{className:"mt-4 grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أعلى شهر"}),e.jsxs("div",{className:"font-semibold",children:[Math.max(...w.map(e=>e.count))," موعد"]})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"متوسط شهري"}),e.jsxs("div",{className:"font-semibold",children:[Math.round(w.reduce((e,t)=>e+t.count,0)/w.length)," موعد"]})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أقل شهر"}),e.jsxs("div",{className:"font-semibold",children:[Math.min(...w.map(e=>e.count))," موعد"]})]})]})]})]})]})]})}function Bt(e){const t=[],s=[];if(null==e)return t.push("Amount is null or undefined"),{isValid:!1,errors:t,warnings:s,sanitizedValue:0};const a=Number(e);if(isNaN(a))return t.push(`Invalid amount: ${e} cannot be converted to number`),{isValid:!1,errors:t,warnings:s,sanitizedValue:0};if(!isFinite(a))return t.push(`Amount is not finite: ${a}`),{isValid:!1,errors:t,warnings:s,sanitizedValue:0};a<0&&s.push(`Negative amount detected: ${a}`),a>1e6&&s.push(`Very large amount detected: ${a}`);return{isValid:!0,errors:t,warnings:s,sanitizedValue:Math.round(100*a)/100}}function Vt(e){if(!Array.isArray(e))return console.error("Payments is not an array:",e),{validPayments:[],invalidPayments:[],totalErrors:1,totalWarnings:0};const t=[],s=[];let a=0,n=0;return e.forEach((e,r)=>{const l=function(e){const t=[],s=[];if(!e)return t.push("Payment object is null or undefined"),{isValid:!1,errors:t,warnings:s};if(e.id||t.push("Payment ID is missing"),e.patient_id||t.push("Patient ID is missing"),e.payment_date){const s=new Date(e.payment_date);isNaN(s.getTime())&&t.push(`Invalid payment date: ${e.payment_date}`)}else t.push("Payment date is missing");e.payment_method||s.push("Payment method is missing"),e.status||s.push("Payment status is missing");const a=Bt(e.amount);return a.isValid||t.push(...a.errors),s.push(...a.warnings),{isValid:0===t.length,errors:t,warnings:s}}(e);if(a+=l.errors.length,n+=l.warnings.length,l.isValid){const s=Bt(e.amount);t.push({...e,amount:s.sanitizedValue||0})}else console.warn(`Invalid payment at index ${r}:`,l.errors),s.push({payment:e,errors:l.errors,warnings:l.warnings})}),{validPayments:t,invalidPayments:s,totalErrors:a,totalWarnings:n}}function qt(e){return Bt(e).sanitizedValue||0}function Yt(e){const t={},s=[];return e&&"object"==typeof e?(Object.entries(e).forEach(([e,a])=>{if(!e.match(/^\d{4}-\d{2}$/))return void s.push(`Invalid month format: ${e}`);const n=Bt(a);n.isValid?t[e]=n.sanitizedValue||0:s.push(`Invalid amount for month ${e}: ${a}`)}),{validData:t,errors:s}):(s.push("Monthly data is not a valid object"),{validData:t,errors:s})}function Kt(e){const t={},s=[];if(!e||"object"!=typeof e)return s.push("Payment method stats is not a valid object"),{validStats:t,errors:s};const a=["cash","card","bank_transfer","check","insurance"];return Object.entries(e).forEach(([e,n])=>{a.includes(e)||"unknown"===e||console.warn(`Unknown payment method: ${e}`);const r=Bt(n);r.isValid?t[e]=r.sanitizedValue||0:s.push(`Invalid amount for payment method ${e}: ${n}`)}),{validStats:t,errors:s}}class Wt{static validateAmount(e){if(null==e)return{isValid:!0,value:0};const t=Number(e);return isNaN(t)?{isValid:!1,value:0,error:`Invalid amount: ${e}`}:isFinite(t)?t<0?{isValid:!1,value:0,error:`Amount cannot be negative: ${e}`}:{isValid:!0,value:Math.round(100*t)/100}:{isValid:!1,value:0,error:`Amount is not finite: ${e}`}}static validatePayments(e){const t=[],s=[];let a=0,n=0,r=0,l=0,i=0;if(!Array.isArray(e))return t.push("Payments data is not an array"),{isValid:!1,errors:t,warnings:s,calculations:{totalRevenue:0,completedAmount:0,partialAmount:0,pendingAmount:0,overdueAmount:0}};e.forEach((e,c)=>{if(!e||"object"!=typeof e)return void t.push(`Payment at index ${c} is invalid`);const d=this.validateAmount(e.amount);if(!d.isValid)return void t.push(`Payment ${e.id||c}: ${d.error}`);const o=d.value;switch(e.status){case"completed":n+=o,a+=o;break;case"partial":const t=this.validateAmount(e.amount_paid||e.amount);t.isValid&&(r+=t.value,a+=t.value);break;case"pending":l+=o;break;case"overdue":i+=o;break;default:s.push(`Payment ${e.id||c}: Unknown status '${e.status}'`)}});const c=n+r;return Math.abs(a-c)>.01&&s.push(`Revenue calculation mismatch: ${a} vs ${c}`),{isValid:0===t.length,errors:t,warnings:s,calculations:{totalRevenue:Math.round(100*a)/100,completedAmount:Math.round(100*n)/100,partialAmount:Math.round(100*r)/100,pendingAmount:Math.round(100*l)/100,overdueAmount:Math.round(100*i)/100}}}static validateExpenses(e){const t=[],s=[];let a=0,n=0,r=0;const l={};return Array.isArray(e)?(e.forEach((e,s)=>{if(!e||"object"!=typeof e)return void t.push(`Expense at index ${s} is invalid`);const i=this.validateAmount(e.amount);if(!i.isValid)return void t.push(`Expense ${e.id||s}: ${i.error}`);const c=i.value;"paid"===e.status?(n+=c,a+=c):"pending"===e.status&&(r+=c);const d=e.expense_type||"other";l[d]=(l[d]||0)+c}),{isValid:0===t.length,errors:t,warnings:s,calculations:{totalExpenses:Math.round(100*a)/100,paidExpenses:Math.round(100*n)/100,pendingExpenses:Math.round(100*r)/100,expensesByType:l}}):(t.push("Expenses data is not an array"),{isValid:!1,errors:t,warnings:s,calculations:{totalExpenses:0,paidExpenses:0,pendingExpenses:0,expensesByType:{}}})}static validateInventory(e){const t=[],s=[];let a=0,n=0,r=0;if(!Array.isArray(e))return t.push("Inventory data is not an array"),{isValid:!1,errors:t,warnings:s,calculations:{totalValue:0,totalItems:0,lowStockItems:0,expiredItems:0}};const l=new Date;return e.forEach((e,i)=>{if(!e||"object"!=typeof e)return void t.push(`Inventory item at index ${i} is invalid`);const c=this.validateAmount(e.quantity),d=this.validateAmount(e.cost_per_unit||0);if(!c.isValid)return void t.push(`Item ${e.id||i}: Invalid quantity`);d.isValid||s.push(`Item ${e.id||i}: Invalid price`);const o=c.value,m=d.value;if(a+=o*m,o<=(e.minimum_stock||0)&&o>0&&n++,e.expiry_date){new Date(e.expiry_date)<l&&r++}}),{isValid:0===t.length,errors:t,warnings:s,calculations:{totalValue:Math.round(100*a)/100,totalItems:e.length,lowStockItems:n,expiredItems:r}}}static validateAllFinancialData(e){const t=[],s=[],a=this.validatePayments(e.payments);t.push(...a.errors),s.push(...a.warnings);let n={calculations:{totalExpenses:0}};e.expenses&&(n=this.validateExpenses(e.expenses),t.push(...n.errors),s.push(...n.warnings));let r={calculations:{totalValue:0}};e.inventory&&(r=this.validateInventory(e.inventory),t.push(...r.errors),s.push(...r.warnings)),e.labOrders&&e.labOrders.forEach((e,a)=>{const n=this.validateAmount(e.paid_amount||0),r=this.validateAmount(e.cost||0);n.isValid||t.push(`Lab order ${a+1}: Invalid paid amount - ${n.error}`),r.isValid||t.push(`Lab order ${a+1}: Invalid cost - ${r.error}`),n.value>r.value&&s.push(`Lab order ${a+1}: Paid amount (${n.value}) exceeds cost (${r.value})`)}),e.clinicNeeds&&e.clinicNeeds.forEach((e,a)=>{const n=this.validateAmount(e.quantity||0),r=this.validateAmount(e.price||0);n.isValid||t.push(`Clinic need ${a+1}: Invalid quantity - ${n.error}`),r.isValid||t.push(`Clinic need ${a+1}: Invalid price - ${r.error}`),n.value<=0&&s.push(`Clinic need ${a+1}: Zero or negative quantity`)});let l=n.calculations.totalExpenses;if(e.inventory){l+=e.inventory.reduce((e,t)=>e+this.validateAmount(t.cost_per_unit||0).value*this.validateAmount(t.quantity||0).value,0)}if(e.labOrders){l+=e.labOrders.reduce((e,t)=>e+this.validateAmount(t.paid_amount||0).value,0)}if(e.clinicNeeds){l+=e.clinicNeeds.filter(e=>"received"===e.status||"ordered"===e.status).reduce((e,t)=>e+this.validateAmount(t.quantity||0).value*this.validateAmount(t.price||0).value,0)}const i=a.calculations.totalRevenue,c=i-l,d=i>0?c/i*100:0;return i<0&&t.push("Total revenue cannot be negative"),l<0&&t.push("Total expenses cannot be negative"),{isValid:0===t.length,errors:t,warnings:s,calculations:{totalRevenue:Math.round(100*i)/100,totalExpenses:Math.round(100*l)/100,netProfit:Math.round(100*c)/100,profitMargin:Math.round(100*d)/100}}}}function Ht(){const{payments:s}=ee(),{expenses:a}=De(),{inventoryItems:n}=X(),{labOrders:r}=Ce(),{clinicNeeds:l}=ke(),{currentCurrency:i}=te(),[c,d]=t.useState(null),[o,h]=t.useState(!1),u=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},f=async()=>{h(!0);try{const e=Wt.validateAllFinancialData({payments:s,expenses:a,inventory:n,labOrders:r,clinicNeeds:l}),t=Tt.calculateFinancialStats(s,r,l,n,a),i=u(a.filter(e=>"paid"===e.status).reduce((e,t)=>e+u(t.amount),0)),c=Array.isArray(n)?n:[],o=u(c.reduce((e,t)=>e+u(t.cost_per_unit||0)*u(t.quantity||0),0)),m=Array.isArray(l)?l:[],x=u(m.filter(e=>"received"===e.status||"ordered"===e.status).reduce((e,t)=>e+u(t.quantity)*u(t.price),0)),h=Array.isArray(r)?r:[],p=i+o+x+u(h.reduce((e,t)=>e+u(t.paid_amount||0),0)),g=u(s.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>e+u(t.amount),0)),f=g-p,j=g>0?f/g*100:0,y={revenueMatch:Math.abs(g-t.totalRevenue)<.01,expensesMatch:Math.abs(p-t.totalExpenses)<.01,profitMatch:Math.abs(f-(t.netProfit||t.lossAmount))<.01},v=e.isValid&&y.revenueMatch&&y.expensesMatch&&y.profitMatch;d({isAccurate:v,totalRevenue:g,totalExpenses:p,netProfit:f,profitMargin:j,dataIntegrity:{paymentsValid:s.length>0,expensesValid:a.length>=0,inventoryValid:n.length>=0,labOrdersValid:r.length>=0,clinicNeedsValid:l.length>=0},errors:e.errors,warnings:e.warnings,lastVerified:new Date})}catch(e){console.error("Error during financial verification:",e),d({isAccurate:!1,totalRevenue:0,totalExpenses:0,netProfit:0,profitMargin:0,dataIntegrity:{paymentsValid:!1,expensesValid:!1,inventoryValid:!1,labOrdersValid:!1,clinicNeedsValid:!1},errors:[`Verification failed: ${e}`],warnings:[],lastVerified:new Date})}finally{h(!1)}};t.useEffect(()=>{f()},[s,a,n,r,l]);const v=t=>t?e.jsx(O,{className:"h-4 w-4 text-green-500"}):e.jsx(dt,{className:"h-4 w-4 text-red-500"});return e.jsxs(p,{className:"w-full",children:[e.jsx(g,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(ut,{className:"h-5 w-5"}),"التحقق من دقة النظام المالي"]}),e.jsx(y,{children:"فحص شامل لضمان دقة 100% في جميع الحسابات المالية"})]}),e.jsxs(F,{onClick:f,disabled:o,size:"sm",children:[o?e.jsx(x,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(x,{className:"h-4 w-4 mr-2"}),"فحص الآن"]})]})}),e.jsx(b,{className:"space-y-6",children:c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[v(c.isAccurate),e.jsxs("span",{className:"font-medium",children:["حالة النظام المالي: ",(N=c.isAccurate,e.jsx(m,{variant:N?"default":"destructive",children:N?"صحيح":"خطأ"}))]})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["آخر فحص: ",c.lastVerified.toLocaleString("ar-SA")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"إجمالي الإيرادات"}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:e.jsx(Pe,{amount:c.totalRevenue,currency:i})})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"إجمالي المصروفات"}),e.jsx("div",{className:"text-2xl font-bold text-red-600",children:e.jsx(Pe,{amount:c.totalExpenses,currency:i})})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"صافي الربح"}),e.jsx("div",{className:"text-2xl font-bold "+(c.netProfit>=0?"text-green-600":"text-red-600"),children:e.jsx(Pe,{amount:c.netProfit,currency:i})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:["هامش الربح: ",c.profitMargin.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"سلامة البيانات"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[v(c.dataIntegrity.paymentsValid),e.jsx("span",{className:"text-sm",children:"المدفوعات"})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[v(c.dataIntegrity.expensesValid),e.jsx("span",{className:"text-sm",children:"المصروفات"})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[v(c.dataIntegrity.inventoryValid),e.jsx("span",{className:"text-sm",children:"المخزون"})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[v(c.dataIntegrity.labOrdersValid),e.jsx("span",{className:"text-sm",children:"المختبر"})]}),e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[v(c.dataIntegrity.clinicNeedsValid),e.jsx("span",{className:"text-sm",children:"الاحتياجات"})]})]})]}),c.errors.length>0&&e.jsxs(M,{variant:"destructive",children:[e.jsx(dt,{className:"h-4 w-4"}),e.jsxs(R,{children:[e.jsx("div",{className:"font-medium mb-2",children:"أخطاء مكتشفة:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:c.errors.map((t,s)=>e.jsx("li",{className:"text-sm",children:t},s))})]})]}),c.warnings.length>0&&e.jsxs(M,{children:[e.jsx(T,{className:"h-4 w-4"}),e.jsxs(R,{children:[e.jsx("div",{className:"font-medium mb-2",children:"تحذيرات:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:c.warnings.map((t,s)=>e.jsx("li",{className:"text-sm",children:t},s))})]})]})]})})]});var N}const Gt=t.forwardRef(({className:t,value:s=0,max:a=100,...n},r)=>{const l=Math.min(Math.max(s/a*100,0),100);return e.jsx("div",{ref:r,className:se("relative h-2 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700",t),...n,children:e.jsx("div",{className:"h-full bg-blue-600 dark:bg-blue-500 transition-all duration-300 ease-in-out rounded-full",style:{width:`${l}%`}})})});function Ut(){const{payments:s}=ee(),{expenses:a}=De(),{inventoryItems:n}=X(),{labOrders:r}=Ce(),{clinicNeeds:l}=ke(),{currentCurrency:i}=te(),[c,d]=t.useState(null),[o,h]=t.useState(!1),u=async()=>{h(!0);try{const e=Date.now(),t=[],i=[],c=[];let o=100;const m=Array.isArray(s)?s:[],x=Array.isArray(a)?a:[],h=Array.isArray(n)?n:[],u=Array.isArray(r)?r:[],p=Array.isArray(l)?l:[];0===m.length&&(i.push("لا توجد مدفوعات في النظام"),o-=20),0===x.length&&(i.push("لا توجد مصروفات مسجلة"),o-=10);const g=Wt.validateAllFinancialData({payments:m,expenses:x,inventory:h,labOrders:u,clinicNeeds:p});let f=g.isValid?100:70;g.isValid||(t.push(...g.errors),f-=10*g.errors.length),g.warnings.length>0&&(i.push(...g.warnings),f-=5*g.warnings.length);const j=Tt.calculateFinancialStats(s,r,l,n,a),y=j.totalRevenue,v=j.totalExpenses,N=j.isProfit?j.netProfit:-j.lossAmount,b=j.profitMargin,w=Date.now()-e;let $=100;w>1e3&&($-=20,i.push("تحليل النظام يستغرق وقتاً أطول من المتوقع"));let F=100;const _=new Date(Date.now()-36e5),D=s.filter(e=>new Date(e.payment_date)>_);s.length>0&&0===D.length&&(F-=10,i.push("لا توجد مدفوعات حديثة في الساعة الماضية")),v>y&&c.push("المصروفات تتجاوز الإيرادات - يُنصح بمراجعة الميزانية"),b<10&&c.push("هامش الربح منخفض - يُنصح بتحسين الكفاءة التشغيلية"),0===n.length&&c.push("لا توجد عناصر في المخزون - يُنصح بإضافة المواد الأساسية");const k=Math.round((o+f+F+$)/4),A={overallHealth:Math.max(0,Math.min(100,k)),dataIntegrity:Math.max(0,Math.min(100,o)),calculationAccuracy:Math.max(0,Math.min(100,f)),realTimeSync:Math.max(0,Math.min(100,F)),performanceScore:Math.max(0,Math.min(100,$))};d({isHealthy:k>=80&&0===t.length,lastUpdated:new Date,metrics:A,issues:t,warnings:i,recommendations:c,financialSummary:{totalRevenue:y,totalExpenses:v,netProfit:N,profitMargin:b},dataStats:{paymentsCount:s.length,expensesCount:a.length,inventoryCount:n.length,labOrdersCount:r.length,clinicNeedsCount:l.length}})}catch(e){console.error("Error analyzing system health:",e),d({isHealthy:!1,lastUpdated:new Date,metrics:{overallHealth:0,dataIntegrity:0,calculationAccuracy:0,realTimeSync:0,performanceScore:0},issues:[`خطأ في تحليل النظام: ${e}`],warnings:[],recommendations:["يُنصح بإعادة تشغيل التطبيق"],financialSummary:{totalRevenue:0,totalExpenses:0,netProfit:0,profitMargin:0},dataStats:{paymentsCount:0,expensesCount:0,inventoryCount:0,labOrdersCount:0,clinicNeedsCount:0}})}finally{h(!1)}};t.useEffect(()=>{u()},[s,a,n,r,l]);const f=e=>e>=90?"text-green-600":e>=70?"text-yellow-600":"text-red-600";return e.jsxs(p,{className:"w-full",children:[e.jsx(g,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5"}),"حالة النظام المالي"]}),e.jsx(y,{children:"مراقبة شاملة لصحة وأداء النظام المالي في الوقت الفعلي"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c&&(v=c.isHealthy,e.jsx(m,{variant:v?"default":"destructive",children:v?"صحي":"يحتاج انتباه"})),e.jsxs(F,{onClick:u,disabled:o,size:"sm",variant:"outline",children:[o?e.jsx(x,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(x,{className:"h-4 w-4 mr-2"}),"تحديث"]})]})]})}),e.jsx(b,{className:"space-y-6",children:c&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-center p-6 border rounded-lg",children:[e.jsxs("div",{className:`text-4xl font-bold ${f(c.metrics.overallHealth)}`,children:[c.metrics.overallHealth,"%"]}),e.jsx("div",{className:"text-sm text-muted-foreground mt-1",children:"الصحة العامة للنظام"}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:["آخر تحديث: ",c.lastUpdated.toLocaleString("ar-SA")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"سلامة البيانات"}),e.jsxs("span",{className:f(c.metrics.dataIntegrity),children:[c.metrics.dataIntegrity,"%"]})]}),e.jsx(Gt,{value:c.metrics.dataIntegrity,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"دقة الحسابات"}),e.jsxs("span",{className:f(c.metrics.calculationAccuracy),children:[c.metrics.calculationAccuracy,"%"]})]}),e.jsx(Gt,{value:c.metrics.calculationAccuracy,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"التزامن الفوري"}),e.jsxs("span",{className:f(c.metrics.realTimeSync),children:[c.metrics.realTimeSync,"%"]})]}),e.jsx(Gt,{value:c.metrics.realTimeSync,className:"h-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"الأداء"}),e.jsxs("span",{className:f(c.metrics.performanceScore),children:[c.metrics.performanceScore,"%"]})]}),e.jsx(Gt,{value:c.metrics.performanceScore,className:"h-2"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ne,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"text-sm font-medium",children:"إجمالي الإيرادات"})]}),e.jsx("div",{className:"text-xl font-bold text-green-600",children:e.jsx(Pe,{amount:c.financialSummary.totalRevenue,currency:i})})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(_t,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium",children:"إجمالي المصروفات"})]}),e.jsx("div",{className:"text-xl font-bold text-red-600",children:e.jsx(Pe,{amount:c.financialSummary.totalExpenses,currency:i})})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.financialSummary.netProfit>=0?e.jsx(pt,{className:"h-4 w-4 text-green-600"}):e.jsx(_t,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium",children:"صافي الربح"})]}),e.jsx("div",{className:"text-xl font-bold "+(c.financialSummary.netProfit>=0?"text-green-600":"text-red-600"),children:e.jsx(Pe,{amount:c.financialSummary.netProfit,currency:i})})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[c.financialSummary.profitMargin>=0?e.jsx(lt,{className:"h-4 w-4 text-green-600"}):e.jsx(it,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm font-medium",children:"هامش الربح"})]}),e.jsxs("div",{className:"text-xl font-bold "+(c.financialSummary.profitMargin>=0?"text-green-600":"text-red-600"),children:[c.financialSummary.profitMargin.toFixed(1),"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"text-center p-3 border rounded",children:[e.jsx("div",{className:"text-2xl font-bold",children:c.dataStats.paymentsCount}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"مدفوعات"})]}),e.jsxs("div",{className:"text-center p-3 border rounded",children:[e.jsx("div",{className:"text-2xl font-bold",children:c.dataStats.expensesCount}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"مصروفات"})]}),e.jsxs("div",{className:"text-center p-3 border rounded",children:[e.jsx("div",{className:"text-2xl font-bold",children:c.dataStats.inventoryCount}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"مخزون"})]}),e.jsxs("div",{className:"text-center p-3 border rounded",children:[e.jsx("div",{className:"text-2xl font-bold",children:c.dataStats.labOrdersCount}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"مختبر"})]}),e.jsxs("div",{className:"text-center p-3 border rounded",children:[e.jsx("div",{className:"text-2xl font-bold",children:c.dataStats.clinicNeedsCount}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"احتياجات"})]})]}),c.issues.length>0&&e.jsxs(M,{variant:"destructive",children:[e.jsx(dt,{className:"h-4 w-4"}),e.jsxs(R,{children:[e.jsx("div",{className:"font-medium mb-2",children:"مشاكل تحتاج إصلاح:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:c.issues.map((t,s)=>e.jsx("li",{className:"text-sm",children:t},s))})]})]}),c.warnings.length>0&&e.jsxs(M,{children:[e.jsx(T,{className:"h-4 w-4"}),e.jsxs(R,{children:[e.jsx("div",{className:"font-medium mb-2",children:"تحذيرات:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:c.warnings.map((t,s)=>e.jsx("li",{className:"text-sm",children:t},s))})]})]}),c.recommendations.length>0&&e.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-950/50 border border-blue-200 dark:border-blue-700 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(gt,{className:"h-4 w-4 text-blue-600"}),e.jsx("span",{className:"font-medium text-blue-800 dark:text-blue-200",children:"توصيات للتحسين:"})]}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-blue-700 dark:text-blue-300",children:c.recommendations.map((t,s)=>e.jsx("li",{children:t},s))})]})]})})]});var v}Gt.displayName="Progress";const Xt=t.memo(function(){const{financialReports:s,isLoading:a,isExporting:l,generateReport:i,clearCache:c}=fe(),{payments:d,totalRevenue:o,pendingAmount:m,overdueAmount:h,paymentMethodStats:u,monthlyRevenue:f,loadPayments:v}=ee(),{expenses:N,analytics:w,loadExpenses:$}=De(),{inventoryItems:_,loadItems:D}=X(),{labOrders:k,loadLabOrders:A}=Ce(),{clinicNeeds:C,loadNeeds:S}=ke(),{currentCurrency:E,formatAmount:P}=te(),{settings:M}=V(),{isDarkMode:T}=q(),R=mt({data:d,dateField:"payment_date",initialFilter:{preset:"all",startDate:"",endDate:""}}),O=mt({data:N,dateField:"payment_date",initialFilter:R.timeFilter});je("financial"),t.useEffect(()=>{i("financial"),v(),$(),D(),A(),S()},[i,v,$,D,A,S]),t.useEffect(()=>{const e=Array.isArray(d)?d:[],t=Array.isArray(N)?N:[],s=Array.isArray(_)?_:[];if(e.length>0||t.length>0||s.length>0)try{(function(e){const t=Wt.validateAllFinancialData(e);return t.isValid?(t.warnings.length>0&&console.warn("⚠️ Financial validation warnings:",t.warnings),console.log("✅ Financial validation passed with 100% accuracy"),!0):(console.error("❌ Financial validation failed:",t.errors),!1)})({payments:e,expenses:t,inventory:s})||console.warn("⚠️ Financial data validation issues detected. Please check the data integrity.")}catch(a){console.error("Error validating financial data:",a)}},[d,N,_]),t.useEffect(()=>{const e=Array.isArray(d)?d:[];if(e.length>0)try{const t=Vt(e);t.totalErrors>0&&console.warn(`Found ${t.totalErrors} errors in ${t.invalidPayments.length} payments`),t.totalWarnings>0&&console.warn(`Found ${t.totalWarnings} warnings in payment data`)}catch(t){console.error("Error validating payments:",t)}},[d]);const I=(()=>{const e=R||{filteredData:[],timeFilter:{preset:"all"}},t=Array.isArray(d)?d:[],a=Vt(Array.isArray(e.filteredData)&&e.filteredData.length>0?e.filteredData:t).validPayments;if(s&&"all"===e.timeFilter.preset&&(!e.timeFilter.startDate||!e.timeFilter.endDate))return{totalRevenue:qt(s.totalRevenue),totalPaid:qt(s.totalPaid),totalPending:qt(s.totalPending),totalOverdue:qt(s.totalOverdue),revenueByPaymentMethod:s.revenueByPaymentMethod||{},revenueTrend:s.revenueTrend||[],recentTransactions:s.recentTransactions||[],outstandingPayments:s.outstandingPayments||[]};const n=a.filter(e=>"completed"===e.status),r=a.filter(e=>"pending"===e.status),l=a.filter(e=>"failed"===e.status),i=a.filter(e=>"refunded"===e.status),c=n.reduce((e,t)=>e+(t.amount||0),0),o=r.reduce((e,t)=>e+(t.amount||0),0),m=a.filter(e=>"overdue"===e.status).reduce((e,t)=>e+(t.amount||0),0);Yt(f||{});const x=Kt(u||{}),h=a.length,p=h>0?Math.round(n.length/h*1e3)/10:0,g=n.length>0&&c>0?Math.round(c/n.length*100)/100:0;return{totalRevenue:qt(c),totalPaid:qt(c),totalPending:qt(o),totalOverdue:qt(m),revenueByPaymentMethod:x.validStats,revenueTrend:[],recentTransactions:[],outstandingPayments:[],totalTransactions:h,completedCount:n.length,pendingCount:r.length,failedCount:l.length,refundedCount:i.length,successRate:isNaN(p)?"0.0":p.toFixed(1),averageTransaction:isNaN(g)?"0.00":g.toFixed(2),validatedPayments:a}})();I.totalTransactions||(d||[]).length,I.completedCount||(d||[]).filter(e=>"completed"===e.status).length,I.pendingCount||(d||[]).filter(e=>"pending"===e.status).length,I.failedCount||(d||[]).filter(e=>"failed"===e.status).length,I.refundedCount||(d||[]).filter(e=>"refunded"===e.status).length,I.successRate,I.averageTransaction;const L=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},z=O||{filteredData:[]},B=Array.isArray(N)?N:[],Y=Array.isArray(z.filteredData)&&z.filteredData.length>0?z.filteredData:B,K=Wt.validateExpenses(Y),U=K.calculations.totalExpenses,Z=L((_||[]).reduce((e,t)=>e+L(t.cost_per_unit||0)*L(t.quantity||0),0)),J=L((C||[]).filter(e=>"received"===e.status||"ordered"===e.status).reduce((e,t)=>e+L(t.quantity)*L(t.price),0)),se=L((k||[]).reduce((e,t)=>e+L(t.paid_amount||0),0)),ae=U+Z+J+se;!K.isValid&&Y.length;const ie=Wt.validateAmount(I.totalRevenue-ae).value,ce=I.totalRevenue>0?ie/I.totalRevenue*100:0,de=Wt.validateAllFinancialData({payments:d||[],expenses:Y||[],inventory:_||[],labOrders:k||[],clinicNeeds:C||[]});de.isValid,de.warnings.length;const oe=Tt.calculateFinancialStats(d,k,C,_,Y);Math.abs(I.totalRevenue-oe.totalRevenue),Math.abs(ae-oe.totalExpenses),Math.abs(ie-oe.netProfit),t.useEffect(()=>{const e=R||{timeFilter:{preset:"all"}},t=O||{timeFilter:{preset:"all"},handleFilterChange:()=>{}};e.timeFilter!==t.timeFilter&&t.handleFilterChange&&t.handleFilterChange(e.timeFilter)},[R?.timeFilter,O?.timeFilter]),t.useEffect(()=>{const e=e=>{v(),$(),D(),A(),S()},t=["payments-changed","clinic-expenses-changed","inventory-changed","lab-orders-changed","clinic-needs-changed"];return t.forEach(t=>{window.addEventListener(t,e)}),()=>{t.forEach(t=>{window.removeEventListener(t,e)})}},[v,$,D,A,S]);const me=(()=>{const e={salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"},t={};return Y.filter(e=>"paid"===e.status).forEach(e=>{const s=e.expense_type||"other",a=L(e.amount);t[s]=(t[s]||0)+a}),Object.entries(t).map(([t,s])=>({name:e[t]||t,value:s,percentage:ae>0?s/ae*100:0}))})();W("categorical",T);const xe=W("primary",T),he=H("financial",T,8),ue=H("status",T,8),pe=G(T),ge=(()=>{try{const e={cash:"نقداً",card:"بطاقة ائتمان",bank_transfer:"تحويل بنكي",check:"شيك",insurance:"تأمين"},t=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},s=d||[],a=R?.filteredData?.length>0?R.filteredData:s;if(0===a.length)return[];const n={};a.filter(e=>"completed"===e.status||"partial"===e.status).forEach(e=>{const s=e.payment_method||"cash",a=t(e.amount);console.log(`Payment method calculation - Payment ${e.id}: Method=${s}, Amount=${a}, Status=${e.status}`),a>0&&(n[s]=(n[s]||0)+a)}),console.log("Payment method calculated stats:",n);const l=Object.entries(n).filter(([e,t])=>t>0).map(([s,n])=>({method:e[s]||s,amount:t(n),formattedAmount:r(n,E),count:a.filter(e=>e.payment_method===s&&("completed"===e.status||"partial"===e.status)).length})).sort((e,t)=>t.amount-e.amount);return console.log("Payment method final data:",l),console.log("Payment method total:",l.reduce((e,t)=>e+t.amount,0)),$e(l)}catch(e){return console.error("Financial Reports: Error processing payment method data:",e),[]}})(),ye=(()=>{try{const e=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},t=d||[],s=R?.filteredData?.length>0?R.filteredData:t;if(0===s.length)return[];console.log("Processing monthly revenue for",s.length,"payments"),console.log("Sample payments:",s.slice(0,3)),console.log("All payment amounts:",s.map(e=>({id:e.id,amount:e.amount,status:e.status,date:e.payment_date})));const a={};s.filter(e=>"completed"===e.status||"partial"===e.status).forEach(t=>{try{const s=new Date(t.payment_date||t.created_at||t.date);if(isNaN(s.getTime()))return void console.warn("Invalid payment date for payment:",t.id,t.payment_date);const n=s.toISOString().slice(0,7),r=e(t.amount);console.log(`Payment ${t.id}: Date=${t.payment_date}, Month=${n}, Amount=${r}, Status=${t.status}`),r>0&&(a[n]=(a[n]||0)+r,console.log(`Added ${r} to month ${n}, total now: ${a[n]}`))}catch(s){console.warn("Error processing payment date:",t.payment_date,s)}}),console.log("Calculated monthly revenue:",a);const n=Object.entries(a);if(1===n.length){const[e,t]=n[0],s=new Date(e+"-01"),r=new Date(s);r.setMonth(r.getMonth()-1);const l=r.toISOString().slice(0,7);a[l]=0;const i=new Date(s);i.setMonth(i.getMonth()+1);const c=i.toISOString().slice(0,7);a[c]=0}const l=Object.entries(a).filter(([e,t])=>e.match(/^\d{4}-\d{2}$/)).map(([t,s])=>{const a=new Date(t+"-01");return{month:`${["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"][a.getMonth()]} ${a.getFullYear()}`,revenue:e(s),formattedRevenue:r(e(s),E),originalMonth:t}}).sort((e,t)=>e.originalMonth.localeCompare(t.originalMonth)).map(({originalMonth:e,...t})=>t);return console.log("Final monthly revenue data:",l),l}catch(e){return console.error("Financial Reports: Error processing monthly revenue data:",e),[]}})(),ve=(()=>{try{const e=d||[],t=R?.filteredData?.length>0?R.filteredData:e;if(0===t.length)return[];const s=t.filter(e=>"completed"===e.status).length,a=t.filter(e=>"partial"===e.status).length,n=t.filter(e=>"pending"===e.status).length,r=t.filter(e=>"failed"===e.status).length,l=t.filter(e=>"refunded"===e.status).length,i=t.length,c=[{name:"مكتمل",value:s,color:ue[0]||"#10b981"},{name:"جزئي",value:a,color:ue[1]||"#f59e0b"},{name:"آجل",value:n,color:ue[2]||"#6b7280"},{name:"فاشل",value:r,color:ue[3]||"#ef4444"},{name:"مسترد",value:l,color:ue[4]||"#8b5cf6"}].filter(e=>e.value>0).map(e=>({...e,percentage:i>0?Math.round(e.value/i*100):0}));return Fe(c)}catch(e){return console.error("Financial Reports: Error processing status data:",e),[]}})();return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"التقارير المالية"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"إحصائيات وتحليلات شاملة للمدفوعات والإيرادات"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:"البيانات محدثة في الوقت الفعلي"})]}),R.filteredData.length>0&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["• ",R.filteredData.length," معاملة",R.timeFilter.startDate&&R.timeFilter.endDate&&" (مفلترة)"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{c(),await i("financial"),await v();const e=new CustomEvent("showToast",{detail:{title:"تم التحديث بنجاح",description:"تم تحديث التقارير المالية",type:"success"}});window.dispatchEvent(e)}catch(e){console.error("Error refreshing financial reports:",e);const t=new CustomEvent("showToast",{detail:{title:"خطأ في التحديث",description:"فشل في تحديث التقارير",type:"error"}});window.dispatchEvent(t)}},disabled:a,children:[e.jsx(x,{className:"w-4 h-4 ml-2 "+(a?"animate-spin":"")}),"تحديث"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{const e=R.filteredData.length>0?R.filteredData:d;if(0===e.length)return void ct.noDataToExport("لا توجد بيانات مالية للتصدير");const t=await async function(e,t,s){const a=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},l=Tt.calculateFinancialStats(e,[],[],[],s);let i="\ufeff";i+="التقرير المالي الشامل\n",i+="===================\n\n",i+="معلومات التقرير\n",i+="================\n",i+=`تاريخ التقرير,${n((new Date).toISOString())}\n`,i+=`وقت التقرير,${(new Date).toLocaleTimeString("ar-SA")}\n`,t.startDate&&t.endDate?i+=`الفترة الزمنية,من ${t.startDate} إلى ${t.endDate}\n`:i+="الفترة الزمنية,جميع البيانات\n",i+=`عدد المعاملات,${e.length}\n\n`,i+="الإحصائيات المالية الرئيسية\n",i+="============================\n",i+=`إجمالي الإيرادات,${r(l.totalRevenue)}\n`,i+=`المدفوعات المكتملة,${r(l.completedPayments)}\n`,i+=`المدفوعات الجزئية,${r(l.partialPayments)}\n`,i+=`المبالغ المتبقية,${r(l.remainingBalances)}\n`,i+=`المبالغ الآجلة,${r(l.pendingAmount)}\n`,i+=`إجمالي المصروفات,${r(l.totalExpenses||0)}\n`,i+=`صافي الربح,${r(l.netProfit||0)}\n`,i+=`هامش الربح,${(l.profitMargin||0).toFixed(2)}%\n`,i+=`حالة الربحية,${(l.netProfit||0)>=0?"ربح":"خسارة"}\n\n`,i+="تحليل الأرباح والخسائر\n",i+="====================\n",i+=`صافي الربح,${r(l.netProfit||0)}\n`,i+=`مبلغ الخسارة,${r(l.lossAmount||0)}\n`,i+=`هامش الربح,${(l.profitMargin||0).toFixed(2)}%\n`,i+=`حالة الأرباح,${l.isProfit?"ربح":"خسارة"}\n`,i+=`إجمالي المصروفات,${r(l.totalExpenses||0)}\n\n`,i+="تفصيل المصروفات\n",i+="================\n",i+=`مصروفات المخابر,${r(l.labOrdersTotal||0)}\n`,i+=`متبقي المخابر,${r(l.labOrdersRemaining||0)}\n`,i+=`مصروفات الاحتياجات,${r(l.clinicNeedsTotal||0)}\n`,i+=`متبقي الاحتياجات,${r(l.clinicNeedsRemaining||0)}\n`,i+=`مصروفات المخزون,${r(l.inventoryExpenses||0)}\n\n`,i+="إحصائيات المعاملات\n",i+="==================\n",i+=`إجمالي المعاملات,${l.totalTransactions}\n`,i+=`المعاملات المكتملة,${l.completedTransactions}\n`,i+=`المعاملات الجزئية,${JSON.stringify(l.partialTransactions)}\n`,i+=`المعاملات الآجلة,${l.pendingTransactions}\n\n`,i+="تحليل طرق الدفع\n",i+="================\n";const c={};if(e.forEach(e=>{const t=e.payment_method||"غير محدد",s="cash"===t?"نقدي":"card"===t?"بطاقة ائتمان":"bank_transfer"===t?"تحويل بنكي":"check"===t?"شيك":"insurance"===t?"تأمين":t;let n=0;"completed"===e.status?n=a(e.amount):"partial"===e.status&&void 0!==e.amount_paid&&(n=a(e.amount_paid)),n>0&&(c[s]=(c[s]||0)+n)}),Object.entries(c).forEach(([e,t])=>{const s=l.totalRevenue>0?(t/l.totalRevenue*100).toFixed(2):"0.00";i+=`${e},${r(t)} (${s}%)\n`}),i+="\n",l.expensesByType&&l.expensesByType.length>0&&(i+="توزيع المصروفات حسب النوع\n",i+="==========================\n",i+="نوع المصروف,المبلغ,النسبة المئوية\n",l.expensesByType.forEach(e=>{i+=`"${e.type}",${r(e.amount)},${e.percentage.toFixed(2)}%\n`}),i+="\n"),s&&s.length>0){const e=s.filter(e=>"paid"===e.status).sort((e,t)=>new Date(t.payment_date).getTime()-new Date(e.payment_date).getTime()).slice(0,20);if(e.length>0){i+="المصروفات الحديثة (آخر 20 مصروف)\n",i+="===================================\n",i+="اسم المصروف,النوع,المبلغ,طريقة الدفع,تاريخ الدفع,المورد,رقم الإيصال,ملاحظات\n";const t={salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"},s={cash:"نقداً",bank_transfer:"تحويل بنكي",check:"شيك",credit_card:"بطاقة ائتمان"};e.forEach(e=>{const a=(e.expense_name||"غير محدد").replace(/,/g,"؛"),l=t[e.expense_type]||e.expense_type||"غير محدد",c=r(e.amount||0),d=s[e.payment_method]||e.payment_method||"غير محدد",o=e.payment_date?n(e.payment_date):"غير محدد",m=(e.vendor||"غير محدد").replace(/,/g,"؛"),x=e.receipt_number||"غير محدد",h=(e.notes||"").replace(/,/g,"؛");i+=`"${a}","${l}",${c},"${d}",${o},"${m}","${x}","${h}"\n`}),i+="\n"}}return e.length<=100&&(i+="تفاصيل المدفوعات الفردية\n",i+="=========================\n",i+="رقم الإيصال,المريض,المبلغ,المبلغ المدفوع,طريقة الدفع,الحالة,تاريخ الدفع,الوصف,ملاحظات\n",e.forEach(e=>{const t=e.receipt_number||`#${e.id?.slice(-6)||"N/A"}`,s=e.patient?.full_name||e.patient_name||"غير محدد",a=r(e.amount||0),l=e.amount_paid?r(e.amount_paid):a,c="cash"===e.payment_method?"نقدي":"card"===e.payment_method?"بطاقة ائتمان":"bank_transfer"===e.payment_method?"تحويل بنكي":"check"===e.payment_method?"شيك":"insurance"===e.payment_method?"تأمين":e.payment_method||"غير محدد",d="completed"===e.status?"مكتمل":"partial"===e.status?"جزئي":"pending"===e.status?"آجل":"failed"===e.status?"فاشل":"refunded"===e.status?"مسترد":e.status||"غير محدد",o=e.payment_date?n(e.payment_date):"غير محدد",m=(e.description||"").replace(/,/g,"؛"),x=(e.notes||"").replace(/,/g,"؛");i+=`"${t}","${s}",${a},${l},"${c}","${d}",${o},"${m}","${x}"\n`})),i}(e,R.timeFilter,Y);await ze.convertCSVToExcel(t,"comprehensive-financial",{format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"}),ct.exportSuccess(`تم تصدير التقرير المالي الشامل بنجاح! (${e.length} معاملة)`)}catch(e){console.error("Error exporting comprehensive financial CSV:",e),ct.exportError("فشل في تصدير التقرير المالي الشامل")}},disabled:l,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير Excel شامل"]}),e.jsxs(F,{variant:"default",size:"sm",onClick:async()=>{try{const e=R.filteredData.length>0?R.filteredData:d;if(0===e.length)return void ct.noDataToExport("لا توجد بيانات مالية للتصدير");const t=await async function(e,t,s,a,n,r){const l=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},i=Tt.calculateFinancialStats(e,s,a,n,r),c=r?r.filter(e=>"paid"===e.status).reduce((e,t)=>e+l(t.amount),0):0,d=r?(()=>{const e={salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"},t={};return r.filter(e=>"paid"===e.status).forEach(e=>{const s=e.expense_type||"other",a=l(e.amount);t[s]=(t[s]||0)+a}),Object.entries(t).map(([t,s])=>({type:e[t]||t,amount:l(s),percentage:c>0?l(s)/c*100:0}))})():[],o=(i.totalExpenses||0)+c,m=i.totalRevenue-o,x=i.totalRevenue>0?m/i.totalRevenue*100:0,h={};return e.forEach(e=>{const t=e.payment_method||"unknown",s=l(e.amount);s>0&&("completed"===e.status||"partial"===e.status)&&(h[t]=(h[t]||0)+s)}),console.log("Payment method stats calculation:",{paymentsLength:e.length,paymentMethodStats:h}),{totalRevenue:i.totalRevenue,totalPaid:i.completedPayments+i.partialPayments,totalPending:i.pendingAmount,totalOverdue:i.remainingBalances,completedPayments:e.filter(e=>"completed"===e.status).length,partialPayments:e.filter(e=>"partial"===e.status).length,pendingPayments:e.filter(e=>"pending"===e.status).length,failedPayments:e.filter(e=>"failed"===e.status).length,netProfit:m,lossAmount:m<0?Math.abs(m):0,profitMargin:x,isProfit:m>=0,totalExpenses:o,labOrdersTotal:i.labOrdersTotal||0,labOrdersRemaining:i.labOrdersRemaining||0,clinicNeedsTotal:i.clinicNeedsTotal||0,clinicNeedsRemaining:i.clinicNeedsRemaining||0,inventoryExpenses:i.inventoryExpenses||0,clinicExpensesTotal:c,expensesByType:d,revenueByPaymentMethod:Object.entries(h).map(([e,t])=>({method:"cash"===e?"نقدي":"card"===e?"بطاقة ائتمان":"bank_transfer"===e?"تحويل بنكي":"check"===e?"شيك":"insurance"===e?"تأمين":e,amount:l(t),percentage:i.totalRevenue>0?l(t)/i.totalRevenue*100:0})),filterInfo:t.startDate&&t.endDate?`البيانات المفلترة من ${t.startDate} إلى ${t.endDate}`:"جميع البيانات المالية",dataCount:e.length,totalTransactions:e.length,successRate:e.length>0?(e.filter(e=>"completed"===e.status||"partial"===e.status).length/e.length*100).toFixed(1):"0.0",averageTransaction:e.length>0?(i.totalRevenue/e.length).toFixed(2):"0.00",payments:e.map(e=>({id:e.id,receipt_number:e.receipt_number||`#${e.id?.slice(-6)||"N/A"}`,patient_name:e.patient?.full_name||e.patient_name||"غير محدد",amount:e.amount,amount_paid:e.amount_paid,payment_method:e.payment_method,status:e.status,payment_date:e.payment_date,description:e.description,notes:e.notes})),expenses:r?r.filter(e=>"paid"===e.status).map(e=>({id:e.id,expense_name:e.expense_name,amount:e.amount,expense_type:e.expense_type,category:e.category,payment_method:e.payment_method,payment_date:e.payment_date,description:e.description,vendor:e.vendor,receipt_number:e.receipt_number,notes:e.notes})):[]}}(e,R.timeFilter,k,C,_,Y);await Le.exportComprehensiveFinancialReport(t,M);let s=`تم تصدير التقرير المالي الشامل كملف PDF بنجاح! (${e.length} معاملة)`;R.timeFilter.startDate&&R.timeFilter.endDate&&(s+=` - مفلتر من ${R.timeFilter.startDate} إلى ${R.timeFilter.endDate}`),s+=` - إجمالي الإيرادات: $${t.totalRevenue.toFixed(2)}`,ct.exportSuccess(s)}catch(e){console.error("Error exporting comprehensive financial PDF:",e),ct.exportError("فشل في تصدير التقرير المالي الشامل كملف PDF")}},disabled:l,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير PDF شامل"]})]})]}),e.jsx(xt,{value:R.timeFilter,onChange:R.handleFilterChange,onClear:R.resetFilter,title:"فلترة زمنية - المدفوعات",defaultOpen:!1}),e.jsx(Ut,{}),e.jsx(Ht,{}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",dir:"rtl",children:[e.jsxs(p,{className:Se("green"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"إجمالي الإيرادات"}),e.jsx(ne,{className:`h-4 w-4 ${Ee("green")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:R?.financialStats?.totalRevenue||o||0,currency:E})}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:["من ",(R?.filteredData||[]).filter(e=>"completed"===e.status||"partial"===e.status).length," معاملة"]}),R?.trend&&e.jsxs("div",{className:"text-xs flex items-center justify-end mt-1 "+(R.trend.isPositive?"text-green-600":"text-red-600"),children:[e.jsxs("span",{className:"ml-1",children:[Math.abs(R.trend.changePercent||0),"%"]}),R.trend.isPositive?e.jsx(lt,{className:"h-3 w-3"}):e.jsx(it,{className:"h-3 w-3"})]})]})]}),e.jsxs(p,{className:Se("red"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"إجمالي المصروفات"}),e.jsx(_t,{className:`h-4 w-4 ${Ee("red")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:ae,currency:E})}),e.jsxs("div",{className:"text-xs text-muted-foreground text-right space-y-1 mt-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"مصروفات مباشرة:"}),e.jsx(Pe,{amount:U,currency:E})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"تكلفة المخزون:"}),e.jsx(Pe,{amount:Z,currency:E})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"احتياجات العيادة:"}),e.jsx(Pe,{amount:J,currency:E})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"طلبات المختبر:"}),e.jsx(Pe,{amount:se,currency:E})]}),e.jsx("div",{className:"border-t pt-1 mt-2 font-medium",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"إجمالي المصروفات:"}),e.jsx(Pe,{amount:ae,currency:E})]})})]})]})]}),e.jsxs(p,{className:Se(ie>=0?"green":"red"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"صافي الربح"}),ie>=0?e.jsx(pt,{className:`h-4 w-4 ${Ee("green")}`}):e.jsx(_t,{className:`h-4 w-4 ${Ee("red")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:ie,currency:E})}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"الإيرادات - المصروفات"})]})]}),e.jsxs(p,{className:Se("yellow"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"المبالغ المستحقة"}),e.jsx(Q,{className:`h-4 w-4 ${Ee("yellow")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:m+h+(R?.financialStats?.totalRemainingBalance||0),currency:E})}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"آجلة ومتأخرة ومتبقية"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",dir:"rtl",children:[e.jsxs(p,{className:Se(ce>=0?"green":"red"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"هامش الربح"}),e.jsx(rt,{className:`h-4 w-4 ${Ee(ce>=0?"green":"red")}`})]}),e.jsxs(b,{children:[e.jsxs("div",{className:"text-2xl font-bold text-foreground text-right",children:[ce.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"نسبة الربح من الإيرادات"})]})]}),e.jsxs(p,{className:Se("purple"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"إجمالي المعاملات"}),e.jsx(re,{className:`h-4 w-4 ${Ee("purple")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:(R?.filteredData||[]).length}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"معاملة مالية"})]})]}),e.jsxs(p,{className:Se("teal"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"متوسط المعاملة"}),e.jsx(ne,{className:`h-4 w-4 ${Ee("teal")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:(()=>{const e=R||{filteredData:[],financialStats:{totalRevenue:0}},t=Array.isArray(d)?d:[],s=Array.isArray(e.filteredData)&&e.filteredData.length>0?e.filteredData:t,a=e.financialStats?.totalRevenue||0;return s.length>0?a/s.length:0})(),currency:E})}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"متوسط قيمة المعاملة"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع حالات المدفوعات"})]}),e.jsxs(y,{children:["توزيع المدفوعات حسب الحالة (",R.filteredData.length," معاملة)",R.timeFilter.startDate&&R.timeFilter.endDate&&" في الفترة المحددة"]})]}),e.jsxs(b,{children:[0===ve.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات مدفوعات متاحة"})]})}):e.jsx(Ye,{width:"100%",height:pe.responsive.desktop.height,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:ve,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,value:t,percent:s})=>t>0?`${e}: ${t} (${(100*s).toFixed(0)}%)`:"",outerRadius:120,innerRadius:50,fill:"#8884d8",dataKey:"value",stroke:T?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:ve.map((t,s)=>e.jsx(He,{fill:t.color},`payment-status-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[`${e} معاملة`,"العدد"],labelFormatter:e=>`الحالة: ${e}`,contentStyle:pe.tooltip})]})}),ve.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-2 text-sm",children:ve.map((t,s)=>e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsxs("span",{className:"text-muted-foreground",children:[t.name,": ",t.value," (",t.percentage,"%)"]})]},`status-legend-${s}`))})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"طرق الدفع"})]}),e.jsxs(y,{children:["الإيرادات حسب طريقة الدفع (",r((()=>{const e=ge.reduce((e,t)=>e+t.amount,0);return console.log("Payment method total calculation:",{paymentMethodData:ge,total:e,financialStatsTotal:R.financialStats.totalRevenue}),e})(),E)," إجمالي)",R.timeFilter.startDate&&R.timeFilter.endDate&&" في الفترة المحددة"]})]}),e.jsxs(b,{children:[0===ge.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(rt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات طرق دفع متاحة"})]})}):e.jsx(Ye,{width:"100%",height:pe.responsive.desktop.height,children:e.jsxs(Ue,{data:ge,margin:{top:20,right:30,left:20,bottom:20},barCategoryGap:pe.bar.barCategoryGap,children:[e.jsx(Xe,{strokeDasharray:pe.grid.strokeDasharray,stroke:pe.grid.stroke,strokeOpacity:pe.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"method",tick:{fontSize:14,fill:T?"#9ca3af":"#6b7280"},axisLine:{stroke:T?"#4b5563":"#d1d5db"},tickLine:{stroke:T?"#4b5563":"#d1d5db"},interval:0,angle:-45,textAnchor:"end",height:60}),e.jsx(Je,{tick:{fontSize:14,fill:T?"#9ca3af":"#6b7280"},axisLine:{stroke:T?"#4b5563":"#d1d5db"},tickLine:{stroke:T?"#4b5563":"#d1d5db"},tickFormatter:e=>le(e,"currency",E),domain:[0,"dataMax + 100"]}),e.jsx(Ge,{formatter:(e,t,s)=>[r(Number(e),E),"المبلغ",`${s.payload.count} معاملة`],labelFormatter:e=>`طريقة الدفع: ${e}`,contentStyle:pe.tooltip}),e.jsx(Qe,{dataKey:"amount",fill:xe[1],radius:[4,4,0,0],minPointSize:5,maxBarSize:100})]})}),ge.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-1 gap-2 text-sm",children:ge.slice(0,3).map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-muted/50 rounded",children:[e.jsx("span",{className:"font-medium",children:t.method}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-semibold",children:t.formattedAmount}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[t.count," معاملة"]})]})]},`method-summary-${s}`))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع المصروفات حسب النوع"})]}),e.jsxs(y,{children:["توزيع المصروفات المدفوعة حسب النوع (",P(ae)," إجمالي)"]})]}),e.jsxs(b,{children:[0===me.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد مصروفات مدفوعة"})]})}):e.jsx(Ye,{width:"100%",height:pe.responsive.desktop.height,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:me,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,value:t,percentage:s})=>t>0?`${e}: ${P(t)} (${s.toFixed(0)}%)`:"",outerRadius:120,innerRadius:50,fill:"#8884d8",dataKey:"value",stroke:T?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:me.map((t,s)=>e.jsx(He,{fill:he[s%he.length]},`expense-type-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[P(Number(e)),"المبلغ"],labelFormatter:e=>`نوع المصروف: ${e}`,contentStyle:pe.tooltip})]})}),me.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-2 text-sm",children:me.map((t,s)=>e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:he[s%he.length]}}),e.jsxs("span",{className:"text-muted-foreground",children:[t.name,": ",e.jsx(Pe,{amount:t.value})," (",t.percentage.toFixed(1),"%)"]})]},`expense-legend-${s}`))})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"مقارنة الإيرادات والمصروفات"})]}),e.jsx(y,{children:"مقارنة بين الإيرادات والمصروفات وصافي الربح"})]}),e.jsx(b,{children:e.jsx(Ye,{width:"100%",height:pe.responsive.desktop.height,children:e.jsxs(Ue,{data:[{name:"الإيرادات",value:I.totalRevenue,type:"revenue"},{name:"المصروفات",value:ae,type:"expenses"},{name:"صافي الربح",value:ie,type:"profit"}],margin:{top:20,right:30,left:20,bottom:20},barCategoryGap:pe.bar.barCategoryGap,children:[e.jsx(Xe,{strokeDasharray:pe.grid.strokeDasharray,stroke:pe.grid.stroke,strokeOpacity:pe.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"name",tick:{fontSize:14,fill:T?"#9ca3af":"#6b7280"},axisLine:{stroke:T?"#4b5563":"#d1d5db"},tickLine:{stroke:T?"#4b5563":"#d1d5db"}}),e.jsx(Je,{tick:{fontSize:14,fill:T?"#9ca3af":"#6b7280"},axisLine:{stroke:T?"#4b5563":"#d1d5db"},tickLine:{stroke:T?"#4b5563":"#d1d5db"},tickFormatter:e=>le(e,"currency",E)}),e.jsx(Ge,{formatter:(e,t,s)=>[P(Number(e)),"المبلغ"],labelFormatter:e=>e,contentStyle:pe.tooltip}),e.jsx(Qe,{dataKey:"value",fill:e=>"revenue"===e?.type?W("financial",T)[0]:"expenses"===e?.type?W("financial",T)[1]:e?.value>=0?W("financial",T)[0]:W("financial",T)[1],radius:[4,4,0,0],minPointSize:5,maxBarSize:100,children:[{name:"الإيرادات",value:I.totalRevenue,type:"revenue"},{name:"المصروفات",value:ae,type:"expenses"},{name:"صافي الربح",value:ie,type:"profit"}].map((t,s)=>e.jsx(He,{fill:"revenue"===t.type?W("financial",T)[0]:"expenses"===t.type?W("financial",T)[1]:t.value>=0?W("financial",T)[0]:W("financial",T)[1]},`profit-loss-${s}`))})]})})})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(lt,{className:"w-5 h-5"}),e.jsx("span",{children:"الإيرادات الشهرية"})]}),e.jsxs(y,{children:["تطور الإيرادات عبر الأشهر (",ye.length," شهر)"]})]}),e.jsxs(b,{children:[0===ye.length?e.jsx("div",{className:"flex items-center justify-center h-96 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(lt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات إيرادات شهرية متاحة"}),e.jsx("p",{className:"text-sm mt-2",children:0===R.filteredData.length?"قم بإضافة مدفوعات لعرض الإحصائيات":`يوجد ${R.filteredData.length} مدفوعة ولكن لا توجد بيانات شهرية صالحة`})]})}):e.jsx(Ye,{width:"100%",height:pe.responsive.large.height,children:e.jsxs(et,{data:ye,margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(Xe,{strokeDasharray:pe.grid.strokeDasharray,stroke:pe.grid.stroke,strokeOpacity:pe.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"month",tick:{fontSize:12,fill:T?"#9ca3af":"#6b7280"},axisLine:{stroke:T?"#4b5563":"#d1d5db"},tickLine:{stroke:T?"#4b5563":"#d1d5db"},interval:0,angle:-45,textAnchor:"end",height:60}),e.jsx(Je,{tick:{fontSize:12,fill:T?"#9ca3af":"#6b7280"},axisLine:{stroke:T?"#4b5563":"#d1d5db"},tickLine:{stroke:T?"#4b5563":"#d1d5db"},tickFormatter:e=>le(e,"currency",E),domain:[0,"dataMax + 100"]}),e.jsx(Ge,{formatter:e=>[r(Number(e),E),"الإيرادات"],labelFormatter:e=>`الشهر: ${e}`,contentStyle:pe.tooltip}),e.jsx(tt,{type:"monotone",dataKey:"revenue",stroke:xe[0],fill:xe[0],fillOpacity:.3,strokeWidth:3,connectNulls:!1})]})}),ye.length>0&&e.jsxs("div",{className:"mt-4 grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أعلى شهر"}),e.jsx("div",{className:"font-semibold",children:(()=>{const e=ye.map(e=>e.revenue).filter(e=>e>0);return e.length>0?r(Math.max(...e),E):r(0,E)})()})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"متوسط شهري"}),e.jsx("div",{className:"font-semibold",children:(()=>{const e=ye.map(e=>e.revenue).filter(e=>e>0);return e.length>0?r(e.reduce((e,t)=>e+t,0)/e.length,E):r(0,E)})()})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أقل شهر"}),e.jsx("div",{className:"font-semibold",children:(()=>{const e=ye.map(e=>e.revenue).filter(e=>e>0);return e.length>0?r(Math.min(...e),E):r(0,E)})()})]})]})]})]}),R.filteredData.length>0&&e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(re,{className:"w-5 h-5"}),e.jsx("span",{children:"المدفوعات الحديثة"})]}),e.jsxs(y,{children:["آخر ",Math.min(10,R.filteredData.length)," مدفوعات",R.timeFilter.startDate&&R.timeFilter.endDate&&` في الفترة من ${R.timeFilter.startDate} إلى ${R.timeFilter.endDate}`]})]}),e.jsxs(b,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"رقم الإيصال"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"المريض"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"المبلغ"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"طريقة الدفع"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"الحالة"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"التاريخ"})]})}),e.jsx("tbody",{children:R.filteredData.sort((e,t)=>new Date(t.payment_date||t.created_at).getTime()-new Date(e.payment_date||e.created_at).getTime()).slice(0,10).map((t,s)=>e.jsxs("tr",{className:"border-b border-border/50 hover:bg-muted/50 transition-colors",children:[e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"font-mono text-sm",children:t.receipt_number||`#${t.id?.slice(-6)||"N/A"}`})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"font-medium",children:t.patient?.full_name||t.patient_name||"غير محدد"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-semibold",children:e.jsx(Pe,{amount:"pending"===t.status?t.total_amount_due&&t.total_amount_due>0?t.total_amount_due:t.remaining_balance&&t.remaining_balance>0?t.remaining_balance:t.amount||0:t.amount||0,currency:E})}),"partial"===t.status&&e.jsxs("div",{className:"text-xs space-y-0.5",children:[t.amount_paid&&e.jsxs("div",{className:"text-blue-600 dark:text-blue-400",children:["مدفوع: ",e.jsx(Pe,{amount:t.amount_paid,currency:E})]}),(t.appointment_remaining_balance||t.remaining_balance)&&e.jsxs("div",{className:"text-orange-600 dark:text-orange-400",children:["متبقي: ",e.jsx(Pe,{amount:t.appointment_remaining_balance||t.remaining_balance||0,currency:E})]})]}),"pending"===t.status&&t.total_amount_due&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["إجمالي مطلوب: ",e.jsx(Pe,{amount:t.total_amount_due,currency:E})]})]})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"text-sm",children:{cash:"نقداً",card:"بطاقة ائتمان",bank_transfer:"تحويل بنكي",check:"شيك",insurance:"تأمين"}[t.payment_method]||t.payment_method||"غير محدد"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${{completed:"text-green-600 bg-green-50 dark:bg-green-900/20",partial:"text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20",pending:"text-gray-600 bg-gray-50 dark:bg-card/20",failed:"text-red-600 bg-red-50 dark:bg-red-900/20",refunded:"text-purple-600 bg-purple-50 dark:bg-purple-900/20"}[t.status]||"text-gray-600 bg-gray-50"}`,children:{completed:"مكتمل",partial:"جزئي",pending:"آجل",failed:"فاشل",refunded:"مسترد"}[t.status]||t.status||"غير محدد"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:n(t.payment_date||t.created_at)})})]},t.id||s))})]})}),R.filteredData.length>10&&e.jsx("div",{className:"mt-4 text-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["عرض 10 من أصل ",R.filteredData.length," مدفوعة"]})})]})]})]})}),Zt=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#84cc16","#f97316"];function Jt({title:t,value:s,icon:a,color:n,description:r,trend:l}){return e.jsxs(p,{className:Se(n),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:t}),e.jsx(a,{className:`h-4 w-4 ${Ee(n)}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right mb-1",children:s}),r&&e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:r}),l&&e.jsxs("div",{className:"text-xs flex items-center justify-end mt-1 "+(l.isPositive?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"),children:[e.jsx(lt,{className:"h-3 w-3 ml-1 "+(l.isPositive?"":"rotate-180")}),e.jsxs("span",{children:[Math.abs(l.value),"%"]})]})]})]})}function Qt(){const{treatmentReports:s,isLoading:l,isExporting:i,generateReport:h,clearCache:u}=fe(),{toothTreatments:f,loadToothTreatments:y}=ie(),{patients:v,loadPatients:N}=Y(),{currency:w,settings:$}=V();q();const _=e=>{if("number"==typeof e)return isNaN(e)||!isFinite(e)?0:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)||!isFinite(t)?0:t}if("object"==typeof e&&null!==e){if(e instanceof Date)return e.getTime();if(void 0!==e.value)return _(e.value);if(void 0!==e.amount)return _(e.amount);if(void 0!==e.count)return _(e.count);const t=Number(e);return isNaN(t)||!isFinite(t)?0:t}return 0},{refreshTreatmentNames:D}=ce(),k=mt({data:f,dateField:"created_at",initialFilter:{preset:"all",startDate:"",endDate:""}});je("treatments"),t.useEffect(()=>{h("treatments"),y(),N(),D()},[h,y,N,D]);const A=t.useMemo(()=>{const e=k.filteredData;if(!e||0===e.length)return{totalTreatments:0,completedTreatments:0,plannedTreatments:0,inProgressTreatments:0,cancelledTreatments:0,totalRevenue:0,averageTreatmentCost:0,completionRate:0,treatmentsByStatus:[],treatmentsByCategory:[],treatmentsByType:[],revenueByCategory:[],pendingTreatments:[],overdueTreatments:[]};const t=e.length,s=e.filter(e=>"completed"===e.status).length,a=e.filter(e=>"planned"===e.status).length,n=e.filter(e=>"in-progress"===e.status).length,r=e.filter(e=>"cancelled"===e.status).length,l=e.reduce((e,t)=>e+(t.cost||0),0),i=t>0?l/t:0,m=t>0?Math.round(s/t*100):0,x=e.reduce((e,t)=>{const s=o(t.status||"غير محدد");return e[s]=(e[s]||0)+1,e},{}),h=Object.entries(x).map(([e,s])=>({status:e,count:s,percentage:t>0?Math.round(s/t*100):0})),u=e.reduce((e,t)=>{const s=d(t.treatment_category||"غير محدد");return e[s]=(e[s]||0)+1,e},{}),p=Object.entries(u).map(([e,s])=>({category:e,count:s,percentage:t>0?Math.round(s/t*100):0})),g=e.reduce((e,t)=>{const s=c(t.treatment_type||"غير محدد");return e[s]=(e[s]||0)+1,e},{}),f=Object.entries(g).map(([e,s])=>({type:e,count:s,percentage:t>0?Math.round(s/t*100):0})),j=Object.entries(e.reduce((e,t)=>{const s=d(t.treatment_category||"غير محدد");return e[s]||(e[s]={revenue:0,count:0}),e[s].revenue+=t.cost||0,e[s].count+=1,e},{})).map(([e,t])=>({category:e,revenue:t.revenue,count:t.count})),y=e.filter(e=>"planned"===e.status||"in-progress"===e.status).map(e=>({...e,patient_name:v.find(t=>t.id===e.patient_id)?.full_name||`${v.find(t=>t.id===e.patient_id)?.first_name||""} ${v.find(t=>t.id===e.patient_id)?.last_name||""}`.trim()||`مريض ${e.patient_id}`})),N=new Date;N.setDate(N.getDate()-30);const b=y.filter(e=>new Date(e.created_at)<N);return{totalTreatments:t,completedTreatments:s,plannedTreatments:a,inProgressTreatments:n,cancelledTreatments:r,totalRevenue:l,averageTreatmentCost:i,completionRate:m,treatmentsByStatus:h,treatmentsByCategory:p,treatmentsByType:f,revenueByCategory:j,pendingTreatments:y,overdueTreatments:b}},[k.filteredData,v]),C=t.useCallback(async()=>{try{u(),await h("treatments"),await y(),await N(),ct.success("تم تحديث تقارير العلاجات بنجاح")}catch(e){console.error("Error refreshing treatment reports:",e),ct.error("فشل في تحديث تقارير العلاجات")}},[u,h,y,N]),S=t.useCallback(async()=>{try{const e=k.filteredData.length>0?k.filteredData:f;if(0===e.length)return void ct.noDataToExport("لا توجد بيانات علاجات للتصدير");const t={};v.forEach(e=>{t[e.id]=e.full_name||`${e.first_name||""} ${e.last_name||""}`.trim()});const s=e.map(e=>({...e,patient_name:t[e.patient_id]||`مريض ${e.patient_id}`}));await ze.exportTreatmentsToCSV(s),ct.exportSuccess(`تم تصدير تقرير العلاجات بنجاح! (${e.length} علاج)`)}catch(e){console.error("Error exporting CSV:",e),ct.exportError("فشل في تصدير تقرير العلاجات")}},[k.filteredData,f,v]),E=t.useCallback(async()=>{try{const e=k.filteredData.length>0?k.filteredData:f;if(0===e.length)return void ct.noDataToExport("لا توجد بيانات علاجات للتصدير");const t={};v.forEach(e=>{t[e.id]=e.full_name||`${e.first_name||""} ${e.last_name||""}`.trim()});e.map(e=>({...e,patient_name:t[e.patient_id]||`مريض ${e.patient_id}`}));const s={...A,filterInfo:k.timeFilter.startDate&&k.timeFilter.endDate?`البيانات من ${k.timeFilter.startDate} إلى ${k.timeFilter.endDate}`:"جميع البيانات",dataCount:e.length};await Le.exportTreatmentReport(s,$),ct.exportSuccess(`تم تصدير تقرير العلاجات كملف PDF بنجاح (${e.length} علاج)`)}catch(e){console.error("Error exporting PDF:",e),ct.exportError("فشل في تصدير تقرير العلاجات كملف PDF")}},[k,f,v,A,$]);return l?e.jsx("div",{className:"flex items-center justify-center h-64",dir:"rtl",children:e.jsxs("div",{className:"text-center",children:[e.jsx(x,{className:"h-8 w-8 animate-spin mx-auto mb-4"}),e.jsx("p",{children:"جاري تحميل تقارير العلاجات..."})]})}):s?e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-3 mb-2",children:e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"تقارير العلاجات"})}),e.jsx("p",{className:"text-muted-foreground",children:"تحليل شامل لجميع العلاجات والإجراءات الطبية"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{onClick:C,disabled:l,variant:"outline",size:"sm",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(x,{className:"w-4 h-4 ml-2 "+(l?"animate-spin":"")}),"تحديث"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:S,disabled:i,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير اكسل"]}),e.jsxs(F,{variant:"default",size:"sm",onClick:E,disabled:i,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير PDF"]})]})]}),e.jsx(xt,{value:k.timeFilter,onChange:k.handleFilterChange,onClear:k.resetFilter,title:"فلترة العلاجات حسب التاريخ",defaultOpen:!1}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(Jt,{title:"إجمالي العلاجات",value:_(A.totalTreatments).toFixed(0),icon:ae,color:"blue",description:"العدد الكلي للعلاجات",trend:k.trend}),e.jsx(Jt,{title:"العلاجات المكتملة",value:_(A.completedTreatments).toFixed(0),icon:O,color:"green",description:`معدل الإنجاز: ${_(A.completionRate).toFixed(1)}%`}),e.jsx(Jt,{title:"إجمالي الإيرادات",value:e.jsx(Pe,{amount:A.totalRevenue,currency:w}),icon:ne,color:"green",description:`متوسط التكلفة: ${r(A.averageTreatmentCost,w)}`}),e.jsx(Jt,{title:"العلاجات الآجلة",value:_(A.pendingTreatments.length).toFixed(0),icon:Q,color:"yellow",description:`متأخرة: ${_(A.overdueTreatments.length).toFixed(0)}`})]}),e.jsxs(he,{defaultValue:"overview",className:"space-y-6",children:[e.jsxs(ue,{className:"grid w-full grid-cols-4",children:[e.jsx(pe,{value:"overview",children:"نظرة عامة"}),e.jsx(pe,{value:"analysis",children:"التحليل"}),e.jsx(pe,{value:"performance",children:"الأداء"}),e.jsx(pe,{value:"details",children:"التفاصيل"})]}),e.jsx(ge,{value:"overview",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-5 w-5"}),"توزيع حالات العلاج"]})}),e.jsx(b,{children:0===A.treatmentsByStatus.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات علاجات متاحة"})]})}):e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ke,{children:[e.jsx(We,{data:A.treatmentsByStatus,cx:"50%",cy:"50%",labelLine:!1,label:({status:e,percentage:t})=>`${a(e)}: ${_(t).toFixed(1)}%`,outerRadius:80,fill:"#8884d8",dataKey:"count",isAnimationActive:!1,animationDuration:0,children:A.treatmentsByStatus.map((t,s)=>e.jsx(He,{fill:Zt[s%Zt.length]},`cell-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[`${_(e).toFixed(0)}`,`${a(t)}`],labelFormatter:e=>`الحالة: ${a(e)}`})]})})})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(rt,{className:"h-5 w-5"}),"العلاجات حسب الفئة"]})}),e.jsx(b,{children:0===A.treatmentsByCategory.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(rt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات فئات علاجات متاحة"})]})}):e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ue,{data:A.treatmentsByCategory,children:[e.jsx(Xe,{strokeDasharray:"3 3"}),e.jsx(Ze,{dataKey:"category",tickFormatter:e=>a(e),tick:{fontSize:12},interval:0,angle:-45,textAnchor:"end",height:80}),e.jsx(Je,{}),e.jsx(Ge,{formatter:e=>[_(e).toFixed(0),"عدد العلاجات"],labelFormatter:e=>`الفئة: ${a(e)}`}),e.jsx(Qe,{dataKey:"count",fill:"#3b82f6",radius:[4,4,0,0],isAnimationActive:!1,animationDuration:0})]})})})]})]})}),e.jsx(ge,{value:"analysis",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{children:"الإيرادات حسب الفئة"})}),e.jsx(b,{children:e.jsx("div",{className:"space-y-4",children:A.revenueByCategory&&0!==A.revenueByCategory.length?A.revenueByCategory.map((t,s)=>e.jsxs("div",{className:"flex justify-between items-center p-3 bg-muted/30 rounded-lg",children:[e.jsx("span",{className:"font-medium text-right",children:t.category}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"font-bold",children:e.jsx(Pe,{amount:t.revenue,currency:w})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[t.count," علاج"]})]})]},s)):e.jsx("div",{className:"flex items-center justify-center h-40 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ne,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"لا توجد بيانات إيرادات متاحة"})]})})})})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{children:"أشهر العلاجات"})}),e.jsx(b,{children:e.jsx("div",{className:"space-y-4",children:Array.isArray(s.mostPopularTreatments)?s.mostPopularTreatments.slice(0,5).map((t,s)=>e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-medium",children:a(t.name)}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"font-bold",children:[_(t.count)," مرة"]}),e.jsx("div",{className:"text-sm text-muted-foreground",children:e.jsx(Pe,{amount:_(t.revenue),currency:w})})]})]},s)):e.jsx("div",{className:"text-center text-muted-foreground py-4",children:"لا توجد بيانات أشهر العلاجات متاحة"})})})]})]})}),e.jsx(ge,{value:"performance",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{children:"اتجاه العلاجات الشهري"})}),e.jsx(b,{children:s.treatmentTrend&&Array.isArray(s.treatmentTrend)&&0!==s.treatmentTrend.length?e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(st,{data:s.treatmentTrend,children:[e.jsx(Xe,{strokeDasharray:"3 3"}),e.jsx(Ze,{dataKey:"period",tickFormatter:e=>a(e)}),e.jsx(Je,{}),e.jsx(Ge,{formatter:(e,t)=>[`${_(e).toFixed(0)}`,`${a(t)}`],labelFormatter:e=>`الفترة: ${a(e)}`}),e.jsx(at,{type:"monotone",dataKey:"completed",stroke:"#10b981",name:"مكتمل",strokeWidth:2,dot:{fill:"#10b981",strokeWidth:2,r:4},isAnimationActive:!1,animationDuration:0}),e.jsx(at,{type:"monotone",dataKey:"planned",stroke:"#3b82f6",name:"مخطط",strokeWidth:2,dot:{fill:"#3b82f6",strokeWidth:2,r:4},isAnimationActive:!1,animationDuration:0})]})}):e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(lt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات اتجاه العلاجات متاحة"})]})})})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{children:"مؤشرات الأداء"})}),e.jsx(b,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"معدل الإنجاز"}),e.jsxs(m,{variant:"secondary",children:[_(s.completionRate).toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"متوسط وقت الإنجاز"}),e.jsxs(m,{variant:"secondary",children:[Math.round(_(s.averageCompletionTime))," يوم"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"المرضى بعلاجات متعددة"}),e.jsx(m,{variant:"secondary",children:_(s.patientsWithMultipleTreatments)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{children:"متوسط العلاجات لكل مريض"}),e.jsx(m,{variant:"secondary",children:_(s.averageTreatmentsPerPatient).toFixed(1)})]})]})})]})]})}),e.jsx(ge,{value:"details",className:"space-y-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5"}),"العلاجات الآجلة (",A.pendingTreatments.length,")"]})}),e.jsx(b,{children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:0===A.pendingTreatments.length?e.jsx("div",{className:"flex items-center justify-center h-40 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(Q,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"لا توجد علاجات آجلة"})]})}):e.jsxs(ft,{children:[e.jsx(jt,{children:e.jsxs(yt,{children:[e.jsx(vt,{className:"text-right",children:"نوع العلاج"}),e.jsx(vt,{className:"text-right",children:"اسم المريض"}),e.jsx(vt,{className:"text-right",children:"الحالة"}),e.jsx(vt,{className:"text-right",children:"التاريخ"}),e.jsx(vt,{className:"text-right",children:"التكلفة"})]})}),e.jsx(Nt,{children:A.pendingTreatments.slice(0,10).map(t=>e.jsxs(yt,{children:[e.jsx(bt,{className:"text-right",children:c(t.treatment_type)}),e.jsx(bt,{className:"text-right",children:a(t.patient_name)}),e.jsx(bt,{className:"text-right",children:e.jsx(m,{variant:"planned"===t.treatment_status?"secondary":"default",children:o(t.treatment_status||"غير محدد")})}),e.jsx(bt,{className:"text-right",children:t.created_at?n(t.created_at):"غير محدد"}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.cost||0,currency:w})})]},t.id))})]})})})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5 text-red-500"}),"العلاجات المتأخرة (",A.overdueTreatments.length,")"]})}),e.jsx(b,{children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:0===A.overdueTreatments.length?e.jsx("div",{className:"flex items-center justify-center h-40 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(O,{className:"w-8 h-8 mx-auto mb-2 opacity-50 text-green-500"}),e.jsx("p",{className:"text-sm",children:"لا توجد علاجات متأخرة"})]})}):e.jsxs(ft,{children:[e.jsx(jt,{children:e.jsxs(yt,{children:[e.jsx(vt,{className:"text-right",children:"نوع العلاج"}),e.jsx(vt,{className:"text-right",children:"اسم المريض"}),e.jsx(vt,{className:"text-right",children:"تاريخ الإنشاء"}),e.jsx(vt,{className:"text-right",children:"الأيام المتأخرة"}),e.jsx(vt,{className:"text-right",children:"التكلفة"})]})}),e.jsx(Nt,{children:A.overdueTreatments.slice(0,10).map(t=>{const s=t.created_at?Math.ceil(((new Date).getTime()-new Date(t.created_at).getTime())/864e5):0;return e.jsxs(yt,{children:[e.jsx(bt,{className:"text-right",children:c(t.treatment_type)}),e.jsx(bt,{className:"text-right",children:a(t.patient_name)}),e.jsx(bt,{className:"text-right",children:t.created_at?n(t.created_at):"غير محدد"}),e.jsx(bt,{className:"text-right",children:e.jsxs(m,{variant:"destructive",children:[s," يوم"]})}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.cost||0,currency:w})})]},t.id)})})]})})})]})]})})]})]}):e.jsxs("div",{className:"text-center py-8",dir:"rtl",children:[e.jsx(de,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"لا توجد بيانات علاجات متاحة"}),e.jsxs(F,{onClick:C,className:"mt-4",children:[e.jsx(x,{className:"h-4 w-4 ml-2"}),"تحديث"]})]})}const es={pending:"#f59e0b",ordered:"#3b82f6",received:"#10b981",cancelled:"#ef4444",urgent:"#dc2626",high:"#f59e0b",medium:"#3b82f6",low:"#10b981"},ts={pending:"آجل",ordered:"مطلوب",received:"مستلم",cancelled:"ملغي"},ss={urgent:"عاجل",high:"عالي",medium:"متوسط",low:"منخفض"};function as(){const{clinicNeedsReports:s,isLoading:a,isExporting:r,generateReport:l,clearCache:i}=fe(),{needs:c,loadNeeds:d}=ke(),{currency:o,settings:h}=V(),{isDarkMode:u}=q(),f=mt({data:c,dateField:"created_at",initialFilter:{preset:"all",startDate:"",endDate:""}});je("clinicNeeds"),t.useEffect(()=>{l("clinicNeeds"),d()},[l,d]);const v=t.useMemo(()=>{const e=f.filteredData;if(!e||0===e.length)return{totalNeeds:0,totalValue:0,pendingCount:0,orderedCount:0,receivedCount:0,cancelledCount:0,urgentCount:0,completionRate:0,urgencyRate:0,averageNeedValue:0,needsByStatus:[],needsByPriority:[],needsByCategory:[],topExpensiveNeeds:[]};const t=e.length,s=e.reduce((e,t)=>e+t.price*t.quantity,0),a=t>0?s/t:0,n=e.filter(e=>"pending"===e.status).length,r=e.filter(e=>"ordered"===e.status).length,l=e.filter(e=>"received"===e.status).length,i=e.filter(e=>"cancelled"===e.status).length,c=e.filter(e=>"urgent"===e.priority).length,d=t>0?l/t*100:0,o=t>0?c/t*100:0,m=[{name:ts.pending,value:n,color:es.pending},{name:ts.ordered,value:r,color:es.ordered},{name:ts.received,value:l,color:es.received},{name:ts.cancelled,value:i,color:es.cancelled}].filter(e=>e.value>0),x={urgent:e.filter(e=>"urgent"===e.priority).length,high:e.filter(e=>"high"===e.priority).length,medium:e.filter(e=>"medium"===e.priority).length,low:e.filter(e=>"low"===e.priority).length},h=[{name:ss.urgent,value:x.urgent,color:es.urgent},{name:ss.high,value:x.high,color:es.high},{name:ss.medium,value:x.medium,color:es.medium},{name:ss.low,value:x.low,color:es.low}].filter(e=>e.value>0),u=new Map;e.forEach(e=>{const t=e.category||"غير محدد",s=u.get(t)||{count:0,value:0};u.set(t,{count:s.count+1,value:s.value+e.price*e.quantity})});return{totalNeeds:t,totalValue:s,pendingCount:n,orderedCount:r,receivedCount:l,cancelledCount:i,urgentCount:c,completionRate:d,urgencyRate:o,averageNeedValue:a,needsByStatus:m,needsByPriority:h,needsByCategory:Array.from(u.entries()).map(([e,t])=>({category:e,count:t.count,value:t.value})).sort((e,t)=>t.value-e.value),topExpensiveNeeds:e.map(e=>({need_name:e.need_name,value:e.price*e.quantity,quantity:e.quantity,price:e.price})).sort((e,t)=>t.value-e.value).slice(0,10)}},[f.filteredData]);if(a)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل تقرير احتياجات العيادة..."})]})});const N=v;return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground flex items-center gap-2",children:[e.jsx(Ae,{className:"w-6 h-6 text-primary"}),"تقرير احتياجات العيادة"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"تحليل شامل لاحتياجات ومتطلبات العيادة"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{i(),await l("clinicNeeds"),await d(),ot.success("تم تحديث التقرير")},disabled:a,className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(x,{className:"w-4 h-4 "+(a?"animate-spin":"")}),e.jsx("span",{children:"تحديث"})]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{const e=f.filteredData;if(!e||0===e.length)return void ot.error("لا توجد بيانات للتصدير");const t=`clinic-needs-report${"all"!==f.filter.preset?`_${f.filter.preset}_${f.filter.startDate||""}_${f.filter.endDate||""}`:""}`;await ze.exportClinicNeedsToCSV(e,t),ot.success(`تم تصدير ${e.length} احتياج بنجاح`)}catch(e){console.error("Error exporting CSV:",e),ot.error("فشل في تصدير البيانات")}},disabled:r,className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(Ve,{className:"w-4 h-4"}),e.jsx("span",{children:"CSV"})]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:async()=>{try{if(!f.filteredData||0===f.filteredData.length)return void ot.error("لا توجد بيانات للتصدير");const e={...N,needsList:f.filteredData,filterInfo:"all"!==f.filter.preset?`الفترة: ${f.filter.preset} (${f.filter.startDate||""} - ${f.filter.endDate||""})`:"جميع البيانات",dataCount:f.filteredData.length};await Le.exportClinicNeedsReport(e,{title:"تقرير احتياجات العيادة",currency:o,isDarkMode:u}),ot.success("تم تصدير التقرير بنجاح")}catch(e){console.error("Error exporting PDF:",e),ot.error("فشل في تصدير التقرير")}},disabled:r,className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(Ve,{className:"w-4 h-4"}),e.jsx("span",{children:"PDF"})]})]})]}),e.jsx(xt,{value:f.filter,onChange:f.setFilter,className:"w-full"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",dir:"rtl",children:[e.jsxs(p,{className:Se("blue"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"إجمالي الاحتياجات"}),e.jsx(Ae,{className:`h-4 w-4 ${Ee("blue")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:N.totalNeeds}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"احتياج مسجل في النظام"})]})]}),e.jsxs(p,{className:Se("green"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"القيمة الإجمالية"}),e.jsx(ne,{className:`h-4 w-4 ${Ee("green")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:N.totalValue,currency:o})}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"قيمة جميع الاحتياجات"})]})]}),e.jsxs(p,{className:Se("orange"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"الاحتياجات الآجلة"}),e.jsx(Q,{className:`h-4 w-4 ${Ee("orange")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:N.pendingCount}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"في انتظار الطلب"})]})]}),e.jsxs(p,{className:Se("red"),dir:"rtl",children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"الاحتياجات العاجلة"}),e.jsx(T,{className:`h-4 w-4 ${Ee("red")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:N.urgentCount}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"تحتاج اهتمام فوري"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع الاحتياجات حسب الحالة"})]}),e.jsxs(y,{children:["توزيع الاحتياجات حسب حالة الطلب (",N.totalNeeds," احتياج إجمالي)"]})]}),e.jsx(b,{children:0===N.needsByStatus.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات احتياجات متاحة"})]})}):e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ke,{children:[e.jsx(We,{data:N.needsByStatus,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,value:t,percent:s})=>`${e}: ${t} (${(100*s).toFixed(1)}%)`,outerRadius:80,fill:"#8884d8",dataKey:"value",children:N.needsByStatus.map((t,s)=>e.jsx(He,{fill:t.color},`cell-${s}`))}),e.jsx(Ge,{}),e.jsx(nt,{})]})})})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع الاحتياجات حسب الأولوية"})]}),e.jsx(y,{children:"توزيع الاحتياجات حسب مستوى الأولوية"})]}),e.jsx(b,{children:0===N.needsByPriority.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(rt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات أولوية متاحة"})]})}):e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ue,{data:N.needsByPriority,children:[e.jsx(Xe,{strokeDasharray:"3 3"}),e.jsx(Ze,{dataKey:"name"}),e.jsx(Je,{}),e.jsx(Ge,{}),e.jsx(Qe,{dataKey:"value",fill:"#8884d8",children:N.needsByPriority.map((t,s)=>e.jsx(He,{fill:t.color},`cell-${s}`))})]})})})]})]}),e.jsxs(he,{defaultValue:"categories",className:"w-full",dir:"rtl",children:[e.jsxs(ue,{className:"grid w-full grid-cols-4",children:[e.jsx(pe,{value:"categories",children:"الفئات"}),e.jsx(pe,{value:"expensive",children:"الأغلى سعراً"}),e.jsx(pe,{value:"pending",children:"الآجلة"}),e.jsx(pe,{value:"urgent",children:"العاجلة"})]}),e.jsx(ge,{value:"categories",className:"space-y-4",children:e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"h-5 w-5"}),"الاحتياجات حسب الفئة (",N.needsByCategory.length," فئة)"]})}),e.jsx(b,{children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs(ft,{children:[e.jsx(jt,{children:e.jsxs(yt,{children:[e.jsx(vt,{className:"text-right",children:"الفئة"}),e.jsx(vt,{className:"text-right",children:"العدد"}),e.jsx(vt,{className:"text-right",children:"القيمة الإجمالية"}),e.jsx(vt,{className:"text-right",children:"متوسط القيمة"})]})}),e.jsx(Nt,{children:N.needsByCategory.map((t,s)=>e.jsxs(yt,{children:[e.jsx(bt,{className:"font-medium text-right",children:t.category}),e.jsx(bt,{className:"text-right",children:t.count}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.value,currency:o})}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.value/t.count,currency:o})})]},s))})]})})})]})}),e.jsx(ge,{value:"expensive",className:"space-y-4",children:e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"}),"الاحتياجات الأغلى سعراً (أعلى 10)"]})}),e.jsx(b,{children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs(ft,{children:[e.jsx(jt,{children:e.jsxs(yt,{children:[e.jsx(vt,{className:"text-right",children:"اسم الاحتياج"}),e.jsx(vt,{className:"text-right",children:"الكمية"}),e.jsx(vt,{className:"text-right",children:"سعر الوحدة"}),e.jsx(vt,{className:"text-right",children:"القيمة الإجمالية"})]})}),e.jsx(Nt,{children:N.topExpensiveNeeds.map((t,s)=>e.jsxs(yt,{children:[e.jsx(bt,{className:"font-medium text-right",children:t.need_name}),e.jsx(bt,{className:"text-right",children:t.quantity}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.price,currency:o})}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.value,currency:o})})]},s))})]})})})]})}),e.jsx(ge,{value:"pending",className:"space-y-4",children:e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"h-5 w-5"}),"الاحتياجات الآجلة (",N.pendingCount,")"]})}),e.jsx(b,{children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs(ft,{children:[e.jsx(jt,{children:e.jsxs(yt,{children:[e.jsx(vt,{className:"text-right",children:"اسم الاحتياج"}),e.jsx(vt,{className:"text-right",children:"الفئة"}),e.jsx(vt,{className:"text-right",children:"الأولوية"}),e.jsx(vt,{className:"text-right",children:"القيمة"}),e.jsx(vt,{className:"text-right",children:"تاريخ الإنشاء"})]})}),e.jsx(Nt,{children:f.filteredData.filter(e=>"pending"===e.status).slice(0,10).map(t=>e.jsxs(yt,{children:[e.jsx(bt,{className:"font-medium text-right",children:t.need_name}),e.jsx(bt,{className:"text-right",children:t.category||"غير محدد"}),e.jsx(bt,{className:"text-right",children:e.jsx(m,{variant:"urgent"===t.priority?"destructive":"secondary",children:ss[t.priority]})}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.price*t.quantity,currency:o})}),e.jsx(bt,{className:"text-right",children:n(t.created_at)})]},t.id))})]})})})]})}),e.jsx(ge,{value:"urgent",className:"space-y-4",children:e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-5 w-5"}),"الاحتياجات العاجلة (",N.urgentCount,")"]})}),e.jsx(b,{children:e.jsx("div",{className:"max-h-96 overflow-y-auto",children:e.jsxs(ft,{children:[e.jsx(jt,{children:e.jsxs(yt,{children:[e.jsx(vt,{className:"text-right",children:"اسم الاحتياج"}),e.jsx(vt,{className:"text-right",children:"الحالة"}),e.jsx(vt,{className:"text-right",children:"الفئة"}),e.jsx(vt,{className:"text-right",children:"القيمة"}),e.jsx(vt,{className:"text-right",children:"تاريخ الإنشاء"})]})}),e.jsx(Nt,{children:f.filteredData.filter(e=>"urgent"===e.priority).slice(0,10).map(t=>e.jsxs(yt,{children:[e.jsx(bt,{className:"font-medium text-right",children:t.need_name}),e.jsx(bt,{className:"text-right",children:e.jsx(m,{variant:"received"===t.status?"default":"secondary",children:ts[t.status]})}),e.jsx(bt,{className:"text-right",children:t.category||"غير محدد"}),e.jsx(bt,{className:"text-right",children:e.jsx(Pe,{amount:t.price*t.quantity,currency:o})}),e.jsx(bt,{className:"text-right",children:n(t.created_at)})]},t.id))})]})})})]})})]})]})}function ns(){const{expenses:s,analytics:a,loadExpenses:l}=De(),{currentCurrency:i,formatAmount:c}=te();V();const{isDarkMode:d}=q(),o=mt({data:s,dateField:"payment_date",initialFilter:{preset:"all",startDate:"",endDate:""}});je("financial");const m=t.useCallback(e=>{console.log("🔄 Expense data changed:",e.detail),l()},[l]);t.useEffect(()=>(window.addEventListener("clinic-expenses-changed",m),()=>{window.removeEventListener("clinic-expenses-changed",m)}),[m]),t.useEffect(()=>{l()},[l]);const h=W("categorical",d),u=W("primary",d),f=G(d),v=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},N=t.useMemo(()=>o||{filteredData:[]},[o]),w=t.useMemo(()=>Array.isArray(N.filteredData)&&N.filteredData.length>0?N.filteredData:s.filter(e=>"paid"===e.status),[N,s]),$=t.useMemo(()=>{const e=w.reduce((e,t)=>e+v(t.amount),0),t=w.length,a=t>0?e/t:0,n={};w.forEach(e=>{const t=e.expense_type||"other";n[t]=(n[t]||0)+v(e.amount)});const r={};w.forEach(e=>{const t=e.vendor||"غير محدد";r[t]=(r[t]||0)+v(e.amount)});const l={};w.forEach(e=>{try{const t=new Date(e.payment_date);if(!isNaN(t.getTime())){const s=t.toISOString().slice(0,7);l[s]=(l[s]||0)+v(e.amount)}}catch(t){console.warn("Invalid expense date:",e.payment_date)}});const i=s||[],c=i.filter(e=>"pending"===e.status),d=i.filter(e=>"overdue"===e.status),m=o?.filteredData?.filter(e=>"pending"===e.status)||c,x=o?.filteredData?.filter(e=>"overdue"===e.status)||d,h={paid:w.filter(e=>"paid"===e.status).length,pending:m.length,overdue:x.length};return{totalAmount:e,totalExpenses:t,averageAmount:a,expensesByType:n,expensesByVendor:r,monthlyExpenses:l,statusBreakdown:h}},[w,s]),_=t.useMemo(()=>Object.entries($.expensesByType).map(([e,t])=>({name:"salary"===e?"رواتب":"utilities"===e?"مرافق":"rent"===e?"إيجار":"maintenance"===e?"صيانة":"supplies"===e?"مستلزمات":"insurance"===e?"تأمين":"other"===e?"أخرى":e,value:v(t),percentage:$.totalAmount>0?v(t)/$.totalAmount*100:0})),[$]),D=t.useMemo(()=>Object.entries($.expensesByVendor).sort(([,e],[,t])=>v(t)-v(e)).slice(0,10).map(([e,t])=>({vendor:e.length>20?e.substring(0,20)+"...":e,amount:v(t),percentage:$.totalAmount>0?v(t)/$.totalAmount*100:0})),[$]),k=t.useMemo(()=>Object.entries($.monthlyExpenses).sort(([e],[t])=>e.localeCompare(t)).map(([e,t])=>{const s=new Date(e+"-01");return{month:`${["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"][s.getMonth()]} ${s.getFullYear()}`,amount:v(t),originalMonth:e}}),[$]),A=t.useCallback(async()=>{try{if(0===w.length)return void ct.noDataToExport("لا توجد بيانات مصروفات للتصدير");await ze.exportClinicExpensesToExcel(w),ct.exportSuccess(`تم تصدير ${w.length} مصروف بنجاح إلى ملف Excel!`)}catch(e){console.error("Error exporting expense reports:",e),ct.exportError("فشل في تصدير تقارير المصروفات")}},[w]),C=t.useCallback(async()=>{try{await l();const e=new CustomEvent("showToast",{detail:{title:"تم التحديث بنجاح",description:"تم تحديث تقارير المصروفات",type:"success"}});window.dispatchEvent(e)}catch(e){console.error("Error refreshing expense reports:",e);const t=new CustomEvent("showToast",{detail:{title:"خطأ في التحديث",description:"فشل في تحديث تقارير المصروفات",type:"error"}});window.dispatchEvent(t)}},[l]);return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-foreground",children:"تقارير مصروفات العيادة"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"تحليل شامل لمصروفات العيادة وإحصائيات مفصلة"}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}),e.jsx("span",{children:"البيانات محدثة في الوقت الفعلي"})]}),w.length>0&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["• ",w.length," مصروف",o.timeFilter?.startDate&&o.timeFilter?.endDate&&" (مفلترة)"]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:C,children:[e.jsx(x,{className:"w-4 h-4 ml-2"}),"تحديث"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:A,disabled:0===w.length,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),"تصدير Excel"]})]})]}),e.jsx(xt,{value:o.timeFilter,onChange:o.handleFilterChange,onClear:o.resetFilter,title:"فلترة زمنية - المصروفات",defaultOpen:!1}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(p,{className:Se("red"),children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"إجمالي المصروفات"}),e.jsx(ne,{className:`h-4 w-4 ${Ee("red")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:$.totalAmount,currency:i})}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:["من ",$.totalExpenses," مصروف"]})]})]}),e.jsxs(p,{className:Se("blue"),children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"متوسط المصروف"}),e.jsx(rt,{className:`h-4 w-4 ${Ee("blue")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:e.jsx(Pe,{amount:$.averageAmount,currency:i})}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"متوسط قيمة المصروف"})]})]}),e.jsxs(p,{className:Se("green"),children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"المصروفات المدفوعة"}),e.jsx(O,{className:`h-4 w-4 ${Ee("green")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:$.statusBreakdown.paid}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"مصروفات مكتملة الدفع"})]})]}),e.jsxs(p,{className:Se("yellow"),children:[e.jsxs(g,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground text-right",children:"المصروفات الآجلة"}),e.jsx(Q,{className:`h-4 w-4 ${Ee("yellow")}`})]}),e.jsxs(b,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground text-right",children:$.statusBreakdown.pending+$.statusBreakdown.overdue}),e.jsx("p",{className:"text-xs text-muted-foreground text-right",children:"في انتظار الدفع أو متأخرة"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع المصروفات حسب النوع"})]}),e.jsxs(y,{children:["توزيع المصروفات المدفوعة حسب النوع (",c($.totalAmount)," إجمالي)"]})]}),e.jsxs(b,{children:[0===_.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات مصروفات حسب النوع"})]})}):e.jsx(Ye,{width:"100%",height:f.responsive.desktop.height,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:_,cx:"50%",cy:"50%",labelLine:!1,outerRadius:120,innerRadius:50,fill:"#8884d8",dataKey:"value",stroke:d?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:_.map((t,s)=>e.jsx(He,{fill:h[s%h.length]},`expense-type-${s}`))}),e.jsx(Ge,{formatter:(e,t)=>[c(Number(e)),"المبلغ"],labelFormatter:e=>`نوع المصروف: ${e}`,contentStyle:{backgroundColor:d?"#1f2937":"#ffffff",border:"1px solid "+(d?"#374151":"#d1d5db"),borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1)",fontSize:"14px",fontWeight:"500"}})]})}),_.length>0&&e.jsxs("div",{className:"mt-6 flex flex-col items-center space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-foreground mb-2",children:"تفاصيل التوزيع"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-md",children:_.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-center space-x-2 space-x-reverse bg-muted/30 rounded-lg p-3",children:[e.jsx("div",{className:"w-4 h-4 rounded-full flex-shrink-0",style:{backgroundColor:h[s%h.length]}}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-foreground",children:t.name}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx(Pe,{amount:t.value})," (",t.percentage.toFixed(1),"%)"]})]})]},`type-legend-${s}`))})]})]})]}),e.jsxs(p,{children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(wt,{className:"w-5 h-5"}),e.jsx("span",{children:"أكبر الموردين"})]}),e.jsx(y,{children:"أكبر 10 موردين حسب إجمالي المصروفات"})]}),e.jsx(b,{children:0===D.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(wt,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات موردين"})]})}):e.jsx(Ye,{width:"100%",height:f.responsive.desktop.height,children:e.jsxs(Ue,{data:D,margin:{top:20,right:30,left:20,bottom:20},layout:"horizontal",children:[e.jsx(Xe,{strokeDasharray:f.grid.strokeDasharray,stroke:f.grid.stroke,strokeOpacity:f.grid.strokeOpacity}),e.jsx(Ze,{type:"number",tick:{fontSize:12,fill:d?"#9ca3af":"#6b7280"},axisLine:{stroke:d?"#4b5563":"#d1d5db"},tickLine:{stroke:d?"#4b5563":"#d1d5db"},tickFormatter:e=>le(e,"currency",i)}),e.jsx(Je,{type:"category",dataKey:"vendor",tick:{fontSize:12,fill:d?"#9ca3af":"#6b7280"},axisLine:{stroke:d?"#4b5563":"#d1d5db"},tickLine:{stroke:d?"#4b5563":"#d1d5db"},width:120}),e.jsx(Ge,{formatter:(e,t)=>[c(Number(e)),"المبلغ"],labelFormatter:e=>`المورد: ${e}`,contentStyle:{backgroundColor:d?"#1f2937":"#ffffff",border:"1px solid "+(d?"#374151":"#d1d5db"),borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1)",fontSize:"14px",fontWeight:"500"}}),e.jsx(Qe,{dataKey:"amount",fill:u[2],radius:[0,4,4,0]})]})})})]})]}),k.length>0&&e.jsxs(p,{children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(lt,{className:"w-5 h-5"}),e.jsx("span",{children:"المصروفات الشهرية"})]}),e.jsxs(y,{children:["تطور المصروفات عبر الأشهر (",k.length," شهر)"]})]}),e.jsxs(b,{children:[e.jsx(Ye,{width:"100%",height:f.responsive.large.height,children:e.jsxs(et,{data:k,margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(Xe,{strokeDasharray:f.grid.strokeDasharray,stroke:f.grid.stroke,strokeOpacity:f.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"month",tick:{fontSize:12,fill:d?"#9ca3af":"#6b7280"},axisLine:{stroke:d?"#4b5563":"#d1d5db"},tickLine:{stroke:d?"#4b5563":"#d1d5db"},interval:0,angle:-45,textAnchor:"end",height:60}),e.jsx(Je,{tick:{fontSize:12,fill:d?"#9ca3af":"#6b7280"},axisLine:{stroke:d?"#4b5563":"#d1d5db"},tickLine:{stroke:d?"#4b5563":"#d1d5db"},tickFormatter:e=>le(e,"currency",i),domain:[0,"dataMax + 100"]}),e.jsx(Ge,{formatter:e=>[r(Number(e),i),"المصروفات"],labelFormatter:e=>`الشهر: ${e}`,contentStyle:{backgroundColor:d?"#1f2937":"#ffffff",border:"1px solid "+(d?"#374151":"#d1d5db"),borderRadius:"8px",boxShadow:"0 10px 15px -3px rgba(0, 0, 0, 0.1)",fontSize:"14px",fontWeight:"500"}}),e.jsx(tt,{type:"monotone",dataKey:"amount",stroke:u[3],fill:u[3],fillOpacity:.3,strokeWidth:3,connectNulls:!1})]})}),k.length>0&&e.jsxs("div",{className:"mt-4 grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أعلى شهر"}),e.jsx("div",{className:"font-semibold",children:(()=>{const e=k.map(e=>e.amount).filter(e=>e>0);return e.length>0?r(Math.max(...e),i):r(0,i)})()})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"متوسط شهري"}),e.jsx("div",{className:"font-semibold",children:(()=>{const e=k.map(e=>e.amount).filter(e=>e>0);return e.length>0?r(e.reduce((e,t)=>e+t,0)/e.length,i):r(0,i)})()})]}),e.jsxs("div",{className:"text-center p-3 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"أقل شهر"}),e.jsx("div",{className:"font-semibold",children:(()=>{const e=k.map(e=>e.amount).filter(e=>e>0);return e.length>0?r(Math.min(...e),i):r(0,i)})()})]})]})]})]}),w.length>0&&e.jsxs(p,{children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(re,{className:"w-5 h-5"}),e.jsx("span",{children:"المصروفات الحديثة"})]}),e.jsxs(y,{children:["آخر ",Math.min(10,w.length)," مصروف",o.timeFilter?.startDate&&o.timeFilter?.endDate&&` في الفترة من ${o.timeFilter.startDate} إلى ${o.timeFilter.endDate}`]})]}),e.jsxs(b,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"اسم المصروف"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"النوع"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"المبلغ"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"المورد"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"حالة الدفع"}),e.jsx("th",{className:"text-right p-3 font-semibold text-muted-foreground",children:"تاريخ الدفع"})]})}),e.jsx("tbody",{children:w.sort((e,t)=>new Date(t.payment_date||t.created_at).getTime()-new Date(e.payment_date||e.created_at).getTime()).slice(0,10).map((t,s)=>e.jsxs("tr",{className:"border-b border-border/50 hover:bg-muted/50 transition-colors",children:[e.jsxs("td",{className:"p-3 text-right",children:[e.jsx("div",{className:"font-medium",children:t.expense_name||"غير محدد"}),t.description&&e.jsx("div",{className:"text-xs text-muted-foreground mt-1 max-w-xs truncate",children:t.description})]}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"text-sm",children:{salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"}[t.expense_type]||t.expense_type||"غير محدد"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("div",{className:"font-semibold",children:e.jsx(Pe,{amount:t.amount,currency:i})})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"text-sm",children:t.vendor||"غير محدد"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${{paid:"text-green-600 bg-green-50 dark:bg-green-900/20",pending:"text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20",overdue:"text-red-600 bg-red-50 dark:bg-red-900/20",cancelled:"text-gray-600 bg-gray-50 dark:bg-gray-900/20"}[t.status]||"text-gray-600 bg-gray-50"}`,children:{paid:"مدفوع",pending:"آجل",overdue:"متأخر",cancelled:"ملغي"}[t.status]||t.status||"غير محدد"})}),e.jsx("td",{className:"p-3 text-right",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:n(t.payment_date||t.created_at)})})]},t.id||s))})]})}),w.length>10&&e.jsx("div",{className:"mt-4 text-center",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:["عرض 10 من أصل ",w.length," مصروف"]})})]})]})]})}class rs{static validateAmount(e){const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100}static filterByDateRange(e,t,s){const a=t.start||t.startDate,n=t.end||t.endDate;if(!a&&!n)return e;return e.filter(e=>{const t=e[s];if(!t)return!1;const r=new Date(t);let l,i=null,c=null;a&&(i=new Date(a),i=new Date(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0,0)),n&&(c=new Date(n),c=new Date(c.getFullYear(),c.getMonth(),c.getDate(),23,59,59,999)),l=t.includes("T")||t.includes(" ")?r:new Date(r.getFullYear(),r.getMonth(),r.getDate(),0,0,0,0);return(!i||l>=i)&&(!c||l<=c)})}static calculateRevenueStats(e){const t=this.validateAmount(e.filter(e=>"completed"===e.status).reduce((e,t)=>e+this.validateAmount(t.amount),0)),s=this.validateAmount(e.filter(e=>"partial"===e.status).reduce((e,t)=>e+this.validateAmount(t.amount),0));return{completedPayments:t,totalRevenue:t+s,partialPayments:s,remainingBalances:this.validateAmount(e.filter(e=>"partial"===e.status).reduce((e,t)=>{const s=this.validateAmount(t.total_amount_due||t.treatment_total_cost||t.appointment_total_cost||0),a=this.validateAmount(t.amount_paid||t.treatment_total_paid||t.appointment_total_paid||t.amount||0),n=Math.max(0,s-a);return 0===s?e+this.validateAmount(t.remaining_balance||t.treatment_remaining_balance||t.appointment_remaining_balance||0):e+n},0)),pendingAmount:this.validateAmount(e.filter(e=>"pending"===e.status).reduce((e,t)=>{const s=this.validateAmount(t.amount),a=this.validateAmount(t.total_amount_due);let n=s;if(t.tooth_treatment_id){n=this.validateAmount(t.treatment_total_cost)||a}else 0===s&&a>0?n=a:t.remaining_balance&&t.remaining_balance>0&&(n=this.validateAmount(t.remaining_balance));return e+n},0))}}static calculateExpenseStats(e,t,s,a){return{labOrdersTotal:this.validateAmount(e.reduce((e,t)=>e+this.validateAmount(t.paid_amount||0),0)),labOrdersRemaining:this.validateAmount(e.reduce((e,t)=>e+this.validateAmount(t.remaining_balance||0),0)),clinicNeedsTotal:this.validateAmount(t.filter(e=>"received"===e.status||"ordered"===e.status).reduce((e,t)=>e+this.validateAmount(t.quantity)*this.validateAmount(t.price),0)),clinicNeedsRemaining:this.validateAmount(t.filter(e=>"pending"===e.status||"ordered"===e.status).reduce((e,t)=>e+this.validateAmount(t.quantity)*this.validateAmount(t.price),0)),inventoryExpenses:this.validateAmount(s.reduce((e,t)=>e+this.validateAmount(t.cost_per_unit||0)*this.validateAmount(t.quantity||0),0)),clinicExpensesTotal:a?this.validateAmount(a.filter(e=>"paid"===e.status).reduce((e,t)=>e+this.validateAmount(t.amount),0)):0}}static calculateProfitLoss(e,t){const s=e-t,a=s>=0,n=a?0:Math.abs(s),r=e>0?s/e*100:0;return{totalIncome:e,totalExpenses:t,netProfit:a?s:0,profitMargin:this.validateAmount(r),lossAmount:n,isProfit:a}}static generateComprehensiveProfitLossReport(e,t,s,a,n,r,l,i){const c=l?.dateRange?this.filterByDateRange(e,l.dateRange,"payment_date"):e,d=l?.dateRange?this.filterByDateRange(t,l.dateRange,"order_date"):t,o=l?.dateRange?this.filterByDateRange(s,l.dateRange,"created_at"):s,m=l?.dateRange?this.filterByDateRange(r,l.dateRange,"created_at"):r,x=l?.dateRange?this.filterByDateRange(a,l.dateRange,"created_at"):a,h=l?.dateRange&&i?this.filterByDateRange(i,l.dateRange,"payment_date"):i,u=this.calculateRevenueStats(c),p=this.calculateExpenseStats(d,o,x,h),g=u.totalRevenue,f=p.labOrdersTotal+p.clinicNeedsTotal+p.inventoryExpenses+p.clinicExpensesTotal;return{revenue:u,expenses:p,calculations:this.calculateProfitLoss(g,f),details:{totalPatients:n.length,totalAppointments:m.length,totalLabOrders:d.length,totalClinicNeeds:o.length,totalInventoryItems:x.length,totalExpenses:h?h.length:0,averageRevenuePerPatient:n.length>0?g/n.length:0,averageRevenuePerAppointment:m.length>0?g/m.length:0},filterInfo:{dateRange:l?.dateRange?`${l.dateRange.start||l.dateRange.startDate||"البداية"} - ${l.dateRange.end||l.dateRange.endDate||"النهاية"}`:"جميع البيانات",totalRecords:e.length+t.length+s.length+r.length+a.length+(i?i.length:0),filteredRecords:c.length+d.length+o.length+m.length+x.length+(h?h.length:0)}}}}function ls(){const{payments:s}=ee(),{expenses:n}=De(),{labOrders:r}=Ce(),{needs:l}=ke(),{items:i}=X(),{patients:c}=Y(),{appointments:d}=J(),{currency:o,settings:x}=V(),{isDarkMode:h}=q(),[u,f]=t.useState(null),[v,N]=t.useState("this_month"),[_,D]=t.useState(""),[E,M]=t.useState(""),[T,R]=t.useState(!1),[O,I]=t.useState(!1),L=t.useMemo(()=>({payments:s,clinicExpenses:n,labOrders:r,clinicNeeds:l,inventoryItems:i,patients:c,appointments:d}),[s,n,r,l,i,c,d]),z=e=>`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`,B=t.useMemo(()=>((e,t,s)=>{const a=new Date,n=new Date(a.getFullYear(),a.getMonth(),a.getDate());switch(e){case"all":default:return null;case"today":return{start:z(n),end:z(n)};case"yesterday":const e=new Date(n);return e.setDate(e.getDate()-1),{start:z(e),end:z(e)};case"this_week":const a=new Date(n);return a.setDate(n.getDate()-n.getDay()),{start:z(a),end:z(n)};case"last_week":const r=new Date(n);r.setDate(n.getDate()-n.getDay()-1);const l=new Date(r);return l.setDate(r.getDate()-6),{start:z(l),end:z(r)};case"this_month":const i=new Date(n.getFullYear(),n.getMonth(),1);return{start:z(i),end:z(n)};case"last_month":const c=new Date(n.getFullYear(),n.getMonth()-1,1),d=new Date(n.getFullYear(),n.getMonth(),0);return{start:z(c),end:z(d)};case"this_quarter":const o=new Date(n.getFullYear(),3*Math.floor(n.getMonth()/3),1);return{start:z(o),end:z(n)};case"last_quarter":const m=new Date(n.getFullYear(),3*Math.floor(n.getMonth()/3)-3,1),x=new Date(n.getFullYear(),3*Math.floor(n.getMonth()/3),0);return{start:z(m),end:z(x)};case"this_year":const h=new Date(n.getFullYear(),0,1);return{start:z(h),end:z(n)};case"last_year":const u=new Date(n.getFullYear()-1,0,1),p=new Date(n.getFullYear()-1,11,31);return{start:z(u),end:z(p)};case"last_30_days":const g=new Date(n);return g.setDate(n.getDate()-30),{start:z(g),end:z(n)};case"last_90_days":const f=new Date(n);return f.setDate(n.getDate()-90),{start:z(f),end:z(n)};case"custom":return t&&s?{start:t,end:s}:null}})(v,_,E),[v,_,E]),K=t.useCallback(async()=>{R(!0);try{const e=B?{dateRange:B}:void 0,t=rs.generateComprehensiveProfitLossReport(L.payments,L.labOrders,L.clinicNeeds,L.inventoryItems,L.patients,L.appointments,e,L.clinicExpenses);f(t)}catch(e){}finally{R(!1)}},[L,B]),W=t.useCallback(async()=>{if(u){I(!0);try{await ze.exportProfitLossToExcel({reportData:u,...L,filter:B,currency:o}),ct.success("تم تصدير تقرير الأرباح والخسائر إلى Excel بنجاح")}catch(e){ct.error("فشل في تصدير التقرير إلى Excel")}finally{I(!1)}}else ct.error("لا توجد بيانات للتصدير")},[u,L,B,o]),H=t.useCallback(async()=>{if(u){I(!0);try{await Le.exportProfitLossReport({reportData:u,...L,filter:B,currency:o},x),ct.success("تم تصدير تقرير الأرباح والخسائر إلى PDF بنجاح")}catch(e){ct.error("فشل في تصدير التقرير إلى PDF")}finally{I(!1)}}else ct.error("لا توجد بيانات للتصدير")},[u,L,B,o,x]);t.useEffect(()=>{K()},[K]);const G=t.useMemo(()=>({primary:h?"#3b82f6":"#2563eb",secondary:h?"#10b981":"#059669",warning:h?"#f59e0b":"#d97706",danger:h?"#ef4444":"#dc2626",purple:h?"#8b5cf6":"#7c3aed",teal:h?"#14b8a6":"#0d9488"}),[h]),U=t.useMemo(()=>{if(!u)return[];const{revenue:e}=u;return[{name:"مدفوعات مكتملة",value:e.completedPayments,color:G.secondary,percentage:e.totalRevenue>0?(e.completedPayments/e.totalRevenue*100).toFixed(1):"0"},{name:"مدفوعات جزئية",value:e.partialPayments,color:G.warning,percentage:e.totalRevenue>0?(e.partialPayments/e.totalRevenue*100).toFixed(1):"0"},{name:"مبالغ آجلة",value:e.pendingAmount||0,color:G.danger,percentage:e.totalRevenue>0?((e.pendingAmount||0)/e.totalRevenue*100).toFixed(1):"0"},{name:"مبالغ متبقية",value:e.remainingBalances,color:G.purple,percentage:e.totalRevenue>0?(e.remainingBalances/e.totalRevenue*100).toFixed(1):"0"}].filter(e=>e.value>0)},[u,G]),Q=t.useMemo(()=>{if(!u)return[];const{expenses:e,calculations:t}=u;return[{name:"طلبات المخابر",value:e.labOrdersTotal,color:G.primary,percentage:t.totalExpenses>0?(e.labOrdersTotal/t.totalExpenses*100).toFixed(1):"0"},{name:"احتياجات العيادة",value:e.clinicNeedsTotal,color:G.secondary,percentage:t.totalExpenses>0?(e.clinicNeedsTotal/t.totalExpenses*100).toFixed(1):"0"},{name:"تكلفة المخزون",value:e.inventoryExpenses,color:G.warning,percentage:t.totalExpenses>0?(e.inventoryExpenses/t.totalExpenses*100).toFixed(1):"0"},{name:"مصروفات مباشرة",value:e.clinicExpensesTotal||0,color:G.danger,percentage:t.totalExpenses>0?((e.clinicExpensesTotal||0)/t.totalExpenses*100).toFixed(1):"0"}].filter(e=>e.value>0)},[u,G]),te=t.useMemo(()=>{if(!u)return[];const{revenue:e,calculations:t}=u;return[{name:"الإيرادات",value:e.totalRevenue,type:"revenue"},{name:"المصروفات",value:t.totalExpenses,type:"expenses"},{name:"صافي الربح",value:t.isProfit?t.netProfit:-t.lossAmount,type:"profit"}]},[u]),se=t.useMemo(()=>{if(!u)return e.jsx("div",{children:"Loading charts..."});const{revenue:t,expenses:n,calculations:r,details:l,filterInfo:i}=u,c={tooltip:{backgroundColor:h?"#1f2937":"#ffffff",border:"1px solid "+(h?"#374151":"#e5e7eb"),borderRadius:"8px",color:h?"#f9fafb":"#111827"},grid:{strokeDasharray:"3 3",stroke:h?"#374151":"#e5e7eb",strokeOpacity:.5}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع الإيرادات"})]}),e.jsxs(y,{children:["توزيع الإيرادات حسب نوع المدفوعات (",U.length," فئة)"]})]}),e.jsxs(b,{children:[0===U.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد بيانات إيرادات متاحة"})]})}):e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:U,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percentage:t})=>`${e}: ${t}%`,outerRadius:100,innerRadius:40,fill:"#8884d8",dataKey:"value",stroke:h?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:U.map((t,s)=>e.jsx(He,{fill:t.color},`revenue-${s}`))}),e.jsx(Ge,{formatter:e=>[Number(e).toLocaleString("ar-EG",{style:"currency",currency:o}),"المبلغ"],labelFormatter:e=>`نوع الإيراد: ${e}`,contentStyle:c.tooltip})]})}),U.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-2 text-sm",children:U.map((t,s)=>e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsxs("span",{className:"text-muted-foreground",children:[t.name,": ",e.jsx(Pe,{amount:t.value,currency:o})," (",t.percentage,"%)"]})]},`revenue-legend-${s}`))})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(qe,{className:"w-5 h-5"}),e.jsx("span",{children:"توزيع المصروفات"})]}),e.jsxs(y,{children:["توزيع المصروفات حسب النوع (",Q.length," فئة)"]})]}),e.jsxs(b,{children:[0===Q.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد مصروفات متاحة"})]})}):e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ke,{margin:{top:20,right:30,left:20,bottom:20},children:[e.jsx(We,{data:Q,cx:"50%",cy:"50%",labelLine:!1,label:({name:e,percentage:t})=>`${e}: ${t}%`,outerRadius:100,innerRadius:40,fill:"#8884d8",dataKey:"value",stroke:h?"#1f2937":"#ffffff",strokeWidth:2,paddingAngle:2,children:Q.map((t,s)=>e.jsx(He,{fill:t.color},`expense-${s}`))}),e.jsx(Ge,{formatter:e=>[Number(e).toLocaleString("ar-EG",{style:"currency",currency:o}),"المبلغ"],labelFormatter:e=>`نوع المصروف: ${e}`,contentStyle:c.tooltip})]})}),Q.length>0&&e.jsx("div",{className:"mt-4 grid grid-cols-2 gap-2 text-sm",children:Q.map((t,s)=>e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsxs("span",{className:"text-muted-foreground",children:[t.name,": ",e.jsx(Pe,{amount:t.value,currency:o})," (",t.percentage,"%)"]})]},`expense-legend-${s}`))})]})]})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(rt,{className:"w-5 h-5"}),e.jsx("span",{children:"مقارنة الإيرادات والمصروفات"})]}),e.jsx(y,{children:"مقارنة شاملة بين الإيرادات والمصروفات وصافي الربح/الخسارة"})]}),e.jsxs(b,{children:[e.jsx(Ye,{width:"100%",height:400,children:e.jsxs(Ue,{data:te,margin:{top:20,right:30,left:20,bottom:20},barCategoryGap:"20%",children:[e.jsx(Xe,{strokeDasharray:c.grid.strokeDasharray,stroke:c.grid.stroke,strokeOpacity:c.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"name",tick:{fontSize:14,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"},tickLine:{stroke:h?"#4b5563":"#d1d5db"}}),e.jsx(Je,{tick:{fontSize:14,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"},tickLine:{stroke:h?"#4b5563":"#d1d5db"},tickFormatter:e=>Math.abs(e)>=1e3?`${(e/1e3).toFixed(0)}k`:a(e)}),e.jsx(Ge,{formatter:e=>[Number(e).toLocaleString("ar-EG",{style:"currency",currency:o}),"المبلغ"],labelFormatter:e=>e,contentStyle:c.tooltip}),e.jsx(Qe,{dataKey:"value",radius:[4,4,0,0],minPointSize:5,maxBarSize:100,isAnimationActive:!1,animationDuration:0,children:te.map((t,s)=>e.jsx(He,{fill:"revenue"===t.type?G.secondary:"expenses"===t.type?G.danger:t.value>=0?G.secondary:G.danger},`comparison-${s}`))})]})}),e.jsxs("div",{className:"mt-4 grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{className:"text-center p-3 bg-green-50 dark:bg-green-950/50 rounded",children:[e.jsx("div",{className:"text-xs text-green-600 dark:text-green-400",children:"الإيرادات"}),e.jsx("div",{className:"font-semibold text-green-700 dark:text-green-300",children:e.jsx(Pe,{amount:t.totalRevenue,currency:o})})]}),e.jsxs("div",{className:"text-center p-3 bg-red-50 dark:bg-red-950/50 rounded",children:[e.jsx("div",{className:"text-xs text-red-600 dark:text-red-400",children:"المصروفات"}),e.jsx("div",{className:"font-semibold text-red-700 dark:text-red-300",children:e.jsx(Pe,{amount:r.totalExpenses,currency:o})})]}),e.jsxs("div",{className:"text-center p-3 rounded "+(r.isProfit?"bg-blue-50 dark:bg-blue-950/50":"bg-orange-50 dark:bg-orange-950/50"),children:[e.jsx("div",{className:"text-xs "+(r.isProfit?"text-blue-600 dark:text-blue-400":"text-orange-600 dark:text-orange-400"),children:r.isProfit?"صافي الربح":"صافي الخسارة"}),e.jsx("div",{className:"font-semibold "+(r.isProfit?"text-blue-700 dark:text-blue-300":"text-orange-700 dark:text-orange-300"),children:e.jsx(Pe,{amount:r.isProfit?r.netProfit:r.lossAmount,currency:o})})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",dir:"rtl",children:[e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(re,{className:"w-5 h-5"}),e.jsx("span",{children:"حالات المدفوعات"})]}),e.jsxs(y,{children:["توزيع المدفوعات حسب الحالة (",s.length," مدفوعة)"]})]}),e.jsx(b,{children:(()=>{const t=[{name:"مكتملة",value:s.filter(e=>"completed"===e.status).length,color:G.secondary,amount:s.filter(e=>"completed"===e.status).reduce((e,t)=>e+(t.amount||0),0)},{name:"جزئية",value:s.filter(e=>"partial"===e.status).length,color:G.warning,amount:s.filter(e=>"partial"===e.status).reduce((e,t)=>e+(t.amount||0),0)},{name:"آجلة",value:s.filter(e=>"pending"===e.status).length,color:G.danger,amount:s.filter(e=>"pending"===e.status).reduce((e,t)=>e+(t.total_amount_due||t.amount||0),0)}].filter(e=>e.value>0);return 0===t.length?e.jsx("div",{className:"flex items-center justify-center h-80 text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(re,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد مدفوعات متاحة"})]})}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{width:"100%",height:300,children:e.jsxs(Ue,{data:t,margin:{top:20,right:30,left:20,bottom:20},barCategoryGap:"20%",children:[e.jsx(Xe,{strokeDasharray:c.grid.strokeDasharray,stroke:c.grid.stroke,strokeOpacity:c.grid.strokeOpacity}),e.jsx(Ze,{dataKey:"name",tick:{fontSize:14,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"},tickLine:{stroke:h?"#4b5563":"#d1d5db"}}),e.jsx(Je,{tick:{fontSize:14,fill:h?"#9ca3af":"#6b7280"},axisLine:{stroke:h?"#4b5563":"#d1d5db"},tickLine:{stroke:h?"#4b5563":"#d1d5db"}}),e.jsx(Ge,{formatter:(e,t,s)=>[`${e} مدفوعة`,"العدد",Number(s?.payload?.amount??0).toLocaleString("ar-EG",{style:"currency",currency:o})],labelFormatter:e=>`الحالة: ${e}`,contentStyle:c.tooltip}),e.jsx(Qe,{dataKey:"value",radius:[4,4,0,0],minPointSize:5,maxBarSize:80,children:t.map((t,s)=>e.jsx(He,{fill:t.color},`status-${s}`))})]})}),e.jsx("div",{className:"mt-4 grid grid-cols-3 gap-2 text-sm",children:t.map((t,s)=>e.jsxs("div",{className:"text-center p-2 bg-muted/50 rounded",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:t.name}),e.jsxs("div",{className:"font-semibold",children:[t.value," مدفوعة"]}),e.jsx("div",{className:"text-xs",children:e.jsx(Pe,{amount:t.amount,currency:o})})]},`status-summary-${s}`))})]})})()})]}),e.jsxs(p,{dir:"rtl",children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(lt,{className:"w-5 h-5"}),e.jsx("span",{children:"تحليل الربحية"})]}),e.jsx(y,{children:"تحليل مفصل لهامش الربح والأداء المالي"})]}),e.jsx(b,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-4xl font-bold mb-2",children:e.jsxs("span",{className:r.isProfit?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400",children:[r.profitMargin.toFixed(1),"%"]})}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"هامش الربح"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"الأداء المالي"}),e.jsx("span",{className:r.isProfit?"text-green-600":"text-red-600",children:r.isProfit?"ربح":"خسارة"})]}),e.jsx("div",{className:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3",children:e.jsx("div",{className:"h-3 rounded-full transition-all duration-300 "+(r.isProfit?"bg-green-500":"bg-red-500"),style:{width:`${Math.min(Math.abs(r.profitMargin),100)}%`}})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"p-3 bg-blue-50 dark:bg-blue-950/50 rounded",children:[e.jsx("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:"نسبة المصروفات"}),e.jsxs("div",{className:"font-semibold text-blue-700 dark:text-blue-300",children:[t.totalRevenue>0?(r.totalExpenses/t.totalRevenue*100).toFixed(1):"0","%"]})]}),e.jsxs("div",{className:"p-3 bg-purple-50 dark:bg-purple-950/50 rounded",children:[e.jsx("div",{className:"text-xs text-purple-600 dark:text-purple-400",children:"كفاءة التكلفة"}),e.jsxs("div",{className:"font-semibold text-purple-700 dark:text-purple-300",children:[r.totalExpenses>0?(t.totalRevenue/r.totalExpenses*100).toFixed(0):"0","%"]})]}),e.jsxs("div",{className:"p-3 bg-teal-50 dark:bg-teal-950/50 rounded",children:[e.jsx("div",{className:"text-xs text-teal-600 dark:text-teal-400",children:"متوسط المعاملة"}),e.jsx("div",{className:"font-semibold text-teal-700 dark:text-teal-300",children:e.jsx(Pe,{amount:s.length>0?t.totalRevenue/s.length:0,currency:o})})]}),e.jsxs("div",{className:"p-3 bg-orange-50 dark:bg-orange-950/50 rounded",children:[e.jsx("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:"المبالغ الآجلة"}),e.jsx("div",{className:"font-semibold text-orange-700 dark:text-orange-300",children:e.jsx(Pe,{amount:t.pendingAmount||0,currency:o})})]})]})]})})]})]})]})},[u,U,Q,te,G,o,h,s]);if(T||!u)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ut,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري حساب التقرير الشامل..."})]})});const{revenue:ae,expenses:ne,calculations:le,details:ie,filterInfo:ce}=u;return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground flex items-center gap-3",children:[e.jsx(ut,{className:"w-6 h-6"}),"التقرير الشامل للأرباح والخسائر"]}),e.jsxs("p",{className:"text-muted-foreground mt-1",children:["تحليل مالي شامل يربط جميع جوانب العيادة - ",ce.dateRange]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(F,{variant:"outline",size:"sm",onClick:H,disabled:O||!u,children:[e.jsx(Ve,{className:"w-4 h-4 ml-2"}),O?"جاري التصدير...":"تصدير PDF"]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:W,disabled:O||!u,children:[e.jsx($t,{className:"w-4 h-4 ml-2"}),O?"جاري التصدير...":"تصدير اكسل"]})]})]}),e.jsxs(p,{className:Se("blue"),children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center gap-3",children:[e.jsx(Ft,{className:`w-5 h-5 ${Ee("blue")}`}),"فلترة التقرير"]}),e.jsx(y,{children:"اختر الفترة الزمنية للتقرير الشامل للأرباح والخسائر"})]}),e.jsx(b,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"period",children:"الفترة الزمنية"}),e.jsxs(k,{value:v,onValueChange:e=>N(e),children:[e.jsx(A,{children:e.jsx(C,{placeholder:"اختر الفترة الزمنية"})}),e.jsx(S,{children:Object.entries(Mt).map(([t,s])=>e.jsx(P,{value:t,children:s},t))})]})]}),"custom"===v&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"startDate",children:"تاريخ البداية"}),e.jsx($,{id:"startDate",type:"date",value:_,onChange:e=>D(e.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"endDate",children:"تاريخ النهاية"}),e.jsx($,{id:"endDate",type:"date",value:E,onChange:e=>M(e.target.value)})]})]})]})})]}),e.jsxs(p,{className:le.isProfit?Se("green"):Se("red"),children:[e.jsx(g,{children:e.jsx(j,{className:"flex items-center gap-3 text-xl",children:le.isProfit?e.jsxs(e.Fragment,{children:[e.jsx(lt,{className:`w-6 h-6 ${Ee("green")}`}),e.jsx("span",{children:"ربح"}),e.jsxs(m,{variant:"secondary",className:"bg-green-100 text-green-800",children:[le.profitMargin.toFixed(1),"%"]})]}):e.jsxs(e.Fragment,{children:[e.jsx(it,{className:`w-6 h-6 ${Ee("red")}`}),e.jsx("span",{children:"خسارة"}),e.jsx(m,{variant:"destructive",children:"خسارة"})]})})}),e.jsxs(b,{children:[e.jsx("div",{className:"text-3xl font-bold",children:le.isProfit?e.jsx(Pe,{amount:le.netProfit,currency:o}):e.jsx(Pe,{amount:le.lossAmount,currency:o})}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:le.isProfit?`صافي الربح بنسبة ${le.profitMargin.toFixed(1)}%`:"إجمالي الخسارة من العمليات"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{className:Se("blue"),children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-3",children:[e.jsx(lt,{className:`w-5 h-5 ${Ee("blue")}`}),"إجمالي الإيرادات"]})}),e.jsxs(b,{className:"space-y-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:e.jsx(Pe,{amount:ae.totalRevenue,currency:o})}),e.jsx(me,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"المدفوعات المكتملة"}),e.jsx(Pe,{amount:ae.completedPayments,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"المدفوعات الجزئية"}),e.jsx(Pe,{amount:ae.partialPayments,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"المبالغ المتبقية"}),e.jsx(Pe,{amount:ae.remainingBalances,currency:o})]})]})]})]}),e.jsxs(p,{className:Se("red"),children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-3",children:[e.jsx(it,{className:`w-5 h-5 ${Ee("red")}`}),"إجمالي المصروفات"]})}),e.jsxs(b,{className:"space-y-4",children:[e.jsx("div",{className:"text-2xl font-bold",children:e.jsx(Pe,{amount:le.totalExpenses,currency:o})}),e.jsx(me,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"مدفوعات المخابر"}),e.jsx(Pe,{amount:ne.labOrdersTotal,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"متبقي المخابر"}),e.jsx(Pe,{amount:ne.labOrdersRemaining,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"احتياجات العيادة"}),e.jsx(Pe,{amount:ne.clinicNeedsTotal,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"متبقي الاحتياجات"}),e.jsx(Pe,{amount:ne.clinicNeedsRemaining,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"قيمة المخزون"}),e.jsx(Pe,{amount:ne.inventoryExpenses,currency:o})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"مصروفات العيادة المباشرة"}),e.jsx(Pe,{amount:ne.clinicExpensesTotal||0,currency:o})]})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(p,{className:Se("purple"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Be,{className:`w-8 h-8 ${Ee("purple")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي المرضى"}),e.jsx("p",{className:"text-xl font-bold",children:ie.totalPatients})]})]})})}),e.jsx(p,{className:Se("orange"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Z,{className:`w-8 h-8 ${Ee("orange")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"المواعيد"}),e.jsx("p",{className:"text-xl font-bold",children:ie.totalAppointments})]})]})})}),e.jsx(p,{className:Se("cyan"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(wt,{className:`w-8 h-8 ${Ee("cyan")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"طلبات المخابر"}),e.jsx("p",{className:"text-xl font-bold",children:ie.totalLabOrders})]})]})})}),e.jsx(p,{className:Se("indigo"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ht,{className:`w-8 h-8 ${Ee("indigo")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"احتياجات العيادة"}),e.jsx("p",{className:"text-xl font-bold",children:ie.totalClinicNeeds})]})]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{className:"text-lg",children:"متوسط الإيرادات لكل مريض"})}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:e.jsx(Pe,{amount:ie.averageRevenuePerPatient,currency:o})})})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{className:"text-lg",children:"متوسط الإيرادات لكل موعد"})}),e.jsx(b,{children:e.jsx("div",{className:"text-2xl font-bold",children:e.jsx(Pe,{amount:ie.averageRevenuePerAppointment,currency:o})})})]})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsx(j,{className:"text-lg",children:"معلومات التقرير"})}),e.jsx(b,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"الفترة المحددة: "}),e.jsx("span",{className:"font-medium",children:Mt[v]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"نطاق التواريخ: "}),e.jsx("span",{className:"font-medium",children:ce.dateRange})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"إجمالي السجلات: "}),e.jsx("span",{className:"font-medium",children:ce.totalRecords})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"السجلات المفلترة: "}),e.jsx("span",{className:"font-medium",children:ce.filteredRecords})]})]})})]}),se]})}function is(){const{currency:s}=V(),{payments:a}=ee(),{expenses:n}=De(),{appointments:r}=J(),{items:l}=X(),{patients:i}=Y(),{needs:c,totalValue:d}=ke(),{labOrders:o}=Ce(),{toothTreatments:m}=ie(),{prescriptions:h}=xe(),{reportData:u,patientReports:f,appointmentReports:v,financialReports:N,inventoryReports:_,clinicNeedsReports:D,isLoading:E,isExporting:M,error:R,activeReportType:O,currentFilter:I,generateReport:L,generateAllReports:z,setActiveReportType:B,setFilter:q,exportReport:K,clearError:W}=fe(),[H,G]=t.useState("overview"),[U,Q]=t.useState("this_month"),[te,se]=t.useState(""),[le,ce]=t.useState(""),[oe,me]=t.useState(!1),je=e=>{if("number"==typeof e)return isNaN(e)||!isFinite(e)?0:e;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)||!isFinite(t)?0:t}if("object"==typeof e&&null!==e){const t=Number(e);return isNaN(t)||!isFinite(t)?0:t}return 0},ye=(e,t)=>Array.isArray(e)?e.reduce((e,s)=>e+je(t(s)),0):0,ve=(e,t)=>{if("all"===U)return e;const s=new Date;let a,n=new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59);switch(U){case"today":a=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0);break;case"this_week":const t=s.getDay();a=new Date(s.getTime()-24*t*60*60*1e3),a.setHours(0,0,0,0);break;case"this_month":a=new Date(s.getFullYear(),s.getMonth(),1,0,0,0);break;case"this_year":a=new Date(s.getFullYear(),0,1,0,0,0);break;case"last_week":const r=new Date(s.getTime()-24*s.getDay()*60*60*1e3);r.setHours(23,59,59,999),n=r,a=new Date(r.getTime()-5184e5),a.setHours(0,0,0,0);break;case"last_month":const l=0===s.getMonth()?11:s.getMonth()-1,i=0===s.getMonth()?s.getFullYear()-1:s.getFullYear();a=new Date(i,l,1,0,0,0),n=new Date(s.getFullYear(),s.getMonth(),0,23,59,59);break;case"last_year":a=new Date(s.getFullYear()-1,0,1,0,0,0),n=new Date(s.getFullYear()-1,11,31,23,59,59);break;case"last_30_days":a=new Date(s.getTime()-2592e6),a.setHours(0,0,0,0);break;case"last_90_days":a=new Date(s.getTime()-7776e6),a.setHours(0,0,0,0);break;case"custom":if(!te||!le)return e;a=new Date(te),n=new Date(le),n.setHours(23,59,59,999);break;default:return e}return e.filter(e=>{const s=new Date(e[t]);return s>=a&&s<=n})},Ne=ve(r,"start_time"),be=ve(a,"payment_date"),we=ve(l,"created_at"),$e=ve(c,"created_at"),Fe=ve(n,"payment_date"),Me=ye(be.filter(e=>{const t=e.status?.toLowerCase();return"pending"===t||"آجل"===t||"unpaid"===t||!e.status&&je(e.amount)>0&&!e.amount_paid}),e=>{let t=je(e.amount);if(e.tooth_treatment_id){t=je(e.treatment_total_cost)||je(e.total_amount_due)}else 0===t&&je(e.total_amount_due)>0?t=je(e.total_amount_due):0===t&&je(e.remaining_balance)>0&&(t=je(e.remaining_balance));return t});t.useEffect(()=>{console.log("🔄 Loading initial reports..."),W(),z();(async()=>{try{const{loadAppointments:e}=J.getState(),{loadPayments:t}=ee.getState(),{loadItems:s}=X.getState(),{loadPatients:a}=Y.getState(),{loadNeeds:n}=ke.getState(),{loadLabOrders:r}=Ce.getState(),{loadToothTreatments:l}=ie.getState(),{loadPrescriptions:i}=xe.getState();console.log("🔄 Loading all data for comprehensive reports..."),await Promise.all([e(),t(),s(),a(),n(),r(),l(),i()]),console.log("✅ All data loaded successfully for reports")}catch(e){console.error("❌ Error loading data for reports:",e)}})()},[z,W]),t.useEffect(()=>{if(R){console.error("❌ Reports error:",R);const e=new CustomEvent("showToast",{detail:{title:"خطأ في التقارير",description:R,type:"error"}});window.dispatchEvent(e)}},[R]);return _e(["overview"]),t.useEffect(()=>{const{startAutoRefresh:e,stopAutoRefresh:t}=fe.getState();return e(1),()=>{t()}},[]),t.useEffect(()=>{B(H)},[H,B]),e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"التقارير والتحليلات"}),e.jsx(Rt,{isActive:!0})]}),e.jsx("p",{className:"text-muted-foreground",children:"تقارير شاملة ومفصلة لجميع جوانب العيادة - تحديث تلقائي في الوقت الفعلي"})]})}),e.jsx(Ot,{}),R&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(T,{className:"h-5 w-5 text-red-600 ml-2"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-red-800",children:"خطأ في تحميل التقارير"}),e.jsx("p",{className:"text-sm text-red-700 mt-1",children:R})]}),e.jsx(F,{variant:"ghost",size:"sm",onClick:W,className:"mr-auto",children:"إغلاق"})]})}),E&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(x,{className:"h-8 w-8 animate-spin text-sky-600 mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"جاري تحميل التقارير..."})]})}),e.jsxs(he,{value:H,onValueChange:async e=>{G(e),B(e);try{if("treatments"===e){const{loadToothTreatments:e}=ie.getState(),{loadPatients:t}=Y.getState();await Promise.all([e(),t()])}else if("clinicNeeds"===e){const{loadNeeds:e}=ke.getState();await e()}else if("inventory"===e){const{loadItems:e}=X.getState();await e()}else if("financial"===e){const{loadPayments:e}=ee.getState(),{loadLabOrders:t}=Ce.getState();await Promise.all([e(),t()])}else if("profitLoss"===e){const{loadPayments:e}=ee.getState(),{loadExpenses:t}=De.getState(),{loadLabOrders:s}=Ce.getState(),{loadNeeds:a}=ke.getState(),{loadItems:n}=X.getState();await Promise.all([e(),t(),s(),a(),n()])}else if("patients"===e){const{loadPatients:e}=Y.getState();await e()}else if("appointments"===e){const{loadAppointments:e}=J.getState();await e()}else if("expenses"===e){const{loadExpenses:e}=De.getState();await e()}"overview"!==e&&await L(e)}catch(t){console.error(`❌ Error loading data for ${e} tab:`,t)}},className:"space-y-6",children:[e.jsxs(ue,{className:"grid w-full grid-cols-6",children:[e.jsxs(pe,{value:"overview",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(ut,{className:"w-4 h-4"}),e.jsx("span",{children:"التقرير الشامل المفصل"})]}),e.jsxs(pe,{value:"profitLoss",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(lt,{className:"w-4 h-4"}),e.jsx("span",{children:"المالية"})]}),e.jsxs(pe,{value:"patients",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(Be,{className:"w-4 h-4"}),e.jsx("span",{children:"المرضى"})]}),e.jsxs(pe,{value:"appointments",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsx("span",{children:"المواعيد"})]}),e.jsxs(pe,{value:"expenses",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{children:"المصروفات"})]}),e.jsxs(pe,{value:"treatments",className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx(de,{className:"w-4 h-4"}),e.jsx("span",{children:"العلاجات"})]})]}),e.jsx(ge,{value:"overview",className:"space-y-6",dir:"rtl",children:e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground flex items-center gap-3",children:[e.jsx(rt,{className:"w-6 h-6"}),"التقرير الشامل المفصل"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"نظرة شاملة على أداء العيادة"})]}),e.jsxs(F,{variant:"outline",onClick:async()=>{me(!0);try{console.log("🔄 Loading fresh data for comprehensive export...");const{loadAppointments:e}=J.getState(),{loadPayments:t}=ee.getState(),{loadExpenses:s}=De.getState(),{loadItems:d}=X.getState(),{loadPatients:x}=Y.getState(),{loadNeeds:u}=ke.getState(),{loadLabOrders:p}=Ce.getState(),{loadToothTreatments:g}=ie.getState(),{loadPrescriptions:f}=xe.getState();await Promise.all([e(),t(),s(),d(),x(),u(),p(),g(),f()]),console.log("✅ All data loaded, starting filtered export..."),await Tt.exportComprehensiveReport({patients:i,appointments:r,payments:a,inventory:l,treatments:m||[],prescriptions:h||[],labOrders:o||[],clinicNeeds:c||[],expenses:n||[],timePeriod:U,customStartDate:"custom"===U?te:void 0,customEndDate:"custom"===U?le:void 0});let j="تم تصدير التقرير الشامل المفصل بنجاح!";j+=` (${Mt[U]})`;j+=` - ${r.length+a.length+(m?.length||0)+(h?.length||0)+(o?.length||0)+(c?.length||0)} سجل إجمالي`,ct.exportSuccess(j)}catch(e){console.error("Error exporting comprehensive report:",e),ct.exportError("فشل في تصدير التقرير الشامل")}finally{me(!1)}},disabled:oe,className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"w-4 h-4"}),oe?"جاري التصدير...":"تصدير التقرير"]})]}),e.jsxs(p,{className:Se("blue"),children:[e.jsxs(g,{children:[e.jsxs(j,{className:"flex items-center gap-3",children:[e.jsx(Ft,{className:`w-5 h-5 ${Ee("blue")}`}),"فلترة التقرير"]}),e.jsx(y,{children:"اختر الفترة الزمنية للتقرير الشامل"})]}),e.jsx(b,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"period",children:"الفترة الزمنية"}),e.jsxs(k,{value:U,onValueChange:e=>Q(e),children:[e.jsx(A,{children:e.jsx(C,{placeholder:"اختر الفترة الزمنية"})}),e.jsx(S,{children:Object.entries(Mt).map(([t,s])=>e.jsx(P,{value:t,children:s},t))})]})]}),"custom"===U&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"startDate",children:"تاريخ البداية"}),e.jsx($,{id:"startDate",type:"date",value:te,onChange:e=>se(e.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"endDate",children:"تاريخ النهاية"}),e.jsx($,{id:"endDate",type:"date",value:le,onChange:e=>ce(e.target.value)})]})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",dir:"rtl",children:[e.jsx(p,{className:Se("blue"),children:e.jsx(b,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-lg ${Se("blue")}`,children:e.jsx(Be,{className:`w-6 h-6 ${Ee("blue")}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي المرضى"}),e.jsx("p",{className:"text-2xl font-bold",children:i.length})]})]})})}),e.jsx(p,{className:Se("purple"),children:e.jsx(b,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-lg ${Se("purple")}`,children:e.jsx(Z,{className:`w-6 h-6 ${Ee("purple")}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"المواعيد المفلترة"}),e.jsx("p",{className:"text-2xl font-bold",children:Ne.length})]})]})})}),e.jsx(p,{className:Se("green"),children:e.jsx(b,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-lg ${Se("green")}`,children:e.jsx(ne,{className:`w-6 h-6 ${Ee("green")}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"الواردات المفلترة"}),e.jsx("p",{className:"text-xl font-bold",children:e.jsx(Pe,{amount:ye(be,e=>je(e.amount)),currency:s})})]})]})})}),e.jsx(p,{className:Se("orange"),children:e.jsx(b,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-lg ${Se("orange")}`,children:e.jsx(ht,{className:`w-6 h-6 ${Ee("orange")}`})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"عناصر المخزون المفلترة"}),e.jsx("p",{className:"text-2xl font-bold",children:we.length})]})]})})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"w-5 h-5 text-green-500"}),"الملخص المالي"]})}),e.jsxs(b,{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 bg-green-50/80 dark:bg-green-950/50 border border-green-200/50 dark:border-green-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("span",{className:"text-sm font-medium text-green-800 dark:text-green-200",children:"الواردات المفلترة"}),e.jsx("span",{className:"text-lg font-bold text-green-700 dark:text-green-100",children:e.jsx(Pe,{amount:ye(be,e=>je(e.amount)),currency:s})})]}),e.jsxs("div",{className:"flex justify-between items-center p-4 bg-yellow-50/80 dark:bg-yellow-950/50 border border-yellow-200/50 dark:border-yellow-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("span",{className:"text-sm font-medium text-yellow-800 dark:text-yellow-200",children:"الإيرادات الآجلة المفلترة"}),e.jsx("span",{className:"text-lg font-bold text-yellow-700 dark:text-yellow-100",children:e.jsx(Pe,{amount:je(Me),currency:s})})]}),e.jsxs("div",{className:"flex justify-between items-center p-4 bg-orange-50/80 dark:bg-orange-950/50 border border-orange-200/50 dark:border-orange-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("span",{className:"text-sm font-medium text-orange-800 dark:text-orange-200",children:"الإيرادات الجزئية المفلترة"}),e.jsx("span",{className:"text-lg font-bold text-orange-700 dark:text-orange-100",children:e.jsx(Pe,{amount:ye(be.filter(e=>"partial"===e.status),e=>{const t=je(e.total_amount_due)||je(e.amount),s=je(e.amount_paid)||je(e.amount);return Math.max(0,t-s)}),currency:s})})]}),e.jsxs("div",{className:"flex justify-between items-center p-4 bg-red-50/80 dark:bg-red-950/50 border border-red-200/50 dark:border-red-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("span",{className:"text-sm font-medium text-red-800 dark:text-red-200",children:"المصروفات المفلترة"}),e.jsx("span",{className:"text-lg font-bold text-red-700 dark:text-red-100",children:e.jsx(Pe,{amount:ye(Fe,e=>je(e.amount)),currency:s})})]})]})]}),e.jsxs(p,{children:[e.jsx(g,{children:e.jsxs(j,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-5 h-5 text-blue-500"}),"إحصائيات سريعة"]})}),e.jsx(b,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-blue-50/80 dark:bg-blue-950/50 border border-blue-200/50 dark:border-blue-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-700 dark:text-blue-100",children:Ne.filter(e=>"completed"===e.status).length}),e.jsx("div",{className:"text-xs text-blue-600 dark:text-blue-200 mt-1 font-medium",children:"مواعيد مكتملة مفلترة"})]}),e.jsxs("div",{className:"text-center p-4 bg-purple-50/80 dark:bg-purple-950/50 border border-purple-200/50 dark:border-purple-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-700 dark:text-purple-100",children:Ne.filter(e=>"scheduled"===e.status).length}),e.jsx("div",{className:"text-xs text-purple-600 dark:text-purple-200 mt-1 font-medium",children:"مواعيد مجدولة مفلترة"})]}),e.jsxs("div",{className:"text-center p-4 bg-emerald-50/80 dark:bg-emerald-950/50 border border-emerald-200/50 dark:border-emerald-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-700 dark:text-emerald-100",children:$e.length}),e.jsx("div",{className:"text-xs text-emerald-600 dark:text-emerald-200 mt-1 font-medium",children:"احتياجات العيادة المفلترة"})]}),e.jsxs("div",{className:"text-center p-4 bg-orange-50/80 dark:bg-orange-950/50 border border-orange-200/50 dark:border-orange-700/50 rounded-lg backdrop-blur-sm",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-700 dark:text-orange-100",children:Fe.length}),e.jsx("div",{className:"text-xs text-orange-600 dark:text-orange-200 mt-1 font-medium",children:"مصروفات مفلترة"})]})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(p,{className:Se("cyan"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($t,{className:`w-6 h-6 ${Ee("cyan")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"العلاجات"}),e.jsx("p",{className:"text-xl font-bold",children:m?.length||0})]})]})})}),e.jsx(p,{className:Se("indigo"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($t,{className:`w-6 h-6 ${Ee("indigo")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"الوصفات"}),e.jsx("p",{className:"text-xl font-bold",children:h?.length||0})]})]})})}),e.jsx(p,{className:Se("purple"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(wt,{className:`w-6 h-6 ${Ee("purple")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"طلبات المخابر"}),e.jsx("p",{className:"text-xl font-bold",children:o?.length||0})]})]})})}),e.jsx(p,{className:Se("gray"),children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{className:`w-6 h-6 ${Ee("gray")}`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"احتياجات العيادة المفلترة"}),e.jsx("p",{className:"text-xl font-bold",children:$e.length})]})]})})})]})]})}),e.jsx(ge,{value:"patients",dir:"rtl",children:e.jsx(Et,{children:e.jsx(It,{})})}),e.jsx(ge,{value:"appointments",dir:"rtl",children:e.jsx(Et,{children:e.jsx(zt,{})})}),e.jsx(ge,{value:"financial",dir:"rtl",children:e.jsx(Et,{children:e.jsx(Xt,{})})}),e.jsx(ge,{value:"treatments",dir:"rtl",children:e.jsx(Et,{children:e.jsx(Qt,{})})}),e.jsx(ge,{value:"inventory",dir:"rtl",children:e.jsx(Et,{children:e.jsx(Lt,{})})}),e.jsx(ge,{value:"clinicNeeds",dir:"rtl",children:e.jsx(Et,{children:e.jsx(as,{})})}),e.jsx(ge,{value:"expenses",dir:"rtl",children:e.jsx(Et,{children:e.jsx(ns,{})})}),e.jsx(ge,{value:"profitLoss",dir:"rtl",children:e.jsx(Et,{children:e.jsx(ls,{})})})]})]})}export{is as default};
