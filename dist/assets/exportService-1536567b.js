import{h as e,E as t}from"./pdf-991f41f6.js";import{E as n}from"./excel-37615a09.js";import{K as a,r as l,b6 as i,bw as o}from"./index-3a8dc84c.js";class r{static generateFileName(e,t,n){const a=new Date,l=`${a.getDate().toString().padStart(2,"0")}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getFullYear()}`,i=a.toTimeString().split(" ")[0].replace(/:/g,"-");let o=`${{patients:"تقرير_المرضى",appointments:"تقرير_المواعيد",financial:"التقرير_المالي",inventory:"تقرير_المخزون",analytics:"تقرير_التحليلات",overview:"التقرير_الشامل",comprehensive:"التقرير_الشامل_المفصل",treatments:"تقرير_العلاجات"}[e]||`تقرير_${e}`}_${l}`;return n?.includeTime&&(o+=`_${i}`),n?.customSuffix&&(o+=`_${n.customSuffix}`),`${o}.${t}`}static async exportReport(e,t,n){try{switch(n.format){case"pdf":return await this.exportToPDF(e,t,n);case"excel":return await this.exportToExcel(e,t,n);case"csv":return await this.exportToCSV(e,t,n);default:throw new Error("Unsupported export format")}}catch(a){throw console.error("Export error:",a),a}}static async exportToPDF(e,t,n){try{const a=this.createReportHTML(e,t,n),l=this.generateFileName(e,"pdf",{includeTime:!0});return await this.convertHTMLToPDF(a,l),l}catch(a){throw console.error("Error exporting to PDF:",a),new Error("فشل في تصدير التقرير إلى PDF")}}static async convertHTMLToPDF(n,a){try{const l=document.createElement("div");l.innerHTML=n,l.style.position="absolute",l.style.left="-9999px",l.style.top="-9999px",l.style.width="800px",l.style.fontFamily="Arial, sans-serif",l.style.direction="rtl",l.style.fontSize="14px",l.style.lineHeight="1.6",l.style.color="#000",l.style.background="#fff",l.style.padding="20px",document.body.appendChild(l),await new Promise(e=>setTimeout(e,100));const i=await e(l,{scale:2,useCORS:!0,allowTaint:!0,backgroundColor:"#ffffff",width:800,height:l.scrollHeight,scrollX:0,scrollY:0});document.body.removeChild(l);const o=i.toDataURL("image/png"),r=new t({orientation:"portrait",unit:"mm",format:"a4"}),s=r.internal.pageSize.getWidth(),d=r.internal.pageSize.getHeight(),c=s-20,u=i.height*c/i.width;let m=u,p=10;for(r.addImage(o,"PNG",10,p,c,u),m-=d-20;m>=0;)p=m-u+10,r.addPage(),r.addImage(o,"PNG",10,p,c,u),m-=d-20;r.save(a)}catch(l){throw console.error("Error converting HTML to PDF:",l),new Error("فشل في تحويل التقرير إلى PDF")}}static createReportHTML(e,t,n){const a="undefined"!=typeof window?window:void 0,l=a?.__CLINIC_SETTINGS__||a?.clinicSettings||void 0,i=l?.clinic_name&&""!==String(l.clinic_name).trim()?String(l.clinic_name):void 0,o={patients:"تقرير المرضى",appointments:"تقرير المواعيد",financial:"التقرير المالي",inventory:"تقرير المخزون",analytics:"تقرير التحليلات",overview:"التقرير الشامل"}[e]||"تقرير";return`\n      <!DOCTYPE html>\n      <html dir="rtl" lang="ar">\n      <head>\n        <meta charset="UTF-8">\n        <title>${o}</title>\n        <style>\n          body {\n            font-family: 'Arial', sans-serif;\n            direction: rtl;\n            margin: 0;\n            padding: 20px;\n            background: #fff;\n            color: #000;\n            line-height: 1.6;\n          }\n          .header {\n            text-align: center;\n            border-bottom: 2px solid #0ea5e9;\n            padding-bottom: 20px;\n            margin-bottom: 30px;\n          }\n          .clinic-name {\n            font-size: 24px;\n            font-weight: bold;\n            color: #0ea5e9;\n            margin-bottom: 10px;\n          }\n          .report-title {\n            font-size: 20px;\n            font-weight: bold;\n            color: #1e293b;\n            margin-bottom: 5px;\n          }\n          .report-date {\n            font-size: 14px;\n            color: #64748b;\n          }\n          .summary-cards {\n            display: flex;\n            justify-content: space-around;\n            margin: 30px 0;\n            flex-wrap: wrap;\n          }\n          .summary-card {\n            background: #f8fafc;\n            padding: 20px;\n            border-radius: 8px;\n            text-align: center;\n            min-width: 150px;\n            margin: 5px;\n            border: 1px solid #e2e8f0;\n          }\n          .summary-card h3 {\n            margin: 0 0 10px 0;\n            font-size: 16px;\n            color: #1e293b;\n          }\n          .summary-card .number {\n            font-size: 24px;\n            font-weight: bold;\n            color: #0ea5e9;\n          }\n          .section {\n            margin: 30px 0;\n          }\n          .section-title {\n            font-size: 18px;\n            font-weight: bold;\n            color: #0ea5e9;\n            margin-bottom: 15px;\n            border-bottom: 1px solid #e2e8f0;\n            padding-bottom: 5px;\n          }\n          table {\n            width: 100%;\n            border-collapse: collapse;\n            margin: 20px 0;\n          }\n          th, td {\n            padding: 12px;\n            text-align: center;\n            border: 1px solid #e2e8f0;\n          }\n          th {\n            background: #f8fafc;\n            font-weight: bold;\n            color: #1e293b;\n          }\n          .footer {\n            margin-top: 40px;\n            text-align: center;\n            font-size: 12px;\n            color: #64748b;\n            border-top: 1px solid #e2e8f0;\n            padding-top: 20px;\n          }\n        </style>\n      </head>\n      <body>\n        <div class="header">\n          <div class="clinic-name">${"عيادة الأسنان"+(i?" - "+i:"")}</div>\n          <div class="report-title">${o}</div>\n          <div class="report-date">${(()=>{const e=new Date;return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`})()}</div>\n        </div>\n\n        ${this.generateReportContent(e,t,n)}\n\n        <div class="footer">\n          تم إنشاء هذا التقرير بواسطة نظام إدارة العيادة - ${(()=>{const e=new Date;return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`})()}\n        </div>\n      </body>\n      </html>\n    `}static generateReportContent(e,t,n){switch(e){case"patients":return this.generatePatientReportContent(t,n);case"appointments":return this.generateAppointmentReportContent(t,n);case"financial":return this.generateFinancialReportContent(t,n);case"inventory":return this.generateInventoryReportContent(t,n);case"labs":return this.generateLabReportContent(t,n);case"clinic-expenses":return this.generateClinicExpensesReportContent(t,n);case"overview":return this.generateOverviewReportContent(t,n);default:return'<div class="section">لا توجد بيانات متاحة</div>'}}static generatePatientReportContent(e,t){return`\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>إجمالي المرضى</h3>\n          <div class="number">${e.totalPatients||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المرضى الجدد</h3>\n          <div class="number">${e.newPatientsThisMonth||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المرضى النشطون</h3>\n          <div class="number">${e.activePatients||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>متوسط العمر</h3>\n          <div class="number">${e.averageAge||0} سنة</div>\n        </div>\n      </div>\n\n      ${e.ageDistribution&&e.ageDistribution.length>0?`\n      <div class="section">\n        <div class="section-title">توزيع الأعمار</div>\n        <table>\n          <thead>\n            <tr>\n              <th>الفئة العمرية</th>\n              <th>العدد</th>\n              <th>النسبة المئوية</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.ageDistribution.map(t=>`\n              <tr>\n                <td>${t.ageGroup||t.range}</td>\n                <td>${t.count}</td>\n                <td>${(t.count/e.totalPatients*100).toFixed(1)}%</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n\n      ${e.genderDistribution&&e.genderDistribution.length>0?`\n      <div class="section">\n        <div class="section-title">توزيع الجنس</div>\n        <table>\n          <thead>\n            <tr>\n              <th>الجنس</th>\n              <th>العدد</th>\n              <th>النسبة المئوية</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.genderDistribution.map(t=>`\n              <tr>\n                <td>${"male"===t.gender?"ذكر":"أنثى"}</td>\n                <td>${t.count}</td>\n                <td>${(t.count/e.totalPatients*100).toFixed(1)}%</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n\n      ${t.includeDetails&&e.patients&&e.patients.length>0?`\n      <div class="section">\n        <div class="section-title">تفاصيل المرضى</div>\n        <table>\n          <thead>\n            <tr>\n              <th>الاسم الكامل</th>\n              <th>الهاتف</th>\n              <th>العمر</th>\n              <th>الجنس</th>\n              <th>#</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.patients.slice(0,50).map(e=>`\n              <tr>\n                <td>${e.full_name||"غير محدد"}</td>\n                <td>${e.phone||"غير محدد"}</td>\n                <td>${e.age||"غير محدد"}</td>\n                <td>${"male"===e.gender?"ذكر":"أنثى"}</td>\n                <td>${e.serial_number||"غير محدد"}</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n    `}static generateAppointmentReportContent(e,t){return`\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>إجمالي المواعيد</h3>\n          <div class="number">${e.totalAppointments||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المكتملة</h3>\n          <div class="number">${e.completedAppointments||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>الملغية</h3>\n          <div class="number">${e.cancelledAppointments||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>معدل الحضور</h3>\n          <div class="number">${e.attendanceRate?.toFixed(1)||0}%</div>\n        </div>\n      </div>\n\n      ${e.appointmentsByStatus&&e.appointmentsByStatus.length>0?`\n      <div class="section">\n        <div class="section-title">توزيع المواعيد حسب الحالة</div>\n        <table>\n          <thead>\n            <tr>\n              <th>الحالة</th>\n              <th>العدد</th>\n              <th>النسبة المئوية</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.appointmentsByStatus.map(e=>`\n              <tr>\n                <td>${this.translateStatus(e.status)}</td>\n                <td>${e.count}</td>\n                <td>${e.percentage?.toFixed(1)||0}%</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n    `}static generateFinancialReportContent(e,t){return`\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>إجمالي الإيرادات</h3>\n          <div class="number">${a(e.totalRevenue||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المدفوعات المكتملة</h3>\n          <div class="number">${a(e.completedPayments||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المدفوعات الآجلة</h3>\n          <div class="number">${a(e.pendingPayments||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المدفوعات المتأخرة</h3>\n          <div class="number">${a(e.overduePayments||0)}</div>\n        </div>\n      </div>\n\n      ${e.paymentMethodStats&&e.paymentMethodStats.length>0?`\n      <div class="section">\n        <div class="section-title">إحصائيات طرق الدفع</div>\n        <table>\n          <thead>\n            <tr>\n              <th>طريقة الدفع</th>\n              <th>المبلغ</th>\n              <th>عدد المعاملات</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.paymentMethodStats.map(e=>`\n              <tr>\n                <td>${this.translatePaymentMethod(e.method)}</td>\n                <td>${a(e.amount)}</td>\n                <td>${e.count}</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n    `}static generateInventoryReportContent(e,t){return`\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>إجمالي الأصناف</h3>\n          <div class="number">${e.totalItems||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>القيمة الإجمالية</h3>\n          <div class="number">${a(e.totalValue||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>أصناف منخفضة المخزون</h3>\n          <div class="number" style="color: #f59e0b;">${e.lowStockItems||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>أصناف منتهية الصلاحية</h3>\n          <div class="number" style="color: #ef4444;">${e.expiredItems||0}</div>\n        </div>\n      </div>\n\n      ${e.itemsByCategory&&e.itemsByCategory.length>0?`\n      <div class="section">\n        <div class="section-title">توزيع الأصناف حسب الفئة</div>\n        <table>\n          <thead>\n            <tr>\n              <th>الفئة</th>\n              <th>عدد الأصناف</th>\n              <th>القيمة</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.itemsByCategory.map(e=>`\n              <tr>\n                <td>${e.category}</td>\n                <td>${e.count}</td>\n                <td>${a(e.value)} $</td>\n              </tr>\n            `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n    `}static generateLabReportContent(e,t){return`\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>إجمالي المختبرات</h3>\n          <div class="number">${e.totalLabs||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>إجمالي الطلبات</h3>\n          <div class="number">${e.totalOrders||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>إجمالي التكلفة</h3>\n          <div class="number">${a(e.totalCost||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>إجمالي المدفوع</h3>\n          <div class="number">${a(e.totalPaid||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>إجمالي المتبقي</h3>\n          <div class="number">${a(e.totalRemaining||0)}</div>\n        </div>\n      </div>\n\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>الطلبات الآجلة</h3>\n          <div class="number" style="color: #f59e0b;">${e.pendingOrders||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>الطلبات المكتملة</h3>\n          <div class="number" style="color: #10b981;">${e.completedOrders||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>الطلبات الملغية</h3>\n          <div class="number" style="color: #ef4444;">${e.cancelledOrders||0}</div>\n        </div>\n        <div class="summary-card">\n          <h3>متوسط التكلفة</h3>\n          <div class="number">${a((e.totalOrders||0)>0?(e.totalCost||0)/(e.totalOrders||1):0)}</div>\n        </div>\n      </div>\n\n      ${e.labsList&&e.labsList.length>0?`\n      <div class="section">\n        <div class="section-title">قائمة المختبرات</div>\n        <table>\n          <thead>\n            <tr>\n              <th>اسم المختبر</th>\n              <th>معلومات الاتصال</th>\n              <th>العنوان</th>\n              <th>عدد الطلبات</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.labsList.slice(0,20).map(t=>{const n=e.labOrdersList?e.labOrdersList.filter(e=>e.lab_id===t.id).length:0;return`\n                <tr>\n                  <td>${t.name||"غير محدد"}</td>\n                  <td>${t.contact_info||"غير محدد"}</td>\n                  <td>${t.address||"غير محدد"}</td>\n                  <td>${n}</td>\n                </tr>\n              `}).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n\n      ${t.includeDetails&&e.labOrdersList&&e.labOrdersList.length>0?`\n      <div class="section">\n        <div class="section-title">تفاصيل طلبات المختبرات</div>\n        <table>\n          <thead>\n            <tr>\n              <th>اسم المختبر</th>\n              <th>اسم المريض</th>\n              <th>نوع الخدمة</th>\n              <th>التكلفة</th>\n              <th>المدفوع</th>\n              <th>المتبقي</th>\n              <th>الحالة</th>\n              <th>تاريخ الطلب</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.labOrdersList.slice(0,30).map(e=>`\n                <tr>\n                  <td>${e.lab?.name||"غير محدد"}</td>\n                  <td>${e.patient?.full_name||"غير محدد"}</td>\n                  <td>${e.service_name||"غير محدد"}</td>\n                  <td>${a(e.cost||0)}</td>\n                  <td>${a(e.paid_amount||0)}</td>\n                  <td>${a(e.remaining_balance||0)}</td>\n                  <td>${"مكتمل"===e.status?"مكتمل":"آجل"===e.status?"آجل":"ملغي"}</td>\n                  <td>${e.order_date?new Date(e.order_date).toLocaleDateString("ar-SA"):"غير محدد"}</td>\n                </tr>\n              `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n    `}static generateClinicExpensesReportContent(e,t){return`\n      <div class="summary-cards">\n        <div class="summary-card">\n          <h3>إجمالي المصروفات</h3>\n          <div class="number">${a(e.totalExpenses||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المصروفات المدفوعة</h3>\n          <div class="number" style="color: #10b981;">${a(e.paidExpenses||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المصروفات الآجلة</h3>\n          <div class="number" style="color: #f59e0b;">${a(e.pendingExpenses||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المصروفات المتأخرة</h3>\n          <div class="number" style="color: #ef4444;">${a(e.overdueExpenses||0)}</div>\n        </div>\n        <div class="summary-card">\n          <h3>المصروفات الملغية</h3>\n          <div class="number">${a(e.cancelledExpenses||0)}</div>\n        </div>\n      </div>\n\n      ${e.expensesByType&&e.expensesByType.length>0?`\n      <div class="section">\n        <div class="section-title">توزيع المصروفات حسب النوع</div>\n        <table>\n          <thead>\n            <tr>\n              <th>نوع المصروف</th>\n              <th>المبلغ</th>\n              <th>عدد المعاملات</th>\n              <th>النسبة المئوية</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.expensesByType.map(e=>`\n                <tr>\n                  <td>${{salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"}[e.type]||e.type}</td>\n                  <td>${a(e.amount)}</td>\n                  <td>${e.count}</td>\n                  <td>${e.percentage?.toFixed(1)||0}%</td>\n                </tr>\n              `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n\n      ${e.expensesByPaymentMethod&&e.expensesByPaymentMethod.length>0?`\n      <div class="section">\n        <div class="section-title">توزيع المصروفات حسب طريقة الدفع</div>\n        <table>\n          <thead>\n            <tr>\n              <th>طريقة الدفع</th>\n              <th>المبلغ</th>\n              <th>عدد المعاملات</th>\n              <th>النسبة المئوية</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.expensesByPaymentMethod.map(e=>`\n                <tr>\n                  <td>${{cash:"نقدي",bank_transfer:"تحويل بنكي",check:"شيك",credit_card:"بطاقة ائتمان"}[e.method]||e.method}</td>\n                  <td>${a(e.amount)}</td>\n                  <td>${e.count}</td>\n                  <td>${e.percentage?.toFixed(1)||0}%</td>\n                </tr>\n              `).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n\n      ${t.includeDetails&&e.expensesList&&e.expensesList.length>0?`\n      <div class="section">\n        <div class="section-title">تفاصيل المصروفات</div>\n        <table>\n          <thead>\n            <tr>\n              <th>اسم المصروف</th>\n              <th>نوع المصروف</th>\n              <th>المبلغ</th>\n              <th>طريقة الدفع</th>\n              <th>تاريخ الدفع</th>\n              <th>المورد</th>\n              <th>الحالة</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${e.expensesList.slice(0,30).map(e=>{const t={salary:"راتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"}[e.expense_type]||e.expense_type,n={cash:"نقدي",bank_transfer:"تحويل بنكي",check:"شيك",credit_card:"بطاقة ائتمان"}[e.payment_method]||e.payment_method,l={paid:"مدفوع",pending:"آجل",overdue:"متأخر",cancelled:"ملغي"}[e.status]||e.status,i=e.payment_date?new Date(e.payment_date).toLocaleDateString("ar-SA"):"غير محدد",o=e.vendor||"غير محدد";return`\n                <tr>\n                  <td>${e.expense_name||"غير محدد"}</td>\n                  <td>${t}</td>\n                  <td>${a(e.amount||0)}</td>\n                  <td>${n}</td>\n                  <td>${i}</td>\n                  <td>${o}</td>\n                  <td>${l}</td>\n                </tr>\n              `}).join("")}\n          </tbody>\n        </table>\n      </div>\n      `:""}\n    `}static generateOverviewReportContent(e,t){return`\n      <div class="section">\n        <div class="section-title">ملخص شامل للعيادة</div>\n        <div class="summary-cards">\n          ${e.patients?`\n          <div class="summary-card">\n            <h3>المرضى</h3>\n            <div class="number">${e.patients.totalPatients||0}</div>\n          </div>\n          `:""}\n          ${e.appointments?`\n          <div class="summary-card">\n            <h3>المواعيد</h3>\n            <div class="number">${e.appointments.totalAppointments||0}</div>\n          </div>\n          `:""}\n          ${e.financial?`\n          <div class="summary-card">\n            <h3>الإيرادات</h3>\n            <div class="number">${a(e.financial.totalRevenue||0)}</div>\n          </div>\n          `:""}\n          ${e.inventory?`\n          <div class="summary-card">\n            <h3>المخزون</h3>\n            <div class="number">${e.inventory.totalItems||0}</div>\n          </div>\n          `:""}\n        </div>\n      </div>\n\n      ${e.patients?this.generatePatientReportContent(e.patients,t):""}\n      ${e.appointments?this.generateAppointmentReportContent(e.appointments,t):""}\n      ${e.financial?this.generateFinancialReportContent(e.financial,t):""}\n      ${e.inventory?this.generateInventoryReportContent(e.inventory,t):""}\n    `}static translateStatus(e){return{scheduled:"مجدول",completed:"مكتمل",cancelled:"ملغي","no-show":"عدم حضور","in-progress":"قيد التنفيذ"}[e]||e}static translatePaymentMethod(e){return{cash:"نقدي",card:"بطاقة ائتمان",bank_transfer:"تحويل بنكي",insurance:"تأمين",installment:"تقسيط"}[e]||e}static getPaymentStatusInArabic(e){return{completed:"مكتمل",partial:"جزئي",pending:"آجل",overdue:"متأخر",cancelled:"ملغي"}[e]||e}static addPDFHeader(e,t,n){const a=e.internal.pageSize.getWidth();e.setFontSize(24),e.setFont("helvetica","bold"),e.text("عيادة الأسنان الحديثة",a/2,20,{align:"center"}),e.setFontSize(18),e.setFont("helvetica","normal");e.text({patients:"تقرير المرضى",appointments:"تقرير المواعيد",financial:"التقرير المالي",inventory:"تقرير المخزون",analytics:"تقرير التحليلات",overview:"التقرير الشامل"}[t]||"تقرير",a/2,35,{align:"center"}),e.setFontSize(12);const l=new Date,i=`${l.getDate().toString().padStart(2,"0")}/${(l.getMonth()+1).toString().padStart(2,"0")}/${l.getFullYear()}`;e.text(`تاريخ التقرير: ${i}`,a-20,45,{align:"right"}),e.setLineWidth(.5),e.line(20,48,a-20,48)}static addPDFFooter(e,t){const n=e.internal.pageSize.getWidth(),a=e.internal.pageSize.getHeight();e.setFontSize(10),e.setFont("helvetica","normal"),e.text("تم إنشاء هذا التقرير بواسطة نظام إدارة العيادة",n/2,a-10,{align:"center"})}static async addPatientReportToPDF(e,t,n,a){const l=e.internal.pageSize.getWidth();return e.setFontSize(14),e.setFont("helvetica","bold"),e.text("ملخص إحصائيات المرضى",20,n),n+=15,e.setFontSize(12),e.setFont("helvetica","normal"),e.text(`إجمالي المرضى: ${t.totalPatients||0}`,20,n),e.text(`المرضى الجدد هذا الشهر: ${t.newPatientsThisMonth||0}`,150,n),n+=10,e.text(`المرضى النشطون: ${t.activePatients||0}`,20,n),e.text(`متوسط العمر: ${t.averageAge||0} سنة`,150,n),n+=20,a.includeCharts&&t.ageDistribution&&(e.setFont("helvetica","bold"),e.text("توزيع الأعمار",20,n),n+=10,t.ageDistribution.forEach(t=>{e.setFont("helvetica","normal"),e.text(`${t.range}: ${t.count} مريض`,30,n),n+=8}),n+=10),a.includeDetails&&t.patients&&(e.setFont("helvetica","bold"),e.text("تفاصيل المرضى",20,n),n+=15,e.setFontSize(10),e.text("الاسم الكامل",20,n),e.text("الهاتف",80,n),e.text("العمر",130,n),e.text("الجنس",170,n),e.text("#",220,n),e.line(20,n+2,l-20,n+2),n+=10,e.setFont("helvetica","normal"),t.patients.slice(0,20).forEach(t=>{n>250&&(e.addPage(),n=30),e.text(t.full_name||"غير محدد",20,n),e.text(t.phone||"غير محدد",80,n),e.text(t.age?.toString()||"غير محدد",130,n),e.text("male"===t.gender?"ذكر":"أنثى",170,n),e.text(t.serial_number||"غير محدد",220,n),n+=8})),n+20}static async addAppointmentReportToPDF(e,t,n,a){return e.internal.pageSize.getWidth(),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("ملخص إحصائيات المواعيد",20,n),n+=15,e.setFontSize(12),e.setFont("helvetica","normal"),e.text(`إجمالي المواعيد: ${t.totalAppointments||0}`,20,n),e.text(`المواعيد المكتملة: ${t.completedAppointments||0}`,150,n),n+=10,e.text(`المواعيد الملغية: ${t.cancelledAppointments||0}`,20,n),e.text(`معدل الحضور: ${t.attendanceRate||0}%`,150,n),n+=20,a.includeCharts&&t.appointmentsByStatus&&(e.setFont("helvetica","bold"),e.text("توزيع حالات المواعيد",20,n),n+=10,t.appointmentsByStatus.forEach(t=>{e.setFont("helvetica","normal"),e.text(`${t.status}: ${t.count} موعد`,30,n),n+=8}),n+=10),n+20}static async addFinancialReportToPDF(e,t,n,l){return e.internal.pageSize.getWidth(),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("ملخص الإحصائيات المالية",20,n),n+=15,e.setFontSize(12),e.setFont("helvetica","normal"),e.text(`إجمالي الإيرادات: ${a(t.totalRevenue||0)}`,20,n),e.text(`المدفوعات المكتملة: ${a(t.completedPayments||0)}`,150,n),n+=10,e.text(`المدفوعات الآجلة: ${a(t.pendingPayments||0)}`,20,n),e.text(`المدفوعات المتأخرة: ${a(t.overduePayments||0)}`,150,n),n+=20,l.includeCharts&&t.paymentMethodStats&&(e.setFont("helvetica","bold"),e.text("توزيع طرق الدفع",20,n),n+=10,t.paymentMethodStats.forEach(t=>{e.setFont("helvetica","normal"),e.text(`${t.method}: ${a(t.amount)} (${t.count} معاملة)`,30,n),n+=8}),n+=10),l.includeCharts&&t.monthlyRevenue&&(e.setFont("helvetica","bold"),e.text("الإيرادات الشهرية",20,n),n+=10,t.monthlyRevenue.slice(-6).forEach(t=>{e.setFont("helvetica","normal"),e.text(`${t.month}: ${a(t.revenue)}`,30,n),n+=8}),n+=10),n+20}static async addInventoryReportToPDF(e,t,n,l){return e.internal.pageSize.getWidth(),e.setFontSize(14),e.setFont("helvetica","bold"),e.text("ملخص إحصائيات المخزون",20,n),n+=15,e.setFontSize(12),e.setFont("helvetica","normal"),e.text(`إجمالي العناصر: ${t.totalItems||0}`,20,n),e.text(`القيمة الإجمالية: ${a(t.totalValue||0)}`,150,n),n+=10,e.text(`عناصر منخفضة المخزون: ${t.lowStockItems||0}`,20,n),e.text(`عناصر منتهية الصلاحية: ${t.expiredItems||0}`,150,n),n+=10,e.text(`عناصر نفدت من المخزون: ${t.outOfStockItems||0}`,20,n),e.text(`معدل دوران المخزون: ${t.turnoverRate||0}%`,150,n),n+=20,l.includeCharts&&t.topCategories&&(e.setFont("helvetica","bold"),e.text("أعلى الفئات استهلاكاً",20,n),n+=10,t.topCategories.slice(0,5).forEach(t=>{e.setFont("helvetica","normal"),e.text(`${t.name}: ${t.count} عنصر`,30,n),n+=8}),n+=10),n+20}static async addOverviewReportToPDF(e,t,n,a){return t.patients&&(n=await this.addPatientReportToPDF(e,t.patients,n,a)),t.appointments&&(n>200&&(e.addPage(),n=30),n=await this.addAppointmentReportToPDF(e,t.appointments,n,a)),t.financial&&(n>200&&(e.addPage(),n=30),n=await this.addFinancialReportToPDF(e,t.financial,n,a)),t.inventory&&(n>200&&(e.addPage(),n=30),n=await this.addInventoryReportToPDF(e,t.inventory,n,a)),n}static async exportToExcel(e,t,a){const l=new n.Workbook;switch(l.creator="نظام إدارة العيادة",l.created=new Date,l.modified=new Date,e){case"patients":await this.addPatientReportToExcel(l,t,a);break;case"appointments":await this.addAppointmentReportToExcel(l,t,a);break;case"financial":await this.addFinancialReportToExcel(l,t,a);break;case"inventory":await this.addInventoryReportToExcel(l,t,a);break;case"labs":await this.addLabReportToExcel(l,t,a);break;case"clinic-needs":await this.addClinicNeedsReportToExcel(l,t,a);break;case"clinic-expenses":await this.addClinicExpensesReportToExcel(l,t,a);break;case"profit-loss":await this.addProfitLossReportToExcel(l,t,a);break;case"overview":await this.addOverviewReportToExcel(l,t,a)}const i=this.generateFileName(e,"xlsx",{includeTime:!0}),o=await l.xlsx.writeBuffer(),r=new Blob([o],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=document.createElement("a"),d=URL.createObjectURL(r);return s.setAttribute("href",d),s.setAttribute("download",`${i}.xlsx`),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),i}static async addPatientReportToExcel(e,t,n){const a=e.addWorksheet("تقرير المرضى");a.mergeCells("A1:F1");const l=a.getCell("A1");if(l.value="تقرير المرضى - عيادة الأسنان الحديثة",l.font={size:16,bold:!0},l.alignment={horizontal:"center"},a.getCell("A3").value="ملخص الإحصائيات",a.getCell("A3").font={bold:!0},a.getCell("A4").value="إجمالي المرضى:",a.getCell("B4").value=t.totalPatients||0,a.getCell("A5").value="المرضى الجدد هذا الشهر:",a.getCell("B5").value=t.newPatientsThisMonth||0,a.getCell("A6").value="المرضى النشطون:",a.getCell("B6").value=t.activePatients||0,a.getCell("A7").value="متوسط العمر:",a.getCell("B7").value=`${t.averageAge||0} سنة`,n.includeDetails&&t.patients){let e=10;a.getCell(`A${e}`).value="تفاصيل المرضى",a.getCell(`A${e}`).font={bold:!0},e+=2;["#","الاسم الكامل","الجنس","العمر","الهاتف","البريد الإلكتروني","تاريخ التسجيل"].forEach((t,n)=>{const l=a.getCell(e,n+1);l.value=t,l.font={bold:!0},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}}),e++,t.patients.forEach(t=>{const n="male"===t.gender?"ذكر":"أنثى",l=t.created_at?new Date(t.created_at).toLocaleDateString("en-GB"):"";a.getCell(e,1).value=t.serial_number||"",a.getCell(e,2).value=t.full_name||"",a.getCell(e,3).value=n,a.getCell(e,4).value=t.age||"",a.getCell(e,5).value=t.phone||"",a.getCell(e,6).value=t.email||"",a.getCell(e,7).value=l,e++})}a.columns.forEach(e=>{e.width=15})}static async addFinancialReportToExcel(e,t,n){const l=e.addWorksheet("التقرير المالي");l.mergeCells("A1:H1");const i=l.getCell("A1");i.value="التقرير المالي الشامل - عيادة الأسنان الحديثة",i.font={size:16,bold:!0},i.alignment={horizontal:"center"},l.getCell("A3").value="ملخص الإحصائيات المالية",l.getCell("A3").font={bold:!0},l.getCell("A4").value="إجمالي الإيرادات:",l.getCell("B4").value=`${a(t.totalRevenue||0)}`,l.getCell("A5").value="المدفوعات المكتملة:",l.getCell("B5").value=`${a(t.completedPayments||0)}`,l.getCell("A6").value="المدفوعات الآجلة:",l.getCell("B6").value=`${a(t.pendingPayments||0)}`,l.getCell("A7").value="المدفوعات المتأخرة:",l.getCell("B7").value=`${a(t.overduePayments||0)}`,l.getCell("D4").value="إجمالي المصروفات:",l.getCell("E4").value=`${a(t.totalExpenses||0)}`,l.getCell("D5").value="صافي الربح:",l.getCell("E5").value=`${a(t.netProfit||0)}`,l.getCell("D6").value="هامش الربح:",l.getCell("E6").value=`${(t.profitMargin||0).toFixed(2)}%`,l.getCell("D7").value="حالة الربحية:",l.getCell("E7").value=(t.netProfit||0)>=0?"ربح":"خسارة";let o=10;t.paymentMethodStats&&(l.getCell(`A${o}`).value="توزيع طرق الدفع",l.getCell(`A${o}`).font={bold:!0},o+=2,l.getCell(o,1).value="طريقة الدفع",l.getCell(o,2).value="المبلغ",l.getCell(o,3).value="عدد المعاملات",l.getRow(o).font={bold:!0},o++,t.paymentMethodStats.forEach(e=>{l.getCell(o,1).value=e.method,l.getCell(o,2).value=`${a(e.amount)}`,l.getCell(o,3).value=e.count,o++}),o+=2),t.expensesByType&&t.expensesByType.length>0&&(l.getCell(`D${o}`).value="توزيع المصروفات حسب النوع",l.getCell(`D${o}`).font={bold:!0},o+=2,l.getCell(o,4).value="نوع المصروف",l.getCell(o,5).value="المبلغ",l.getCell(o,6).value="النسبة المئوية",l.getRow(o).font={bold:!0},o++,t.expensesByType.forEach(e=>{l.getCell(o,4).value=e.type,l.getCell(o,5).value=`${a(e.amount)}`,l.getCell(o,6).value=`${e.percentage.toFixed(2)}%`,o++}),o+=2),t.recentExpenses&&t.recentExpenses.length>0&&(l.getCell(`A${o}`).value="المصروفات الحديثة (آخر 10 مصروفات)",l.getCell(`A${o}`).font={bold:!0},o+=2,l.getCell(o,1).value="اسم المصروف",l.getCell(o,2).value="النوع",l.getCell(o,3).value="المبلغ",l.getCell(o,4).value="طريقة الدفع",l.getCell(o,5).value="تاريخ الدفع",l.getCell(o,6).value="المورد",l.getRow(o).font={bold:!0},o++,t.recentExpenses.slice(0,10).forEach(e=>{l.getCell(o,1).value=e.expense_name||"غير محدد",l.getCell(o,2).value={salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"}[e.expense_type]||e.expense_type||"غير محدد",l.getCell(o,3).value=`${a(e.amount||0)}`,l.getCell(o,4).value={cash:"نقداً",bank_transfer:"تحويل بنكي",check:"شيك",credit_card:"بطاقة ائتمان"}[e.payment_method]||e.payment_method||"غير محدد",l.getCell(o,5).value=e.payment_date?new Date(e.payment_date).toLocaleDateString("en-GB"):"غير محدد",l.getCell(o,6).value=e.vendor||"غير محدد",o++})),l.columns.forEach(e=>{e.width=20})}static async addClinicExpensesReportToExcel(e,t,n){const l=e.addWorksheet("مصروفات العيادة");l.views=[{rightToLeft:!0}];let i=1;l.mergeCells(i,1,i,7);const o=l.getCell(i,1);if(o.value="تقرير مصروفات العيادة",o.font={name:"Arial",size:18,bold:!0},o.alignment={horizontal:"center",vertical:"middle"},o.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},o.font.color={argb:"FFFFFFFF"},l.getRow(i).height=30,i+=2,t.summary){l.mergeCells(i,1,i,7);const e=l.getCell(i,1);e.value="ملخص المصروفات",e.font={name:"Arial",size:14,bold:!0},e.alignment={horizontal:"center"},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE7E6E6"}},i++,Object.entries(t.summary).forEach(([e,t])=>{l.getCell(i,1).value=e,l.getCell(i,2).value=t,l.getCell(i,1).font={name:"Arial",size:11,bold:!0},l.getCell(i,2).font={name:"Arial",size:11},i++}),i++}if(["اسم المصروف","نوع المصروف","المبلغ","طريقة الدفع","تاريخ الدفع","المورد","الحالة"].forEach((e,t)=>{const n=l.getCell(i,t+1);n.value=e,n.font={name:"Arial",size:12,bold:!0},n.alignment={horizontal:"center",vertical:"middle"},n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFD9E1F2"}},n.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}}),i++,t.expenses&&t.expenses.length>0){const e={salary:"راتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"},n={cash:"نقدي",card:"بطاقة",bank_transfer:"تحويل بنكي",check:"شيك"},o={paid:"مدفوع",pending:"آجل",overdue:"متأخر"};t.expenses.forEach(t=>{l.getCell(i,1).value=t.expense_name||"غير محدد",l.getCell(i,2).value=e[t.expense_type]||t.expense_type||"غير محدد",l.getCell(i,3).value=`${a(t.amount||0)}`,l.getCell(i,4).value=n[t.payment_method]||t.payment_method||"غير محدد",l.getCell(i,5).value=t.payment_date?new Date(t.payment_date).toLocaleDateString("en-GB"):"غير محدد",l.getCell(i,6).value=t.vendor||"غير محدد",l.getCell(i,7).value=o[t.status]||t.status||"غير محدد";for(let e=1;e<=7;e++){const t=l.getCell(i,e);t.font={name:"Arial",size:10},t.alignment={horizontal:"center",vertical:"middle"},t.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}}i++})}l.columns.forEach(e=>{e.width=20})}static async addAppointmentReportToExcel(e,t,n){const a=e.addWorksheet("تقرير المواعيد");a.mergeCells("A1:F1");const l=a.getCell("A1");l.value="تقرير المواعيد - عيادة الأسنان الحديثة",l.font={size:16,bold:!0},l.alignment={horizontal:"center"},a.getCell("A3").value="ملخص إحصائيات المواعيد",a.getCell("A3").font={bold:!0},a.getCell("A4").value="إجمالي المواعيد:",a.getCell("B4").value=t.totalAppointments||0,a.getCell("A5").value="المواعيد المكتملة:",a.getCell("B5").value=t.completedAppointments||0,a.getCell("A6").value="المواعيد الملغية:",a.getCell("B6").value=t.cancelledAppointments||0,a.getCell("A7").value="معدل الحضور:",a.getCell("B7").value=`${t.attendanceRate||0}%`,a.columns.forEach(e=>{e.width=20})}static async addInventoryReportToExcel(e,t,n){const l=e.addWorksheet("تقرير المخزون");l.mergeCells("A1:F1");const i=l.getCell("A1");i.value="تقرير المخزون - عيادة الأسنان الحديثة",i.font={size:16,bold:!0},i.alignment={horizontal:"center"},l.getCell("A3").value="ملخص إحصائيات المخزون",l.getCell("A3").font={bold:!0};const o=t.summary||t;l.getCell("A4").value="إجمالي العناصر:",l.getCell("B4").value=o["إجمالي العناصر"]||t.totalItems||0,l.getCell("A5").value="القيمة الإجمالية:",l.getCell("B5").value=o["القيمة الإجمالية"]||a(t.totalValue||0),l.getCell("A6").value="عناصر منخفضة المخزون:",l.getCell("B6").value=o["عناصر منخفضة المخزون"]||t.lowStockItems||0,l.getCell("A7").value="عناصر منتهية الصلاحية:",l.getCell("B7").value=o["عناصر منتهية الصلاحية"]||t.expiredItems||0,void 0!==o["عناصر نفدت من المخزون"]&&(l.getCell("A8").value="عناصر نفدت من المخزون:",l.getCell("B8").value=o["عناصر نفدت من المخزون"]),void 0!==o["عناصر بدون أسعار"]&&(l.getCell("A9").value="عناصر بدون أسعار:",l.getCell("B9").value=o["عناصر بدون أسعار"]),o["تاريخ التقرير"]&&(l.getCell("A10").value="تاريخ التقرير:",l.getCell("B10").value=o["تاريخ التقرير"]),l.columns.forEach(e=>{e.width=20})}static async addLabReportToExcel(e,t,n){if(!t)return void console.error("No data provided to addLabReportToExcel");const a=e.addWorksheet("تقرير المختبرات");a.mergeCells("A1:F1");const l=a.getCell("A1"),i="undefined"!=typeof window?window:void 0,o=i?.__CLINIC_SETTINGS__||i?.clinicSettings||void 0,r="عيادة الأسنان"+(o?.clinic_name&&""!==String(o.clinic_name).trim()?" - "+String(o.clinic_name):"");l.value=`تقرير المختبرات - ${r}`,l.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2E8B57"}},l.alignment={horizontal:"center",vertical:"middle"},l.border={top:{style:"thick"},left:{style:"thick"},bottom:{style:"thick"},right:{style:"thick"}},a.getCell("A2").value=`تاريخ التقرير: ${(new Date).toLocaleDateString("ar-SA")}`,a.getCell("A2").font={size:12,italic:!0},a.getCell("A2").alignment={horizontal:"right"};let s=4;if(t&&t.summary&&"object"==typeof t.summary){a.getCell(`A${s}`).value="ملخص الإحصائيات",a.getCell(`A${s}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},s+=2;try{const e=Object.entries(t.summary);for(const[t,n]of e){a.getCell(`A${s}`).value=t,a.getCell(`B${s}`).value=n,a.getCell(`A${s}`).font={bold:!0},a.getCell(`B${s}`).font={size:11};const e=a.getCell(`A${s}`);e.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},e.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}},e.alignment={horizontal:"right",vertical:"middle"};const l=a.getCell(`B${s}`);l.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}},l.alignment={horizontal:"right",vertical:"middle"},s++}}catch(d){console.error("Error processing summary data:",d)}s+=2}if(t.labs&&t.labs.length>0){a.getCell(`A${s}`).value="بيانات المختبرات",a.getCell(`A${s}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},s+=2;["اسم المختبر","معلومات الاتصال","العنوان","عدد الطلبات","تاريخ الإضافة"].forEach((e,t)=>{const n=a.getCell(s,t+1);n.value=e,n.font={bold:!0,size:12,color:{argb:"FFFFFFFF"}},n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},n.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}},n.alignment={horizontal:"center",vertical:"middle"}}),s++;try{t.labs.forEach((e,t)=>{[e.name,e.contact_info||"",e.address||"",e.ordersCount||0,new Date(e.created_at).toLocaleDateString("ar-SA")].forEach((e,n)=>{const l=a.getCell(s,n+1);l.value=e,l.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},l.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}})}),s++})}catch(d){console.error("Error processing labs data:",d)}}if(t.labOrders&&t.labOrders.length>0){s+=2,a.getCell(`A${s}`).value="بيانات طلبات المختبرات",a.getCell(`A${s}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},s+=2;["رقم الطلب","اسم المختبر","اسم الخدمة","اسم المريض","التكلفة","المبلغ المدفوع","المبلغ المتبقي","تاريخ الطلب","الحالة","الملاحظات"].forEach((e,t)=>{const n=a.getCell(s,t+1);n.value=e,n.font={bold:!0,size:12,color:{argb:"FFFFFFFF"}},n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},n.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}},n.alignment={horizontal:"center",vertical:"middle"}}),s++;try{t.labOrders.forEach((e,t)=>{[t+1,e.lab?.name||"غير محدد",e.service_name,e.patient?.full_name||"غير محدد",`$${e.cost}`,`$${e.paid_amount||0}`,`$${e.remaining_balance||0}`,new Date(e.order_date).toLocaleDateString("en-GB"),e.status,e.notes||""].forEach((e,n)=>{const l=a.getCell(s,n+1);l.value=e,l.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},l.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),n>=4&&n<=6&&(l.font={bold:!0},l.fill||(l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}}))}),s++})}catch(d){console.error("Error processing lab orders data:",d)}}a.columns.forEach(e=>{e.width=15}),a.getColumn(1).width=20,a.getColumn(2).width=25,a.getColumn(3).width=30,a.getColumn(4).width=15,a.getColumn(5).width=20}static async addClinicNeedsReportToExcel(e,t,n){const a=e.addWorksheet("تقرير احتياجات العيادة");a.mergeCells("A1:H1");const l=a.getCell("A1"),i="undefined"!=typeof window?window:void 0,o=i?.__CLINIC_SETTINGS__||i?.clinicSettings||void 0,r="عيادة الأسنان"+(o?.clinic_name&&""!==String(o.clinic_name).trim()?" - "+String(o.clinic_name):"");l.value=`تقرير احتياجات العيادة - ${r}`,l.font={size:16,bold:!0,color:{argb:"FFFFFFFF"}},l.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2E8B57"}},l.alignment={horizontal:"center",vertical:"middle"},l.border={top:{style:"thick"},left:{style:"thick"},bottom:{style:"thick"},right:{style:"thick"}},a.getCell("A2").value=`تاريخ التقرير: ${(new Date).toLocaleDateString("en-GB")}`,a.getCell("A2").font={size:12,italic:!0},a.getCell("A2").alignment={horizontal:"right"};let s=4;if(t.summary&&(a.getCell(`A${s}`).value="ملخص الإحصائيات",a.getCell(`A${s}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},s+=2,Object.entries(t.summary).forEach(([e,t])=>{a.getCell(`A${s}`).value=e,a.getCell(`B${s}`).value=t,a.getCell(`A${s}`).font={bold:!0},a.getCell(`B${s}`).font={size:11}.B.forEach(e=>{const t=a.getCell(`${e}${s}`);t.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}},t.alignment={horizontal:"right",vertical:"middle"}}),s++}),s+=2),t.needs&&t.needs.length>0){a.getCell(`A${s}`).value="بيانات احتياجات العيادة",a.getCell(`A${s}`).font={size:14,bold:!0,color:{argb:"FF2E8B57"}},s+=2;["#","اسم العنصر","الكمية المطلوبة","الأولوية","الحالة","تاريخ الطلب","تاريخ الاستلام","الملاحظات"].forEach((e,t)=>{const n=a.getCell(s,t+1);n.value=e,n.font={bold:!0,size:12,color:{argb:"FFFFFFFF"}},n.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},n.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}},n.alignment={horizontal:"center",vertical:"middle"}}),s++,t.needs.forEach((e,t)=>{[t+1,e.item_name,e.quantity_needed,{urgent:"عاجل",high:"عالي",medium:"متوسط",low:"منخفض"}[e.priority]||e.priority,{pending:"آجل",ordered:"تم الطلب",received:"تم الاستلام"}[e.status]||e.status,new Date(e.date_needed).toLocaleDateString("en-GB"),e.date_received?new Date(e.date_received).toLocaleDateString("en-GB"):"",e.notes||""].forEach((n,l)=>{const i=a.getCell(s,l+1);if(i.value=n,i.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},i.alignment={horizontal:"right",vertical:"middle"},t%2==0&&(i.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}}),3===l){let t="FFF8F9FA";switch(e.priority){case"urgent":t="FFFFE6E6";break;case"high":t="FFFFF2CC";break;case"medium":t="FFFFFFE6";break;case"low":t="FFE6F7FF"}i.fill={type:"pattern",pattern:"solid",fgColor:{argb:t}}}if(4===l){let t="FFF8F9FA";switch(e.status){case"pending":t="FFFFE6E6";break;case"ordered":t="FFFFF2CC";break;case"received":t="FFE6F7E6"}i.fill={type:"pattern",pattern:"solid",fgColor:{argb:t}}}}),s++})}a.columns.forEach(e=>{e.width=15}),a.getColumn(1).width=12,a.getColumn(2).width=25,a.getColumn(3).width=15,a.getColumn(4).width=12,a.getColumn(5).width=15,a.getColumn(6).width=18,a.getColumn(7).width=18,a.getColumn(8).width=30}static async addOverviewReportToExcel(e,t,n){t.patients&&await this.addPatientReportToExcel(e,t.patients,n),t.appointments&&await this.addAppointmentReportToExcel(e,t.appointments,n),t.financial&&await this.addFinancialReportToExcel(e,t.financial,n),t.inventory&&await this.addInventoryReportToExcel(e,t.inventory,n),t.labs&&await this.addLabReportToExcel(e,t.labs,n),t.clinicNeeds&&await this.addClinicNeedsReportToExcel(e,t.clinicNeeds,n)}static async addProfitLossReportToExcel(e,t,n){const l=e.addWorksheet("تقرير الأرباح والخسائر");l.mergeCells("A1:H1");const i=l.getCell("A1");i.value="التقرير الشامل للأرباح والخسائر - عيادة الأسنان",i.font={size:16,bold:!0},i.alignment={horizontal:"center"},l.getCell("A3").value="ملخص الأرباح والخسائر",l.getCell("A3").font={bold:!0,size:14};let o=5;if(t.summary&&(Object.entries(t.summary).forEach(([e,t])=>{l.getCell(o,1).value=e,l.getCell(o,2).value=t,l.getCell(o,1).font={bold:!0},o++}),o+=2),t.revenue&&(l.getCell(o,1).value="تفاصيل الإيرادات",l.getCell(o,1).font={bold:!0,size:12,color:{argb:"FF059669"}},l.getCell(o,1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE6F7E6"}},o+=2,l.getCell(o,1).value="المدفوعات المكتملة:",l.getCell(o,2).value=a(t.revenue.completedPayments||0),l.getCell(o,1).font={bold:!0},o++,l.getCell(o,1).value="المدفوعات الجزئية:",l.getCell(o,2).value=a(t.revenue.partialPayments||0),l.getCell(o,1).font={bold:!0},o++,l.getCell(o,1).value="المبالغ الآجلة:",l.getCell(o,2).value=a(t.revenue.pendingPayments||0),l.getCell(o,1).font={bold:!0},o++,l.getCell(o,1).value="المبالغ المتبقية من الجزئية:",l.getCell(o,2).value=a(t.revenue.remainingBalances||0),l.getCell(o,1).font={bold:!0},o++,l.getCell(o,1).value="إجمالي الإيرادات:",l.getCell(o,2).value=a(t.revenue.totalRevenue||0),l.getCell(o,1).font={bold:!0,color:{argb:"FF059669"}},l.getCell(o,2).font={bold:!0,color:{argb:"FF059669"}},l.getCell(o,1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}},l.getCell(o,2).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}},o+=3),t.expenses){l.getCell(o,1).value="تفاصيل المصروفات",l.getCell(o,1).font={bold:!0,size:12},o+=2,l.getCell(o,1).value="مدفوعات المخابر:",l.getCell(o,2).value=a(t.expenses.labOrdersTotal||0),o++,l.getCell(o,1).value="متبقي المخابر:",l.getCell(o,2).value=a(t.expenses.labOrdersRemaining||0),o++,l.getCell(o,1).value="احتياجات العيادة:",l.getCell(o,2).value=a(t.expenses.clinicNeedsTotal||0),o++,l.getCell(o,1).value="متبقي الاحتياجات:",l.getCell(o,2).value=a(t.expenses.clinicNeedsRemaining||0),o++,l.getCell(o,1).value="قيمة المخزون:",l.getCell(o,2).value=a(t.expenses.inventoryExpenses||0),o++,l.getCell(o,1).value="مصروفات العيادة المباشرة:",l.getCell(o,2).value=a(t.expenses.clinicExpensesTotal||0),o++;const e=(t.expenses.labOrdersTotal||0)+(t.expenses.labOrdersRemaining||0)+(t.expenses.clinicNeedsTotal||0)+(t.expenses.clinicNeedsRemaining||0)+(t.expenses.inventoryExpenses||0)+(t.expenses.clinicExpensesTotal||0);l.getCell(o,1).value="إجمالي المصروفات:",l.getCell(o,2).value=a(e),l.getCell(o,1).font={bold:!0},l.getCell(o,2).font={bold:!0},o+=3}t.payments&&t.payments.length>0&&this.addPaymentsDetailSheet(e,t.payments),t.labOrders&&t.labOrders.length>0&&this.addLabOrdersDetailSheet(e,t.labOrders),t.clinicNeeds&&t.clinicNeeds.length>0&&this.addClinicNeedsDetailSheet(e,t.clinicNeeds),t.inventoryItems&&t.inventoryItems.length>0&&this.addInventoryDetailSheet(e,t.inventoryItems),t.clinicExpenses&&t.clinicExpenses.length>0&&this.addClinicExpensesDetailSheet(e,t.clinicExpenses),l.columns.forEach(e=>{e.width=25})}static addPaymentsDetailSheet(e,t){const n=e.addWorksheet("تفاصيل المدفوعات"),l=t.filter(e=>"pending"===e.status),i=t.filter(e=>"partial"===e.status),o=l.reduce((e,t)=>e+(t.treatment_total_cost||t.total_amount_due||0),0),r=i.reduce((e,t)=>{const n=t.total_amount_due||t.treatment_total_cost||0;if(n>0){const a=t.amount_paid||t.treatment_total_paid||t.amount||0;return e+Math.max(0,n-a)}return e+(t.treatment_remaining_balance||t.remaining_balance||0)},0);["اسم المريض","المبلغ المدفوع","المبلغ الإجمالي","المبلغ المتبقي","الحالة","طريقة الدفع","تاريخ الدفع","ملاحظات"].forEach((e,t)=>{const a=n.getCell(1,t+1);a.value=e,a.font={bold:!0},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}}),t.forEach((e,t)=>{const l=t+2,i=e.amount||0;let o=0,r=0;if("partial"===e.status)if(o=e.total_amount_due||e.treatment_total_cost||0,o>0){const t=e.amount_paid||e.treatment_total_paid||i;r=Math.max(0,o-t)}else r=e.remaining_balance||e.treatment_remaining_balance||0;else"pending"===e.status?(o=e.total_amount_due||e.treatment_total_cost||i,r=o):(o=i,r=0);n.getCell(l,1).value=e.patient_name||"",n.getCell(l,2).value=a(i),n.getCell(l,3).value=a(o),n.getCell(l,4).value=a(r),n.getCell(l,5).value="completed"===e.status?"مكتمل":"partial"===e.status?"جزئي":"آجل",n.getCell(l,6).value=e.payment_method||"",n.getCell(l,7).value=e.payment_date?new Date(e.payment_date).toLocaleDateString("en-GB"):"",n.getCell(l,8).value=e.notes||""});const s=t.length+4;n.getCell(s,1).value="ملخص المدفوعات الآجلة والمتبقية",n.getCell(s,1).font={bold:!0,size:14},n.mergeCells(s,1,s,8),n.getCell(s+2,1).value="إجمالي المدفوعات الآجلة:",n.getCell(s+2,2).value=a(o),n.getCell(s+2,1).font={bold:!0},n.getCell(s+2,2).font={bold:!0},n.getCell(s+3,1).value="إجمالي المبالغ المتبقية من الدفعات الجزئية:",n.getCell(s+3,2).value=a(r),n.getCell(s+3,1).font={bold:!0},n.getCell(s+3,2).font={bold:!0};const d=o+r;n.getCell(s+4,1).value="إجمالي المبالغ غير المدفوعة:",n.getCell(s+4,2).value=a(d),n.getCell(s+4,1).font={bold:!0,color:{argb:"FFDC2626"}},n.getCell(s+4,2).font={bold:!0,color:{argb:"FFDC2626"}};for(let a=s;a<=s+4;a++)for(let e=1;e<=2;e++){const t=n.getCell(a,e);t.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},a===s?(t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},t.font={bold:!0,size:14,color:{argb:"FFFFFFFF"}}):a>s+1&&(t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}})}n.columns.forEach(e=>{e.width=15})}static addLabOrdersDetailSheet(e,t){const n=e.addWorksheet("تفاصيل طلبات المخابر");["رقم الطلب","اسم المختبر","اسم المريض","التكلفة","المدفوع","المتبقي","الحالة","تاريخ الطلب"].forEach((e,t)=>{const a=n.getCell(1,t+1);a.value=e,a.font={bold:!0},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}}),t.forEach((e,t)=>{const l=t+2;n.getCell(l,1).value=e.id||"",n.getCell(l,2).value=e.lab?.name||"",n.getCell(l,3).value=e.patient?.full_name||"",n.getCell(l,4).value=a(e.cost||0),n.getCell(l,5).value=a(e.paid_amount||0),n.getCell(l,6).value=a((e.cost||0)-(e.paid_amount||0)),n.getCell(l,7).value="completed"===e.status?"مكتمل":"pending"===e.status?"آجل":"ملغي",n.getCell(l,8).value=e.order_date?new Date(e.order_date).toLocaleDateString("en-GB"):""}),n.columns.forEach(e=>{e.width=15})}static addClinicNeedsDetailSheet(e,t){const n=e.addWorksheet("تفاصيل احتياجات العيادة");["اسم العنصر","الكمية","سعر الوحدة","التكلفة الإجمالية","الأولوية","الحالة","التاريخ المطلوب","التاريخ المستلم","ملاحظات"].forEach((e,t)=>{const a=n.getCell(1,t+1);a.value=e,a.font={bold:!0},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}}),t.forEach((e,t)=>{const l=t+2,i=e.quantity||0,o=e.price||0,r=i*o;n.getCell(l,1).value=e.need_name||e.item_name||"",n.getCell(l,2).value=i,n.getCell(l,3).value=a(o),n.getCell(l,4).value=a(r),n.getCell(l,5).value="urgent"===e.priority?"عاجل":"high"===e.priority?"عالي":"medium"===e.priority?"متوسط":"منخفض",n.getCell(l,6).value="received"===e.status?"مستلم":"ordered"===e.status?"مطلوب":"آجل",n.getCell(l,7).value=e.date_needed?new Date(e.date_needed).toLocaleDateString("en-GB"):"",n.getCell(l,8).value=e.date_received?new Date(e.date_received).toLocaleDateString("en-GB"):"",n.getCell(l,9).value=e.notes||""});const l=t.reduce((e,t)=>e+(t.quantity||0)*(t.price||0),0),i=t.length+3;n.getCell(i,1).value="إجمالي تكلفة احتياجات العيادة:",n.getCell(i,4).value=a(l),n.getCell(i,1).font={bold:!0},n.getCell(i,4).font={bold:!0},n.columns.forEach(e=>{e.width=15})}static addInventoryDetailSheet(e,t){const n=e.addWorksheet("تفاصيل المخزون");["اسم العنصر","الكمية","سعر الوحدة","القيمة الإجمالية","الحد الأدنى","تاريخ الانتهاء","الفئة"].forEach((e,t)=>{const a=n.getCell(1,t+1);a.value=e,a.font={bold:!0},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}}),t.forEach((e,t)=>{const l=t+2,i=parseFloat(String(e.cost_per_unit||0))||0,o=parseFloat(String(e.unit_price||0))||0,r=i||o,s=parseFloat(String(e.quantity||0))||0,d=s*r;n.getCell(l,1).value=e.name||"",n.getCell(l,2).value=s,n.getCell(l,3).value=a(r),n.getCell(l,4).value=a(d),n.getCell(l,5).value=e.minimum_stock||0,n.getCell(l,6).value=e.expiry_date?new Date(e.expiry_date).toLocaleDateString("en-GB"):"",n.getCell(l,7).value=e.category||""}),n.columns.forEach(e=>{e.width=15})}static addClinicExpensesDetailSheet(e,t){const n=e.addWorksheet("تفاصيل مصروفات العيادة");["اسم المصروف","النوع","المبلغ","طريقة الدفع","تاريخ الدفع","المورد","ملاحظات"].forEach((e,t)=>{const a=n.getCell(1,t+1);a.value=e,a.font={bold:!0},a.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE0E0E0"}}}),t.forEach((e,t)=>{const l=t+2;n.getCell(l,1).value=e.expense_name||"",n.getCell(l,2).value=e.expense_type||"",n.getCell(l,3).value=a(e.amount||0),n.getCell(l,4).value=e.payment_method||"",n.getCell(l,5).value=e.payment_date?new Date(e.payment_date).toLocaleDateString("en-GB"):"",n.getCell(l,6).value=e.vendor||"",n.getCell(l,7).value=e.notes||""}),n.columns.forEach(e=>{e.width=15})}static async exportToCSV(e,t,n){let a="\ufeff";switch(e){case"patients":a+=this.generatePatientCSV(t,n);break;case"appointments":a+=this.generateAppointmentCSV(t,n);break;case"financial":a+=this.generateFinancialCSV(t,n);break;case"inventory":a+=this.generateInventoryCSV(t,n);break;case"profit-loss":a+=this.generateProfitLossCSV(t,n);break;case"overview":a+=this.generateOverviewCSV(t,n)}await this.convertCSVToExcel(a,e,n);return this.generateFileName(e,"xlsx",{includeTime:!0})}static isTableHeader(e,t){return e.includes("اسم المريض")||e.includes("نوع الموعد")||e.includes("نوع الدفع")||e.includes("تاريخ الدفع")||e.includes("اسم الصنف")||e.includes("التاريخ,الوقت")||e.includes("رقم الإيصال")||e.includes("#")||e.includes("اسم العلاج")||e.includes("اسم المنتج")||1===t&&e.includes(",")}static isFinancialData(e){return e.includes("إجمالي")||e.includes("صافي")||e.includes("الربح")||e.includes("الخسارة")||e.includes("المدفوعات")||e.includes("الإيرادات")||e.includes("المصروفات")||e.includes("القيمة الإجمالية")||e.includes("المبلغ الإجمالي")}static async convertCSVToExcel(e,t,a){try{const a=new n.Workbook;a.creator="نظام إدارة العيادة",a.created=new Date,a.modified=new Date;const l=a.addWorksheet("التقرير"),i=e.replace("\ufeff","").split("\n").filter(e=>e.trim());let o=1;for(const e of i){if(e.includes(",")){this.parseCSVLine(e).forEach((n,a)=>{const i=l.getCell(o,a+1);i.value=n,this.isTableHeader(e,o)?(i.font={bold:!0,size:12,color:{argb:"FFFFFFFF"}},i.fill={type:"pattern",pattern:"solid",fgColor:{argb:"comprehensive"===t?"FF2E8B57":"FF4472C4"}},i.border={top:{style:"medium"},left:{style:"medium"},bottom:{style:"medium"},right:{style:"medium"}}):this.isFinancialData(e)?(i.font={bold:!0,size:11},i.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFF2CC"}},i.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}):(i.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},o%2==0&&(i.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF8F9FA"}})),i.alignment={horizontal:"right",vertical:"middle"}})}else{const t=l.getCell(o,1);t.value=e.trim(),e.includes("عيادة الأسنان")||e.includes("التقرير الشامل")||e.includes("التقرير المالي")?(t.font={bold:!0,size:18,color:{argb:"FF1F4E79"}},t.alignment={horizontal:"center",vertical:"middle"},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFE7F3FF"}},l.mergeCells(o,1,o,12)):e.includes("===")||e.includes("تحليل")||e.includes("ملخص")?(t.font={bold:!0,size:14,color:{argb:"FF2E8B57"}},t.alignment={horizontal:"right",vertical:"middle"},t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF0FFF0"}},l.mergeCells(o,1,o,8)):(t.font={bold:!0,size:12},t.alignment={horizontal:"right",vertical:"middle"})}o++}l.columns.forEach((e,t)=>{e.width=0===t?25:18}),i.length>0&&i[0].includes(",")&&(l.views=[{state:"frozen",ySplit:1}]),l.eachRow((e,t)=>{e.height=25,1===t&&(e.height=30)});const r=this.generateFileName(t,"xlsx",{includeTime:!0}),s=await a.xlsx.writeBuffer(),d=new Blob([s],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=document.createElement("a"),u=URL.createObjectURL(d);c.setAttribute("href",u),c.setAttribute("download",`${r}.xlsx`),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c),console.log(`✅ تم تحويل CSV إلى Excel: ${r}.xlsx`)}catch(l){console.error("خطأ في تحويل CSV إلى Excel:",l)}}static parseCSVLine(e){const t=[];let n="",a=!1;for(let l=0;l<e.length;l++){const i=e[l];'"'===i?a=!a:","!==i||a?n+=i:(t.push(n.trim()),n="")}return t.push(n.trim()),t.map(e=>e.replace(/^"|"$/g,""))}static generatePatientCSV(e,t){let n="تقرير المرضى - عيادة الأسنان الحديثة\n\n";return n+="ملخص الإحصائيات\n",n+=`إجمالي المرضى,${e.totalPatients||0}\n`,n+=`المرضى الجدد هذا الشهر,${e.newPatientsThisMonth||0}\n`,n+=`المرضى النشطون,${e.activePatients||0}\n`,n+=`متوسط العمر,${e.averageAge||0} سنة\n\n`,e.ageDistribution&&e.ageDistribution.length>0&&(n+="توزيع الأعمار\n",n+="الفئة العمرية,العدد,النسبة المئوية\n",e.ageDistribution.forEach(t=>{const a=e.totalPatients>0?(t.count/e.totalPatients*100).toFixed(1):"0.0";n+=`"${t.ageGroup}",${t.count},${a}%\n`}),n+="\n"),e.genderDistribution&&e.genderDistribution.length>0&&(n+="توزيع الجنس\n",n+="الجنس,العدد,النسبة المئوية\n",e.genderDistribution.forEach(t=>{const a=e.totalPatients>0?(t.count/e.totalPatients*100).toFixed(1):"0.0",l="male"===t.gender||"ذكور"===t.gender?"ذكر":"أنثى";n+=`"${l}",${t.count},${a}%\n`}),n+="\n"),t.includeDetails&&e.patients&&(n+="تفاصيل المرضى\n",n+="#,الاسم الكامل,الجنس,العمر,الهاتف,البريد الإلكتروني,تاريخ التسجيل\n",e.patients.forEach(e=>{const t="male"===e.gender?"ذكر":"أنثى",a=e.created_at?new Date(e.created_at).toLocaleDateString("ar-SA"):"";n+=`"${e.serial_number||""}","${e.full_name||""}","${t}","${e.age||""}","${e.phone||""}","${e.email||""}","${a}"\n`})),n}static generateFinancialCSV(e,t){let n="التقرير المالي الشامل - عيادة الأسنان الحديثة\n\n";const i=new Date,o=`${i.getDate().toString().padStart(2,"0")}/${(i.getMonth()+1).toString().padStart(2,"0")}/${i.getFullYear()}`,r=i.toLocaleTimeString("ar-SA");if(n+=`تاريخ التقرير,${o}\n`,n+=`وقت الإنشاء,${r}\n\n`,e.filterInfo&&(n+="معلومات الفلترة المطبقة\n",n+=`نطاق البيانات,"${e.filterInfo}"\n`,n+=`عدد المعاملات المصدرة,${e.dataCount||0}\n\n`),n+="ملخص الإحصائيات المالية\n",n+=`إجمالي الإيرادات,${a(e.totalRevenue||0)}\n`,n+=`المدفوعات المكتملة,${a(e.completedPayments||0)}\n`,n+=`المدفوعات الآجلة,${a(e.pendingPayments||0)}\n`,n+=`المدفوعات المتأخرة,${a(e.overduePayments||0)}\n`,n+=`إجمالي المصروفات,${a(e.totalExpenses||0)}\n`,n+=`صافي الربح,${a(e.netProfit||0)}\n`,n+=`هامش الربح,${(e.profitMargin||0).toFixed(2)}%\n`,n+=`حالة الربحية,${(e.netProfit||0)>=0?"ربح":"خسارة"}\n`,e.payments&&Array.isArray(e.payments)){const t=e.payments.filter(e=>"partial"===e.status).reduce((e,t)=>{const n=void 0!==t.remaining_balance?Number(t.remaining_balance):Number(t.total_amount_due||t.amount)-Number(t.amount_paid||t.amount);return e+Math.max(0,n)},0);t>0&&(n+=`المبالغ المتبقية من الدفعات الجزئية,${a(t)}\n`)}if(n+=`الرصيد المستحق الإجمالي,${a(e.outstandingBalance||0)}\n\n`,e.paymentMethodStats&&e.paymentMethodStats.length>0){n+="توزيع طرق الدفع\n",n+="طريقة الدفع,المبلغ,عدد المعاملات,النسبة المئوية\n";const t=e.paymentMethodStats.reduce((e,t)=>e+t.amount,0);e.paymentMethodStats.forEach(e=>{const l=t>0?(e.amount/t*100).toFixed(1):"0.0";n+=`"${e.method}","${a(e.amount)}","${e.count}","${l}%"\n`}),n+="\n"}if(t.includeDetails&&e.payments&&Array.isArray(e.payments)){const t=e.payments;n+="تفاصيل المعاملات المالية\n",n+="رقم الإيصال,تاريخ الدفع,اسم المريض,وصف العلاج,المبلغ الإجمالي,المبلغ المدفوع,الرصيد المتبقي,طريقة الدفع,الحالة,ملاحظات\n",t.forEach(e=>{const t=e.receipt_number||`#${e.id?.slice(-6)||""}`,i=e.payment_date?l(e.payment_date):"",o=e.patient_name||`${e.patient?.first_name||""} ${e.patient?.last_name||""}`.trim()||"غير محدد",r=e.description||e.treatment_type||"غير محدد";let s,d,c;"partial"===e.status?(s=a(Number(e.total_amount_due||e.amount)||0),d=a(Number(e.amount_paid||e.amount)||0),c=a(Number(e.remaining_balance||0))):e.appointment_id&&e.appointment_total_cost?(s=a(Number(e.appointment_total_cost)||0),d=a(Number(e.appointment_total_paid||e.amount)||0),c=a(Number(e.appointment_remaining_balance||0))):(s=a(Number(e.amount)||0),d=a(Number(e.amount)||0),c=a(0));const u=this.translatePaymentMethod(e.payment_method||"غير محدد"),m=this.getPaymentStatusInArabic(e.status),p=e.notes||"";n+=`"${t}","${i}","${o}","${r}","${s}","${d}","${c}","${u}","${m}","${p}"\n`}),n+="\n"}if(e.expensesByType&&e.expensesByType.length>0&&(n+="توزيع المصروفات حسب النوع\n",n+="نوع المصروف,المبلغ,النسبة المئوية\n",e.expensesByType.forEach(e=>{n+=`"${e.type}","${a(e.amount)}","${e.percentage.toFixed(2)}%"\n`}),n+="\n"),e.recentExpenses&&e.recentExpenses.length>0){n+="المصروفات الحديثة (آخر 10 مصروفات)\n",n+="اسم المصروف,النوع,المبلغ,طريقة الدفع,تاريخ الدفع,المورد,رقم الإيصال,ملاحظات\n";const t={salary:"رواتب",utilities:"مرافق",rent:"إيجار",maintenance:"صيانة",supplies:"مستلزمات",insurance:"تأمين",other:"أخرى"},i={cash:"نقداً",bank_transfer:"تحويل بنكي",check:"شيك",credit_card:"بطاقة ائتمان"};e.recentExpenses.slice(0,10).forEach(e=>{const o=e.expense_name||"غير محدد",r=t[e.expense_type]||e.expense_type||"غير محدد",s=a(e.amount||0),d=i[e.payment_method]||e.payment_method||"غير محدد",c=e.payment_date?l(e.payment_date):"غير محدد",u=e.vendor||"غير محدد",m=e.receipt_number||"غير محدد",p=e.notes||"";n+=`"${o}","${r}","${s}","${d}","${c}","${u}","${m}","${p}"\n`}),n+="\n"}return n}static generateAppointmentCSV(e,t){let n="تقرير المواعيد - عيادة الأسنان الحديثة\n\n";return n+="ملخص إحصائيات المواعيد\n",n+=`إجمالي المواعيد,${e.totalAppointments||0}\n`,n+=`المواعيد المكتملة,${e.completedAppointments||0}\n`,n+=`المواعيد الملغية,${e.cancelledAppointments||0}\n`,n+=`المواعيد المجدولة,${e.scheduledAppointments||0}\n`,n+=`عدم الحضور,${e.noShowAppointments||0}\n`,n+=`معدل الحضور,${e.attendanceRate?.toFixed(1)||"0.0"}%\n`,n+=`معدل الإلغاء,${e.cancellationRate?.toFixed(1)||"0.0"}%\n\n`,e.appointmentsByStatus&&e.appointmentsByStatus.length>0&&(n+="توزيع حالات المواعيد\n",n+="الحالة,العدد,النسبة المئوية\n",e.appointmentsByStatus.forEach(e=>{const t=e.percentage?.toFixed(1)||"0.0";n+=`"${e.status}",${e.count},${t}%\n`}),n+="\n"),e.appointmentsByTreatment&&e.appointmentsByTreatment.length>0&&(n+="توزيع المواعيد حسب نوع العلاج\n",n+="نوع العلاج,عدد المواعيد\n",e.appointmentsByTreatment.forEach(e=>{n+=`"${e.treatment}",${e.count}\n`}),n+="\n"),e.filterInfo&&(n+="معلومات الفلترة\n",n+=`نطاق البيانات,"${e.filterInfo}"\n`,n+=`عدد المواعيد المصدرة,${e.dataCount||e.totalAppointments||0}\n`),n}static generateInventoryCSV(e,t){let n="تقرير المخزون - عيادة الأسنان الحديثة\n\n";return n+="ملخص إحصائيات المخزون\n",n+=`إجمالي العناصر,${e.totalItems||0}\n`,n+=`القيمة الإجمالية,${a(e.totalValue||0)}\n`,n+=`عناصر منخفضة المخزون,${e.lowStockItems||0}\n`,n+=`عناصر منتهية الصلاحية,${e.expiredItems||0}\n`,n}static generateOverviewCSV(e,t){let n="التقرير الشامل - عيادة الأسنان الحديثة\n\n";return e.patients&&(n+=this.generatePatientCSV(e.patients,t)+"\n\n"),e.appointments&&(n+=this.generateAppointmentCSV(e.appointments,t)+"\n\n"),e.financial&&(n+=this.generateFinancialCSV(e.financial,t)+"\n\n"),e.inventory&&(n+=this.generateInventoryCSV(e.inventory,t)),n}static async exportClinicNeedsToCSV(e,t="clinic-needs-report"){try{const n=e=>{try{const t=new Date(e);if(isNaN(t.getTime()))return"--";const n=t.getDate().toString().padStart(2,"0"),a=(t.getMonth()+1).toString().padStart(2,"0");return`${n}/${a}/${t.getFullYear()}`}catch(t){return"--"}},a=[["#","اسم الاحتياج","الكمية","السعر","الإجمالي","الوصف","الفئة","الأولوية","الحالة","المورد","الملاحظات","تاريخ الإنشاء","تاريخ التحديث"],...e.map(e=>[e.serial_number||"",e.need_name||"",e.quantity?.toString()||"0",e.price?.toString()||"0",((e.price||0)*(e.quantity||0)).toString(),e.description||"",e.category||"",this.getPriorityLabel(e.priority||""),this.getStatusLabel(e.status||""),e.supplier||"",e.notes||"",e.created_at?n(e.created_at):"",e.updated_at?n(e.updated_at):""])].map(e=>e.map(e=>`"${e}"`).join(",")).join("\n"),l="\ufeff"+a;console.log(`✅ Clinic needs exported to Excel: ${t}.xlsx`);const i={format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"};await this.convertCSVToExcel(l,"clinic-needs",i)}catch(n){throw console.error("Error exporting clinic needs to CSV:",n),new Error("فشل في تصدير احتياجات العيادة إلى CSV")}}static getPriorityLabel(e){return{urgent:"عاجل",high:"عالي",medium:"متوسط",low:"منخفض"}[e]||e}static getStatusLabel(e){return{pending:"آجل",ordered:"مطلوب",received:"مستلم",cancelled:"ملغي"}[e]||e}static async exportPatientsToPDF(e,t="عيادة الأسنان الحديثة"){const n=new Date,a=new Date(n.getFullYear(),n.getMonth(),1),l=e.filter(e=>new Date(e.created_at)>=a).length,i={children:0,teens:0,adults:0,seniors:0},o={male:0,female:0};e.forEach(e=>{if(e.age&&"number"==typeof e.age&&e.age>0){const t=e.age;t<13?i.children++:t<20?i.teens++:t<60?i.adults++:i.seniors++}"male"===e.gender?o.male++:"female"===e.gender&&o.female++});const r={totalPatients:e.length,newPatients:l,activePatients:e.length,inactivePatients:0,ageDistribution:[{ageGroup:"أطفال (0-12)",count:i.children},{ageGroup:"مراهقون (13-19)",count:i.teens},{ageGroup:"بالغون (20-59)",count:i.adults},{ageGroup:"كبار السن (60+)",count:i.seniors}],genderDistribution:[{gender:"ذكور",count:o.male},{gender:"إناث",count:o.female}],registrationTrend:[],patientsList:e};await this.exportToPDF("patients",r,{format:"pdf",includeCharts:!1,includeDetails:!0,language:"ar",orientation:"landscape",pageSize:"A4"})}static async exportAppointmentsToPDF(e,t="عيادة الأسنان الحديثة"){const n=e.length,a=e.filter(e=>"completed"===e.status).length,l=e.filter(e=>"cancelled"===e.status).length,i=e.filter(e=>"no_show"===e.status).length,o=e.filter(e=>"scheduled"===e.status).length,r=n>0?Math.round(a/n*100):0,s=n>0?Math.round(l/n*100):0,d={totalAppointments:n,completedAppointments:a,cancelledAppointments:l,noShowAppointments:i,scheduledAppointments:o,attendanceRate:r,cancellationRate:s,appointmentsByStatus:[{status:"مكتمل",count:a,percentage:r},{status:"ملغي",count:l,percentage:s},{status:"لم يحضر",count:i,percentage:n>0?Math.round(i/n*100):0},{status:"مجدول",count:o,percentage:n>0?Math.round(o/n*100):0}],appointmentsByTreatment:[],appointmentsByDay:[],appointmentsByHour:[],peakHours:[],appointmentTrend:[],filterInfo:`البيانات المصدرة: ${n} موعد`,dataCount:n};await this.exportToPDF("appointments",d,{format:"pdf",includeCharts:!1,includeDetails:!0,language:"ar",orientation:"landscape",pageSize:"A4"})}static async exportPaymentsToPDF(e,t="عيادة الأسنان الحديثة"){const n=e.reduce((e,t)=>e+Number(t.amount),0),a=e.filter(e=>"completed"===e.status).reduce((e,t)=>e+Number(t.amount),0),l=e.filter(e=>"partial"===e.status).reduce((e,t)=>e+Number(t.amount),0),i=e.filter(e=>"pending"===e.status).reduce((e,t)=>e+Number(t.amount),0),o=e.filter(e=>"pending"===e.status).reduce((e,t)=>e+Number(t.amount),0),r=e.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>{const n=t.payment_method||"غير محدد";e[n]||(e[n]={count:0,amount:0}),e[n].count++;const a=Number(t.amount);return e[n].amount+=a,e},{}),s=Object.entries(r).map(([e,t])=>({method:e,count:t.count,amount:t.amount})),d={totalRevenue:n,totalPaid:a+l,totalPending:i,totalOverdue:o,totalExpenses:0,netProfit:n-0,profitMargin:0,revenueByPaymentMethod:s.map(e=>({method:e.method,amount:e.amount,percentage:n>0?e.amount/n*100:0})),revenueByTreatment:[],expensesByType:[],revenueTrend:[],expenseTrend:[],cashFlow:[],outstandingPayments:[],recentTransactions:[],recentExpenses:[],outstandingBalance:i+o};await this.exportToPDF("financial",d,{format:"pdf",includeCharts:!1,includeDetails:!0,language:"ar",orientation:"landscape",pageSize:"A4"})}static async exportPatientsToExcel(e){const t=new Date,n=new Date(t.getFullYear(),t.getMonth(),1),a=e.filter(e=>new Date(e.created_at)>=n).length,l={children:0,teens:0,adults:0,seniors:0},i={male:0,female:0};e.forEach(e=>{if(e.age&&"number"==typeof e.age&&e.age>0){const t=e.age;t<13?l.children++:t<20?l.teens++:t<60?l.adults++:l.seniors++}"male"===e.gender?i.male++:"female"===e.gender&&i.female++});const o={totalPatients:e.length,newPatients:a,activePatients:e.length,patients:e,ageDistribution:[{ageGroup:"أطفال (0-12)",count:l.children},{ageGroup:"مراهقون (13-19)",count:l.teens},{ageGroup:"بالغون (20-59)",count:l.adults},{ageGroup:"كبار السن (60+)",count:l.seniors}],genderDistribution:[{gender:"ذكور",count:i.male},{gender:"إناث",count:i.female}],registrationTrend:[]};await this.exportToExcel("patients",o,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportAppointmentsToExcel(e){const t=e.length,n=e.filter(e=>"completed"===e.status).length,a=e.filter(e=>"cancelled"===e.status).length,l=e.filter(e=>"no_show"===e.status).length,i=e.filter(e=>"scheduled"===e.status).length,o=t>0?Math.round(n/t*100):0,r=t>0?Math.round(a/t*100):0,s={totalAppointments:t,completedAppointments:n,cancelledAppointments:a,noShowAppointments:l,scheduledAppointments:i,attendanceRate:o,cancellationRate:r,appointmentsByStatus:[{status:"مكتمل",count:n,percentage:o},{status:"ملغي",count:a,percentage:r},{status:"لم يحضر",count:l,percentage:t>0?Math.round(l/t*100):0},{status:"مجدول",count:i,percentage:t>0?Math.round(i/t*100):0}],appointmentsByTreatment:[],appointmentsByDay:[],appointmentsByHour:[],peakHours:[],appointmentTrend:[],filterInfo:`البيانات المصدرة: ${t} موعد`,dataCount:t};await this.exportToExcel("appointments",s,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportTreatmentsToCSV(e){const t=[];t.push(["نوع العلاج","فئة العلاج","حالة العلاج","التكلفة","تاريخ البداية","تاريخ الإنجاز","اسم المريض","رقم السن","تاريخ الإنشاء"]),e.forEach(e=>{var n;t.push([i(e.treatment_type||""),o(e.treatment_category||""),(n=e.treatment_status||"planned",{planned:"مخطط",in_progress:"قيد التنفيذ",completed:"مكتمل",cancelled:"ملغي"}[n]||n),e.cost||0,e.start_date||"",e.completion_date||"",e.patient_name||`مريض ${e.patient_id}`,e.tooth_number||"",e.created_at||""])});const n=e.length,a=e.filter(e=>"completed"===e.treatment_status).length,l=e.filter(e=>"planned"===e.treatment_status).length,r=e.filter(e=>"in_progress"===e.treatment_status).length,s=e.filter(e=>"cancelled"===e.treatment_status).length,d=e.filter(e=>"completed"===e.treatment_status).reduce((e,t)=>e+(e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100})(t.cost),0),c=n>0?Math.round(a/n*100):0;t.push([]),t.push(["ملخص الإحصائيات"]),t.push(["إجمالي العلاجات",n]),t.push(["العلاجات المكتملة",a]),t.push(["العلاجات المخططة",l]),t.push(["العلاجات قيد التنفيذ",r]),t.push(["العلاجات الملغية",s]),t.push(["إجمالي الإيرادات",d]),t.push(["معدل الإنجاز (%)",c]);const u="\ufeff"+t.map(e=>e.map(e=>`"${e}"`).join(",")).join("\n");await this.convertCSVToExcel(u,"treatments",{format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportPaymentsToExcel(e){const t=e.reduce((e,t)=>e+Number(t.amount),0),n=e.filter(e=>"completed"===e.status).reduce((e,t)=>e+Number(t.amount),0),l=e.filter(e=>"partial"===e.status).reduce((e,t)=>e+Number(t.amount),0),i=new Date;i.setDate(i.getDate()-30);const o=e.filter(e=>"pending"===e.status).filter(e=>new Date(e.payment_date||e.created_at)>=i).reduce((e,t)=>{const n=Number(t.amount)||0,a=Number(t.total_amount_due)||0;return e+(0===n&&a>0?a:n)},0),r=e.filter(e=>"pending"===e.status).filter(e=>new Date(e.payment_date||e.created_at)<i).reduce((e,t)=>{const n=Number(t.amount)||0,a=Number(t.total_amount_due)||0;return e+(0===n&&a>0?a:n)},0),s=e.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>{const n=t.payment_method||"غير محدد";e[n]||(e[n]={count:0,amount:0}),e[n].count++;const a=Number(t.amount);return e[n].amount+=a,e},{}),d=Object.entries(s).map(([e,t])=>({method:e,count:t.count,amount:t.amount})),c=new Map;let u=0;e.forEach(e=>{if("partial"===e.status)if(e.appointment_id){const t=e.appointment_id,n=Number(e.total_amount_due||e.treatment_total_cost||0),a=Number(e.amount||0);c.has(t)||c.set(t,{totalDue:n,totalPaid:0});c.get(t).totalPaid+=a}else{const t=Number(e.total_amount_due||e.amount||0),n=Number(e.amount_paid||e.amount||0);u+=Math.max(0,t-n)}});const m=Array.from(c.values()).reduce((e,t)=>e+Math.max(0,t.totalDue-t.totalPaid),0)+u,p={totalRevenue:t,totalPaid:n+l,totalPending:o,totalOverdue:r,revenueByPaymentMethod:d.map(e=>({method:e.method,amount:e.amount,percentage:t>0?e.amount/t*100:0})),revenueTrend:[],topTreatments:[],outstandingBalance:o+r+m,filterInfo:`البيانات المصدرة: ${e.length} دفعة (مكتملة: ${e.filter(e=>"completed"===e.status).length}, جزئية: ${e.filter(e=>"partial"===e.status).length}, آجلة: ${e.filter(e=>"pending"===e.status).length}, متأخرة: ${r>0?e.filter(e=>"pending"===e.status&&new Date(e.payment_date||e.created_at)<i).length:0}, مبلغ متبقي من الجزئية: ${a(m)})`,dataCount:e.length};await this.exportToExcel("financial",p,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportPaymentsToCSV(e){const t=e.reduce((e,t)=>e+Number(t.amount),0),n=e.filter(e=>"completed"===e.status).reduce((e,t)=>e+Number(t.amount),0),l=e.filter(e=>"partial"===e.status).reduce((e,t)=>e+Number(t.amount),0),i=new Date;i.setDate(i.getDate()-30);const o=e.filter(e=>"pending"===e.status).filter(e=>new Date(e.payment_date||e.created_at)>=i).reduce((e,t)=>{const n=Number(t.amount)||0,a=Number(t.total_amount_due)||0;return e+(0===n&&a>0?a:n)},0),r=e.filter(e=>"pending"===e.status).filter(e=>new Date(e.payment_date||e.created_at)<i).reduce((e,t)=>{const n=Number(t.amount)||0,a=Number(t.total_amount_due)||0;return e+(0===n&&a>0?a:n)},0),s=e.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>{const n=t.payment_method||"غير محدد";e[n]||(e[n]={count:0,amount:0}),e[n].count++;const a=Number(t.amount);return e[n].amount+=a,e},{}),d=Object.entries(s).map(([e,t])=>({method:e,count:t.count,amount:t.amount})),c=new Map;let u=0;e.forEach(e=>{if("partial"===e.status)if(e.appointment_id){const t=e.appointment_id,n=Number(e.total_amount_due||e.treatment_total_cost||0),a=Number(e.amount||0);c.has(t)||c.set(t,{totalDue:n,totalPaid:0});c.get(t).totalPaid+=a}else{const t=Number(e.total_amount_due||e.amount||0),n=Number(e.amount_paid||e.amount||0);u+=Math.max(0,t-n)}});const m=Array.from(c.values()).reduce((e,t)=>e+Math.max(0,t.totalDue-t.totalPaid),0)+u,p={totalRevenue:t,totalPaid:n+l,totalPending:o,totalOverdue:r,paymentMethodStats:d,monthlyRevenue:[],revenueTrend:[],topTreatments:[],outstandingBalance:o+r+m,filterInfo:`البيانات المصدرة: ${e.length} دفعة (مكتملة: ${e.filter(e=>"completed"===e.status).length}, جزئية: ${e.filter(e=>"partial"===e.status).length}, آجلة: ${e.filter(e=>"pending"===e.status).length}, متأخرة: ${r>0?e.filter(e=>"pending"===e.status&&new Date(e.payment_date||e.created_at)<i).length:0}, مبلغ متبقي من الجزئية: ${a(m)})`,dataCount:e.length,payments:e};await this.exportToCSV("financial",p,{format:"csv",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportLabsToExcel(e,t){const n=e.length,i=t.length,o=t.reduce((e,t)=>e+Number(t.cost),0),r=t.reduce((e,t)=>e+Number(t.paid_amount||0),0),s=t.reduce((e,t)=>e+Number(t.remaining_balance||0),0),d={summary:{"إجمالي المختبرات":n,"إجمالي الطلبات":i,"إجمالي التكلفة":a(o),"إجمالي المدفوع":a(r),"إجمالي المتبقي":a(s),"تاريخ التقرير":l(new Date)},labs:e.map(e=>({...e,ordersCount:t.filter(t=>t.lab_id===e.id).length})),labOrders:t,filterInfo:`البيانات المصدرة: ${e.length} مختبر، ${t.length} طلب`,dataCount:e.length+t.length};await this.exportToExcel("labs",d,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportClinicExpensesToPDF(e,t="عيادة الأسنان الحديثة"){e.length;const n=e.reduce((e,t)=>e+Number(t.amount),0),a=e.filter(e=>"paid"===e.status).reduce((e,t)=>e+Number(t.amount),0),l=e.filter(e=>"pending"===e.status).reduce((e,t)=>e+Number(t.amount),0),i=e.filter(e=>"overdue"===e.status).reduce((e,t)=>e+Number(t.amount),0),o=e.filter(e=>"cancelled"===e.status).reduce((e,t)=>e+Number(t.amount),0),r=e.reduce((e,t)=>{const n=t.expense_type;return e[n]||(e[n]={amount:0,count:0}),e[n].amount+=Number(t.amount),e[n].count++,e},{}),s=Object.entries(r).map(([e,t])=>({type:e,amount:t.amount,count:t.count,percentage:n>0?t.amount/n*100:0})),d=e.reduce((e,t)=>{const n=t.payment_method;return e[n]||(e[n]={amount:0,count:0}),e[n].amount+=Number(t.amount),e[n].count++,e},{}),c=Object.entries(d).map(([e,t])=>({method:e,amount:t.amount,count:t.count,percentage:n>0?t.amount/n*100:0})),u={totalExpenses:n,paidExpenses:a,pendingExpenses:l,overdueExpenses:i,cancelledExpenses:o,expensesByType:s,expensesByPaymentMethod:c,expensesList:e,filterInfo:`البيانات المصدرة: ${e.length} مصروف`,dataCount:e.length};await this.exportToPDF("clinic-expenses",u,{format:"pdf",includeCharts:!1,includeDetails:!0,language:"ar",orientation:"landscape",pageSize:"A4"})}static async testLabReportGeneration(e,t){try{return console.log("🧪 Testing lab report PDF generation..."),e&&0!==e.length?t&&0!==t.length?(await this.exportLabsToPDF(e,t,"عيادة الأسنان للاختبار"),console.log("✅ Lab report PDF generation test completed successfully"),!0):(console.warn("⚠️ No lab orders data provided for testing"),!1):(console.warn("⚠️ No labs data provided for testing"),!1)}catch(n){return console.error("❌ Lab report PDF generation test failed:",n),!1}}static async testClinicExpensesReportGeneration(e){try{return console.log("🧪 Testing clinic expenses report PDF generation..."),e&&0!==e.length?(await this.exportClinicExpensesToPDF(e,"عيادة الأسنان للاختبار"),console.log("✅ Clinic expenses report PDF generation test completed successfully"),!0):(console.warn("⚠️ No expenses data provided for testing"),!1)}catch(t){return console.error("❌ Clinic expenses report PDF generation test failed:",t),!1}}static async exportLabsToPDF(e,t,n="عيادة الأسنان الحديثة"){const a={totalLabs:e.length,totalOrders:t.length,totalCost:t.reduce((e,t)=>e+Number(t.cost),0),totalPaid:t.reduce((e,t)=>e+Number(t.paid_amount||0),0),totalRemaining:t.reduce((e,t)=>e+Number(t.remaining_balance||0),0),pendingOrders:t.filter(e=>"آجل"===e.status).length,completedOrders:t.filter(e=>"مكتمل"===e.status).length,cancelledOrders:t.filter(e=>"ملغي"===e.status).length,labsList:e,labOrdersList:t,filterInfo:`البيانات المصدرة: ${e.length} مختبر، ${t.length} طلب`,dataCount:e.length+t.length};await this.exportToPDF("labs",a,{format:"pdf",includeCharts:!1,includeDetails:!0,language:"ar",orientation:"landscape",pageSize:"A4"})}static async exportClinicNeedsToExcel(e){const t={summary:{"إجمالي الاحتياجات":e.length,"احتياجات آجلة":e.filter(e=>"pending"===e.status).length,"احتياجات مطلوبة":e.filter(e=>"ordered"===e.status).length,"احتياجات مستلمة":e.filter(e=>"received"===e.status).length,"احتياجات عاجلة":e.filter(e=>"urgent"===e.priority).length,"احتياجات عالية الأولوية":e.filter(e=>"high"===e.priority).length,"تاريخ التقرير":l(new Date)},needs:e,filterInfo:`البيانات المصدرة: ${e.length} احتياج`,dataCount:e.length};await this.exportToExcel("clinic-needs",t,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportInventoryToExcel(e){const t=e.length,n=e.filter(e=>{const t=parseFloat(String(e.cost_per_unit||0))||0,n=parseFloat(String(e.unit_price||0))||0;return 0===t&&0===n});n.length>0&&console.warn(`⚠️ ${n.length} عنصر لا يحتوي على سعر:`,n.map(e=>e.name));const i=e.reduce((e,t)=>{const n=parseFloat(String(t.quantity||0))||0,a=parseFloat(String(t.cost_per_unit||0))||0,l=parseFloat(String(t.unit_price||0))||0;return e+n*(a||l)},0),o=e.filter(e=>Number(e.quantity)<=Number(e.minimum_stock||0)).length,r=e.filter(e=>0===Number(e.quantity)).length,s=e.filter(e=>e.expiry_date&&new Date(e.expiry_date)<new Date).length,d={summary:{"إجمالي العناصر":t,"القيمة الإجمالية":a(i),"عناصر منخفضة المخزون":o,"عناصر نفدت من المخزون":r,"عناصر منتهية الصلاحية":s,"عناصر بدون أسعار":n.length,"تاريخ التقرير":l(new Date)},items:e,filterInfo:`البيانات المصدرة: ${e.length} عنصر${n.length>0?` (${n.length} بدون أسعار)`:""}`,dataCount:e.length};await this.exportToExcel("inventory",d,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static async exportClinicExpensesToExcel(e){if(!e||0===e.length)throw new Error("لا توجد بيانات مصروفات للتصدير");const t=e.reduce((e,t)=>e+(parseFloat(String(t.amount||0))||0),0),n=e.filter(e=>"paid"===e.status).reduce((e,t)=>e+(parseFloat(String(t.amount||0))||0),0),i=e.filter(e=>"pending"===e.status).reduce((e,t)=>e+(parseFloat(String(t.amount||0))||0),0),o=e.filter(e=>"overdue"===e.status).reduce((e,t)=>e+(parseFloat(String(t.amount||0))||0),0),r={summary:{"إجمالي المصروفات":e.length,"إجمالي المبلغ":a(t),"المبلغ المدفوع":a(n),"المبلغ الآجل":a(i),"المبلغ المتأخر":a(o),"تاريخ التقرير":l(new Date)},expenses:e,filterInfo:`البيانات المصدرة: ${e.length} مصروف`,dataCount:e.length};await this.exportToExcel("clinic-expenses",r,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static filterDataByDateRange(e,t,n){if(!t||!t.start||!t.end)return e;const a=new Date(t.start),l=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0),i=new Date(t.end),o=new Date(i.getFullYear(),i.getMonth(),i.getDate(),23,59,59,999);return e.filter(e=>{const t=e[n];if(!t)return!1;const a=new Date(t);let i;return i=t.includes("T")||t.includes(" ")?a:new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0),i>=l&&i<=o})}static async exportProfitLossToExcel(e){const{reportData:t,payments:n,labOrders:i,clinicNeeds:o,inventoryItems:r,clinicExpenses:s,patients:d,appointments:c,filter:u,currency:m}=e,p=this.filterDataByDateRange(n,u,"payment_date"),g=this.filterDataByDateRange(i,u,"order_date"),h=this.filterDataByDateRange(o,u,"created_at"),v=this.filterDataByDateRange(c,u,"created_at"),f=this.filterDataByDateRange(r,u,"created_at"),y=s?this.filterDataByDateRange(s,u,"payment_date"):[],b={summary:{"إجمالي الإيرادات":a(t.revenue.totalRevenue),"إجمالي المصروفات":a(t.calculations.totalExpenses),"صافي الربح/الخسارة":a(t.calculations.isProfit?t.calculations.netProfit:-t.calculations.lossAmount),"نسبة الربح":`${t.calculations.profitMargin.toFixed(2)}%`,"حالة المالية":t.calculations.isProfit?"ربح":"خسارة","إجمالي المرضى":t.details.totalPatients,"إجمالي المواعيد":t.details.totalAppointments,"متوسط الإيرادات لكل مريض":a(t.details.averageRevenuePerPatient),"متوسط الإيرادات لكل موعد":a(t.details.averageRevenuePerAppointment),"الفترة الزمنية":t.filterInfo.dateRange,"تاريخ التقرير":l(new Date)},revenue:{completedPayments:t.revenue.completedPayments,partialPayments:t.revenue.partialPayments,remainingBalances:t.revenue.remainingBalances,pendingPayments:t.revenue.pendingAmount||0,totalRevenue:t.revenue.totalRevenue},expenses:{labOrdersTotal:t.expenses.labOrdersTotal,labOrdersRemaining:t.expenses.labOrdersRemaining,clinicNeedsTotal:t.expenses.clinicNeedsTotal,clinicNeedsRemaining:t.expenses.clinicNeedsRemaining,inventoryExpenses:t.expenses.inventoryExpenses,clinicExpensesTotal:t.expenses.clinicExpensesTotal||0},payments:p,labOrders:g,clinicNeeds:h,inventoryItems:f,clinicExpenses:y,patients:d,appointments:v,filterInfo:`تقرير الأرباح والخسائر - ${t.filterInfo.dateRange} - ${p.length} دفعة، ${g.length} طلب مختبر، ${h.length} احتياج، ${f.length} عنصر مخزون، ${y.length} مصروف`,dataCount:p.length+g.length+h.length+f.length+y.length};await this.exportToExcel("profit-loss",b,{format:"excel",includeCharts:!1,includeDetails:!0,language:"ar"})}static generateProfitLossCSV(e,t){let n="";return n+="التقرير الشامل للأرباح والخسائر\n",n+=`تاريخ التقرير,${l(new Date)}\n`,n+=`وقت التقرير,${(new Date).toLocaleTimeString("ar-SA")}\n\n`,e.summary&&(n+="ملخص الأرباح والخسائر\n",Object.entries(e.summary).forEach(([e,t])=>{n+=`${e},${t}\n`}),n+="\n"),e.revenue&&(n+="تفاصيل الإيرادات\n",n+=`المدفوعات المكتملة,${a(e.revenue.completedPayments||0)}\n`,n+=`المدفوعات الجزئية,${a(e.revenue.partialPayments||0)}\n`,n+=`المبالغ المتبقية,${a(e.revenue.remainingBalances||0)}\n`,n+=`إجمالي الإيرادات,${a(e.revenue.totalRevenue||0)}\n\n`),e.expenses&&(n+="تفاصيل المصروفات\n",n+=`مدفوعات المخابر,${a(e.expenses.labOrdersTotal||0)}\n`,n+=`متبقي المخابر,${a(e.expenses.labOrdersRemaining||0)}\n`,n+=`احتياجات العيادة,${a(e.expenses.clinicNeedsTotal||0)}\n`,n+=`متبقي الاحتياجات,${a(e.expenses.clinicNeedsRemaining||0)}\n`,n+=`قيمة المخزون,${a(e.expenses.inventoryExpenses||0)}\n`,n+=`مصروفات العيادة المباشرة,${a(e.expenses.clinicExpensesTotal||0)}\n\n`),e.payments&&e.payments.length>0&&(n+="تفاصيل المدفوعات\n",n+="رقم المريض,اسم المريض,المبلغ,الحالة,طريقة الدفع,تاريخ الدفع,ملاحظات\n",e.payments.forEach(e=>{const t="completed"===e.status?"مكتمل":"partial"===e.status?"جزئي":"آجل",i=e.payment_date?l(e.payment_date):"";n+=`${e.patient_id||""},${e.patient_name||""},${a(e.amount||0)},${t},${e.payment_method||""},${i},"${e.notes||""}"\n`}),n+="\n"),e.labOrders&&e.labOrders.length>0&&(n+="تفاصيل طلبات المخابر\n",n+="رقم الطلب,اسم المختبر,اسم المريض,التكلفة,المدفوع,المتبقي,الحالة,تاريخ الطلب\n",e.labOrders.forEach(e=>{const t="completed"===e.status?"مكتمل":"pending"===e.status?"آجل":"ملغي",i=e.order_date?l(e.order_date):"",o=(e.cost||0)-(e.paid_amount||0);n+=`${e.id||""},${e.lab?.name||""},${e.patient?.full_name||""},${a(e.cost||0)},${a(e.paid_amount||0)},${a(o)},${t},${i}\n`}),n+="\n"),e.clinicNeeds&&e.clinicNeeds.length>0&&(n+="تفاصيل احتياجات العيادة\n",n+="اسم العنصر,الكمية,الأولوية,الحالة,التاريخ المطلوب,التاريخ المستلم,ملاحظات\n",e.clinicNeeds.forEach(e=>{const t="urgent"===e.priority?"عاجل":"high"===e.priority?"عالي":"عادي",a="received"===e.status?"مستلم":"ordered"===e.status?"مطلوب":"آجل",i=e.date_needed?l(e.date_needed):"",o=e.date_received?l(e.date_received):"";n+=`${e.item_name||""},${e.quantity||0},${t},${a},${i},${o},"${e.notes||""}"\n`}),n+="\n"),e.inventoryItems&&e.inventoryItems.length>0&&(n+="تفاصيل المخزون\n",n+="اسم العنصر,الكمية,سعر الوحدة,القيمة الإجمالية,الحد الأدنى,تاريخ الانتهاء,الفئة\n",e.inventoryItems.forEach(e=>{const t=parseFloat(String(e.cost_per_unit||0))||0,i=parseFloat(String(e.unit_price||0))||0,o=t||i,r=parseFloat(String(e.quantity||0))||0,s=r*o,d=e.expiry_date?l(e.expiry_date):"";n+=`${e.name||""},${r},${a(o)},${a(s)},${e.minimum_stock||0},${d},${e.category||""}\n`}),n+="\n"),e.clinicExpenses&&e.clinicExpenses.length>0&&(n+="تفاصيل مصروفات العيادة\n",n+="اسم المصروف,النوع,المبلغ,طريقة الدفع,تاريخ الدفع,المورد,ملاحظات\n",e.clinicExpenses.forEach(e=>{const t=e.payment_date?l(e.payment_date):"";n+=`${e.expense_name||""},${e.expense_type||""},${a(e.amount||0)},${e.payment_method||""},${t},${e.vendor||""},"${e.notes||""}"\n`}),n+="\n"),n+="معلومات التقرير\n",n+=`${e.filterInfo||""}\n`,n+=`إجمالي السجلات,${e.dataCount||0}\n`,n}}export{r as E};
