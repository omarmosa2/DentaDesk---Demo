import{j as e}from"./ui-cacc1eea.js";import{r as s,c as a}from"./vendor-696af5bd.js";import{Q as n,u as t,aH as l,U as r,B as i,a$ as c,r as d,w as o,Z as m,S as x,m as h,n as p,o as j,p as u,a1 as f,D as N,f as g,g as w,h as v,i as b,L as y,I as C,T as _,x as P,ae as S,b as E,c as k,a as D,b0 as T,C as I,l as F,ag as O,ah as A,b1 as z,y as M,z as L,E as $,G as V,H,N as q,P as Q,O as B}from"./index-3a8dc84c.js";import{D as G,a as J,b as R,c as U,d as K}from"./dropdown-menu-0651433f.js";import{C as Y,a as Z,b as W}from"./collapsible-d3d2b240.js";import{n as X}from"./notificationService-09cb27cc.js";import{E as ee}from"./exportService-1536567b.js";import{T as se,a as ae,b as ne,c as te,d as le,e as re}from"./table-20957d0a.js";import{P as ie,a as ce}from"./PatientDetailsModal-ebd37fae.js";import{P as de}from"./pdfService-844f6d4e.js";import{P as oe}from"./pen-square-6c634feb.js";import{T as me,D as xe}from"./upload-4df8a268.js";import{M as he}from"./more-horizontal-5517ce56.js";import{P as pe}from"./printer-5ab76652.js";import{F as je}from"./file-text-861b9f90.js";import{C as ue,a as fe}from"./chevrons-right-9b995d31.js";import{C as Ne}from"./chevron-left-343e35ff.js";import{b as ge,A as we,a as ve}from"./arrow-up-832b5917.js";import be from"./ComprehensivePendingInvoiceDialog-f22679a2.js";import{P as ye}from"./plus-1eab3b5b.js";import{F as Ce}from"./filter-f006659c.js";import"./pdf-991f41f6.js";import"./utils-ec524415.js";import"./charts-b4389b44.js";import"./index-a46c293c.js";import"./excel-37615a09.js";import"./tabs-952e3ebd.js";import"./phone-a8e6eab2.js";import"./mail-8c3a07ed.js";import"./map-pin-a7696fe0.js";import"./switch-3ea40783.js";import"./qr-d6f50769.js";import"./calculator-63fcb348.js";import"./settings-39dd9f65.js";const _e=s.memo(function({patients:a,isLoading:N,onEdit:g,onDelete:w,onViewDetails:v,onViewPendingInvoice:b}){const[y,C]=s.useState(null),[_,P]=s.useState(null),[S,E]=s.useState(1),[k,D]=s.useState(10),T=n(e=>e.settings),{toast:I}=t(),F=async(e,s)=>new Promise((a,n)=>{try{const t=window.open("","_blank","width=800,height=600,scrollbars=yes,resizable=yes");if(!t)throw new Error("لا يمكن فتح نافذة الطباعة");t.document.open(),t.document.write("<!DOCTYPE html>"),t.document.write('<html dir="rtl" lang="ar">'),t.document.write("<head>"),t.document.write('<meta charset="UTF-8">'),t.document.write('<meta name="viewport" content="width=device-width, initial-scale=1.0">'),t.document.write(`<title>طباعة سجل المريض - ${s}</title>`),t.document.write("<style>"),t.document.write("\n          body {\n            font-family: 'Arial', sans-serif;\n            margin: 0;\n            padding: 20px;\n            direction: rtl;\n            background: white;\n          }\n          @media print {\n            body { margin: 0; padding: 10px; }\n            .no-print { display: none !important; }\n          }\n          .print-controls {\n            position: fixed;\n            top: 10px;\n            left: 10px;\n            background: #f0f0f0;\n            padding: 10px;\n            border-radius: 5px;\n            border: 1px solid #ccc;\n            z-index: 1000;\n          }\n        "),t.document.write("</style>"),t.document.write("</head>"),t.document.write("<body>"),t.document.write('\n          <div class="print-controls no-print">\n            <button onclick="window.print()" style="margin: 5px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">\n              طباعة\n            </button>\n            <button onclick="window.close()" style="margin: 5px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">\n              إغلاق\n            </button>\n          </div>\n        ');const l=t.document.createElement("div");l.innerHTML=e,t.document.body.appendChild(l),t.document.write("</body>"),t.document.write("</html>"),t.document.close();const r=()=>{t.focus(),a()};"complete"===t.document.readyState?r():t.addEventListener("load",r),t.addEventListener("error",()=>{n(new Error("فشل في تحميل نافذة الطباعة"))}),setTimeout(()=>{t.closed||t.close()},3e5)}catch(t){n(t)}}),O=s.useMemo(()=>{let e=a;y&&_&&(e=[...a].sort((e,s)=>{let a=e[y],n=s[y];return null==a&&null==n?0:null==a?"asc"===_?1:-1:null==n?"asc"===_?-1:1:(a=l(a).toLowerCase(),n=l(n).toLowerCase(),a<n?"asc"===_?-1:1:a>n?"asc"===_?1:-1:0)}));const s=(S-1)*k,n=s+k;return{patients:e.slice(s,n),totalPages:Math.ceil(e.length/k),totalCount:e.length}},[a,y,_,S,k]),A=s=>y!==s?e.jsx(ge,{className:"w-4 h-4 opacity-50"}):"asc"===_?e.jsx(we,{className:"w-4 h-4"}):"desc"===_?e.jsx(ve,{className:"w-4 h-4"}):e.jsx(ge,{className:"w-4 h-4 opacity-50"}),z=({field:s,children:a})=>e.jsx(te,{className:"cursor-pointer hover:bg-muted/50 select-none text-center",onClick:()=>(e=>{y===e?"asc"===_?P("desc"):"desc"===_?(C(null),P(null)):P("asc"):(C(e),P("asc"))})(s),children:e.jsxs("div",{className:"flex items-center justify-center space-x-1 space-x-reverse",children:[e.jsx("span",{children:a}),A(s)]})});if(N)return e.jsx("div",{className:"border rounded-lg",children:e.jsxs(se,{className:"table-center-all",children:[e.jsx(ae,{children:e.jsxs(ne,{children:[e.jsx(te,{className:"text-center",children:"#"}),e.jsx(te,{className:"text-center",children:"الاسم الكامل للمريض"}),e.jsx(te,{className:"text-center",children:"الجنس"}),e.jsx(te,{className:"text-center",children:"العمر"}),e.jsx(te,{className:"text-center",children:"رقم الهاتف"}),e.jsx(te,{className:"text-center",children:"حالة المريض"}),e.jsx(te,{className:"text-center",children:"تاريخ الإضافة"}),e.jsx(te,{className:"text-center",children:"الاجراءات"})]})}),e.jsx(le,{children:[...Array(5)].map((s,a)=>e.jsx(ne,{children:[...Array(8)].map((s,a)=>e.jsx(re,{children:e.jsx("div",{className:"h-4 bg-muted animate-pulse rounded"})},a))},a))})]})});if(0===a.length)return e.jsx("div",{className:"border rounded-lg",children:e.jsxs(se,{className:"table-center-all",children:[e.jsx(ae,{children:e.jsxs(ne,{children:[e.jsx(te,{className:"text-center w-12 max-w-12 min-w-12",children:e.jsx("span",{className:"arabic-enhanced font-medium text-xs",children:"#"})}),e.jsx(z,{field:"full_name",children:"الاسم الكامل للمريض"}),e.jsx(z,{field:"gender",children:"الجنس"}),e.jsx(z,{field:"age",children:"العمر"}),e.jsx(z,{field:"phone",children:"رقم الهاتف"}),e.jsx(z,{field:"patient_condition",children:"حالة المريض"}),e.jsx(z,{field:"date_added",children:"تاريخ الإضافة"}),e.jsx(te,{className:"text-center",children:"الاجراءات"})]})}),e.jsx(le,{children:e.jsx(ne,{children:e.jsx(re,{colSpan:8,className:"text-center py-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(r,{className:"w-12 h-12 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"لا توجد مرضى"})]})})})})]})});const{patients:M,totalPages:L,totalCount:$}=O,V=(S-1)*k,H=e=>{E(e)};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(se,{className:"table-center-all",children:[e.jsx(ae,{children:e.jsxs(ne,{className:"bg-muted/50",children:[e.jsx(te,{className:"text-center w-12 max-w-12 min-w-12",children:e.jsx("span",{className:"arabic-enhanced font-medium text-xs",children:"#"})}),e.jsx(z,{field:"full_name",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"الاسم الكامل للمريض"})}),e.jsx(z,{field:"gender",children:e.jsx("span",{className:"arabic-enhanced font-medium hidden md:inline",children:"الجنس"})}),e.jsx(z,{field:"age",children:e.jsx("span",{className:"arabic-enhanced font-medium hidden md:inline",children:"العمر"})}),e.jsx(z,{field:"phone",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"رقم الهاتف"})}),e.jsx(z,{field:"patient_condition",children:e.jsx("span",{className:"arabic-enhanced font-medium hidden lg:inline",children:"حالة المريض"})}),e.jsx(z,{field:"date_added",children:e.jsx("span",{className:"arabic-enhanced font-medium hidden lg:inline",children:"تاريخ الإضافة"})}),e.jsx(te,{className:"text-center",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"الاجراءات"})})]})}),e.jsx(le,{children:M.map((s,a)=>{const n=V+a+1;return e.jsxs(ne,{className:"hover:bg-muted/50",children:[e.jsx(re,{className:"font-medium text-center w-12 max-w-12 min-w-12 text-xs",children:n}),e.jsx(re,{className:"font-medium text-center",children:e.jsx("span",{children:s.full_name??"غير محدد"})}),e.jsx(re,{className:"text-center hidden md:table-cell",children:e.jsx(i,{variant:"male"===s.gender?"default":"secondary",children:"male"===s.gender?"ذكر":"أنثى"})}),e.jsxs(re,{className:"text-center hidden md:table-cell",children:[s.age," سنة"]}),e.jsx(re,{className:"min-w-[120px] text-center table-cell-wrap-truncate-sm",children:s.phone?e.jsx("div",{className:"flex items-center justify-center",children:e.jsxs("button",{onClick:async()=>{const e=`https://api.whatsapp.com/send/?phone=${s.phone}`;try{if(window.electronAPI&&window.electronAPI.system&&window.electronAPI.system.openExternal)return void(await window.electronAPI.system.openExternal(e))}catch(a){console.log("Method 1 failed:",a)}try{if(window.electronAPI)return void(await(window.electronAPI.shell?.openExternal?.(e)))}catch(a){console.log("Method 2 failed:",a)}window.open(e,"_blank","noopener,noreferrer")},className:"text-sm arabic-enhanced text-green-600 hover:text-green-800 hover:underline cursor-pointer transition-colors bg-transparent border-none p-0 flex items-center gap-1",title:"فتح محادثة واتساب",children:[s.phone,e.jsx(c,{className:"w-3 h-3 text-green-600"})]})}):e.jsx("span",{className:"text-muted-foreground text-sm arabic-enhanced",children:"غير محدد"})}),e.jsx(re,{className:"min-w-[150px] text-center hidden lg:table-cell",children:e.jsx(i,{variant:"outline",className:"max-w-[150px] truncate arabic-enhanced",title:s.patient_condition,children:s.patient_condition})}),e.jsx(re,{className:"text-center hidden lg:table-cell",children:e.jsx("span",{className:"text-sm arabic-enhanced",children:d(s.date_added)})}),e.jsx(re,{className:"w-auto text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 flex-wrap",children:[e.jsxs(o,{variant:"ghost",size:"sm",className:"action-btn-view h-8 px-2 min-w-0",onClick:()=>v(s),title:"عرض تفاصيل المريض",children:[e.jsx(m,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs arabic-enhanced hidden sm:inline ml-1",children:"عرض"})]}),e.jsxs(o,{variant:"ghost",size:"sm",className:"action-btn-edit h-8 px-2 min-w-0",onClick:()=>g(s),title:"تعديل بيانات المريض",children:[e.jsx(oe,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs arabic-enhanced hidden sm:inline ml-1",children:"تعديل"})]}),e.jsxs(o,{variant:"ghost",size:"sm",className:"action-btn-delete text-red-600 hover:text-red-700 hover:bg-red-50 h-8 px-2 min-w-0",onClick:()=>w(s.id),title:"حذف المريض",children:[e.jsx(me,{className:"w-3 h-3"}),e.jsx("span",{className:"text-xs arabic-enhanced hidden sm:inline ml-1",children:"حذف"})]}),e.jsxs(G,{children:[e.jsx(J,{asChild:!0,children:e.jsx(o,{variant:"ghost",size:"sm",className:"h-8 px-2 min-w-0",title:"المزيد من الخيارات",children:e.jsx(he,{className:"w-3 h-3"})})}),e.jsxs(R,{align:"end",className:"patient-actions-dropdown",children:[e.jsxs(U,{onClick:()=>(async e=>{try{I({title:"جاري إعداد الطباعة...",description:"يتم تجميع بيانات المريض وإعداد الطباعة المباشرة"});const s=await ie.getPatientIntegratedData(e.id);if(!s)throw new Error("لا يمكن جلب بيانات المريض");const a=de.createPatientRecordHTMLForPrint(s,T);await F(a,e.full_name),I({title:"تم إعداد الطباعة",description:`تم إعداد طباعة سجل المريض ${e.full_name}`})}catch(s){console.error("Error printing patient record:",s),I({title:"خطأ في الطباعة",description:"فشل في إعداد طباعة سجل المريض. يرجى المحاولة مرة أخرى.",variant:"destructive"})}})(s),className:"dropdown-item",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{className:"arabic-enhanced",children:"طباعة مباشرة"})]}),e.jsxs(U,{onClick:()=>(async e=>{try{I({title:"جاري إعداد التقرير...",description:"يتم تجميع بيانات المريض وإعداد التقرير للتصدير"});const s=await ie.getPatientIntegratedData(e.id);if(!s)throw new Error("لا يمكن جلب بيانات المريض");await de.exportIndividualPatientRecord(s,T),I({title:"تم إنشاء التقرير بنجاح",description:`تم إنشاء سجل المريض ${e.full_name} وحفظه كملف PDF`})}catch(s){console.error("Error exporting patient record:",s),I({title:"خطأ في إنشاء التقرير",description:"فشل في إنشاء سجل المريض. يرجى المحاولة مرة أخرى.",variant:"destructive"})}})(s),className:"dropdown-item",children:[e.jsx(xe,{className:"w-4 h-4"}),e.jsx("span",{className:"arabic-enhanced",children:"تصدير سجل المريض"})]}),e.jsx(K,{}),b&&e.jsxs(U,{onClick:()=>b(s),className:"dropdown-item",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{className:"arabic-enhanced",children:"فاتورة الآجلات"})]})]})]})]})})]},s.id)})})]})})}),$>0&&e.jsxs("div",{className:"flex items-center justify-between px-2 flex-col gap-3 sm:flex-row",children:[e.jsx("div",{className:"flex items-center space-x-2 space-x-reverse",children:e.jsxs("p",{className:"text-sm text-muted-foreground arabic-enhanced",children:["عرض ",(S-1)*k+1," إلى ",Math.min(S*k,$)," من ",$," مريض"]})}),e.jsxs("div",{className:"flex items-center space-x-6 space-x-reverse lg:space-x-8 flex-wrap justify-center",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("p",{className:"text-sm font-medium arabic-enhanced",children:"عدد الصفوف لكل صفحة"}),e.jsxs(x,{value:`${k}`,onValueChange:e=>{D(parseInt(e)),E(1)},children:[e.jsx(h,{className:"h-8 w-[70px]",children:e.jsx(p,{placeholder:k})}),e.jsx(j,{side:"top",children:[10,20,30,50,100].map(s=>e.jsx(u,{value:`${s}`,children:s},s))})]})]}),e.jsxs("div",{className:"flex w-[120px] items-center justify-center text-sm font-medium arabic-enhanced",children:["صفحة ",S," من ",L]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(o,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>H(1),disabled:1===S,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة الأولى"}),e.jsx(ue,{className:"h-4 w-4"})]}),e.jsxs(o,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>H(S-1),disabled:1===S,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة السابقة"}),e.jsx(f,{className:"h-4 w-4"})]}),e.jsxs(o,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>H(S+1),disabled:S===L,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة التالية"}),e.jsx(Ne,{className:"h-4 w-4"})]}),e.jsxs(o,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>H(L),disabled:S===L,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة الأخيرة"}),e.jsx(fe,{className:"h-4 w-4"})]})]})]})]})]})});function Pe({isOpen:a,patient:n,onClose:t,onSave:l}){const[r,i]=s.useState({serial_number:"",full_name:"",gender:"male",age:0,patient_condition:"",allergies:"",medical_conditions:"",email:"",address:"",notes:"",phone:"",date_added:""});s.useEffect(()=>{if(n){const e=e=>{if(!e)return"";return new Date(e).toISOString().slice(0,16)};i({serial_number:n.serial_number||"",full_name:n.full_name||"",gender:n.gender||"male",age:n.age||0,patient_condition:n.patient_condition||"",allergies:n.allergies||"",medical_conditions:n.medical_conditions||"",email:n.email||"",address:n.address||"",notes:n.notes||"",phone:n.phone||"",date_added:e(n.date_added||n.created_at||"")})}},[n]);const c=e=>{i({...r,[e.target.name]:e.target.value})};return n?e.jsx(N,{open:a,onOpenChange:t,children:e.jsxs(g,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs(w,{children:[e.jsx(v,{children:"تعديل بيانات المريض"}),e.jsx(b,{children:"قم بتعديل معلومات المريض أدناه. الحقول المميزة بـ * مطلوبة."})]}),e.jsxs("form",{onSubmit:e=>{e.preventDefault(),n&&(l(n.id,r),t())},className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"الحقول المطلوبة"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"الاسم الكامل *"}),e.jsx(C,{type:"text",name:"full_name",value:r.full_name,onChange:c,required:!0,placeholder:"أدخل الاسم الكامل"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"الجنس *"}),e.jsxs(x,{value:r.gender,onValueChange:e=>i({...r,gender:e}),children:[e.jsx(h,{className:"bg-background border-input text-foreground",children:e.jsx(p,{placeholder:"اختر الجنس",className:"text-muted-foreground"})}),e.jsxs(j,{children:[e.jsx(u,{value:"male",children:"ذكر"}),e.jsx(u,{value:"female",children:"أنثى"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"العمر *"}),e.jsx(C,{type:"number",min:"1",max:"120",name:"age",value:r.age,onChange:c,required:!0,placeholder:"أدخل العمر"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"تاريخ الإضافة *"}),e.jsx(C,{type:"datetime-local",name:"date_added",value:r.date_added,onChange:c,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"رقم الهاتف"}),e.jsx(C,{type:"tel",name:"phone",value:r.phone,onChange:c,placeholder:"963987654321"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"يرجى إدخال رقم الهاتف مع رمز الدولة بدون + أو 00 (مثل: 963987654321)"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:"الحقول الاختيارية"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"حالة المريض / التشخيص"}),e.jsx(_,{name:"patient_condition",value:r.patient_condition,onChange:c,placeholder:"أدخل وصف الحالة الطبية أو التشخيص",rows:3})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"الحساسية"}),e.jsx(C,{type:"text",name:"allergies",value:r.allergies,onChange:c,placeholder:"أدخل معلومات الحساسية المعروفة"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"الحالات الطبية / الأمراض"}),e.jsx(_,{name:"medical_conditions",value:r.medical_conditions,onChange:c,placeholder:"أدخل الحالات الطبية أو الأمراض المزمنة",rows:2})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"البريد الإلكتروني"}),e.jsx(C,{type:"email",name:"email",value:r.email,onChange:c,placeholder:"أدخل البريد الإلكتروني"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"العنوان"}),e.jsx(C,{type:"text",name:"address",value:r.address,onChange:c,placeholder:"أدخل العنوان الكامل"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{className:"text-sm font-medium",children:"ملاحظات / تعليقات"}),e.jsx(_,{name:"notes",value:r.notes,onChange:c,placeholder:"أدخل أي ملاحظات أو تعليقات إضافية",rows:3})]})]}),e.jsxs(P,{className:"flex justify-end space-x-4 space-x-reverse",children:[e.jsx(o,{type:"button",variant:"outline",onClick:t,children:"إلغاء"}),e.jsx(o,{type:"submit",children:"حفظ التغييرات"})]})]})]})}):null}function Se({onNavigateToTreatments:n,onNavigateToPayments:l}){S();const{filteredPatients:r,isLoading:i,error:c,searchQuery:d,setSearchQuery:m,deletePatient:f,updatePatient:N,clearError:g,loadPatients:w}=E(),{loadAppointments:v}=k(),{loadPayments:b}=D(),{toast:y}=t(),[_,P]=s.useState(!1),[se,ae]=s.useState(!1),[ne,te]=s.useState(!1),[le,re]=s.useState(!1),[ie,de]=s.useState(null),[oe,he]=s.useState(null),[pe,ue]=s.useState(null),[fe,Ne]=s.useState(!1),[ge,we]=s.useState(null),[ve,Se]=s.useState(!1),[Ee,ke]=s.useState("all"),[De,Te]=s.useState("all"),[Ie,Fe]=s.useState({start:"",end:""});s.useEffect(()=>{w(),v(),b()},[w,v,b]),s.useEffect(()=>{const e=localStorage.getItem("selectedPatientForDetails");if(e)try{const{patient:s,openDetailsModal:a}=JSON.parse(e);a&&s&&(de(s),ae(!0),localStorage.removeItem("selectedPatientForDetails"))}catch(s){console.error("Error parsing search result data:",s),localStorage.removeItem("selectedPatientForDetails")}},[]);const Oe=e=>{he(e),te(!0)},Ae=a.useMemo(()=>{let e=[...r];if("all"!==Ee&&(e=e.filter(e=>e.gender===Ee)),"all"!==De&&(e=e.filter(e=>{const s="number"==typeof e.age?e.age:e.date_of_birth?T(e.date_of_birth):null;if(null==s)return"unknown"===De;switch(De){case"child":return s<18;case"adult":return s>=18&&s<60;case"senior":return s>=60;case"unknown":return!1;default:return!0}})),Ie.start&&Ie.end){const s=new Date(Ie.start),a=new Date(Ie.end);a.setHours(23,59,59,999),e=e.filter(e=>{if(!e.date_added)return!1;const n=new Date(e.date_added);return n>=s&&n<=a})}return e},[r,Ee,De,Ie]);return c?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-destructive mb-4",children:c}),e.jsx(o,{onClick:g,children:"Try Again"})]})}):e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-start sm:items-center justify-between gap-4 flex-col sm:flex-row",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-heading-1 text-foreground arabic-enhanced",children:"إدارة المرضى"}),e.jsx("p",{className:"text-body text-muted-foreground mt-2 arabic-enhanced",children:"إدارة معلومات المرضى وسجلاتهم الطبية"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap sm:flex-nowrap space-x-2 space-x-reverse",children:[e.jsxs(G,{children:[e.jsx(J,{asChild:!0,children:e.jsxs(o,{variant:"outline",className:"w-full sm:w-auto",children:[e.jsx(xe,{className:"w-4 h-4 ml-2"}),"تصدير"]})}),e.jsxs(R,{align:"end",className:"w-44",children:[e.jsxs(U,{onClick:async()=>{if(0!==Ae.length)try{await ee.exportPatientsToExcel(Ae),X.exportSuccess(`تم تصدير ${Ae.length} مريض بنجاح إلى ملف Excel!`)}catch(e){console.error("Error exporting patients (Excel):",e),X.exportError("فشل في تصدير بيانات المرضى (Excel)")}else X.noDataToExport("لا توجد بيانات مرضى للتصدير")},className:"arabic-enhanced",children:[e.jsx(xe,{className:"w-4 h-4 ml-2"}),"تصدير Excel"]}),e.jsx(K,{}),e.jsxs(U,{onClick:async()=>{if(0!==Ae.length)try{await ee.exportPatientsToPDF(Ae),X.exportSuccess(`تم تصدير ${Ae.length} مريض كملف PDF بنجاح!`)}catch(e){console.error("Error exporting patients (PDF):",e),X.exportError("فشل في تصدير بيانات المرضى (PDF)")}else X.noDataToExport("لا توجد بيانات مرضى للتصدير")},className:"arabic-enhanced",children:[e.jsx(je,{className:"w-4 h-4 ml-2"}),"تصدير PDF"]})]})]}),e.jsxs(o,{onClick:()=>P(!0),className:"w-full sm:w-auto",children:[e.jsx(ye,{className:"w-4 h-4 ml-2"}),"إضافة مريض جديد"]})]})]}),e.jsx(I,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-stretch gap-4 flex-col md:flex-row",dir:"rtl",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(O,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(C,{placeholder:"البحث بالاسم أو الهاتف أو البريد الإلكتروني...",value:d,onChange:e=>m(e.target.value),className:"pr-10 text-right",dir:"rtl"})]}),e.jsx(Y,{open:ve,onOpenChange:Se,children:e.jsx(Z,{asChild:!0,children:e.jsxs(o,{variant:"outline",size:"sm",className:"shrink-0 w-full md:w-auto",children:[e.jsx(Ce,{className:"w-4 h-4 mr-2"}),"تصفية",("all"!==Ee||"all"!==De||Ie.start||Ie.end)&&e.jsx("span",{className:"mr-2 w-2 h-2 bg-primary rounded-full"})]})})}),(d||"all"!==Ee||"all"!==De||Ie.start||Ie.end)&&e.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>{m(""),ke("all"),Te("all"),Fe({start:"",end:""}),Se(!1)},className:"shrink-0 w-full md:w-auto",children:[e.jsx(A,{className:"w-4 h-4 mr-2"}),"مسح الكل"]})]}),e.jsx(Y,{open:ve,onOpenChange:Se,children:e.jsx(W,{className:"space-y-4",dir:"rtl",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 p-4 bg-muted/50 rounded-lg",dir:"rtl",children:[e.jsxs("div",{className:"space-y-2 text-right",children:[e.jsx("label",{className:"text-sm font-medium",children:"الجنس"}),e.jsxs(x,{value:Ee,onValueChange:ke,dir:"rtl",children:[e.jsx(h,{className:"text-right",children:e.jsx(p,{placeholder:"جميع الأجناس"})}),e.jsxs(j,{children:[e.jsx(u,{value:"all",children:"جميع الأجناس"}),e.jsx(u,{value:"male",children:"ذكر"}),e.jsx(u,{value:"female",children:"أنثى"})]})]})]}),e.jsxs("div",{className:"space-y-2 text-right",children:[e.jsx("label",{className:"text-sm font-medium",children:"الفئة العمرية"}),e.jsxs(x,{value:De,onValueChange:Te,dir:"rtl",children:[e.jsx(h,{className:"text-right",children:e.jsx(p,{placeholder:"جميع الأعمار"})}),e.jsxs(j,{children:[e.jsx(u,{value:"all",children:"جميع الأعمار"}),e.jsx(u,{value:"child",children:"أطفال (أقل من 18)"}),e.jsx(u,{value:"adult",children:"بالغين (18-59)"}),e.jsx(u,{value:"senior",children:"كبار السن (60+)"}),e.jsx(u,{value:"unknown",children:"غير محدد"})]})]})]}),e.jsxs("div",{className:"space-y-2 text-right",children:[e.jsx("label",{className:"text-sm font-medium",children:"تاريخ الإضافة"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(C,{type:"date",placeholder:"من تاريخ",value:Ie.start,onChange:e=>Fe(s=>({...s,start:e.target.value})),className:"text-right",dir:"rtl"}),e.jsx(C,{type:"date",placeholder:"إلى تاريخ",value:Ie.end,onChange:e=>Fe(s=>({...s,end:e.target.value})),className:"text-right",dir:"rtl"})]})]})]})})})]})})}),e.jsx("div",{className:"space-y-6",children:e.jsx(_e,{patients:Ae,isLoading:i,onEdit:Oe,onDelete:async e=>{we(e),Ne(!0)},onViewDetails:e=>{de(e),ae(!0)},onViewPendingInvoice:e=>{ue(e),re(!0)}})}),e.jsx(z,{open:_,onOpenChange:P}),e.jsx(ce,{patient:ie,open:se,onOpenChange:ae,onEdit:Oe,onNavigateToTreatments:n,onNavigateToPayments:l}),e.jsx(Pe,{isOpen:ne,patient:oe,onClose:()=>{te(!1),he(null)},onSave:async(e,s)=>{try{await N(e,s),te(!1),he(null),y({title:"نجح",description:"تم تحديث بيانات المريض بنجاح"})}catch(a){console.error("Error updating patient:",a),y({title:"خطأ",description:"فشل في تحديث بيانات المريض. يرجى المحاولة مرة أخرى",variant:"destructive"})}}}),e.jsx(be,{patient:pe,open:le,onOpenChange:e=>{re(e),e||ue(null)}}),e.jsx(M,{open:fe,onOpenChange:Ne,children:e.jsxs(L,{dir:"rtl",children:[e.jsxs($,{children:[e.jsxs(V,{className:"flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5 text-destructive"}),"تأكيد حذف المريض"]}),e.jsxs(H,{children:["هل أنت متأكد من حذف هذا المريض؟ سيتم حذف جميع البيانات المرتبطة به بما في ذلك المواعيد والمدفوعات.",e.jsx("br",{}),e.jsx("strong",{className:"text-destructive",children:"تحذير: لا يمكن التراجع عن هذا الإجراء!"})]})]}),e.jsxs(q,{className:"flex-row-reverse",children:[e.jsxs(Q,{onClick:async()=>{if(ge)try{await f(ge),X.deleteSuccess("تم حذف المريض بنجاح")}catch(e){X.deleteError("فشل في حذف المريض")}finally{Ne(!1),we(null)}},className:"bg-destructive hover:bg-destructive/90",children:[e.jsx(me,{className:"w-4 h-4 ml-2"}),"تأكيد الحذف"]}),e.jsx(B,{children:"إلغاء"})]})]})})]})}export{Se as default};
