import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{u as a,a as s,b as n,c as r,d as i,e as l,D as d,f as o,g as c,h as m,i as x,A as p,C as u,j as h,k as j,R as g,l as f,L as N,S as b,m as v,n as _,o as y,p as w,q as k,B as F,r as $,s as C,I as D,t as S,v as T,w as P,T as L,x as z,y as E,z as M,E as A,F as R,G as B,H as O,J as Q,K as V,U as q,M as H,N as I,O as J,P as W,Q as U,V as G,W as K,X as Y,Y as X,Z,_ as ee,$ as te,a0 as ae,a1 as se,a2 as ne,a3 as re,a4 as ie,a5 as le,a6 as de,a7 as oe,a8 as ce,a9 as me,aa as xe,ab as pe,ac as ue,ad as he,ae as je,af as ge,ag as fe,ah as Ne,ai as be}from"./index-3a8dc84c.js";import{D as ve,a as _e,b as ye,c as we,d as ke}from"./dropdown-menu-0651433f.js";import{g as Fe,a as $e}from"./cardStyles-c77ef46a.js";import{u as Ce,T as De}from"./useTimeFilteredStats-1c30c8be.js";import{P as Se}from"./pen-square-6c634feb.js";import{b as Te,J as Pe}from"./qr-d6f50769.js";import{S as Le}from"./settings-39dd9f65.js";import{D as ze,T as Ee}from"./upload-4df8a268.js";import{P as Me}from"./printer-5ab76652.js";import{F as Ae}from"./file-text-861b9f90.js";import{T as Re,a as Be,b as Oe,c as Qe,d as Ve,e as qe}from"./table-20957d0a.js";import{C as He,a as Ie}from"./chevrons-right-9b995d31.js";import{C as Je}from"./chevron-left-343e35ff.js";import{A as We,a as Ue,b as Ge}from"./arrow-up-832b5917.js";import{C as Ke,a as Ye,b as Xe}from"./collapsible-d3d2b240.js";import{U as Ze}from"./unlock-51cfe0e8.js";import{n as et}from"./notificationService-09cb27cc.js";import{E as tt}from"./exportService-1536567b.js";import{P as at}from"./plus-1eab3b5b.js";import{T as st}from"./trending-up-5cd3f2a0.js";import{F as nt}from"./filter-f006659c.js";import"./pdf-991f41f6.js";import"./utils-ec524415.js";import"./charts-b4389b44.js";import"./index-a46c293c.js";import"./excel-37615a09.js";const rt=t.memo(function({open:E,onOpenChange:M,payment:A}){const{toast:R}=a(),{updatePayment:B,isLoading:O,getPaymentsByPatient:Q,getPaymentsByAppointment:V,getPaymentsByToothTreatment:q}=s(),H=n(e=>e.patients),I=r(e=>e.appointments),J=i(e=>e.toothTreatments),W=i(e=>e.loadToothTreatmentsByPatient),{formatAmount:U}=l(),[G,K]=t.useState({patient_id:"",tooth_treatment_id:"none",appointment_id:"none",amount:"",payment_method:"cash",payment_date:"",description:"",receipt_number:"",status:"completed",notes:"",discount_amount:"",tax_amount:"",total_amount_due:"",amount_paid:""}),[Y,X]=t.useState({previousPayments:0,originalAmount:0,isCalculating:!1}),Z=e=>{if(!e)return"";const t=e.replace(/,/g,"");if(isNaN(Number(t)))return e;const a=t.split(".");return a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),a.join(".")},ee=e=>e.replace(/,/g,""),te=()=>{const e=new Date;return`RCP-${e.getFullYear().toString().slice(-2)}${(e.getMonth()+1).toString().padStart(2,"0")}${e.getDate().toString().padStart(2,"0")}-${e.getTime().toString().slice(-4)}`},ae=()=>{const e=parseFloat(G.amount)||0;return Y.previousPayments+e},se=()=>{const e=parseFloat(G.total_amount_due)||0,t=ae();return Math.max(0,e-t)};t.useEffect(()=>{if(G.appointment_id&&"none"!==G.appointment_id&&A){X(e=>({...e,isCalculating:!0}));const a=(e=G.appointment_id,t=A.id,e&&"none"!==e?V(e).filter(e=>e.id!==t).reduce((e,t)=>e+t.amount,0):0),s=A.amount;X({previousPayments:a,originalAmount:s,isCalculating:!1})}else A&&X({previousPayments:0,originalAmount:A.amount,isCalculating:!1});var e,t},[G.appointment_id,A]),t.useEffect(()=>{if(G.appointment_id&&"none"!==G.appointment_id){const e=(e=>{if(!e||"none"===e)return 0;const t=I.find(t=>t.id===e);return t?.cost||0})(G.appointment_id);e>0&&!G.total_amount_due&&K(t=>({...t,total_amount_due:e.toString()}))}},[G.appointment_id]),t.useEffect(()=>{if(G.tooth_treatment_id&&"none"!==G.tooth_treatment_id){const e=J.find(e=>e.id===G.tooth_treatment_id);e&&e.cost&&K(t=>({...t,total_amount_due:e.cost.toString()}))}},[G.tooth_treatment_id,J]),t.useEffect(()=>{if(G.amount&&Y.previousPayments>=0){const e=ae();K(t=>({...t,amount_paid:e.toString()}))}},[G.amount,Y.previousPayments]),t.useEffect(()=>{A&&E&&(K({patient_id:A.patient_id||"",tooth_treatment_id:A.tooth_treatment_id||"none",appointment_id:A.appointment_id||"none",amount:A.amount.toString(),payment_method:A.payment_method,payment_date:A.payment_date.split("T")[0],description:A.description||"",receipt_number:A.receipt_number||"",status:A.status,notes:A.notes||"",discount_amount:A.discount_amount?.toString()||"",tax_amount:A.tax_amount?.toString()||"",total_amount_due:A.total_amount_due?.toString()||"",amount_paid:A.amount_paid?.toString()||""}),A.patient_id&&W(A.patient_id))},[A,E]);const ne=(e,t)=>{K(a=>({...a,[e]:t}))},re=()=>{const e=G.amount?parseFloat(G.amount):0,t=G.total_amount_due?parseFloat(G.total_amount_due):0;if(t>0){if(G.appointment_id&&"none"!==G.appointment_id){const a=V(G.appointment_id).filter(e=>e.id!==A.id).reduce((e,t)=>e+t.amount,0)+e;return a>=t?"completed":a>0?"partial":"pending"}{const a=parseFloat(G.amount_paid)||e;return a>=t?"completed":a>0?"partial":"pending"}}return e>0?"completed":"pending"};t.useEffect(()=>{const e=G.amount?parseFloat(G.amount):0;if((G.total_amount_due?parseFloat(G.total_amount_due):0)>0||e>0){const e=re();K(t=>({...t,status:e}))}},[G.amount,G.total_amount_due,G.appointment_id]);const ie=I.filter(e=>e.patient_id===G.patient_id),le=J.filter(e=>{if(e.patient_id!==G.patient_id)return!1;if(A.tooth_treatment_id===e.id)return!0;const t=q(e.id),a=e.cost||0;if(0===t.length)return!0;return t.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>e+t.amount,0)<a});return e.jsx(d,{open:E,onOpenChange:M,children:e.jsxs(o,{className:"max-w-4xl max-h-[90vh] overflow-y-auto bg-background border-border shadow-2xl",dir:"rtl",children:[e.jsxs(c,{className:"border-b border-border pb-4",children:[e.jsxs(m,{className:"flex items-center text-xl font-semibold text-foreground",children:[e.jsx(Se,{className:"w-5 h-5 ml-2 text-primary"}),"تعديل الدفعة"]}),e.jsxs(x,{className:"text-muted-foreground",children:["تعديل بيانات الدفعة رقم ",A.receipt_number||A.id.slice(-6)]})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),G.patient_id&&G.payment_date)try{const e=G.amount?parseFloat(G.amount):0,t=G.discount_amount?parseFloat(G.discount_amount):0,a=G.tax_amount?parseFloat(G.tax_amount):0,s=e+a-t,n=G.total_amount_due?parseFloat(G.total_amount_due):s,r=ae(),i=n-r,l=A.tooth_treatment_id&&"none"!==A.tooth_treatment_id?A.tooth_treatment_id:G.tooth_treatment_id&&"none"!==G.tooth_treatment_id?G.tooth_treatment_id:void 0,d={patient_id:G.patient_id,tooth_treatment_id:l,appointment_id:G.appointment_id&&"none"!==G.appointment_id?G.appointment_id:void 0,amount:e,payment_method:G.payment_method,payment_date:G.payment_date,description:G.description,receipt_number:G.receipt_number||te(),status:G.status,notes:G.notes,discount_amount:t>0?t:void 0,tax_amount:a>0?a:void 0,total_amount:s,total_amount_due:n,amount_paid:r,remaining_balance:i};await B(A.id,d),R({title:"تم بنجاح",description:"تم تحديث الدفعة بنجاح"}),M(!1)}catch(t){R({title:"خطأ",description:t instanceof Error?t.message:"فشل في تحديث الدفعة",variant:"destructive"})}else R({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"})},className:"space-y-6",children:["none"!==G.tooth_treatment_id&&e.jsx("div",{className:"bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(p,{className:"w-5 h-5 text-orange-600 dark:text-orange-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium text-orange-800 dark:text-orange-200",children:"دفعة مرتبطة بعلاج"}),e.jsx("p",{className:"text-sm text-orange-700 dark:text-orange-300",children:"هذه الدفعة مرتبطة بعلاج محدد. المبلغ الإجمالي المطلوب مرتبط بتكلفة العلاج ولا يمكن تعديله من هنا. لتعديل المبلغ، قم بتعديل تكلفة العلاج من قسم العلاجات."})]})]})}),e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(g,{className:"w-4 h-4 ml-2 text-primary"}),"معلومات المريض"]})}),e.jsx(f,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"patient_id",className:"text-foreground font-medium",children:"المريض *"}),e.jsxs(b,{value:G.patient_id,onValueChange:e=>ne("patient_id",e),children:[e.jsx(v,{className:"bg-background border-input text-foreground",children:e.jsx(_,{placeholder:"اختر المريض",className:"text-muted-foreground"})}),e.jsx(y,{children:H.map(t=>e.jsx(w,{value:t.id,children:t.full_name},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"tooth_treatment_id",className:"text-foreground font-medium",children:"العلاج"}),A.tooth_treatment_id&&"none"!==A.tooth_treatment_id?e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"p-3 bg-muted/50 border border-border rounded-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex flex-col",children:(()=>{const t=J.find(e=>e.id===A.tooth_treatment_id);return t?e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"font-medium text-foreground",children:["السن ",t.tooth_number," - ",k(t.treatment_type)]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["التكلفة: ",U(t.cost||0)]})]}):e.jsxs("span",{className:"text-muted-foreground",children:["العلاج المرتبط (معرف: ",A.tooth_treatment_id,")"]})})()}),e.jsx(F,{variant:"secondary",className:"text-xs",children:"مرتبط"})]})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"⚠️ لا يمكن تغيير العلاج للمدفوعات المرتبطة بعلاج محدد"}),e.jsx("input",{type:"hidden",value:A.tooth_treatment_id})]}):e.jsxs(b,{value:G.tooth_treatment_id,onValueChange:e=>ne("tooth_treatment_id",e),children:[e.jsx(v,{className:"bg-background border-input text-foreground",children:e.jsx(_,{placeholder:"اختر العلاج",className:"text-muted-foreground"})}),e.jsxs(y,{children:[e.jsx(w,{value:"none",children:"بدون علاج محدد"}),le.map(t=>{const a=q(t.id),s=t.cost||0,n=s-a.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>e+t.amount,0);return e.jsx(w,{value:t.id,children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{children:`السن ${t.tooth_number} - ${k(t.treatment_type)}`}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsxs("span",{children:["التكلفة: ",U(s)]}),n>0&&n<s&&e.jsxs("span",{className:"text-orange-600 font-medium",children:[" • متبقي: ",U(n)]})]})]})},t.id)})]})]})]}),e.jsxs("div",{className:"space-y-2 hidden",children:[e.jsx(N,{htmlFor:"appointment_id",className:"text-foreground font-medium",children:"الموعد (اختياري)"}),e.jsxs(b,{value:G.appointment_id,onValueChange:e=>ne("appointment_id",e),children:[e.jsx(v,{className:"bg-background border-input text-foreground",children:e.jsx(_,{placeholder:"اختر الموعد",className:"text-muted-foreground"})}),e.jsxs(y,{children:[e.jsx(w,{value:"none",children:"بدون موعد محدد"}),ie.map(t=>e.jsxs(w,{value:t.id,children:[t.title," - ",$(t.start_time)]},t.id))]})]})]})]})})]}),e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(C,{className:"w-4 h-4 ml-2 text-primary"}),"تفاصيل المبالغ والدفع"]})}),e.jsxs(f,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"amount",className:"text-foreground font-medium",children:"المبلغ"}),e.jsx(D,{id:"amount",type:"text",value:Z(G.amount),onChange:e=>{const t=ee(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&ne("amount",t)},onBlur:e=>{const t=ee(e.target.value),a=parseFloat(t)||0;ne("amount",a.toString())},placeholder:"0",className:"bg-background border-input text-foreground"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"payment_method",className:"text-foreground font-medium",children:"طريقة الدفع"}),e.jsxs(b,{value:G.payment_method,onValueChange:e=>ne("payment_method",e),children:[e.jsx(v,{className:"bg-background border-input text-foreground",children:e.jsx(_,{placeholder:"اختر طريقة الدفع",className:"text-muted-foreground"})}),e.jsxs(y,{children:[e.jsx(w,{value:"cash",children:"نقداً"}),e.jsx(w,{value:"bank_transfer",children:"تحويل بنكي"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"payment_date",className:"text-foreground font-medium",children:"تاريخ الدفع *"}),e.jsx(D,{id:"payment_date",type:"date",value:G.payment_date,onChange:e=>ne("payment_date",e.target.value),required:!0,className:"bg-background border-input text-foreground"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{htmlFor:"status",className:"text-foreground font-medium",children:["الحالة",G.amount&&parseFloat(G.amount)>0&&e.jsxs("span",{className:"text-xs text-muted-foreground mr-2",children:["(مقترح: ","completed"===re()?"مكتمل":"partial"===re()?"جزئي":"آجل",")"]})]}),e.jsxs(b,{value:G.status,onValueChange:e=>ne("status",e),children:[e.jsx(v,{className:"bg-background border-input text-foreground",children:e.jsx(_,{placeholder:"اختر الحالة",className:"text-muted-foreground"})}),e.jsxs(y,{children:[e.jsx(w,{value:"completed",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"مكتمل"}),"completed"===re()&&e.jsx("span",{className:"text-xs text-green-600",children:"✓ مقترح"})]})}),e.jsx(w,{value:"partial",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"جزئي"}),"partial"===re()&&e.jsx("span",{className:"text-xs text-orange-600",children:"✓ مقترح"})]})}),e.jsx(w,{value:"pending",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"آجل"}),"pending"===re()&&e.jsx("span",{className:"text-xs text-blue-600",children:"✓ مقترح"})]})})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"discount_amount",className:"text-foreground font-medium",children:"مبلغ الخصم"}),e.jsx(D,{id:"discount_amount",type:"text",value:Z(G.discount_amount),onChange:e=>{const t=ee(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&ne("discount_amount",t)},onBlur:e=>{const t=ee(e.target.value),a=parseFloat(t)||0;ne("discount_amount",a.toString())},placeholder:"0",className:"bg-background border-input text-foreground"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"tax_amount",className:"text-foreground font-medium",children:"مبلغ الضريبة"}),e.jsx(D,{id:"tax_amount",type:"text",value:Z(G.tax_amount),onChange:e=>{const t=ee(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&ne("tax_amount",t)},onBlur:e=>{const t=ee(e.target.value),a=parseFloat(t)||0;ne("tax_amount",a.toString())},placeholder:"0",className:"bg-background border-input text-foreground"})]})]})]})]}),e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsxs(h,{children:[e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(S,{className:"w-4 h-4 ml-2 text-primary"}),"تتبع المدفوعات التلقائي"]}),e.jsx(T,{className:"text-muted-foreground",children:"تتبع المبالغ المطلوبة والمدفوعة والمتبقية مع الحسابات التلقائية"})]}),e.jsxs(f,{className:"space-y-4",children:[G.appointment_id&&"none"!==G.appointment_id&&e.jsx(u,{className:"bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-950/50 dark:to-blue-900/30 border-blue-200 dark:border-blue-800 shadow-sm transition-all duration-200",children:e.jsxs(f,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(S,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-sm font-medium text-primary",children:"الحسابات التلقائية للموعد"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"المدفوعات السابقة لهذا الموعد:"}),e.jsxs("span",{className:"font-medium text-foreground",children:["$",Y.previousPayments.toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"المبلغ الأصلي لهذه الدفعة:"}),e.jsxs("span",{className:"font-medium text-foreground",children:["$",Y.originalAmount.toFixed(2)]})]})]})]})}),"none"===G.appointment_id&&e.jsx(u,{className:"bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-950/50 dark:to-yellow-900/30 border-yellow-200 dark:border-yellow-800 shadow-sm transition-all duration-200",children:e.jsxs(f,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(p,{className:"w-4 h-4 text-yellow-600 dark:text-yellow-400"}),e.jsx("span",{className:"text-sm font-medium text-yellow-800 dark:text-yellow-200",children:"دفعة بدون موعد محدد"})]}),e.jsx("p",{className:"text-xs text-yellow-700 dark:text-yellow-300",children:"هذه الدفعة غير مرتبطة بموعد محدد، لذلك لا توجد مدفوعات سابقة مرتبطة بها"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{className:"flex items-center gap-2 text-foreground font-medium",htmlFor:"total_amount_due",children:["المبلغ الإجمالي المطلوب","none"!==G.tooth_treatment_id&&e.jsx(F,{variant:"outline",className:"text-xs text-orange-600 border-orange-600",children:"🔒 مرتبط بالعلاج"}),"none"!==G.appointment_id&&"none"===G.tooth_treatment_id&&e.jsxs(F,{variant:"secondary",className:"text-xs",children:[e.jsx(S,{className:"w-3 h-3 ml-1"}),"تلقائي"]})]}),e.jsx(D,{id:"total_amount_due",type:"text",value:Z(G.total_amount_due),onChange:e=>{const t=ee(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&ne("total_amount_due",t)},onBlur:e=>{const t=ee(e.target.value),a=parseFloat(t)||0;ne("total_amount_due",a.toString())},placeholder:"0",className:"bg-background border-input text-foreground "+("none"!==G.tooth_treatment_id?"opacity-60 cursor-not-allowed bg-muted":""),disabled:"none"!==G.tooth_treatment_id}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"none"!==G.tooth_treatment_id?"🔒 المبلغ مرتبط بتكلفة العلاج ولا يمكن تعديله هنا. لتعديل المبلغ، قم بتعديل تكلفة العلاج من قسم العلاجات.":"none"!==G.appointment_id?"تم جلب المبلغ من الموعد المحدد تلقائياً":"المبلغ الكامل المطلوب للعلاج أو الخدمة"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{className:"flex items-center gap-2 text-foreground font-medium",htmlFor:"amount_paid",children:["إجمالي المبلغ المدفوع",e.jsxs(F,{variant:"secondary",className:"text-xs",children:[e.jsx(S,{className:"w-3 h-3 ml-1"}),"محسوب تلقائياً"]})]}),e.jsx(D,{id:"amount_paid",type:"number",step:"0.1",value:G.amount_paid,readOnly:!0,className:"bg-muted cursor-not-allowed border-input text-foreground font-medium",placeholder:"0.00"}),e.jsxs("p",{className:"text-xs text-emerald-600 dark:text-emerald-400 font-medium",children:["✓ محسوب تلقائياً: المدفوعات السابقة (",U(Y.previousPayments),") + هذه الدفعة (",U(parseFloat(G.amount)||0),")"]})]})]}),G.total_amount_due&&e.jsx(u,{className:"shadow-sm transition-all duration-200 "+(se()>0?"bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-950/50 dark:to-orange-900/30 border-orange-200 dark:border-orange-800":"bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950/50 dark:to-green-900/30 border-green-200 dark:border-green-800"),children:e.jsxs(f,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium text-foreground",children:"المبلغ المتبقي:"}),e.jsxs(F,{variant:se()>0?"destructive":"default",className:"text-lg px-3 py-1",children:["$",se().toFixed(2)]})]}),0===se()&&e.jsx("p",{className:"text-xs text-emerald-600 dark:text-emerald-400 font-medium mt-2",children:"✓ تم سداد المبلغ بالكامل"})]})}),e.jsxs(u,{className:"bg-gradient-to-r from-muted/30 to-muted/50 border-border",children:[e.jsx(h,{children:e.jsx(j,{className:"text-sm text-card-foreground",children:"ملخص هذه الدفعة"})}),e.jsxs(f,{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"المبلغ الأساسي:"}),e.jsx("span",{className:"font-medium text-foreground",children:U(parseFloat(G.amount)||0)})]}),G.tax_amount&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"الضريبة:"}),e.jsxs("span",{className:"text-orange-600 dark:text-orange-400 font-medium",children:["+",U(parseFloat(G.tax_amount)||0)]})]}),G.discount_amount&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"الخصم:"}),e.jsxs("span",{className:"text-emerald-600 dark:text-emerald-400 font-medium",children:["-",U(parseFloat(G.discount_amount)||0)]})]}),e.jsxs("div",{className:"flex justify-between font-medium border-t border-border pt-2",children:[e.jsx("span",{className:"text-foreground",children:"إجمالي هذه الدفعة:"}),e.jsx(F,{variant:"outline",className:"text-base",children:U((parseFloat(G.amount)||0)+(parseFloat(G.tax_amount)||0)-(parseFloat(G.discount_amount)||0))})]})]})]})]})]}),e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{children:e.jsx(j,{className:"text-lg text-card-foreground",children:"معلومات إضافية"})}),e.jsxs(f,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{className:"flex items-center gap-2 text-foreground",htmlFor:"receipt_number",children:["رقم الإيصال",e.jsxs(F,{variant:"secondary",className:"text-xs",children:[e.jsx(S,{className:"w-3 h-3 ml-1"}),"مولد تلقائياً"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(D,{id:"receipt_number",value:G.receipt_number,onChange:e=>ne("receipt_number",e.target.value),placeholder:"رقم الإيصال",className:"flex-1 bg-background border-input text-foreground"}),e.jsx(P,{type:"button",variant:"outline",size:"sm",onClick:()=>ne("receipt_number",te()),className:"px-3",children:e.jsx(S,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-xs text-emerald-600 dark:text-emerald-400 font-medium",children:"✓ يمكن توليد رقم إيصال جديد تلقائياً"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"description",className:"text-foreground",children:"الوصف"}),e.jsx(L,{id:"description",value:G.description,onChange:e=>ne("description",e.target.value),placeholder:"وصف الدفعة",rows:3,className:"bg-background border-input text-foreground placeholder:text-muted-foreground"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"notes",className:"text-foreground",children:"ملاحظات"}),e.jsx(L,{id:"notes",value:G.notes,onChange:e=>ne("notes",e.target.value),placeholder:"ملاحظات إضافية",rows:3,className:"bg-background border-input text-foreground placeholder:text-muted-foreground"})]})]})]}),e.jsxs(z,{className:"flex justify-end space-x-3 space-x-reverse border-t border-border pt-4",children:[e.jsx(P,{type:"button",variant:"outline",onClick:()=>M(!1),disabled:O,children:"إلغاء"}),e.jsx(P,{type:"submit",disabled:O,className:"bg-primary hover:bg-primary/90 text-primary-foreground",children:O?"جاري الحفظ...":"حفظ التغييرات"})]})]})]})})});function it({open:t,onOpenChange:r,payment:i}){const{toast:l}=a(),{deletePayment:d,isLoading:o}=s(),{patients:c}=n();return e.jsx(E,{open:t,onOpenChange:r,children:e.jsxs(M,{className:"max-w-lg",dir:"rtl",children:[e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10",children:e.jsx(R,{className:"h-6 w-6 text-destructive"})}),e.jsxs("div",{children:[e.jsx(B,{className:"text-lg font-semibold text-destructive",children:"تأكيد حذف الدفعة"}),e.jsx(O,{children:"هذا الإجراء لا يمكن التراجع عنه"})]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(O,{children:"هل أنت متأكد من رغبتك في حذف هذه الدفعة؟ لا يمكن التراجع عن هذا الإجراء."}),e.jsx(u,{children:e.jsxs(f,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Q,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:"تفاصيل الدفعة"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"رقم الإيصال:"}),e.jsx("div",{className:"font-medium",children:i.receipt_number||`#${i.id.slice(-6)}`})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"المبلغ:"}),e.jsx(F,{variant:"outline",className:"font-medium",children:V(i.amount)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),"المريض:"]}),e.jsx("div",{className:"font-medium",children:(e=>{if(e.patient)return`${e.patient.first_name} ${e.patient.last_name}`;const t=c.find(t=>t.id===e.patient_id);return t?`${t.first_name} ${t.last_name}`:"غير محدد"})(i)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"طريقة الدفع:"}),e.jsx(F,{variant:"secondary",children:(x=i.payment_method,{cash:"نقداً",bank_transfer:"تحويل بنكي"}[x]||x)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"الحالة:"}),e.jsx(F,{variant:"outline",children:(m=i.status,{completed:"مكتمل",partial:"جزئي",pending:"آجل"}[m]||m)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(H,{className:"w-3 h-3"}),"تاريخ الدفع:"]}),e.jsx("div",{className:"font-medium",children:$(i.payment_date)})]})]}),i.description&&e.jsx("div",{className:"border-t pt-3 mt-3 space-y-2",children:e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground text-xs",children:"الوصف:"}),e.jsx("p",{className:"text-sm",children:i.description})]})})]})})]}),e.jsxs(I,{className:"flex justify-end space-x-2 space-x-reverse",children:[e.jsx(J,{disabled:o,children:"إلغاء"}),e.jsx(W,{onClick:async()=>{try{await d(i.id),l({title:"تم بنجاح",description:"تم حذف الدفعة بنجاح"}),r(!1)}catch(e){l({title:"خطأ",description:"فشل في حذف الدفعة",variant:"destructive"})}},disabled:o,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:o?"جاري الحذف...":"حذف الدفعة"})]})]})});var m,x}const lt=t.memo(function({open:a,onOpenChange:s,payment:n}){const r=U(e=>e.settings),i=U(e=>e.loadSettings),{formatAmount:p}=l(),u=G(),h=K(),j=Y(),{phone:f,email:N,address:k}=X(),F=t.useRef(null);t.useEffect(()=>{a&&!r&&i()},[a,r,i]);const[C,D]=t.useState({printerType:"80mm",includeQR:!0,includeBarcode:!0,includeLogo:!0,colorMode:"color",qrType:"text"}),[S,T]=t.useState(!1),[L,E]=t.useState(""),[M,A]=t.useState("");t.useEffect(()=>{const e=async()=>{try{const e=(()=>{const e=n.receipt_number||`RCP-${n.id.slice(-6)}`,t=n.patient?.full_name||"غير محدد",a=$(n.payment_date),s=p(n.amount);let r="";if("partial"===n.status){let e=0;if(n.appointment_id){const t=n.total_amount_due||n.appointment_total_cost||0,a=n.amount_paid||n.amount||0;e=Math.max(0,t-a)}else{const t=n.total_amount_due||n.amount||0,a=n.amount_paid||n.amount||0;e=Math.max(0,t-a)}e>0&&(r=`⚠️ المبلغ المتبقي: ${p(e)}`)}return`🏥 ${u}\n${h?`👨‍⚕️ ${h}`:""}\n\n📋 إيصال دفع رقم: ${e}\n👤 المريض: ${t}\n💰 المبلغ المدفوع: ${s}\n📅 التاريخ: ${a}\n🔄 حالة الدفعة: ${Q(n.status)}\n${n.appointment_id?"📅 مرتبطة بموعد: نعم":""}\n${r?`\n${r}`:""}\n\n✅ هذا إيصال رسمي معتمد\n🔒 معرف التحقق: ${n.id.slice(-12)}\n\n${f?`📞 للاستفسار: ${f}`:""}\n${k?`📍 العنوان: ${k}`:""}\n\nشكراً لثقتكم بنا 🙏`})(),t=await Te.toDataURL(e,{width:200,margin:1,color:{dark:"#000000",light:"#FFFFFF"}});E(t)}catch(e){}};a&&(C.includeQR&&e(),C.includeBarcode&&(()=>{try{const e=document.createElement("canvas"),t=R();Pe(e,t,{format:"CODE128",width:2,height:40,displayValue:!1,margin:0,background:"#ffffff",lineColor:"#000000"}),A(e.toDataURL())}catch(e){}})())},[a,C.includeQR,C.includeBarcode,n,r]);const R=()=>`${new Date(n.payment_date).getTime().toString().slice(-8)}${n.patient_id.slice(-4)}${Math.floor(n.amount).toString().padStart(4,"0")}`,B=()=>{if(F.current){const e=window.open("","_blank");if(e){const t="color"===C.colorMode,a="a4"===C.printerType?"210mm":C.printerType;e.document.write(`\n          <html>\n            <head>\n              <title>إيصال دفع - ${n.receipt_number||n.id.slice(-6)}</title>\n              <style>\n                body {\n                  font-family: 'Arial', 'Tahoma', sans-serif;\n                  direction: rtl;\n                  margin: 0;\n                  padding: 0;\n                  font-size: ${"a4"===C.printerType?"14px":"12px"};\n                  line-height: 1.4;\n                  color: #000;\n                  background: white;\n                }\n\n                .receipt {\n                  width: ${"a4"===a?"100%":a};\n                  max-width: ${"a4"===a?"210mm":a};\n                  margin: 0 auto;\n                  background: white;\n                  font-size: ${"a4"===C.printerType?"12px":"11px"};\n                  padding: ${"a4"===C.printerType?"20px":"0"};\n                }\n\n                .header {\n                  text-align: center;\n                  padding: ${"a4"===C.printerType?"20px 10px":"8px 4px"};\n                  background: ${t?"linear-gradient(135deg, #667eea 0%, #764ba2 100%)":"#f8f9fa"};\n                  color: ${t?"white":"#000"};\n                  border-bottom: 2px solid ${t?"#764ba2":"#000"};\n                  margin-bottom: 8px;\n                  border-radius: ${"a4"===C.printerType?"8px 8px 0 0":"0"};\n                }\n\n                .clinic-logo {\n                  width: ${"a4"===C.printerType?"60px":"45px"};\n                  height: ${"a4"===C.printerType?"60px":"45px"};\n                  margin: 0 auto 6px;\n                  border-radius: 50%;\n                  background: ${t?"rgba(255,255,255,0.15)":"#e9ecef"};\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  font-size: ${"a4"===C.printerType?"20px":"14px"};\n                  font-weight: bold;\n                  color: ${t?"white":"#495057"};\n                  border: 2px solid ${t?"rgba(255,255,255,0.3)":"#dee2e6"};\n                  box-shadow: ${t?"0 2px 8px rgba(0,0,0,0.15)":"0 1px 4px rgba(0,0,0,0.1)"};\n                  overflow: hidden;\n                  flex-shrink: 0;\n                }\n\n                .clinic-logo img {\n                  width: 100%;\n                  height: 100%;\n                  object-fit: cover;\n                  border-radius: 50%;\n                  max-width: ${"a4"===C.printerType?"60px":"45px"};\n                  max-height: ${"a4"===C.printerType?"60px":"45px"};\n                }\n\n                .clinic-name {\n                  font-size: ${"a4"===C.printerType?"20px":"16px"};\n                  font-weight: bold;\n                  margin-bottom: 4px;\n                  text-transform: uppercase;\n                  text-shadow: ${t?"0 1px 2px rgba(0,0,0,0.3)":"none"};\n                }\n\n                .doctor-name {\n                  font-size: ${"a4"===C.printerType?"16px":"13px"};\n                  font-weight: bold;\n                  margin-bottom: 3px;\n                  opacity: ${t?"0.95":"1"};\n                }\n\n                .clinic-info {\n                  font-size: ${"a4"===C.printerType?"12px":"10px"};\n                  margin: 1px 0;\n                  line-height: 1.2;\n                  opacity: ${t?"0.9":"1"};\n                }\n\n                .receipt-title {\n                  font-size: ${"a4"===C.printerType?"18px":"14px"};\n                  font-weight: bold;\n                  text-align: center;\n                  padding: ${"a4"===C.printerType?"12px 0":"6px 0"};\n                  margin: 8px 0;\n                  background: ${t?"linear-gradient(90deg, #f8f9fa, #e9ecef, #f8f9fa)":"#f8f9fa"};\n                  border-top: 1px dashed #000;\n                  border-bottom: 1px dashed #000;\n                  color: #495057;\n                }\n\n                .content {\n                  padding: ${"a4"===C.printerType?"10px":"4px"};\n                }\n\n                .section {\n                  margin-bottom: ${"a4"===C.printerType?"15px":"8px"};\n                }\n\n                .info-row {\n                  display: flex;\n                  justify-content: space-between;\n                  margin: ${"a4"===C.printerType?"6px 0":"3px 0"};\n                  padding: ${"a4"===C.printerType?"4px 0":"2px 0"};\n                  font-size: ${"a4"===C.printerType?"13px":"11px"};\n                  border-bottom: 1px solid #f1f3f4;\n                }\n\n                .label {\n                  font-weight: bold;\n                  flex: 1;\n                  text-align: right;\n                  color: ${t?"#495057":"#000"};\n                }\n\n                .value {\n                  flex: 1;\n                  text-align: left;\n                  font-weight: normal;\n                  color: ${t?"#212529":"#000"};\n                }\n\n                .amount-section {\n                  background: ${t?"linear-gradient(135deg, #f8f9fa, #e9ecef)":"#f8f9fa"};\n                  border: 1px solid ${t?"#dee2e6":"#000"};\n                  border-radius: ${"a4"===C.printerType?"8px":"4px"};\n                  padding: ${"a4"===C.printerType?"15px":"6px"};\n                  margin-top: 8px;\n                }\n\n                .amount-row {\n                  display: flex;\n                  justify-content: space-between;\n                  margin: ${"a4"===C.printerType?"6px 0":"3px 0"};\n                  font-size: ${"a4"===C.printerType?"13px":"11px"};\n                  font-weight: 500;\n                }\n\n                .total-amount {\n                  font-size: ${"a4"===C.printerType?"18px":"14px"};\n                  font-weight: bold;\n                  text-align: center;\n                  padding: ${"a4"===C.printerType?"12px":"6px"};\n                  margin: 6px 0;\n                  background: ${t?"linear-gradient(135deg, #28a745, #20c997)":"#f0f0f0"};\n                  color: ${t?"white":"#000"};\n                  border: 2px solid ${t?"#28a745":"#000"};\n                  border-radius: ${"a4"===C.printerType?"8px":"4px"};\n                  box-shadow: ${t?"0 2px 10px rgba(40, 167, 69, 0.3)":"none"};\n                }\n\n                .qr-section, .barcode-section {\n                  text-align: center;\n                  margin: ${"a4"===C.printerType?"15px 0":"8px 0"};\n                  padding: ${"a4"===C.printerType?"10px":"5px"};\n                  background: ${t?"#f8f9fa":"white"};\n                  border: 1px dashed ${t?"#dee2e6":"#000"};\n                  border-radius: ${"a4"===C.printerType?"6px":"3px"};\n                }\n\n                .qr-placeholder, .barcode-placeholder {\n                  width: ${"a4"===C.printerType?"80px":"60px"};\n                  height: ${"a4"===C.printerType?"80px":"60px"};\n                  margin: 0 auto 5px;\n                  background: ${t?"linear-gradient(45deg, #000, #333)":"#000"};\n                  border-radius: 4px;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  color: white;\n                  font-size: ${"a4"===C.printerType?"10px":"8px"};\n                  font-weight: bold;\n                }\n\n                .barcode-placeholder {\n                  height: ${"a4"===C.printerType?"30px":"20px"};\n                  width: ${"a4"===C.printerType?"120px":"100px"};\n                  border-radius: 2px;\n                }\n\n                .bottom-section {\n                  display: flex;\n                  justify-content: space-between;\n                  align-items: flex-start;\n                  margin: 12px 0;\n                  gap: 15px;\n                  flex-wrap: wrap;\n                }\n\n                .qr-section {\n                  text-align: center;\n                  flex: 1;\n                  min-width: 80px;\n                }\n\n                .signature-section {\n                  flex: 1;\n                  min-width: 120px;\n                  text-align: center;\n                }\n\n                .signature-box {\n                  margin-bottom: 8px;\n                }\n\n                .signature-line {\n                  width: ${"a4"===C.printerType?"100px":"80px"};\n                  height: 1px;\n                  border-bottom: 1px solid #333;\n                  margin: 0 auto 4px;\n                }\n\n                .signature-label {\n                  font-size: ${"a4"===C.printerType?"10px":"8px"};\n                  color: #666;\n                  margin-bottom: 6px;\n                }\n\n                .stamp-box {\n                  margin-top: 6px;\n                }\n\n                .stamp-area {\n                  width: ${"a4"===C.printerType?"80px":"60px"};\n                  height: ${"a4"===C.printerType?"60px":"45px"};\n                  border: 2px dashed #999;\n                  border-radius: 50%;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  margin: 0 auto;\n                  background: rgba(0,0,0,0.02);\n                }\n\n                .stamp-placeholder {\n                  font-size: ${"a4"===C.printerType?"9px":"7px"};\n                  color: #999;\n                  text-align: center;\n                  line-height: 1.2;\n                }\n\n                .footer {\n                  text-align: center;\n                  padding: ${"a4"===C.printerType?"15px 10px":"6px 4px"};\n                  background: ${t?"linear-gradient(135deg, #f8f9fa, #e9ecef)":"#f8f9fa"};\n                  border-top: 2px solid ${t?"#dee2e6":"#000"};\n                  margin-top: 8px;\n                  font-size: ${"a4"===C.printerType?"12px":"10px"};\n                  border-radius: ${"a4"===C.printerType?"0 0 8px 8px":"0"};\n                }\n\n                .thank-you {\n                  font-size: ${"a4"===C.printerType?"16px":"12px"};\n                  font-weight: bold;\n                  margin-bottom: 3px;\n                  color: ${t?"#495057":"#000"};\n                }\n\n                .date-created {\n                  font-size: ${"a4"===C.printerType?"11px":"9px"};\n                  color: ${t?"#6c757d":"#666"};\n                }\n\n                .separator {\n                  text-align: center;\n                  margin: 6px 0;\n                  font-size: 16px;\n                  letter-spacing: 2px;\n                  color: ${t?"#dee2e6":"#000"};\n                }\n\n                /* Print optimizations */\n                @media print {\n                  body {\n                    margin: 0 !important;\n                    padding: 0 !important;\n                    background: white !important;\n                  }\n\n                  .receipt {\n                    box-shadow: none !important;\n                    border: none !important;\n                    margin: 0 !important;\n                  }\n\n                  .no-print {\n                    display: none !important;\n                  }\n\n                  .info-row, .amount-row {\n                    page-break-inside: avoid;\n                  }\n\n                  ${t?"\n                    .header {\n                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;\n                      color: white !important;\n                      -webkit-print-color-adjust: exact;\n                    }\n                    .total-amount {\n                      background: linear-gradient(135deg, #28a745, #20c997) !important;\n                      color: white !important;\n                      -webkit-print-color-adjust: exact;\n                    }\n                  ":""}\n                }\n\n                /* Screen display styles */\n                @media screen {\n                  body {\n                    padding: 20px;\n                    background: #f5f5f5;\n                  }\n\n                  .receipt {\n                    max-width: ${"a4"===C.printerType?"600px":"320px"};\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n                    border-radius: 12px;\n                    overflow: hidden;\n                    background: white;\n                    margin: 0 auto;\n                  }\n                }\n              </style>\n            </head>\n            <body>\n              ${F.current.innerHTML}\n            </body>\n          </html>\n        `),e.document.close(),e.print()}}},O=e=>({cash:"نقداً",card:"بطاقة ائتمان",bank_transfer:"تحويل بنكي",check:"شيك",insurance:"تأمين"}[e]||e),Q=e=>({completed:"مكتمل",pending:"آجل",partial:"جزئي",overdue:"متأخر",failed:"فاشل",refunded:"مسترد"}[e]||e);return e.jsx(d,{open:a,onOpenChange:s,children:e.jsxs(o,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs(c,{children:[e.jsxs(m,{className:"flex items-center text-xl font-semibold",children:[e.jsx(g,{className:"w-5 h-5 ml-2"}),"إيصال الدفع"]}),e.jsxs(x,{children:["إيصال رقم ",n.receipt_number||n.id.slice(-6)]})]}),e.jsxs("div",{ref:F,className:"receipt",children:[e.jsxs("div",{className:"header",children:[C.includeLogo&&e.jsx("div",{className:"clinic-logo",style:{width:"60px",height:"60px",margin:"0 auto 8px",borderRadius:"50%",overflow:"hidden",border:"2px solid #e0e0e0",boxShadow:"0 2px 8px rgba(0,0,0,0.1)",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",background:"#f8f9fa"},children:j&&""!==j.trim()?e.jsx("img",{src:j,alt:"شعار العيادة",style:{width:"100%",height:"100%",objectFit:"cover",borderRadius:"50%",maxWidth:"60px",maxHeight:"60px"},onError:e=>{e.currentTarget.style.display="none"}}):e.jsx("span",{style:{fontSize:"20px",fontWeight:"bold",color:"#495057"},children:u.charAt(0)})}),e.jsx("div",{className:"clinic-name",children:u}),h&&e.jsx("div",{className:"doctor-name",children:h}),f&&e.jsxs("div",{className:"clinic-info",children:["📞 ",f]}),k&&e.jsxs("div",{className:"clinic-info",children:["📍 ",k]}),N&&e.jsxs("div",{className:"clinic-info",children:["✉️ ",N]})]}),e.jsx("div",{className:"separator",children:"═══════════════════"}),e.jsxs("div",{className:"receipt-title",children:["إيصال دفع رقم ",n.receipt_number||`RCP-${n.id.slice(-6)}`]}),e.jsxs("div",{className:"content",children:[e.jsxs("div",{className:"section",children:[e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"التاريخ:"}),e.jsx("span",{className:"value",children:$(n.payment_date)})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"الوقت:"}),e.jsx("span",{className:"value",children:new Date(n.payment_date).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit",hour12:!0})})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"المريض:"}),e.jsx("span",{className:"value",children:n.patient?n.patient.full_name||`${n.patient.first_name||""} ${n.patient.last_name||""}`.trim():"غير محدد"})]}),n.patient?.phone&&e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"الهاتف:"}),e.jsx("span",{className:"value",children:n.patient.phone})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"طريقة الدفع:"}),e.jsx("span",{className:"value",children:O(n.payment_method)})]}),n.description&&e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"الوصف:"}),e.jsx("span",{className:"value",children:n.description})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"حالة الدفعة:"}),e.jsx("span",{className:"value",children:Q(n.status)})]}),n.appointment_id&&e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"مرتبطة بموعد:"}),e.jsx("span",{className:"value",children:"نعم"})]})]}),e.jsx("div",{className:"separator",children:"- - - - - - - - - - - - - - - -"}),e.jsxs("div",{className:"amount-section",children:[e.jsxs("div",{className:"amount-row",children:[e.jsx("span",{children:"المبلغ المدفوع في هذه الدفعة:"}),e.jsx("span",{children:p(n.amount)})]}),n.discount_amount&&n.discount_amount>0&&e.jsxs("div",{className:"amount-row",children:[e.jsx("span",{children:"الخصم:"}),e.jsxs("span",{children:["-",p(n.discount_amount)]})]}),n.tax_amount&&n.tax_amount>0&&e.jsxs("div",{className:"amount-row",children:[e.jsx("span",{children:"الضريبة:"}),e.jsxs("span",{children:["+",p(n.tax_amount)]})]}),"partial"===n.status&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"separator",children:"- - - - - - - - - - - - - - - -"}),(n.total_amount_due||n.appointment_total_cost)&&e.jsxs("div",{className:"amount-row",children:[e.jsx("span",{children:"إجمالي المبلغ المطلوب:"}),e.jsx("span",{children:p(n.total_amount_due||n.appointment_total_cost||0)})]}),n.amount_paid&&e.jsxs("div",{className:"amount-row",children:[e.jsx("span",{children:"إجمالي المبلغ المدفوع:"}),e.jsx("span",{children:p(n.amount_paid)})]}),(()=>{let t=0;if(n.appointment_id){const e=n.total_amount_due||n.appointment_total_cost||0,a=n.amount_paid||n.amount||0;t=Math.max(0,e-a)}else{const e=n.total_amount_due||n.amount||0,a=n.amount_paid||n.amount||0;t=Math.max(0,e-a)}return t>0?e.jsxs("div",{className:"amount-row",style:{color:"#dc3545",fontWeight:"bold"},children:[e.jsx("span",{children:"المبلغ المتبقي:"}),e.jsx("span",{children:p(t)})]}):null})()]}),e.jsx("div",{className:"separator",children:"═══════════════════"}),e.jsxs("div",{className:"total-amount",children:["المبلغ الإجمالي لهذه الدفعة: ",p(n.total_amount||n.amount+(n.tax_amount||0)-(n.discount_amount||0))]})]}),e.jsxs("div",{className:"bottom-section",children:[C.includeQR&&e.jsxs("div",{className:"qr-section",children:[L?e.jsx("img",{src:L,alt:"QR Code للتحقق من الإيصال",style:{width:"a4"===C.printerType?"80px":"60px",height:"a4"===C.printerType?"80px":"60px",margin:"0 auto"}}):e.jsx("div",{className:"qr-placeholder",children:"QR"}),e.jsx("div",{style:{fontSize:"8px",color:"#666",marginTop:"4px"},children:"امسح للتحقق من الإيصال"})]}),e.jsxs("div",{className:"signature-section",children:[e.jsxs("div",{className:"signature-box",children:[e.jsx("div",{className:"signature-line"}),e.jsx("div",{className:"signature-label",children:"توقيع الطبيب"})]}),e.jsx("div",{className:"stamp-box",children:e.jsx("div",{className:"stamp-area",children:e.jsx("div",{className:"stamp-placeholder",children:"ختم العيادة"})})})]})]}),C.includeBarcode&&e.jsxs("div",{className:"barcode-section",children:[M?e.jsx("img",{src:M,alt:"باركود الإيصال",style:{width:"a4"===C.printerType?"120px":"100px",height:"a4"===C.printerType?"30px":"20px",margin:"0 auto"}}):e.jsx("div",{className:"barcode-placeholder",children:R()}),e.jsx("div",{style:{fontSize:"8px",color:"#666",marginTop:"2px"},children:R()})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"separator",children:"- - - - - - - - - - - - - - - -"}),e.jsxs("div",{style:{fontSize:"9px",color:"#666",textAlign:"center",margin:"4px 0"},children:[e.jsxs("div",{children:["معرف الدفعة: ",n.id.slice(-8)]}),e.jsxs("div",{children:["طريقة الدفع: ",O(n.payment_method)]}),"partial"===n.status&&e.jsx("div",{style:{color:"#dc3545",fontWeight:"bold"},children:"⚠️ دفعة جزئية - يرجى الاحتفاظ بالإيصال"}),e.jsxs("div",{style:{marginTop:"4px"},children:["تاريخ الطباعة: ",(new Date).toLocaleDateString("ar-SA")," - ",(new Date).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})]})]})]})]}),e.jsxs("div",{className:"footer",children:[e.jsx("div",{className:"separator",children:"═══════════════════"}),e.jsx("div",{className:"thank-you",children:"شكراً لثقتكم بنا"}),e.jsxs("div",{className:"date-created",children:["تم الإنشاء: ",$((new Date).toISOString())]}),e.jsx("div",{className:"separator",children:"═══════════════════"})]})]}),e.jsxs("div",{className:"border-t bg-muted/30 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-medium flex items-center",children:[e.jsx(Le,{className:"w-4 h-4 ml-2"}),"إعدادات الطباعة"]}),e.jsxs(P,{variant:"ghost",size:"sm",onClick:()=>T(!S),className:"text-xs",children:[e.jsx(Z,{className:"w-3 h-3 ml-1"}),S?"إخفاء المعاينة":"معاينة"]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium",children:"نوع الطابعة"}),e.jsxs(b,{value:C.printerType,onValueChange:e=>D(t=>({...t,printerType:e})),children:[e.jsx(v,{className:"h-8 text-xs",children:e.jsx(_,{})}),e.jsxs(y,{children:[e.jsx(w,{value:"58mm",children:"حرارية 58mm"}),e.jsx(w,{value:"80mm",children:"حرارية 80mm"}),e.jsx(w,{value:"a4",children:"عادية A4"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium",children:"نمط الألوان"}),e.jsxs(b,{value:C.colorMode,onValueChange:e=>D(t=>({...t,colorMode:e})),children:[e.jsx(v,{className:"h-8 text-xs",children:e.jsx(_,{})}),e.jsxs(y,{children:[e.jsx(w,{value:"color",children:"ملون"}),e.jsx(w,{value:"bw",children:"أبيض وأسود"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("input",{type:"checkbox",id:"includeLogo",checked:C.includeLogo,onChange:e=>D(t=>({...t,includeLogo:e.target.checked})),className:"rounded border-gray-300"}),e.jsx("label",{htmlFor:"includeLogo",className:"text-xs font-medium",children:"تضمين الشعار"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("input",{type:"checkbox",id:"includeQR",checked:C.includeQR,onChange:e=>D(t=>({...t,includeQR:e.target.checked})),className:"rounded border-gray-300"}),e.jsx("label",{htmlFor:"includeQR",className:"text-xs font-medium",children:"QR Code"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("input",{type:"checkbox",id:"includeBarcode",checked:C.includeBarcode,onChange:e=>D(t=>({...t,includeBarcode:e.target.checked})),className:"rounded border-gray-300"}),e.jsx("label",{htmlFor:"includeBarcode",className:"text-xs font-medium",children:"تضمين الباركود"})]})]}),e.jsxs(z,{className:"flex justify-end space-x-2 space-x-reverse",children:[e.jsx(P,{variant:"outline",onClick:()=>s(!1),children:"إغلاق"}),e.jsxs(P,{variant:"outline",onClick:()=>{B()},children:[e.jsx(ze,{className:"w-4 h-4 ml-2"}),"تحميل PDF"]}),e.jsxs(P,{variant:"outline",onClick:()=>{if(F.current){const e=window.open("","_blank");e&&(e.document.write(`\n          <html>\n            <head>\n              <title>إيصال حراري - ${n.receipt_number||n.id.slice(-6)}</title>\n              <style>\n                @page {\n                  size: 80mm auto;\n                  margin: 0;\n                }\n                body {\n                  font-family: 'Courier New', monospace;\n                  direction: rtl;\n                  margin: 0;\n                  padding: 2mm;\n                  font-size: 10px;\n                  line-height: 1.2;\n                  color: #000;\n                  background: white;\n                  width: 76mm;\n                }\n                .receipt {\n                  width: 100%;\n                  font-size: 10px;\n                }\n                .header {\n                  text-align: center;\n                  margin-bottom: 4px;\n                  border-bottom: 1px solid #000;\n                  padding-bottom: 2px;\n                }\n                .clinic-name {\n                  font-size: 12px;\n                  font-weight: bold;\n                  margin-bottom: 1px;\n                }\n                .doctor-name {\n                  font-size: 10px;\n                  font-weight: bold;\n                }\n                .clinic-info {\n                  font-size: 8px;\n                  margin: 0;\n                }\n                .receipt-title {\n                  font-size: 11px;\n                  font-weight: bold;\n                  text-align: center;\n                  margin: 3px 0;\n                  border-top: 1px dashed #000;\n                  border-bottom: 1px dashed #000;\n                  padding: 2px 0;\n                }\n                .info-row, .amount-row {\n                  display: flex;\n                  justify-content: space-between;\n                  margin: 1px 0;\n                  font-size: 9px;\n                }\n                .separator {\n                  text-align: center;\n                  margin: 2px 0;\n                  font-size: 8px;\n                }\n                .total-amount {\n                  font-size: 11px;\n                  font-weight: bold;\n                  text-align: center;\n                  margin: 3px 0;\n                  border: 1px solid #000;\n                  padding: 2px;\n                }\n                .footer {\n                  text-align: center;\n                  margin-top: 4px;\n                  border-top: 1px solid #000;\n                  padding-top: 2px;\n                  font-size: 8px;\n                }\n                .thank-you {\n                  font-size: 9px;\n                  font-weight: bold;\n                }\n                .bottom-section {\n                  display: flex;\n                  justify-content: space-between;\n                  align-items: flex-start;\n                  margin: 4px 0;\n                  gap: 6px;\n                  flex-wrap: wrap;\n                }\n                .qr-section {\n                  text-align: center;\n                  flex: 1;\n                  min-width: 50px;\n                }\n                .signature-section {\n                  flex: 1;\n                  min-width: 70px;\n                  text-align: center;\n                }\n                .signature-line {\n                  width: 50px;\n                  height: 1px;\n                  border-bottom: 1px solid #000;\n                  margin: 0 auto 2px;\n                }\n                .signature-label {\n                  font-size: 6px;\n                  margin-bottom: 2px;\n                }\n                .stamp-area {\n                  width: 35px;\n                  height: 25px;\n                  border: 1px dashed #000;\n                  border-radius: 50%;\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  margin: 0 auto;\n                  background: rgba(0,0,0,0.02);\n                }\n                .stamp-placeholder {\n                  font-size: 5px;\n                  text-align: center;\n                  line-height: 1.1;\n                }\n              </style>\n            </head>\n            <body>\n              ${F.current.innerHTML}\n            </body>\n          </html>\n        `),e.document.close(),e.print())}},className:"bg-blue-50 hover:bg-blue-100 text-blue-700 border-blue-200",children:[e.jsx(Me,{className:"w-4 h-4 ml-2"}),"طباعة حرارية"]}),e.jsxs(P,{onClick:B,className:"bg-green-600 hover:bg-green-700 text-white",children:[e.jsx(Me,{className:"w-4 h-4 ml-2"}),"طباعة ذكية"]})]})]})})});function dt({open:t,onOpenChange:a,payment:s,patients:n}){const{formatAmount:r}=l();if(!s)return null;const i=n.find(e=>e.id===s.patient_id);return e.jsx(d,{open:t,onOpenChange:a,children:e.jsxs(o,{className:"max-w-4xl max-h-[90vh] overflow-y-auto bg-background border-border shadow-2xl",dir:"rtl",children:[e.jsxs(c,{className:"border-b border-border pb-4",children:[e.jsxs(m,{className:"flex items-center text-xl font-semibold text-foreground",children:[e.jsx(Z,{className:"w-5 h-5 ml-2 text-primary"}),"تفاصيل الدفعة"]}),e.jsxs(x,{className:"text-muted-foreground",children:["عرض تفاصيل شاملة للدفعة رقم ",s.receipt_number||s.id.slice(-6)]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(q,{className:"w-4 h-4 ml-2 text-primary"}),"معلومات المريض"]})}),e.jsxs(f,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"الاسم:"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:i?.full_name||"غير محدد"})]}),i?.phone&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"الهاتف:"}),e.jsx("span",{className:"text-sm text-foreground",children:i.phone})]}),i?.date_of_birth&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"تاريخ الميلاد:"}),e.jsx("span",{className:"text-sm text-foreground",children:$(i.date_of_birth)})]})]})]}),e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(Q,{className:"w-4 h-4 ml-2 text-primary"}),"معلومات الدفعة"]})}),e.jsxs(f,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"رقم الإيصال:"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:s.receipt_number||s.id.slice(-6)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"تاريخ الدفع:"}),e.jsx("span",{className:"text-sm text-foreground",children:$(s.payment_date)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"طريقة الدفع:"}),e.jsx(F,{variant:"outline",className:"text-xs",children:(e=>{switch(e){case"cash":return"نقدي";case"bank_transfer":return"تحويل بنكي";default:return e}})(s.payment_method)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"الحالة:"}),(t=>{switch(t){case"completed":return e.jsxs(F,{variant:"default",className:"bg-green-100 text-green-800 border-green-200",children:[e.jsx(ae,{className:"w-3 h-3 ml-1"}),"مكتملة"]});case"partial":return e.jsxs(F,{variant:"default",className:"bg-yellow-100 text-yellow-800 border-yellow-200",children:[e.jsx(p,{className:"w-3 h-3 ml-1"}),"جزئية"]});case"pending":return e.jsxs(F,{variant:"default",className:"bg-orange-100 text-orange-800 border-orange-200",children:[e.jsx(te,{className:"w-3 h-3 ml-1"}),"آجلة"]});default:return e.jsx(F,{variant:"outline",children:t})}})(s.status)]})]})]})]}),e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(C,{className:"w-4 h-4 ml-2 text-primary"}),"التفاصيل المالية"]})}),e.jsx(f,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-blue-50 dark:bg-blue-950/30 rounded-lg border border-blue-200 dark:border-blue-800",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600 dark:text-blue-400",children:r(s.amount)}),e.jsx("div",{className:"text-sm text-blue-600 dark:text-blue-400 mt-1",children:"المبلغ المدفوع"})]}),s.discount_amount&&s.discount_amount>0&&e.jsxs("div",{className:"text-center p-4 bg-green-50 dark:bg-green-950/30 rounded-lg border border-green-200 dark:border-green-800",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400",children:r(s.discount_amount)}),e.jsx("div",{className:"text-sm text-green-600 dark:text-green-400 mt-1",children:"الخصم"})]}),s.tax_amount&&s.tax_amount>0&&e.jsxs("div",{className:"text-center p-4 bg-orange-50 dark:bg-orange-950/30 rounded-lg border border-orange-200 dark:border-orange-800",children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600 dark:text-orange-400",children:r(s.tax_amount)}),e.jsx("div",{className:"text-sm text-orange-600 dark:text-orange-400 mt-1",children:"الضريبة"})]}),e.jsxs("div",{className:"text-center p-4 bg-purple-50 dark:bg-purple-950/30 rounded-lg border border-purple-200 dark:border-purple-800",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600 dark:text-purple-400",children:r(s.total_amount||s.amount+(s.tax_amount||0)-(s.discount_amount||0))}),e.jsx("div",{className:"text-sm text-purple-600 dark:text-purple-400 mt-1",children:"المبلغ الإجمالي"})]})]})})]}),s.tooth_treatment&&e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(ee,{className:"w-4 h-4 ml-2 text-primary"}),"معلومات العلاج"]})}),e.jsxs(f,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"نوع العلاج:"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:k(s.tooth_treatment.treatment_type)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"رقم السن:"}),e.jsx("span",{className:"text-sm text-foreground",children:s.tooth_treatment.tooth_number})]}),s.tooth_treatment.tooth_name&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"اسم السن:"}),e.jsx("span",{className:"text-sm text-foreground",children:s.tooth_treatment.tooth_name})]}),s.tooth_treatment.cost&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"تكلفة العلاج:"}),e.jsx("span",{className:"text-sm font-medium text-foreground",children:r(s.tooth_treatment.cost)})]})]})]}),s.appointment&&e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(H,{className:"w-4 h-4 ml-2 text-primary"}),"معلومات الموعد"]})}),e.jsxs(f,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"تاريخ الموعد:"}),e.jsx("span",{className:"text-sm text-foreground",children:$(s.appointment.appointment_date)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"الوقت:"}),e.jsx("span",{className:"text-sm text-foreground",children:s.appointment.appointment_time})]}),s.appointment.notes&&e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"ملاحظات:"}),e.jsx("span",{className:"text-sm text-foreground text-right max-w-xs",children:s.appointment.notes})]})]})]}),(s.description||s.notes)&&e.jsxs(u,{className:"border-border bg-card shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(Ae,{className:"w-4 h-4 ml-2 text-primary"}),"ملاحظات إضافية"]})}),e.jsxs(f,{className:"space-y-3",children:[s.description&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-muted-foreground block mb-1",children:"الوصف:"}),e.jsx("p",{className:"text-sm text-foreground bg-muted/30 p-3 rounded border",children:s.description})]}),s.notes&&e.jsxs("div",{children:[e.jsx("span",{className:"text-sm text-muted-foreground block mb-1",children:"ملاحظات:"}),e.jsx("p",{className:"text-sm text-foreground bg-muted/30 p-3 rounded border",children:s.notes})]})]})]}),e.jsxs(u,{className:"border-border bg-muted/30 shadow-sm",children:[e.jsx(h,{className:"pb-3",children:e.jsxs(j,{className:"flex items-center text-lg text-card-foreground",children:[e.jsx(te,{className:"w-4 h-4 ml-2 text-primary"}),"معلومات النظام"]})}),e.jsxs(f,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"تاريخ الإنشاء:"}),e.jsx("span",{className:"text-sm text-foreground",children:$(s.created_at)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"آخر تحديث:"}),e.jsx("span",{className:"text-sm text-foreground",children:$(s.updated_at)})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"معرف الدفعة:"}),e.jsx("span",{className:"text-xs font-mono text-foreground bg-background px-2 py-1 rounded border",children:s.id})]})]})]})]})]})})}const ot=t.memo(function({payments:a,patients:s,isLoading:n,onEdit:r,onDelete:i,onShowReceipt:l,onViewDetails:d}){const[o,c]=t.useState("payment_date"),[m,x]=t.useState("desc"),[p,u]=t.useState(1),[h,j]=t.useState(10),g=t.useMemo(()=>{const e=new Map;return s.forEach(t=>{e.set(t.id,t)}),e},[s]),f=e=>{if(e.patient?.full_name)return e.patient.full_name;if(e.patient?.first_name||e.patient?.last_name)return`${e.patient.first_name||""} ${e.patient.last_name||""}`.trim();const t=g.get(e.patient_id);return t?.full_name||"مريض غير معروف"},N=t.useMemo(()=>{let e=[...a];return e.sort((e,t)=>{let a,s;switch(o){case"patient_name":a=f(e),s=f(t);break;case"payment_date":a=new Date(e.payment_date),s=new Date(t.payment_date);break;case"amount":a=e.amount,s=t.amount;break;case"payment_method":a=e.payment_method,s=t.payment_method;break;case"status":a=e.status,s=t.status;break;case"receipt_number":a=e.receipt_number||"",s=t.receipt_number||"";break;default:return 0}return a<s?"asc"===m?-1:1:a>s?"asc"===m?1:-1:0}),e},[a,o,m,g]),D=Math.ceil(N.length/h),S=(p-1)*h,T=N.slice(S,S+h),L=({field:t,children:a})=>e.jsx(Qe,{className:"cursor-pointer hover:bg-muted/50 text-center",onClick:()=>(e=>{o===e?x("asc"===m?"desc":"asc"):(c(e),x("asc"))})(t),children:e.jsxs("div",{className:"flex items-center justify-center space-x-1 space-x-reverse",children:[a,o===t?"asc"===m?e.jsx(We,{className:"w-4 h-4"}):e.jsx(Ue,{className:"w-4 h-4"}):e.jsx(Ge,{className:"w-4 h-4 opacity-50"})]})}),z=t=>{const a={completed:{label:"مكتمل",variant:"default"},partial:{label:"جزئي",variant:"outline"},pending:{label:"آجل",variant:"secondary"}}[t]||{label:t,variant:"outline"};return e.jsx(F,{variant:a.variant,children:a.label})};return n?e.jsx("div",{className:"border rounded-lg",children:e.jsxs(Re,{children:[e.jsx(Be,{children:e.jsxs(Oe,{children:[e.jsx(Qe,{children:"رقم الإيصال"}),e.jsx(Qe,{children:"المريض"}),e.jsx(Qe,{children:"المبلغ"}),e.jsx(Qe,{children:"طريقة الدفع"}),e.jsx(Qe,{children:"الحالة"}),e.jsx(Qe,{children:"تاريخ الدفع"}),e.jsx(Qe,{children:"الإجراءات"})]})}),e.jsx(Ve,{children:[...Array(5)].map((t,a)=>e.jsx(Oe,{children:[...Array(7)].map((t,a)=>e.jsx(qe,{children:e.jsx("div",{className:"h-4 bg-muted animate-pulse rounded"})},a))},a))})]})}):0===N.length?e.jsx("div",{className:"border rounded-lg",children:e.jsxs(Re,{className:"table-center-all",children:[e.jsx(Be,{children:e.jsxs(Oe,{children:[e.jsx(Qe,{className:"text-center",children:"#"}),e.jsx(L,{field:"patient_name",children:"المريض"}),e.jsx(Qe,{className:"text-center",children:"العلاج/الموعد"}),e.jsx(L,{field:"amount",children:"المبلغ والرصيد"}),e.jsx(L,{field:"payment_method",children:"طريقة الدفع"}),e.jsx(L,{field:"status",children:"الحالة"}),e.jsx(L,{field:"payment_date",children:"تاريخ الدفع"}),e.jsx(Qe,{className:"text-center",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"الإجراءات"})})]})}),e.jsx(Ve,{children:e.jsx(Oe,{children:e.jsx(qe,{colSpan:8,className:"text-center py-8",children:e.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[e.jsx(C,{className:"w-12 h-12 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"لم يتم تسجيل أي مدفوعات بعد"})]})})})})]})}):e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Re,{className:"table-center-all",children:[e.jsx(Be,{children:e.jsxs(Oe,{className:"bg-muted/50",children:[e.jsx(Qe,{className:"text-center",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"#"})}),e.jsx(L,{field:"patient_name",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"المريض"})}),e.jsx(Qe,{className:"text-center",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"العلاج/الموعد"})}),e.jsx(L,{field:"amount",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"المبلغ والرصيد"})}),e.jsx(L,{field:"payment_method",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"طريقة الدفع"})}),e.jsx(L,{field:"status",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"الحالة"})}),e.jsx(L,{field:"payment_date",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"تاريخ الدفع"})}),e.jsx(Qe,{className:"text-center",children:e.jsx("span",{className:"arabic-enhanced font-medium",children:"الإجراءات"})})]})}),e.jsx(Ve,{children:T.map((t,a)=>{return e.jsxs(Oe,{className:"hover:bg-muted/50",children:[e.jsx(qe,{className:"font-medium text-center",children:S+a+1}),e.jsx(qe,{className:"font-medium text-center",children:e.jsx("span",{className:"arabic-enhanced",children:f(t)})}),e.jsx(qe,{className:"text-center",children:t.tooth_treatment_id?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-sm font-medium arabic-enhanced text-blue-600 dark:text-blue-400",children:["السن ",t.tooth_treatment?.tooth_number]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:k(t.tooth_treatment?.treatment_type||"")}),t.treatment_total_cost&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["تكلفة: ",V(t.treatment_total_cost)]}),void 0!==t.treatment_remaining_balance&&t.treatment_remaining_balance>0&&e.jsxs("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:["متبقي: ",V(t.treatment_remaining_balance)]})]}):t.appointment_id?e.jsxs("div",{className:"space-y-1",children:[(()=>{const a=t.appointment?.start_time;if(a)try{const t=new Date(a);if(!isNaN(t.getTime()))return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm font-medium arabic-enhanced",children:t.toLocaleDateString("en-GB",{year:"numeric",month:"2-digit",day:"2-digit"})}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit",hour12:!0})})]})}catch(s){console.error("Error parsing appointment date:",s)}return e.jsx("div",{className:"text-sm font-medium arabic-enhanced",children:"موعد محدد"})})(),t.appointment_total_cost&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["تكلفة: ",V(t.appointment_total_cost)]}),void 0!==t.appointment_remaining_balance&&t.appointment_remaining_balance>0&&e.jsxs("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:["متبقي: ",V(t.appointment_remaining_balance)]})]}):e.jsx("div",{className:"text-sm text-muted-foreground arabic-enhanced",children:"دفعة عامة"})}),e.jsx(qe,{className:"text-center",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"font-medium text-lg",children:V(t.amount)}),t.tooth_treatment_id?e.jsxs(e.Fragment,{children:[t.treatment_total_cost&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["من أصل ",V(t.treatment_total_cost)]}),t.treatment_total_paid&&e.jsxs("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:["إجمالي مدفوع: ",V(t.treatment_total_paid)]}),t.treatment_remaining_balance&&t.treatment_remaining_balance>0&&e.jsxs("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:["متبقي: ",V(t.treatment_remaining_balance)]})]}):t.appointment_id?e.jsxs(e.Fragment,{children:[t.total_amount_due&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["من أصل ",V(t.total_amount_due)]}),t.total_amount_due&&t.amount_paid&&e.jsxs("div",{className:"text-xs text-blue-600 dark:text-blue-400",children:["إجمالي مدفوع: ",V(t.amount_paid)]}),t.remaining_balance&&t.remaining_balance>0&&e.jsxs("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:["متبقي: ",V(t.remaining_balance)]})]}):e.jsxs(e.Fragment,{children:[t.total_amount_due&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["من أصل ",V(t.total_amount_due)]}),t.total_amount_due&&(()=>{const a=t.total_amount_due||0,s=t.amount||0,n=Math.max(0,a-s);return n>0&&e.jsxs("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:["متبقي: ",V(n)]})})()]})]})}),e.jsx(qe,{className:"text-center",children:e.jsx(F,{variant:"outline",className:"arabic-enhanced",children:(s=t.payment_method,{cash:"نقداً",bank_transfer:"تحويل بنكي"}[s]||s)})}),e.jsx(qe,{className:"text-center",children:z(t.status)}),e.jsx(qe,{className:"text-center",children:e.jsx("div",{className:"text-sm arabic-enhanced",children:$(t.payment_date)})}),e.jsx(qe,{className:"min-w-[220px] text-center",children:e.jsxs("div",{className:"flex items-center justify-center space-x-1 space-x-reverse",children:[e.jsxs(P,{variant:"ghost",size:"sm",className:"action-btn-details text-blue-600 hover:text-blue-700 hover:bg-blue-50",onClick:()=>d(t),title:"عرض التفاصيل",children:[e.jsx(Z,{className:"w-4 h-4 ml-1"}),e.jsx("span",{className:"text-xs arabic-enhanced",children:"تفاصيل"})]}),e.jsxs(P,{variant:"ghost",size:"sm",className:"action-btn-receipt",onClick:()=>l(t),children:[e.jsx(Me,{className:"w-4 h-4 ml-1"}),e.jsx("span",{className:"text-xs arabic-enhanced",children:"إيصال"})]}),e.jsxs(P,{variant:"ghost",size:"sm",className:"action-btn-edit",onClick:()=>r(t),children:[e.jsx(Se,{className:"w-4 h-4 ml-1"}),e.jsx("span",{className:"text-xs arabic-enhanced",children:"تعديل"})]}),e.jsxs(P,{variant:"ghost",size:"sm",className:"action-btn-delete",onClick:()=>i(t),children:[e.jsx(Ee,{className:"w-4 h-4 ml-1"}),e.jsx("span",{className:"text-xs arabic-enhanced",children:"حذف"})]})]})})]},t.id);var s})})]})})}),N.length>0&&e.jsxs("div",{className:"flex items-center justify-between px-2",children:[e.jsx("div",{className:"flex items-center space-x-2 space-x-reverse",children:e.jsxs("p",{className:"text-sm text-muted-foreground arabic-enhanced",children:["عرض ",S+1," إلى ",Math.min(S+h,N.length)," من ",N.length," مدفوعة"]})}),e.jsxs("div",{className:"flex items-center space-x-6 space-x-reverse lg:space-x-8",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("p",{className:"text-sm font-medium arabic-enhanced",children:"عدد الصفوف لكل صفحة"}),e.jsxs(b,{value:`${h}`,onValueChange:e=>{j(Number(e)),u(1)},children:[e.jsx(v,{className:"h-8 w-[70px]",children:e.jsx(_,{placeholder:h})}),e.jsx(y,{side:"top",children:[5,10,20,30,50].map(t=>e.jsx(w,{value:`${t}`,children:t},t))})]})]}),e.jsxs("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium arabic-enhanced",children:["صفحة ",p," من ",D]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(P,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>u(1),disabled:1===p,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة الأولى"}),e.jsx(He,{className:"h-4 w-4"})]}),e.jsxs(P,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>u(p-1),disabled:1===p,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة السابقة"}),e.jsx(se,{className:"h-4 w-4"})]}),e.jsxs(P,{variant:"outline",className:"h-8 w-8 p-0",onClick:()=>u(p+1),disabled:p===D,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة التالية"}),e.jsx(Je,{className:"h-4 w-4"})]}),e.jsxs(P,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex",onClick:()=>u(D),disabled:p===D,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة الأخيرة"}),e.jsx(Ie,{className:"h-4 w-4"})]})]})]})]})]})});function ct(){const{toast:s}=a(),[n,r]=t.useState(!1),[i,l]=t.useState(""),[d,o]=t.useState(""),[c,m]=t.useState(""),[x,p]=t.useState(""),[g,k]=t.useState(""),[F,$]=t.useState(!1),[C,S]=t.useState(!1),[L,z]=t.useState(!1),[E,M]=t.useState(!1),[A,B]=t.useState(""),[O,Q]=t.useState(!1);t.useEffect(()=>{r(ne())},[]);const V=()=>{l(""),o(""),m(""),p(""),k(""),B(""),$(!1),S(!1),z(!1)},q=async e=>{if(e.preventDefault(),!n||i.trim())if(d.trim())if(c.trim())if(n&&d===i)B("كلمة المرور الجديدة يجب أن تكون مختلفة عن الحالية");else if(d===c)if(xe(d)){M(!0),B("");try{let e=!1;if(n)e=await pe(i.trim(),d.trim()),e&&s({title:"تم تغيير كلمة المرور بنجاح",description:"استخدم كلمة المرور الجديدة في المرات القادمة",variant:"default"});else{if(!x||!g.trim())return B("يرجى اختيار سؤال أماني والإجابة عليه"),void M(!1);const t=oe.find(e=>e.id===x);if(!t)return B("سؤال أماني غير صالح"),void M(!1);const a={password:d.trim(),securityQuestion:t,securityAnswer:g.trim()};e=await ue(a),e&&(s({title:"تم إعداد كلمة المرور بنجاح",description:"سيتم طلب كلمة المرور عند الوصول لقسم المدفوعات",variant:"default"}),r(!0))}e?V():B(n?"فشل في تغيير كلمة المرور. تأكد من صحة كلمة المرور الحالية.":"فشل في إعداد كلمة المرور. يرجى المحاولة مرة أخرى.")}catch(t){B(t.message||"حدث خطأ أثناء حفظ كلمة المرور")}finally{M(!1)}}else B("كلمة المرور ضعيفة. يجب أن تحتوي على 4 أحرف على الأقل وحرف أو رقم واحد");else B("كلمات المرور غير متطابقة");else B("يرجى تأكيد كلمة المرور الجديدة");else B("يرجى إدخال كلمة مرور جديدة");else B("يرجى إدخال كلمة المرور الحالية")};return e.jsx(u,{className:"w-full",dir:"rtl",children:e.jsxs(Ke,{open:O,onOpenChange:Q,children:[e.jsx(Ye,{asChild:!0,children:e.jsx(h,{className:"cursor-pointer hover:bg-muted/50 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center",children:n?e.jsx(re,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}):e.jsx(Ze,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx(j,{className:"text-lg",children:"إعدادات الأمان"}),e.jsx(T,{className:"text-right",children:n?"تغيير كلمة مرور قسم المدفوعات":"إعداد كلمة مرور لحماية قسم المدفوعات"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:O?"إغلاق":"فتح"}),O?e.jsx(ie,{className:"w-4 h-4 text-muted-foreground"}):e.jsx(le,{className:"w-4 h-4 text-muted-foreground"})]})]})})}),e.jsx(Xe,{children:e.jsx(f,{children:e.jsxs("form",{onSubmit:q,onKeyDown:e=>{"Enter"!==e.key||E||q(e)},className:"space-y-4",children:[n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"currentPassword",className:"text-right block",children:"كلمة المرور الحالية"}),e.jsxs("div",{className:"relative",children:[e.jsx(D,{id:"currentPassword",type:F?"text":"password",value:i,onChange:e=>l(e.target.value),placeholder:"أدخل كلمة المرور الحالية",className:"pr-10 text-right",disabled:E}),e.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute left-2 top-1/2 -translate-y-1/2 h-auto p-1",onClick:()=>$(!F),disabled:E,children:F?e.jsx(de,{className:"w-4 h-4"}):e.jsx(Z,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"newPassword",className:"text-right block",children:n?"كلمة المرور الجديدة":"كلمة المرور"}),e.jsxs("div",{className:"relative",children:[e.jsx(D,{id:"newPassword",type:C?"text":"password",value:d,onChange:e=>o(e.target.value),placeholder:n?"أدخل كلمة مرور جديدة":"أدخل كلمة مرور",className:"pr-10 text-right",disabled:E}),e.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute left-2 top-1/2 -translate-y-1/2 h-auto p-1",onClick:()=>S(!C),disabled:E,children:C?e.jsx(de,{className:"w-4 h-4"}):e.jsx(Z,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"confirmPassword",className:"text-right block",children:"تأكيد كلمة المرور"}),e.jsxs("div",{className:"relative",children:[e.jsx(D,{id:"confirmPassword",type:L?"text":"password",value:c,onChange:e=>m(e.target.value),placeholder:"أعد إدخال كلمة المرور",className:"pr-10 text-right",disabled:E}),e.jsx(P,{type:"button",variant:"ghost",size:"sm",className:"absolute left-2 top-1/2 -translate-y-1/2 h-auto p-1",onClick:()=>z(!L),disabled:E,children:L?e.jsx(de,{className:"w-4 h-4"}):e.jsx(Z,{className:"w-4 h-4"})})]})]}),!n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{className:"text-right block",children:"السؤال الأماني (لإعادة التعيين في حال نسيان كلمة المرور)"}),e.jsxs(b,{value:x,onValueChange:p,disabled:E,children:[e.jsx(v,{className:"text-right",children:e.jsx(_,{placeholder:"اختر سؤال أماني"})}),e.jsx(y,{children:oe.map(t=>e.jsx(w,{value:t.id,className:"text-right",children:t.question},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"securityAnswer",className:"text-right block",children:"إجابة السؤال الأماني"}),e.jsx(D,{id:"securityAnswer",type:"text",value:g,onChange:e=>k(e.target.value),placeholder:"أدخل إجابتك على السؤال المختار",className:"text-right",disabled:E})]})]}),A&&e.jsxs(ce,{variant:"destructive",children:[e.jsx(R,{className:"h-4 w-4"}),e.jsx(me,{className:"text-right",children:A})]}),e.jsxs("div",{className:"text-xs text-muted-foreground text-right",children:[e.jsx("p",{className:"font-medium mb-1",children:"متطلبات كلمة المرور:"}),e.jsx("p",{children:"• على الأقل 4 أحرف"}),e.jsx("p",{children:"• حرف أو رقم واحد على الأقل"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 pt-4",children:[e.jsx(P,{type:"button",variant:"outline",onClick:V,disabled:E,className:"w-full sm:w-auto",children:"إعادة تعيين"}),n&&e.jsx(P,{type:"button",variant:"destructive",onClick:async()=>{if(confirm("هل أنت متأكد من حذف كلمة المرور؟ سيتم السماح بالوصول المباشر لقسم المدفوعات.")){M(!0);try{he(),r(!1),V(),s({title:"تم حذف كلمة المرور",description:"يمكنك الآن الوصول لقسم المدفوعات مباشرة بدون كلمة مرور",variant:"default"})}catch(e){console.error("Error disabling password:",e),s({title:"خطأ",description:"فشل في حذف كلمة المرور",variant:"destructive"})}finally{M(!1)}}},disabled:E,className:"w-full sm:w-auto",children:"حذف كلمة المرور"}),e.jsx(P,{type:"submit",disabled:E||!d.trim()||!c.trim()||(n?!i.trim():!x||!g.trim()),className:"w-full sm:w-auto",children:E?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-4 h-4 ml-2"}),n?"حفظ التغييرات":"إعداد كلمة المرور"]})})]})]})})})]})})}function mt(){je(),ge();const{toast:r}=a(),[i,l]=t.useState(!1),[d,o]=t.useState(!1),[c,m]=t.useState(!1),[x,p]=t.useState(!1),[g,N]=t.useState(!1),[k,F]=t.useState(null),[$,S]=t.useState(void 0),{payments:T,filteredPayments:L,isLoading:z,error:E,searchQuery:M,statusFilter:A,paymentMethodFilter:B,totalRevenue:O,pendingAmount:Q,totalRemainingBalance:q,partialPaymentsCount:H,pendingPaymentsCount:I,paymentMethodStats:J,loadPayments:W,deletePayment:U,clearError:G,setSearchQuery:K,setStatusFilter:Y,setPaymentMethodFilter:X}=s(),{loadPatients:Z,patients:ee}=n(),ae=Ce({data:T,dateField:"payment_date",initialFilter:{preset:"all",startDate:"",endDate:""}});t.useEffect(()=>{W(),Z()},[W,Z]),t.useEffect(()=>{(()=>{try{const e=localStorage.getItem("selectedPatientForPayment");if(e){const t=JSON.parse(e);S(t.selectedPatientId),t.openAddDialog&&l(!0),localStorage.removeItem("selectedPatientForPayment")}}catch(e){console.error("Error reading pre-selected patient for payment:",e)}})()},[]),t.useEffect(()=>{const e=localStorage.getItem("selectedPaymentForDetails");if(e)try{const{payment:t,openDetailsModal:a}=JSON.parse(e);a&&t&&(F(t),p(!0),localStorage.removeItem("selectedPaymentForDetails"))}catch(t){console.error("Error parsing search result data:",t),localStorage.removeItem("selectedPaymentForDetails")}},[]),t.useEffect(()=>{E&&(r({title:"خطأ",description:E,variant:"destructive"}),G())},[E,r,G]);const se=""!==M||"all"!==A||"all"!==B;return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-heading-1 text-foreground arabic-enhanced",children:"إدارة الواردات"}),e.jsx("p",{className:"text-body text-muted-foreground mt-2 arabic-enhanced",children:"تتبع المدفوعات والفواتير والسجلات المالية"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(ve,{children:[e.jsx(_e,{asChild:!0,children:e.jsxs(P,{variant:"outline",children:[e.jsx(ze,{className:"w-4 h-4 ml-2"}),"تصدير"]})}),e.jsxs(ye,{align:"end",className:"w-48",children:[e.jsxs(we,{onClick:async()=>{if(0!==T.length)try{let e=[...T];if(ae.timeFilter.startDate&&ae.timeFilter.endDate){const t=new Date(ae.timeFilter.startDate),a=new Date(ae.timeFilter.endDate);a.setHours(23,59,59,999),e=e.filter(e=>{const s=new Date(e.payment_date);return s>=t&&s<=a})}M&&(e=e.filter(e=>{const t=ee.find(t=>t.id===e.patient_id)?.full_name||"";return e.receipt_number?.toLowerCase().includes(M.toLowerCase())||e.description?.toLowerCase().includes(M.toLowerCase())||t.toLowerCase().includes(M.toLowerCase())||e.amount.toString().includes(M)||e.payment_method.toLowerCase().includes(M.toLowerCase())||e.status.toLowerCase().includes(M.toLowerCase())})),"all"!==A&&(e=e.filter(e=>e.status===A)),"all"!==B&&(e=e.filter(e=>e.payment_method===B)),await tt.exportPaymentsToExcel(e),et.exportSuccess(`تم تصدير ${e.length} دفعة بنجاح إلى ملف Excel!`)}catch(e){console.error("Error exporting payments (Excel):",e),et.exportError("فشل في تصدير بيانات المدفوعات (Excel)")}else et.noDataToExport("لا توجد بيانات مدفوعات للتصدير")},className:"arabic-enhanced",children:[e.jsx(ze,{className:"w-4 h-4 ml-2"}),"تصدير Excel"]}),e.jsx(ke,{}),e.jsxs(we,{onClick:async()=>{if(0!==T.length)try{let e=[...T];if(ae.timeFilter.startDate&&ae.timeFilter.endDate){const t=new Date(ae.timeFilter.startDate),a=new Date(ae.timeFilter.endDate);a.setHours(23,59,59,999),e=e.filter(e=>{const s=new Date(e.payment_date);return s>=t&&s<=a})}M&&(e=e.filter(e=>{const t=ee.find(t=>t.id===e.patient_id)?.full_name||"";return e.receipt_number?.toLowerCase().includes(M.toLowerCase())||e.description?.toLowerCase().includes(M.toLowerCase())||t.toLowerCase().includes(M.toLowerCase())||e.amount.toString().includes(M)||e.payment_method.toLowerCase().includes(M.toLowerCase())||e.status.toLowerCase().includes(M.toLowerCase())})),"all"!==A&&(e=e.filter(e=>e.status===A)),"all"!==B&&(e=e.filter(e=>e.payment_method===B)),await tt.exportPaymentsToPDF(e),et.exportSuccess(`تم تصدير ${e.length} دفعة كملف PDF بنجاح!`)}catch(e){console.error("Error exporting payments (PDF):",e),et.exportError("فشل في تصدير بيانات المدفوعات (PDF)")}else et.noDataToExport("لا توجد بيانات مدفوعات للتصدير")},className:"arabic-enhanced",children:[e.jsx(Ae,{className:"w-4 h-4 ml-2"}),"تصدير PDF"]})]})]}),e.jsxs(P,{onClick:()=>{S(void 0),l(!0)},children:[e.jsx(at,{className:"w-4 h-4 ml-2"}),"تسجيل دفعة جديدة"]})]})]}),e.jsx(De,{value:ae.timeFilter,onChange:ae.handleFilterChange,onClear:ae.resetFilter,title:"فلترة زمنية - المدفوعات",defaultOpen:!1}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs(u,{className:Fe("green"),children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?"إجمالي الإيرادات":"الإيرادات المفلترة"}),e.jsx(C,{className:`h-4 w-4 ${$e("green")}`})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?V(O):V(ae.financialStats.totalRevenue)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?"من المدفوعات المكتملة والجزئية":"من المدفوعات المكتملة والجزئية في الفترة المحددة"}),ae.trend&&e.jsxs("div",{className:"text-xs flex items-center mt-1 "+(ae.trend.isPositive?"text-green-600":"text-red-600"),children:[e.jsx(st,{className:"w-3 h-3 ml-1 "+(ae.trend.isPositive?"":"rotate-180")}),e.jsxs("span",{children:[Math.abs(ae.trend.changePercent),"% من الفترة السابقة"]})]})]})]}),e.jsxs(u,{className:Fe("red"),children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?"المبالغ غير المدفوعة":"المبالغ غير المدفوعة المفلترة"}),e.jsx(R,{className:`h-4 w-4 ${$e("red")}`})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?V(Q):V(ae.financialStats.pendingAmount)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?"من العلاجات والمواعيد الآجلة":"من العلاجات والمواعيد الآجلة في الفترة المحددة"})]})]}),e.jsxs(u,{className:Fe("yellow"),children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?"المبالغ المتبقية":"المبالغ المتبقية المفلترة"}),e.jsx(te,{className:`h-4 w-4 ${$e("yellow")}`})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:(()=>{let e=[...T];if(ae.timeFilter.startDate&&ae.timeFilter.endDate){const t=new Date(ae.timeFilter.startDate),a=new Date(ae.timeFilter.endDate);a.setHours(23,59,59,999),e=e.filter(e=>{const s=new Date(e.payment_date);return s>=t&&s<=a})}M&&(e=e.filter(e=>{const t=ee.find(t=>t.id===e.patient_id)?.full_name||"";return e.receipt_number?.toLowerCase().includes(M.toLowerCase())||e.description?.toLowerCase().includes(M.toLowerCase())||t.toLowerCase().includes(M.toLowerCase())||e.amount.toString().includes(M)||e.payment_method.toLowerCase().includes(M.toLowerCase())||e.status.toLowerCase().includes(M.toLowerCase())})),"all"!==A&&(e=e.filter(e=>e.status===A)),"all"!==B&&(e=e.filter(e=>e.payment_method===B));const t=e=>{const t=Number(e);return isNaN(t)||!isFinite(t)?0:Math.round(100*t)/100},a=new Map,s=new Map;let n=0;e.forEach(e=>{if("partial"===e.status)if(e.tooth_treatment_id){const s=e.tooth_treatment_id,n=t(e.treatment_total_cost||e.total_amount_due||0),r=t(e.amount);a.has(s)||a.set(s,{totalDue:n,totalPaid:0});a.get(s).totalPaid+=r}else if(e.appointment_id){const a=e.appointment_id,n=t(e.total_amount_due||0),r=t(e.amount);s.has(a)||s.set(a,{totalDue:n,totalPaid:0});s.get(a).totalPaid+=r}else{const a=t(e.total_amount_due||e.amount),s=t(e.amount_paid||e.amount);n+=Math.max(0,a-s)}});const r=Array.from(a.values()).reduce((e,t)=>e+Math.max(0,t.totalDue-t.totalPaid),0),i=Array.from(s.values()).reduce((e,t)=>e+Math.max(0,t.totalDue-t.totalPaid),0),l=t(r+i+n),d=ae.timeFilter.startDate&&ae.timeFilter.endDate;return V(d?l:q)})()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:(()=>{let e=[...T];if(ae.timeFilter.startDate&&ae.timeFilter.endDate){const t=new Date(ae.timeFilter.startDate),a=new Date(ae.timeFilter.endDate);a.setHours(23,59,59,999),e=e.filter(e=>{const s=new Date(e.payment_date);return s>=t&&s<=a})}M&&(e=e.filter(e=>{const t=ee.find(t=>t.id===e.patient_id)?.full_name||"";return e.receipt_number?.toLowerCase().includes(M.toLowerCase())||e.description?.toLowerCase().includes(M.toLowerCase())||t.toLowerCase().includes(M.toLowerCase())||e.amount.toString().includes(M)||e.payment_method.toLowerCase().includes(M.toLowerCase())||e.status.toLowerCase().includes(M.toLowerCase())})),"all"!==A&&(e=e.filter(e=>e.status===A)),"all"!==B&&(e=e.filter(e=>e.payment_method===B));const t=e.filter(e=>"partial"===e.status).length;return"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?`من ${H} دفعة جزئية`:`من ${t} دفعة جزئية في الفترة المحددة`})()})]})]}),e.jsxs(u,{className:Fe("purple"),children:[e.jsxs(h,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(j,{className:"text-sm font-medium text-muted-foreground",children:"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?"معدل الإنجاز":"معدل الإنجاز المفلتر"}),e.jsx(st,{className:`h-4 w-4 ${$e("purple")}`})]}),e.jsxs(f,{children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:(()=>{let e=[...T];if(ae.timeFilter.startDate&&ae.timeFilter.endDate){const t=new Date(ae.timeFilter.startDate),a=new Date(ae.timeFilter.endDate);a.setHours(23,59,59,999),e=e.filter(e=>{const s=new Date(e.payment_date);return s>=t&&s<=a})}const t=e.length,a=e.filter(e=>"completed"===e.status).length;return`${t>0?(a/t*100).toFixed(1):"0.0"}%`})()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:(()=>{let e=[...T];if(ae.timeFilter.startDate&&ae.timeFilter.endDate){const t=new Date(ae.timeFilter.startDate),a=new Date(ae.timeFilter.endDate);a.setHours(23,59,59,999),e=e.filter(e=>{const s=new Date(e.payment_date);return s>=t&&s<=a})}const t=e.filter(e=>"completed"===e.status).length,a=e.length;return"all"===ae.timeFilter.preset||!ae.timeFilter.startDate&&!ae.timeFilter.endDate?`${t} مكتملة من ${a} إجمالي`:`${t} مكتملة من ${a} في الفترة المحددة`})()})]})]})]}),e.jsx(ct,{}),e.jsxs(u,{children:[e.jsx(h,{children:e.jsx(j,{className:"text-lg arabic-enhanced",children:"البحث والتصفية"})}),e.jsxs(f,{children:[e.jsx("div",{className:"flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 flex-1",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(D,{placeholder:"البحث في المدفوعات...",value:M,onChange:e=>K(e.target.value),className:"pl-10 arabic-enhanced text-right"})]}),e.jsxs(b,{value:A,onValueChange:Y,children:[e.jsxs(v,{className:"w-[180px]",children:[e.jsx(nt,{className:"w-4 h-4 mr-2"}),e.jsx(_,{placeholder:"تصفية حسب الحالة"})]}),e.jsxs(y,{children:[e.jsx(w,{value:"all",children:"جميع الحالات"}),e.jsx(w,{value:"completed",children:"مكتمل"}),e.jsx(w,{value:"pending",children:"آجل"}),e.jsx(w,{value:"partial",children:"جزئي"}),e.jsx(w,{value:"overdue",children:"متأخر"}),e.jsx(w,{value:"failed",children:"فاشل"}),e.jsx(w,{value:"refunded",children:"مسترد"})]})]}),e.jsxs(b,{value:B,onValueChange:X,children:[e.jsxs(v,{className:"w-[180px]",children:[e.jsx(nt,{className:"w-4 h-4 mr-2"}),e.jsx(_,{placeholder:"تصفية حسب طريقة الدفع"})]}),e.jsxs(y,{children:[e.jsx(w,{value:"all",children:"جميع طرق الدفع"}),e.jsx(w,{value:"cash",children:"نقداً"}),e.jsx(w,{value:"card",children:"بطاقة ائتمان"}),e.jsx(w,{value:"bank_transfer",children:"تحويل بنكي"}),e.jsx(w,{value:"check",children:"شيك"}),e.jsx(w,{value:"insurance",children:"تأمين"})]})]}),se&&e.jsxs(P,{variant:"outline",onClick:()=>{K(""),Y("all"),X("all")},className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4"}),"مسح الفلاتر"]})]})}),se&&e.jsxs("div",{className:"mt-4 text-sm text-muted-foreground arabic-enhanced",children:["عرض ",L.length," من أصل ",T.length," مدفوعة"]})]})]}),e.jsx(ot,{payments:L,patients:ee,isLoading:z,onEdit:e=>{F(e),o(!0)},onDelete:e=>{F(e),m(!0)},onShowReceipt:e=>{F(e),p(!0)},onViewDetails:e=>{F(e),N(!0)}}),e.jsx(be,{open:i,onOpenChange:e=>{l(e),e||S(void 0)},preSelectedPatientId:$}),k&&e.jsxs(e.Fragment,{children:[e.jsx(rt,{open:d,onOpenChange:o,payment:k}),e.jsx(it,{open:c,onOpenChange:m,payment:k}),e.jsx(lt,{open:x,onOpenChange:p,payment:k}),e.jsx(dt,{open:g,onOpenChange:N,payment:k,patients:ee})]})]})}export{mt as default};
