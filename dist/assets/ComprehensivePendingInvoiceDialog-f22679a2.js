import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{b6 as n,u as a,a as s,c as i,d as r,Q as o,D as l,f as c,g as d,h as m,B as p,C as x,L as u,S as h,m as _,n as g,o as v,p as j,I as f,aZ as y,w as N,Z as b,a0 as $,a$ as w,r as T,K as S,s as D,F as C}from"./index-3a8dc84c.js";import{S as F}from"./switch-3ea40783.js";import{P}from"./pdfService-844f6d4e.js";import{b as R,J as I}from"./qr-d6f50769.js";import{F as k}from"./file-text-861b9f90.js";import{F as z}from"./filter-f006659c.js";import{C as Q}from"./calculator-63fcb348.js";import{S as B}from"./settings-39dd9f65.js";import{P as O}from"./printer-5ab76652.js";import{D as M}from"./upload-4df8a268.js";import"./pdf-991f41f6.js";import"./utils-ec524415.js";import"./charts-b4389b44.js";class E{static calculateDateRange(e){const t=new Date,n=t.toISOString().split("T")[0];switch(e.date_range){case"last_month":return{from:new Date(t.getFullYear(),t.getMonth()-1,t.getDate()).toISOString().split("T")[0],to:n};case"last_3_months":return{from:new Date(t.getFullYear(),t.getMonth()-3,t.getDate()).toISOString().split("T")[0],to:n};case"last_6_months":return{from:new Date(t.getFullYear(),t.getMonth()-6,t.getDate()).toISOString().split("T")[0],to:n};case"last_year":return{from:new Date(t.getFullYear()-1,t.getMonth(),t.getDate()).toISOString().split("T")[0],to:n};case"custom":return{from:e.custom_start_date||n,to:e.custom_end_date||n};default:return{from:n,to:n}}}static filterPaymentsByDate(e,t){return e.filter(e=>{const n=e.payment_date;return n>=t.from&&n<=t.to})}static async getPatientPendingPayments(e,t,a,s=[],i=[]){try{const r=this.calculateDateRange(t),o=s||[],l=i||[],c=(a||[]).filter(t=>t.patient_id===e&&"pending"===t.status),d=this.filterPaymentsByDate(c,r),m=[];for(const e of d){const t=e.appointment_id?o.find(t=>t.id===e.appointment_id):void 0,a=e.tooth_treatment_id?l.find(t=>t.id===e.tooth_treatment_id):void 0,s=t?l.filter(e=>e.appointment_id===t.id):[],i=a||(1===s.length?s[0]:void 0),r=a?[a]:s,c=e.amount||0;let d,p=c,x=0,u=0;if(e.tooth_treatment_id?(x=e.treatment_total_cost||0,u=e.treatment_remaining_balance||0,p=u>0?u:x):e.appointment_id?(x=e.appointment_total_cost||e.total_amount_due||0,u=e.appointment_remaining_balance||e.remaining_balance||0,p=u>0?u:x):(x=e.total_amount_due||0,u=e.remaining_balance||0,0===c&&x>0?p=x:(0===c&&u>0||u>0)&&(p=u)),i?.treatment_type){if(d=n(i.treatment_type),d===i.treatment_type){d={pediatric_pulp_treatment:"معالجة لبية",pulp_therapy:"مداولة لبية",filling_metal:"حشو معدني",filling_cosmetic:"حشو تجميلي",crown_ceramic:"تاج خزفي",extraction_simple:"قلع بسيط"}[i.treatment_type]||i.treatment_type}}else r.length>0&&(d=r.map(e=>{let t=n(e.treatment_type);if(t===e.treatment_type){t={pediatric_pulp_treatment:"معالجة لبية",pulp_therapy:"مداولة لبية",filling_metal:"حشو معدني",filling_cosmetic:"حشو تجميلي",crown_ceramic:"تاج خزفي",extraction_simple:"قلع بسيط"}[e.treatment_type]||e.treatment_type}return t}).join(", "));let h=e.description;if(h&&(h=h.replace(/\[علاج:[^\]]+\]/g,"").trim(),h=h.replace(/^\s*-\s*/,"").trim(),!h&&d&&(h=d)),!d&&h){const e={pediatric_pulp_treatment:"معالجة لبية","معالجة لبية":"معالجة لبية","علاج عصب":"علاج عصب","حشو":"حشو","تاج":"تاج","قلع":"قلع"};for(const[t,n]of Object.entries(e))if(h.includes(t)){d=n;break}}let _=e.notes;_&&(_=_.replace(/\[علاج:[^\]]+\]/g,"").trim(),_=_.replace(/^\s*-\s*/,"").trim());const g={id:e.id,patient_id:e.patient_id,appointment_id:e.appointment_id,tooth_treatment_id:e.tooth_treatment_id,appointment_date:t?.start_time?.split("T")[0],appointment_title:t?.title,treatment_type:d,tooth_number:i?.tooth_number,tooth_name:i?.tooth_name,amount:this.roundToTwoDecimals(p),description:h,payment_date:e.payment_date,notes:_,discount_amount:this.roundToTwoDecimals(e.discount_amount||0),tax_amount:this.roundToTwoDecimals(e.tax_amount||0),total_amount:this.roundToTwoDecimals(e.total_amount||p),treatment_total_cost:e.treatment_total_cost,treatment_remaining_balance:e.treatment_remaining_balance,appointment_total_cost:e.appointment_total_cost,appointment_remaining_balance:e.appointment_remaining_balance};m.push(g)}return m.sort((e,t)=>new Date(e.payment_date).getTime()-new Date(t.payment_date).getTime())}catch(r){throw console.error("خطأ في جلب المدفوعات الآجلة:",r),new Error("فشل في جلب المدفوعات الآجلة")}}static calculatePendingPaymentsSummary(e,t,n,a,s){const i=this.roundToTwoDecimals(n.reduce((e,t)=>e+t.amount,0));let r=0;a.apply_discount&&a.discount_value>0&&(r="percentage"===a.discount_type?this.roundToTwoDecimals(i*a.discount_value/100):this.roundToTwoDecimals(Math.min(a.discount_value,i)));const o=this.roundToTwoDecimals(i-r);let l=0;a.include_tax&&a.tax_rate>0&&(l=this.roundToTwoDecimals(o*a.tax_rate/100));const c=this.roundToTwoDecimals(o+l);return{patient_id:e,patient_name:t,total_pending_amount:i,total_items:n.length,items:n,subtotal:i,total_discount:r,total_tax:l,final_total:c,date_range:s}}static roundToTwoDecimals(e){return Math.round(100*(e+Number.EPSILON))/100}static generateInvoiceNumber(){const e=new Date;return`INV-${e.getFullYear()}${String(e.getMonth()+1).padStart(2,"0")}${String(e.getDate()).padStart(2,"0")}-${String(e.getHours()).padStart(2,"0")+String(e.getMinutes()).padStart(2,"0")}-${Math.floor(1e3*Math.random()).toString().padStart(3,"0")}`}static createComprehensiveInvoiceData(e,t,n,a){return{invoice_number:this.generateInvoiceNumber(),invoice_date:(new Date).toISOString().split("T")[0],patient:e,summary:t,settings:n,clinic_info:a,generated_at:(new Date).toISOString()}}static validateFinancialData(e){const t=this.roundToTwoDecimals(e.items.reduce((e,t)=>e+t.amount,0));if(Math.abs(t-e.subtotal)>.01)return console.error("خطأ في حساب المجموع الفرعي"),!1;const n=this.roundToTwoDecimals(e.subtotal-e.total_discount+e.total_tax);return!(Math.abs(n-e.final_total)>.01)||(console.error("خطأ في حساب المجموع النهائي"),!1)}}const L=t.memo(function({patient:n,open:L,onOpenChange:V}){const{toast:A}=a(),{payments:U,updatePayment:Y}=s(),{appointments:q}=i(),{toothTreatments:G,loadToothTreatments:J,loadToothTreatmentsByPatient:W}=r(),{settings:Z}=o(),[H,K]=t.useState(!1),[X,ee]=t.useState(null),[te,ne]=t.useState(null);t.useState(!1);const[ae,se]=t.useState({date_range:"last_3_months"}),[ie,re]=t.useState({apply_discount:!1,discount_type:"percentage",discount_value:0,discount_reason:"",include_tax:!1,tax_rate:0,include_clinic_logo:!0,include_patient_details:!0,include_payment_terms:!0,payment_terms_text:"",footer_notes:"شكراً لثقتكم بنا"}),[oe,le]=t.useState({printerType:"80mm",includeQR:!0,includeBarcode:!0,includeLogo:!0,colorMode:"color",qrType:"text"}),[ce,de]=t.useState(!1),[me,pe]=t.useState(""),[xe,ue]=t.useState(""),he=t.useRef(null),_e=()=>{if(!X||!n)return"";const e=ge(),t=n.full_name||"غير محدد",a=n.phone||"غير محدد",s=n.id.toString().padStart(4,"0"),i=T((new Date).toISOString().split("T")[0]),r=Z?.clinic_name||"عيادة الأسنان",o=Z?.doctor_name||"الطبيب",l=Z?.clinic_phone||"غير محدد",c=Z?.clinic_address||"غير محدد",d=S(X.subtotal),m=X.total_discount>0?S(X.total_discount):"0",p=X.total_tax>0?S(X.total_tax):"0",x=S(X.final_total),u=X.items.length;return`🏥 ${r}\n👨‍⚕️ د. ${o}\n📞 ${l}\n📍 ${c}\n\n📋 فاتورة المدفوعات الآجلة\n🔢 رقم الفاتورة: ${e}\n📅 تاريخ الإصدار: ${i}\n📅 فترة الفاتورة: ${`${T(X.date_range.from)} - ${T(X.date_range.to)}`}\n\n👤 بيانات المريض:\n🆔 رقم المريض: ${s}\n👤 الاسم: ${t}\n📞 الهاتف: ${a}\n\n📋 تفاصيل العناصر (${u} عنصر):\n${X.items.slice(0,3).map((e,t)=>`${t+1}. ${e.appointment_title||e.treatment_type||e.description} - ${S(e.amount)}${e.tooth_name?` (🦷 ${e.tooth_name})`:""}`).join("\n")}${X.items.length>3?`\n... و ${X.items.length-3} عنصر إضافي`:""}\n\n💰 ملخص المبالغ:\nالمجموع الفرعي: ${d}\nالخصم: ${m}\nالضريبة: ${p}\n━━━━━━━━━━━━━━━━━━━━\nالمجموع النهائي: ${x}\n\n${ie.discount_reason?`💸 سبب الخصم: ${ie.discount_reason}\n`:""}${ie.notes?`📝 ملاحظات: ${ie.notes}\n`:""}\n🙏 شكراً لثقتكم بنا\n⏰ تم الإنشاء: ${(new Date).toLocaleString("ar-EG")}`},ge=()=>{if(!X||!n)return"";const e=Date.now().toString();return`INV${n.id.toString().padStart(4,"0")}${X.items.length.toString().padStart(2,"0")}${Math.round(X.final_total).toString().padStart(6,"0")}${e.slice(-4)}`};t.useEffect(()=>{L&&n&&Promise.all([J(),W(n.id)]).then(()=>{ve()}).catch(e=>{console.error("خطأ في تحميل البيانات:",e),ve()})},[L,n,ae]),t.useEffect(()=>{X&&n&&((async()=>{if(oe.includeQR&&X&&n)try{const e=_e();if(console.log("QR Code Data:",e),!e)return void console.error("QR Code: لا توجد بيانات للتوليد");const t=await R.toDataURL(e,{width:"a4"===oe.printerType?120:80,margin:1,color:{dark:"#000000",light:"#FFFFFF"}});pe(t)}catch(e){console.error("خطأ في توليد QR Code:",e)}})(),(async()=>{if(oe.includeBarcode&&X)try{const e=document.createElement("canvas"),t=ge();if(console.log("Barcode Data:",t),!t)return void console.error("Barcode: لا توجد بيانات للتوليد");I(e,t,{format:"CODE128",width:"a4"===oe.printerType?2:1,height:"a4"===oe.printerType?50:30,displayValue:!0,fontSize:"a4"===oe.printerType?12:8,margin:5});const n=e.toDataURL();ue(n)}catch(e){console.error("خطأ في توليد الباركود:",e)}})())},[X,oe.includeQR,oe.includeBarcode,oe.printerType]),t.useEffect(()=>{X&&n&&je()},[ie]);const ve=async()=>{if(n){K(!0);try{!!U&&U.length,!!q&&q.length,!!G&&G.length;U&&q&&G||console.warn("بعض البيانات المطلوبة غير متوفرة:",{payments:!!U,appointments:!!q,toothTreatments:!!G});const e=await E.getPatientPendingPayments(n.id,ae,U||[],q||[],G||[]),t=E.calculateDateRange(ae),a=E.calculatePendingPaymentsSummary(n.id,n.full_name,e,ie,t);if(!E.validateFinancialData(a))throw new Error("خطأ في حساب البيانات المالية");ee(a);const s=E.createComprehensiveInvoiceData(n,a,ie,Z);ne(s)}catch(e){console.error("خطأ في تحميل المدفوعات الآجلة:",e),A({title:"خطأ",description:"فشل في تحميل المدفوعات الآجلة",variant:"destructive"})}finally{K(!1)}}},je=()=>{if(!X||!n)return;const e=E.calculateDateRange(ae),t=E.calculatePendingPaymentsSummary(n.id,n.full_name,X.items,ie,e);ee(t),te&&ne({...te,summary:t,settings:ie})},fe=(e,t)=>{se(n=>({...n,[e]:t})),setTimeout(()=>{ve()},100)},ye=(e,t)=>{re(n=>({...n,[e]:t}))},Ne=async()=>{if(te)try{K(!0),await P.exportComprehensivePendingInvoice(te),A({title:"تم بنجاح",description:"تم تصدير الفاتورة كملف PDF",variant:"default"})}catch(e){console.error("خطأ في تصدير PDF:",e),A({title:"خطأ",description:"فشل في تصدير الفاتورة كـ PDF",variant:"destructive"})}finally{K(!1)}else A({title:"خطأ",description:"لا توجد بيانات فاتورة للتصدير",variant:"destructive"})};return n?e.jsx(l,{open:L,onOpenChange:V,children:e.jsxs(c,{className:"max-w-[95vw] max-h-[95vh] p-0",children:[e.jsx(d,{className:"p-4 border-b",children:e.jsxs(m,{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"}),"فاتورة المدفوعات الآجلة الشاملة"]}),e.jsx(p,{variant:"outline",className:"text-sm",children:n.full_name})]})}),e.jsxs("div",{className:"grid grid-cols-12 gap-4 p-4 h-[calc(95vh-100px)]",children:[e.jsxs("div",{className:"col-span-3 space-y-3",children:[e.jsx(x,{className:"p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{className:"text-xs font-medium flex items-center gap-1",children:[e.jsx(z,{className:"w-3 h-3"}),"فلتر التاريخ"]}),e.jsxs(h,{value:ae.date_range,onValueChange:e=>fe("date_range",e),children:[e.jsx(_,{className:"h-8 text-xs",children:e.jsx(g,{})}),e.jsxs(v,{children:[e.jsx(j,{value:"last_month",children:"آخر شهر"}),e.jsx(j,{value:"last_3_months",children:"آخر 3 أشهر"}),e.jsx(j,{value:"last_6_months",children:"آخر 6 أشهر"}),e.jsx(j,{value:"last_year",children:"آخر سنة"}),e.jsx(j,{value:"custom",children:"تاريخ مخصص"})]})]}),"custom"===ae.date_range&&e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs("div",{children:[e.jsx(u,{className:"text-xs",children:"من"}),e.jsx(f,{type:"date",className:"h-8 text-xs",value:ae.custom_start_date||"",onChange:e=>fe("custom_start_date",e.target.value)})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs",children:"إلى"}),e.jsx(f,{type:"date",className:"h-8 text-xs",value:ae.custom_end_date||"",onChange:e=>fe("custom_end_date",e.target.value)})]})]})]})}),e.jsx(x,{className:"p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{className:"text-xs font-medium flex items-center gap-1",children:[e.jsx(Q,{className:"w-3 h-3"}),"الخصومات والضرائب"]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(u,{className:"text-xs",children:"تطبيق خصم"}),e.jsx(F,{checked:ie.apply_discount,onCheckedChange:e=>ye("apply_discount",e)})]}),ie.apply_discount&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs("div",{children:[e.jsx(u,{className:"text-xs",children:"نوع الخصم"}),e.jsxs(h,{value:ie.discount_type,onValueChange:e=>ye("discount_type",e),children:[e.jsx(_,{className:"h-8 text-xs",children:e.jsx(g,{})}),e.jsxs(v,{children:[e.jsx(j,{value:"percentage",children:"نسبة مئوية"}),e.jsx(j,{value:"fixed",children:"مبلغ ثابت"})]})]})]}),e.jsxs("div",{children:[e.jsxs(u,{className:"text-xs",children:["قيمة الخصم ","percentage"===ie.discount_type?"(%)":"(مبلغ)"]}),e.jsx(f,{type:"number",min:"0",step:"0.1",className:"h-8 text-xs",value:ie.discount_value,onChange:e=>{const t=e.target.value;ye("discount_value",""===t?0:parseFloat(t)||0)},onBlur:e=>{const t=parseFloat(e.target.value)||0;ye("discount_value",t)}})]})]}),e.jsxs("div",{children:[e.jsx(u,{className:"text-xs",children:"سبب الخصم"}),e.jsx(f,{className:"h-8 text-xs",value:ie.discount_reason||"",onChange:e=>ye("discount_reason",e.target.value),placeholder:"اختياري"})]})]}),e.jsx(y,{}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(u,{className:"text-xs",children:"تضمين ضريبة"}),e.jsx(F,{checked:ie.include_tax,onCheckedChange:e=>ye("include_tax",e)})]}),ie.include_tax&&e.jsxs("div",{children:[e.jsx(u,{className:"text-xs",children:"معدل الضريبة (%)"}),e.jsx(f,{type:"number",min:"0",max:"100",step:"0.1",className:"h-8 text-xs",value:ie.tax_rate,onChange:e=>{const t=e.target.value;ye("tax_rate",""===t?0:parseFloat(t)||0)},onBlur:e=>{const t=parseFloat(e.target.value)||0;ye("tax_rate",t)}})]})]})}),e.jsx(x,{className:"p-3",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(u,{className:"text-xs font-medium flex items-center gap-1",children:[e.jsx(B,{className:"w-3 h-3"}),"إعدادات الطباعة"]}),e.jsxs(N,{variant:"ghost",size:"sm",onClick:()=>de(!ce),className:"text-xs h-6 px-2",children:[e.jsx(b,{className:"w-3 h-3 ml-1"}),ce?"إخفاء":"معاينة"]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(u,{className:"text-xs",children:"نوع الطابعة"}),e.jsxs(h,{value:oe.printerType,onValueChange:e=>le(t=>({...t,printerType:e})),children:[e.jsx(_,{className:"h-8 text-xs",children:e.jsx(g,{})}),e.jsxs(v,{children:[e.jsx(j,{value:"58mm",children:"حرارية 58mm"}),e.jsx(j,{value:"80mm",children:"حرارية 80mm"}),e.jsx(j,{value:"a4",children:"عادية A4"})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(u,{className:"text-xs",children:"نمط الألوان"}),e.jsxs(h,{value:oe.colorMode,onValueChange:e=>le(t=>({...t,colorMode:e})),children:[e.jsx(_,{className:"h-8 text-xs",children:e.jsx(g,{})}),e.jsxs(v,{children:[e.jsx(j,{value:"color",children:"ملون"}),e.jsx(j,{value:"bw",children:"أبيض وأسود"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("input",{type:"checkbox",id:"includeLogo",checked:oe.includeLogo,onChange:e=>le(t=>({...t,includeLogo:e.target.checked})),className:"rounded border-gray-300"}),e.jsx(u,{htmlFor:"includeLogo",className:"text-xs",children:"تضمين الشعار"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("input",{type:"checkbox",id:"includeQR",checked:oe.includeQR,onChange:e=>le(t=>({...t,includeQR:e.target.checked})),className:"rounded border-gray-300"}),e.jsx(u,{htmlFor:"includeQR",className:"text-xs",children:"QR Code"})]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("input",{type:"checkbox",id:"includeBarcode",checked:oe.includeBarcode,onChange:e=>le(t=>({...t,includeBarcode:e.target.checked})),className:"rounded border-gray-300"}),e.jsx(u,{htmlFor:"includeBarcode",className:"text-xs",children:"تضمين الباركود"})]})]}),ce&&(oe.includeQR||oe.includeBarcode)&&e.jsxs("div",{className:"mt-3 p-2 border rounded bg-muted/20",children:[e.jsx(u,{className:"text-xs font-medium",children:"معاينة:"}),e.jsxs("div",{className:"flex justify-center gap-4 mt-2",children:[oe.includeQR&&e.jsxs("div",{className:"text-center",children:[me?e.jsx("img",{src:me,alt:"QR Code",className:"w-16 h-16 mx-auto border"}):e.jsx("div",{className:"w-16 h-16 mx-auto border flex items-center justify-center bg-gray-100",children:e.jsx("span",{className:"text-xs",children:"QR"})}),e.jsx("p",{className:"text-xs mt-1",children:"QR Code"})]}),oe.includeBarcode&&e.jsxs("div",{className:"text-center",children:[xe?e.jsx("img",{src:xe,alt:"Barcode",className:"h-8 mx-auto border",style:{width:"auto"}}):e.jsx("div",{className:"w-20 h-8 mx-auto border flex items-center justify-center bg-gray-100",children:e.jsx("span",{className:"text-xs",children:"|||"})}),e.jsx("p",{className:"text-xs mt-1",children:"باركود"})]})]})]})]})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(N,{onClick:async()=>{if(X&&n)try{K(!0);const e=X.items.filter(e=>!e.id.startsWith("unpaid-")).map(async e=>{const t=U.find(t=>t.id===e.id);if(!t)return;let n=0,a={status:"completed",payment_date:(new Date).toISOString().split("T")[0],notes:`تم التأكيد عبر الفاتورة الشاملة - ${(new Date).toLocaleDateString("ar-SA")}`};return t.tooth_treatment_id?(n=t.treatment_total_cost||e.amount||0,a={...a,amount:n,treatment_total_paid:n,treatment_remaining_balance:0}):t.appointment_id?(n=t.appointment_total_cost||t.total_amount_due||e.amount||0,a={...a,amount:n,appointment_total_paid:n,appointment_remaining_balance:0,amount_paid:n,remaining_balance:0}):(n=t.total_amount_due||t.remaining_balance||e.amount||0,a={...a,amount:n,amount_paid:n,remaining_balance:0}),Y(e.id,a)});await Promise.all(e),A({title:"تم بنجاح",description:`تم تأكيد ${e.length} دفعة كمكتملة وتحديث المبالغ المالية`,variant:"default"}),await ve(),ee(null),ne(null),setTimeout(async()=>{try{await Ne()}catch(e){console.error("خطأ في التصدير التلقائي للـ PDF:",e)}},1e3)}catch(e){console.error("خطأ في تحديث المدفوعات:",e),A({title:"خطأ",description:"فشل في تحديث المدفوعات",variant:"destructive"})}finally{K(!1)}},disabled:H||!X||0===X.items.length,className:"w-full h-8 text-xs",variant:"default",children:[e.jsx($,{className:"w-3 h-3 mr-1"}),"تأكيد دفع الكل"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-1",children:[e.jsxs(N,{onClick:async()=>{if(!X||!n)return;let e=me,t=xe;if(oe.includeQR)try{const t=_e();t&&(e=await R.toDataURL(t,{width:"a4"===oe.printerType?120:80,margin:1,color:{dark:"#000000",light:"#FFFFFF"}}))}catch(s){console.error("خطأ في توليد QR Code للطباعة:",s)}if(oe.includeBarcode)try{const e=document.createElement("canvas"),n=ge();n&&(I(e,n,{format:"CODE128",width:"a4"===oe.printerType?2:1,height:"a4"===oe.printerType?50:30,displayValue:!0,fontSize:"a4"===oe.printerType?12:8,margin:5}),t=e.toDataURL())}catch(s){console.error("خطأ في توليد الباركود للطباعة:",s)}const a=window.open("","_blank");if(a){const s=`INV-${Date.now().toString().slice(-6)}`,i=T((new Date).toISOString().split("T")[0]),r="a4"===oe.printerType?"210mm":"58mm"===oe.printerType?"58mm":"80mm",o="a4"===oe.printerType?"200mm":"58mm"===oe.printerType?"54mm":"76mm",l=`\n        <html>\n          <head>\n            <title>فاتورة المدفوعات الآجلة - ${s}</title>\n            <meta charset="UTF-8">\n            <style>\n              @page {\n                size: ${r} auto;\n                margin: 0;\n              }\n              body {\n                font-family: 'Courier New', monospace;\n                direction: rtl;\n                margin: 0;\n                padding: 2mm;\n                font-size: ${"a4"===oe.printerType?"12px":"10px"};\n                line-height: 1.2;\n                color: #000;\n                background: white;\n                width: ${o};\n              }\n              .receipt {\n                width: 100%;\n                font-size: 10px;\n              }\n              .header {\n                text-align: center;\n                margin-bottom: 4px;\n                border-bottom: 1px solid #000;\n                padding-bottom: 2px;\n              }\n              .clinic-name {\n                font-size: 12px;\n                font-weight: bold;\n                margin-bottom: 1px;\n              }\n              .doctor-name {\n                font-size: 10px;\n                font-weight: bold;\n              }\n              .contact-info {\n                font-size: 8px;\n                margin: 1px 0;\n              }\n              .receipt-info {\n                margin: 3px 0;\n                font-size: 9px;\n              }\n              .patient-info {\n                margin: 3px 0;\n                padding: 2px 0;\n                border-top: 1px dashed #000;\n                border-bottom: 1px dashed #000;\n              }\n              .items {\n                margin: 3px 0;\n              }\n              .item {\n                margin: 2px 0;\n                padding: 1px 0;\n                border-bottom: 1px dotted #ccc;\n              }\n              .item-header {\n                font-weight: bold;\n                font-size: 9px;\n              }\n              .item-details {\n                font-size: 8px;\n                color: #666;\n                margin: 1px 0;\n              }\n              .item-amount {\n                text-align: left;\n                font-weight: bold;\n              }\n              .totals {\n                margin: 3px 0;\n                border-top: 1px solid #000;\n                padding-top: 2px;\n              }\n              .total-line {\n                display: flex;\n                justify-content: space-between;\n                margin: 1px 0;\n              }\n              .final-total {\n                font-weight: bold;\n                font-size: 11px;\n                border-top: 1px solid #000;\n                padding-top: 2px;\n                margin-top: 2px;\n              }\n              .footer {\n                text-align: center;\n                margin-top: 4px;\n                padding-top: 2px;\n                border-top: 1px dashed #000;\n                font-size: 8px;\n              }\n              .dashed-line {\n                border-top: 1px dashed #000;\n                margin: 2px 0;\n              }\n            </style>\n          </head>\n          <body>\n            <div class="receipt">\n              <div class="header">\n                ${oe.includeLogo&&Z?.clinic_logo?`\n                  <div style="text-align: center; margin-bottom: 5px;">\n                    <img src="${Z.clinic_logo}" alt="شعار العيادة" style="width: ${"a4"===oe.printerType?"60px":"40px"}; height: ${"a4"===oe.printerType?"60px":"40px"}; border-radius: 50%; border: 1px solid #000;" />\n                  </div>\n                `:""}\n                <div class="clinic-name">${Z?.clinic_name||"عيادة الأسنان"}</div>\n                <div class="doctor-name">د. ${Z?.doctor_name||"اسم الطبيب"}</div>\n                <div class="contact-info">${Z?.clinic_phone||"رقم الهاتف"}</div>\n                <div class="contact-info">${Z?.clinic_address||"العنوان"}</div>\n              </div>\n\n              <div class="receipt-info">\n                <div><strong>فاتورة المدفوعات الآجلة</strong></div>\n                <div>رقم الفاتورة: ${s}</div>\n                <div>التاريخ: ${i}</div>\n              </div>\n\n              <div class="patient-info">\n                <div><strong>بيانات المريض:</strong></div>\n                <div>الاسم: ${n.full_name}</div>\n                <div>الهاتف: ${n.phone||"غير محدد"}</div>\n              </div>\n\n              <div class="items">\n                <div><strong>تفاصيل المدفوعات الآجلة:</strong></div>\n                ${X.items.map((e,t)=>`\n                  <div class="item">\n                    <div class="item-header">\n                      ${t+1}. ${e.appointment_title||e.treatment_type||e.description}\n                    </div>\n                    <div class="item-details">\n                      ${e.payment_date?`📅 تاريخ الدفعة: ${T(e.payment_date)}`:""}\n                      ${e.appointment_date?`<br>📅 تاريخ الموعد: ${T(e.appointment_date)}`:""}\n                      ${e.treatment_type?`<br>🔧 نوع العلاج: ${e.treatment_type}`:""}\n                      ${e.tooth_name?`<br>🦷 ${e.tooth_name} (${e.tooth_number})`:""}\n                      ${e.doctor_name?`<br>👨‍⚕️ الطبيب: ${e.doctor_name}`:""}\n                      ${e.notes?`<br>📝 ملاحظات: ${e.notes}`:""}\n                      ${e.payment_method?`<br>💳 طريقة الدفع: ${e.payment_method}`:""}\n                      ${e.discount_amount&&e.discount_amount>0?`<br><span style="color: #dc2626;">💰 خصم: ${S(e.discount_amount)}</span>`:""}\n                    </div>\n                    <div class="item-amount">${S(e.amount)}</div>\n                  </div>\n                `).join("")}\n              </div>\n\n              \x3c!-- تفاصيل إضافية للفاتورة --\x3e\n              <div class="invoice-details" style="margin: 10px 0; padding: 5px 0; border-top: 1px dashed #000;">\n                <div style="font-size: 9px; color: #666;">\n                  <div>📊 إجمالي العناصر: ${X.items.length}</div>\n                  <div>📅 فترة الفاتورة: ${T(X.date_range.from)} - ${T(X.date_range.to)}</div>\n                  ${ie.discount_reason?`<div>💸 سبب الخصم: ${ie.discount_reason}</div>`:""}\n                  ${ie.notes?`<div>📝 ملاحظات: ${ie.notes}</div>`:""}\n                </div>\n              </div>\n\n              <div class="totals">\n                <div class="total-line">\n                  <span>المجموع الفرعي:</span>\n                  <span>${S(X.subtotal)}</span>\n                </div>\n                ${X.total_discount>0?`\n                  <div class="total-line">\n                    <span>الخصم:</span>\n                    <span>-${S(X.total_discount)}</span>\n                  </div>\n                `:""}\n                ${X.total_tax>0?`\n                  <div class="total-line">\n                    <span>الضريبة:</span>\n                    <span>+${S(X.total_tax)}</span>\n                  </div>\n                `:""}\n                <div class="total-line final-total">\n                  <span>المجموع النهائي:</span>\n                  <span>${S(X.final_total)}</span>\n                </div>\n              </div>\n\n              ${oe.includeQR?`\n                <div style="text-align: center; margin: 10px 0; border-top: 1px dashed #000; padding-top: 5px;">\n                  ${e?`\n                    <img src="${e}" alt="QR Code" style="width: ${"a4"===oe.printerType?"80px":"60px"}; height: ${"a4"===oe.printerType?"80px":"60px"}; margin: 0 auto;" />\n                    <div style="font-size: 8px; color: #666; margin-top: 2px;">امسح للتحقق من الفاتورة الكاملة</div>\n                    <div style="font-size: 7px; color: #999; margin-top: 1px;">\n                      يحتوي على: تفاصيل العيادة | بيانات المريض | ${X.items.length} عنصر | المبلغ الإجمالي\n                    </div>\n                    <div style="font-size: 7px; color: #999; margin-top: 1px;">\n                      رقم الفاتورة: ${ge()}\n                    </div>\n                  `:`\n                    <div style="border: 1px solid #000; width: ${"a4"===oe.printerType?"80px":"60px"}; height: ${"a4"===oe.printerType?"80px":"60px"}; margin: 0 auto; display: flex; align-items: center; justify-content: center;">\n                      <div style="font-size: 8px; text-align: center;">QR Code<br/>غير متوفر</div>\n                    </div>\n                  `}\n                </div>\n              `:""}\n\n              ${oe.includeBarcode?`\n                <div style="text-align: center; margin: 5px 0;">\n                  ${t?`\n                    <img src="${t}" alt="باركود الفاتورة" style="width: ${"a4"===oe.printerType?"120px":"100px"}; height: ${"a4"===oe.printerType?"30px":"20px"}; margin: 0 auto;" />\n                    <div style="font-size: 8px; color: #666; margin-top: 2px;">${ge()}</div>\n                    <div style="font-size: 7px; color: #999; margin-top: 1px;">\n                      المريض: ${n.id.toString().padStart(4,"0")} | العناصر: ${X.items.length.toString().padStart(2,"0")} | المبلغ: ${Math.round(X.final_total).toString().padStart(6,"0")}\n                    </div>\n                  `:`\n                    <div style="border: 1px solid #000; width: ${"a4"===oe.printerType?"120px":"100px"}; height: ${"a4"===oe.printerType?"30px":"20px"}; margin: 0 auto; display: flex; align-items: center; justify-content: center;">\n                      <div style="font-size: 8px;">باركود غير متوفر</div>\n                    </div>\n                  `}\n                </div>\n              `:""}\n\n              <div class="footer">\n                <div>شكراً لثقتكم بنا</div>\n                <div class="dashed-line"></div>\n                <div>تم الطباعة: ${(new Date).toLocaleString("ar-EG")}</div>\n              </div>\n            </div>\n          </body>\n        </html>\n      `;a.document.write(l),a.document.close(),a.onload=()=>{setTimeout(()=>{a.print()},1e3)},setTimeout(()=>{a.print()},2e3)}},disabled:!X,variant:"outline",className:"h-8 text-xs",children:[e.jsx(O,{className:"w-3 h-3 mr-1"}),"طباعة حرارية"]}),e.jsxs(N,{onClick:async()=>{if(!X||!n)return;let e=n.phone||"";if(e=e.replace(/\D/g,""),!e)return void A({title:"خطأ",description:"رقم هاتف المريض غير متوفر",variant:"destructive"});e.startsWith("963")||(e="963"+e);const t=Z?.clinic_name||"عيادة الأسنان",a=Z?.doctor_name||"الطبيب",s=`INV-${Date.now().toString().slice(-6)}`,i=T((new Date).toISOString().split("T")[0]);let r=`🏥 *${t}*\n`;r+=`👨‍⚕️ د. ${a}\n\n`,r+="📋 *فاتورة المدفوعات الآجلة*\n",r+=`🔢 رقم الفاتورة: ${s}\n`,r+=`📅 التاريخ: ${i}\n\n`,r+="👤 *بيانات المريض:*\n",r+=`الاسم: ${n.full_name}\n\n`,r+="💰 *تفاصيل المدفوعات الآجلة:*\n",X.items.forEach((e,t)=>{r+=`\n${t+1}. ${e.appointment_title||e.treatment_type||e.description}\n`,e.payment_date&&(r+=`   📅 تاريخ الدفعة: ${T(e.payment_date)}\n`),e.appointment_date&&(r+=`   📅 تاريخ الموعد: ${T(e.appointment_date)}\n`),e.treatment_type&&(r+=`   🔧 ${e.treatment_type}\n`),e.tooth_name&&(r+=`   🦷 ${e.tooth_name} (${e.tooth_number})\n`),r+=`   💵 ${S(e.amount)}\n`}),r+="\n📊 *ملخص المبالغ:*\n",r+=`المجموع الفرعي: ${S(X.subtotal)}\n`,X.total_discount>0&&(r+=`الخصم: -${S(X.total_discount)}\n`),X.total_tax>0&&(r+=`الضريبة: +${S(X.total_tax)}\n`),r+=`*المجموع النهائي: ${S(X.final_total)}*\n\n`,r+="🙏 شكراً لثقتكم بنا";const o=`https://wa.me/${e}?text=${encodeURIComponent(r)}`;try{if(window.electronAPI&&window.electronAPI.system&&window.electronAPI.system.openExternal)return await window.electronAPI.system.openExternal(o),void A({title:"تم بنجاح",description:"تم فتح الواتساب خارجياً لإرسال الفاتورة",variant:"default"})}catch(l){}try{if(window.electronAPI)return await(window.electronAPI.shell?.openExternal?.(o)),void A({title:"تم بنجاح",description:"تم فتح الواتساب خارجياً لإرسال الفاتورة",variant:"default"})}catch(l){}window.open(o,"_blank","noopener,noreferrer"),A({title:"تم بنجاح",description:"تم فتح الواتساب في المتصفح لإرسال الفاتورة",variant:"default"})},disabled:!X,variant:"outline",className:"h-8 text-xs",children:[e.jsx(w,{className:"w-3 h-3 mr-1"}),"واتساب"]})]}),e.jsxs(N,{onClick:Ne,disabled:!X,variant:"outline",className:"w-full h-8 text-xs",children:[e.jsx(M,{className:"w-3 h-3 mr-1"}),"تصدير PDF"]})]})]}),e.jsx("div",{className:"col-span-9 overflow-y-auto",children:H?e.jsx("div",{className:"flex items-center justify-center h-40",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"جاري تحميل المدفوعات الآجلة..."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"يرجى الانتظار"})]})}):X?e.jsxs("div",{ref:he,className:"space-y-4 p-4",children:[e.jsxs("div",{className:"text-center border-b pb-3",children:[e.jsx("h2",{className:"text-xl font-bold",children:"فاتورة المدفوعات الآجلة الشاملة"}),e.jsxs("div",{className:"flex justify-center gap-4 text-sm text-muted-foreground mt-1",children:[e.jsxs("span",{children:["رقم الفاتورة: ",te?.invoice_number]}),e.jsxs("span",{children:["تاريخ الإصدار: ",T(te?.invoice_date||"")]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"p-3 border rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"معلومات المريض"}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"الاسم:"})," ",n.full_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"الهاتف:"})," ",n.phone]}),n.email&&e.jsxs("p",{children:[e.jsx("strong",{children:"الإيميل:"})," ",n.email]})]})]}),e.jsxs("div",{className:"p-3 border rounded-lg",children:[e.jsx("h3",{className:"text-sm font-medium mb-2",children:"معلومات العيادة"}),e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"اسم العيادة:"})," ",Z.clinic_name]}),Z.clinic_phone&&e.jsxs("p",{children:[e.jsx("strong",{children:"الهاتف:"})," ",Z.clinic_phone]}),Z.clinic_address&&e.jsxs("p",{children:[e.jsx("strong",{children:"العنوان:"})," ",Z.clinic_address]})]})]})]}),e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-medium",children:"تفاصيل المدفوعات الآجلة الشاملة"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"secondary",className:"text-xs",children:[X.total_items," عنصر"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[T(X.date_range.from)," - ",T(X.date_range.to)]})]})]}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:X.items.map((t,n)=>{let a="عام",s="💰",i="دفعة آجلة",r=t.description;return r&&(r=r.replace(/\[علاج:[^\]]+\]/g,"").trim(),r=r.replace(/^\s*-\s*/,"").trim()),t.tooth_treatment_id?(a="علاج",s="🦷",i=t.treatment_type||r||"علاج سن"):t.appointment_id?(a="موعد",s="📅",i=t.appointment_title||r||"موعد طبي"):i=r||"دفعة آجلة",e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded text-xs",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsxs("span",{className:"font-medium text-xs",children:[n+1,"."]}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs(p,{variant:"علاج"===a?"default":"موعد"===a?"secondary":"outline",className:"text-xs px-1 py-0",children:[s," ",a]}),e.jsx("p",{className:"font-medium text-sm",children:i})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1 space-y-0.5",children:[t.payment_date&&e.jsxs("p",{children:["📅 تاريخ الدفعة: ",T(t.payment_date)]}),t.appointment_date&&e.jsxs("p",{children:["📅 تاريخ الموعد: ",T(t.appointment_date)]}),t.tooth_name&&e.jsxs("p",{children:["🦷 ",t.tooth_name," (سن #",t.tooth_number,")"]}),t.treatment_type&&"علاج"===a&&e.jsxs("p",{children:["🔧 نوع العلاج: ",t.treatment_type]}),t.doctor_name&&e.jsxs("p",{children:["👨‍⚕️ الطبيب: ",t.doctor_name]}),t.notes&&e.jsxs("p",{children:["📝 ملاحظات: ",t.notes]})]})]})]})}),e.jsxs("div",{className:"text-left ml-2",children:[e.jsx("p",{className:"font-bold text-sm",children:S(t.amount)}),t.discount_amount&&t.discount_amount>0&&e.jsxs("p",{className:"text-xs text-red-600",children:["خصم: ",S(t.discount_amount)]}),"علاج"===a&&t.treatment_remaining_balance&&t.treatment_remaining_balance>0&&e.jsxs("p",{className:"text-xs text-orange-600",children:["متبقي: ",S(t.treatment_remaining_balance)]})]})]},t.id)})})]}),e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsxs("h3",{className:"text-sm font-medium mb-3 flex items-center gap-1",children:[e.jsx(D,{className:"w-4 h-4"}),"ملخص المبالغ"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"المجموع الفرعي:"}),e.jsx("span",{className:"font-medium",children:S(X.subtotal)})]}),X.total_discount>0&&e.jsxs("div",{className:"flex justify-between text-red-600",children:[e.jsxs("span",{children:["الخصم (","percentage"===ie.discount_type?`${ie.discount_value}%`:"مبلغ ثابت","):"]}),e.jsxs("span",{className:"font-medium",children:["-",S(X.total_discount)]})]}),X.total_tax>0&&e.jsxs("div",{className:"flex justify-between text-blue-600",children:[e.jsxs("span",{children:["الضريبة (",ie.tax_rate,"%):"]}),e.jsxs("span",{className:"font-medium",children:["+",S(X.total_tax)]})]}),e.jsx(y,{}),e.jsxs("div",{className:"flex justify-between text-lg font-bold",children:[e.jsx("span",{children:"المجموع النهائي:"}),e.jsx("span",{className:"text-primary",children:S(X.final_total)})]})]})]}),ie.footer_notes&&e.jsx("div",{className:"border rounded-lg p-3",children:e.jsx("p",{className:"text-center text-sm text-muted-foreground",children:ie.footer_notes})})]}):e.jsx("div",{className:"flex items-center justify-center h-40",children:e.jsxs("div",{className:"text-center",children:[e.jsx(C,{className:"w-12 h-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"لا توجد مدفوعات آجلة للمريض"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"جرب تغيير فلتر التاريخ أو تفعيل خيارات إضافية"}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsx("p",{children:'• تأكد من وجود مدفوعات بحالة "آجل" للمريض'}),e.jsx("p",{children:"• جرب توسيع نطاق التاريخ"}),e.jsx("p",{children:'• فعل خيار "المواعيد غير المدفوعة" أو "العلاجات غير المدفوعة"'})]})]})})})]})]})}):null});export{L as default};
