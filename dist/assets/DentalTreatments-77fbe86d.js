import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{aj as s,d as a,ar as r,b9 as l,C as n,as as o,j as i,k as d,_ as c,v as m,L as x,l as u,bd as h,B as p,be as g,bf as b,bg as j,ba as v,bb as f,w as N,bc as y,a0 as w,$ as _,bh as k,b7 as C,ah as S,S as T,m as P,n as E,o as I,p as D,I as $,T as B,M as L,a as F,b as U,bi as A,bj as z,bk as O,s as G,r as M,bl as V,bm as R,bn as K,y as H,z as q,E as Z,F as J,G as Y,H as W,N as Q,O as X,P as ee,A as te,D as se,f as ae,g as re,h as le,i as ne,t as oe,bo as ie,Z as de,U as ce,a1 as me,u as xe,a_ as ue,Q as he,ae as pe,aY as ge,at as be,ag as je,am as ve}from"./index-3a8dc84c.js";import{C as fe}from"./checkbox-8b9b9c35.js";import{T as Ne,a as ye,b as we,c as _e}from"./tabs-952e3ebd.js";import{C as ke}from"./currency-display-e01ebf49.js";import{S as Ce,n as Se,X as Te}from"./notificationService-09cb27cc.js";import{P as Pe}from"./pen-square-6c634feb.js";import{T as Ee,U as Ie}from"./upload-4df8a268.js";import{P as De}from"./plus-1eab3b5b.js";import{u as $e}from"./labStore-8f239aba.js";import{u as Be}from"./labOrderStore-b969024d.js";import{A as Le,a as Fe,b as Ue}from"./arrow-up-832b5917.js";import{I as Ae}from"./image-d8fa81df.js";import{P as ze}from"./PrescriptionReceiptDialog-36713fb4.js";import{T as Oe,a as Ge,b as Me,c as Ve,d as Re,e as Ke}from"./table-20957d0a.js";import{P as He}from"./phone-a8e6eab2.js";import{C as qe,a as Ze}from"./chevrons-right-9b995d31.js";import{C as Je}from"./chevron-left-343e35ff.js";import{F as Ye}from"./file-text-861b9f90.js";import{P as We}from"./printer-5ab76652.js";import"./pdf-991f41f6.js";import"./utils-ec524415.js";import"./charts-b4389b44.js";import"./index-a46c293c.js";import"./qr-d6f50769.js";import"./settings-39dd9f65.js";import"./pill-2f66511d.js";
/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=s("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),Xe=s("GitCompare",[["circle",{cx:"18",cy:"18",r:"3",key:"1xkwt0"}],["circle",{cx:"6",cy:"6",r:"3",key:"1lh9wr"}],["path",{d:"M13 6h3a2 2 0 0 1 2 2v7",key:"1yeb86"}],["path",{d:"M11 18H8a2 2 0 0 1-2-2V9",key:"19pyzm"}]]),et=s("Layers",[["path",{d:"m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z",key:"8b97xw"}],["path",{d:"m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65",key:"dd6zsq"}],["path",{d:"m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65",key:"ep9fru"}]]),tt=s("PlayCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]);
/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */function st({patientId:s,onToothClick:S,selectedTooth:T,selectedTeeth:P=[],isMultiSelectMode:E=!1,className:I,isPrimaryTeeth:D=!1,onPrimaryTeethChange:$}){const{toothTreatments:B,toothTreatmentImages:L,loadToothTreatmentsByPatient:F,loadToothTreatmentImagesByTooth:U,loadAllToothTreatmentImagesByPatient:A}=a();r();const[z,O]=t.useState(null),[G,M]=t.useState(!1),[V,R]=t.useState(0),K=$?D:G,H=$||M;t.useEffect(()=>{s&&(F(s),A(s))},[s,F,A]);const q=async()=>{s&&(await Promise.all([F(s),A(s)]),R(e=>e+1))};t.useEffect(()=>{"undefined"!=typeof window&&(window.forceToothColorUpdate=q().triggerToothColorUpdate=()=>{window.dispatchEvent(new CustomEvent("tooth-color-update",{detail:{type:"manual-trigger",timestamp:Date.now()}}))})},[s]),t.useEffect(()=>{},[L]),t.useEffect(()=>{R(e=>e+1)},[B]),t.useEffect(()=>{const e=()=>{R(e=>e+1)},t=async e=>{await q()};return window.addEventListener("treatment-updated",e),window.addEventListener("treatment-changed",e),window.addEventListener("tooth-color-update",t),window.addEventListener("treatments-loaded",e),()=>{window.removeEventListener("treatment-updated",e),window.removeEventListener("treatment-changed",e),window.removeEventListener("tooth-color-update",t),window.removeEventListener("treatments-loaded",e)}},[s]);const Z=K?g:b,J=Z.filter(e=>"upper"===e.position),Y=Z.filter(e=>"lower"===e.position),W=e=>B.filter(t=>t.patient_id===s&&t.tooth_number===e).sort((e,t)=>e.priority-t.priority),Q=t=>{const a=j(t,K),r=(e=>{const t=W(e);return{total:t.length,completed:t.filter(e=>"completed"===e.treatment_status).length,inProgress:t.filter(e=>"in_progress"===e.treatment_status).length,planned:t.filter(e=>"planned"===e.treatment_status).length,treatments:t}})(t),l=(e=>{const t=W(e);if(0===t.length)return"#22c55e";if(t.every(e=>"completed"===e.treatment_status))return"#22c55e";const s=t.find(e=>"in_progress"===e.treatment_status)||t.find(e=>"planned"===e.treatment_status)||t[0];return s?.treatment_color||"#22c55e"})(t),n=(e=>s?L.filter(t=>t.tooth_number===e&&t.patient_id===s).length:0)(t),i=T===t,d=P.includes(t),m=z===t;return a?e.jsxs(v,{children:[e.jsx(f,{asChild:!0,children:e.jsxs(N,{variant:"outline",className:o("relative h-16 w-16 p-1 transition-all duration-200 border-2 overflow-hidden","flex flex-col items-center justify-center text-xs font-medium",i&&"ring-2 ring-blue-500 ring-offset-2",d&&"ring-2 ring-orange-500 ring-offset-2 border-orange-400",m&&"scale-105 shadow-lg"),style:{borderColor:l,color:"#000000",textShadow:"0 0 2px rgba(255,255,255,0.8)"},onClick:e=>{const s=e.ctrlKey||e.metaKey;S(t,s)},onMouseEnter:()=>O(t),onMouseLeave:()=>O(null),children:[e.jsx("div",{className:"absolute inset-0",children:0===r.total?e.jsx("div",{className:"w-full h-full",style:{backgroundColor:i?l:m?l+"40":l+"20"}}):1===r.total?(()=>{const t="completed"===r.treatments[0].treatment_status?l:r.treatments[0].treatment_color;return e.jsx("div",{className:"w-full h-full",style:{backgroundColor:t,opacity:i?.95:m?.85:"completed"===r.treatments[0].treatment_status?.8:"in_progress"===r.treatments[0].treatment_status?.75:.7}})})():2===r.total?r.treatments.every(e=>"completed"===e.treatment_status)?e.jsx("div",{className:"w-full h-full",style:{backgroundColor:l,opacity:i?.95:m?.85:.8}}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-1/2 border-b-2 border-white/50",style:{backgroundColor:"completed"===r.treatments[0].treatment_status?l:r.treatments[0].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[0].treatment_status?.8:"in_progress"===r.treatments[0].treatment_status?.75:.7}}),e.jsx("div",{className:"absolute bottom-0 left-0 w-full h-1/2",style:{backgroundColor:"completed"===r.treatments[1].treatment_status?l:r.treatments[1].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[1].treatment_status?.8:"in_progress"===r.treatments[1].treatment_status?.75:.7}})]}):3===r.total?r.treatments.every(e=>"completed"===e.treatment_status)?e.jsx("div",{className:"w-full h-full",style:{backgroundColor:l,opacity:i?.95:m?.85:.8}}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-1/2 border-b-2 border-white/50",style:{backgroundColor:"completed"===r.treatments[0].treatment_status?l:r.treatments[0].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[0].treatment_status?.8:"in_progress"===r.treatments[0].treatment_status?.75:.7}}),e.jsx("div",{className:"absolute bottom-0 left-0 w-1/2 h-1/2 border-r-2 border-white/50",style:{backgroundColor:"completed"===r.treatments[1].treatment_status?l:r.treatments[1].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[1].treatment_status?.8:"in_progress"===r.treatments[1].treatment_status?.75:.7}}),e.jsx("div",{className:"absolute bottom-0 right-0 w-1/2 h-1/2",style:{backgroundColor:"completed"===r.treatments[2].treatment_status?l:r.treatments[2].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[2].treatment_status?.8:"in_progress"===r.treatments[2].treatment_status?.75:.7}})]}):r.treatments.every(e=>"completed"===e.treatment_status)?e.jsx("div",{className:"w-full h-full",style:{backgroundColor:l,opacity:i?.95:m?.85:.8}}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-0 left-0 w-1/2 h-1/2 border-r-2 border-b-2 border-white/50",style:{backgroundColor:"completed"===r.treatments[0].treatment_status?l:r.treatments[0].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[0].treatment_status?.8:"in_progress"===r.treatments[0].treatment_status?.75:.7}}),e.jsx("div",{className:"absolute top-0 right-0 w-1/2 h-1/2 border-b-2 border-white/50",style:{backgroundColor:"completed"===r.treatments[1].treatment_status?l:r.treatments[1].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[1].treatment_status?.8:"in_progress"===r.treatments[1].treatment_status?.75:.7}}),e.jsx("div",{className:"absolute bottom-0 left-0 w-1/2 h-1/2 border-r-2 border-white/50",style:{backgroundColor:"completed"===r.treatments[2].treatment_status?l:r.treatments[2].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[2].treatment_status?.8:"in_progress"===r.treatments[2].treatment_status?.75:.7}}),e.jsx("div",{className:"absolute bottom-0 right-0 w-1/2 h-1/2",style:{backgroundColor:"completed"===r.treatments[3].treatment_status?l:r.treatments[3].treatment_color,opacity:i?.95:m?.85:"completed"===r.treatments[3].treatment_status?.8:"in_progress"===r.treatments[3].treatment_status?.75:.7}})]})}),e.jsx("div",{className:"relative z-10 text-xs font-bold mb-1 px-1 rounded",style:{backgroundColor:"rgba(255,255,255,0.95)",color:"#000000",textShadow:"none"},children:t}),e.jsx("div",{className:"relative z-10",children:e.jsx("div",{className:"w-6 h-6 rounded-sm border-2 border-white flex items-center justify-center text-xs font-bold",style:{backgroundColor:r.total>0?"rgba(255,255,255,0.95)":"rgba(255,255,255,0.7)",color:r.total>0?"#1f2937":"#6b7280",textShadow:"none"},children:r.total>0?r.total:"✓"})}),n>0&&e.jsx("div",{className:"absolute -top-2 -left-2 z-20",children:e.jsx("div",{className:(n>9?"w-7 h-6 px-1":"w-6 h-6")+" rounded-full border-2 border-white bg-blue-600 flex items-center justify-center text-white font-bold shadow-lg transition-transform duration-200 hover:scale-110",style:{fontSize:n>9?"10px":"12px",fontWeight:"800",boxShadow:"0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(0,0,0,0.3)",background:"linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",textShadow:"0 1px 2px rgba(0,0,0,0.5)",minWidth:"24px"},children:n>99?"99+":n})}),r.inProgress>0&&e.jsx("div",{className:"absolute -bottom-1 -left-1 z-20",children:e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded-full border border-white"})})]})}),e.jsx(y,{side:"top",className:"max-w-xs",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"font-semibold",children:["السن رقم ",t," - ",a.arabicName]}),r.total>0?e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(et,{className:"w-3 h-3"}),e.jsxs("span",{children:[r.total," علاج مسجل"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[r.completed>0&&e.jsxs(p,{variant:"secondary",className:"text-xs bg-green-100 text-green-800",children:[e.jsx(w,{className:"w-2 h-2 ml-1"}),r.completed," مكتمل"]}),r.inProgress>0&&e.jsxs(p,{variant:"secondary",className:"text-xs bg-yellow-100 text-yellow-800",children:[e.jsx(c,{className:"w-2 h-2 ml-1"}),r.inProgress," قيد التنفيذ"]}),r.planned>0&&e.jsxs(p,{variant:"secondary",className:"text-xs bg-blue-100 text-blue-800",children:[e.jsx(_,{className:"w-2 h-2 ml-1"}),r.planned," مخطط"]})]}),e.jsxs("div",{className:"space-y-1 mt-2",children:[r.treatments.slice(0,3).map((t,s)=>e.jsxs("div",{className:"text-xs flex items-center gap-2 p-1 rounded bg-gray-50 dark:bg-gray-700",children:[e.jsx("div",{className:"w-2.5 h-2.5 rounded-full border border-white/50",style:{backgroundColor:t.treatment_color,opacity:"completed"===t.treatment_status?1:"in_progress"===t.treatment_status?.8:.6}}),e.jsxs("span",{className:"font-medium text-blue-600",children:["#",t.priority]}),e.jsx("span",{className:"flex-1",children:k(t.treatment_type)?.label||t.treatment_type}),e.jsx(p,{variant:"outline",className:"text-xs px-1 py-0",style:{borderColor:t.treatment_color,color:t.treatment_color},children:C.find(e=>e.value===t.treatment_status)?.label})]},t.id)),r.total>3&&e.jsxs("div",{className:"text-xs text-muted-foreground text-center",children:["و ",r.total-3," علاج آخر... انقر لعرض الكل"]})]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:"لا توجد علاجات مسجلة"}),n>0&&e.jsxs("div",{className:"text-xs text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 p-1 rounded",children:["📷 ",n," صورة"]})]})})]},t):null};return e.jsx(l,{children:e.jsxs(n,{className:o("w-full",I),id:"dental-chart-section",children:[e.jsx(i,{className:"pb-6",children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(d,{className:"flex items-center gap-2 text-xl",children:[e.jsx(c,{className:"w-6 h-6 text-blue-600"}),"مخطط الأسنان التفاعلي"]}),e.jsx(m,{className:"text-base",children:"انقر على أي سن لعرض وإدارة العلاجات المتعددة"})]}),e.jsxs("div",{className:"flex items-center space-x-3 space-x-reverse p-3 bg-muted/50 rounded-lg",children:[e.jsx(x,{htmlFor:"teeth-type",className:"text-sm font-medium",children:"أسنان لبنية"}),e.jsx(fe,{id:"teeth-type",checked:K,onCheckedChange:H})]})]})}),e.jsxs(u,{className:"space-y-8 bg-card dark:bg-card",children:[e.jsx("div",{className:"flex flex-wrap justify-center gap-3 p-4 bg-muted/30 rounded-lg",children:h.slice(0,6).map(t=>e.jsxs(p,{variant:"secondary",className:"text-sm px-3 py-2",style:{backgroundColor:t.color+"20",color:t.color,borderColor:t.color+"40"},children:[e.jsx("span",{className:"ml-2",children:t.icon}),t.label]},t.value))}),e.jsxs("div",{className:"space-y-4 p-4 bg-muted/20 rounded-lg",children:[e.jsx("div",{className:"text-center text-lg font-semibold text-foreground",children:K?"الفك العلوي اللبني":"الفك العلوي"}),e.jsx("div",{className:"grid gap-2 justify-center "+(K?"grid-cols-10":"grid-cols-16"),children:J.map(e=>Q(e.number))})]}),e.jsxs("div",{className:"space-y-4 p-4 bg-muted/20 rounded-lg",children:[e.jsx("div",{className:"text-center text-lg font-semibold text-foreground",children:K?"الفك السفلي اللبني":"الفك السفلي"}),e.jsx("div",{className:"grid gap-2 justify-center "+(K?"grid-cols-10":"grid-cols-16"),children:Y.map(e=>Q(e.number))})]}),e.jsxs("div",{className:"text-center space-y-4 p-4 bg-muted/30 rounded-lg",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"انقر على أي سن لعرض تفاصيل العلاج وإدارة العلاجات المتعددة"}),e.jsxs("div",{className:"flex justify-center gap-6 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold",children:"#"}),e.jsx("span",{children:"عدد العلاجات"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-yellow-500 rounded-full"}),e.jsx("span",{children:"قيد التنفيذ"})]})]})]})]})]},`dental-chart-${V}`)})}const at=[{value:"drilling",label:"حفر السن",description:"فتح السن والوصول للعصب"},{value:"nerve_extraction",label:"سحب العصب",description:"إزالة العصب المصاب"},{value:"canal_cleaning",label:"تنظيف القنوات",description:"تنظيف وتطهير قنوات الجذر"},{value:"canal_shaping",label:"تشكيل القنوات",description:"توسيع وتشكيل قنوات الجذر"},{value:"medication",label:"وضع الدواء",description:"وضع مضاد حيوي داخل القنوات"},{value:"filling",label:"حشو القنوات",description:"حشو نهائي لقنوات الجذر"},{value:"crown_prep",label:"تحضير للتاج",description:"تحضير السن لوضع التاج"},{value:"final_restoration",label:"الترميم النهائي",description:"وضع الحشوة أو التاج النهائي"}],rt=[{value:"cavity_prep",label:"تحضير التجويف",description:"إزالة التسوس وتحضير السن"},{value:"base_placement",label:"وضع القاعدة",description:"وضع مادة القاعدة الواقية"},{value:"filling_placement",label:"وضع الحشوة",description:"وضع مادة الحشو"},{value:"polishing",label:"تلميع",description:"تلميع وتنعيم الحشوة"},{value:"bite_adjustment",label:"تعديل العضة",description:"تعديل ارتفاع الحشوة"}],lt=[{value:"tooth_prep",label:"تحضير السن",description:"برد وتشكيل السن"},{value:"impression",label:"أخذ الطبعة",description:"أخذ طبعة للسن المحضر"},{value:"temp_crown",label:"تاج مؤقت",description:"وضع تاج مؤقت"},{value:"try_in",label:"تجربة التاج",description:"تجربة التاج النهائي"},{value:"cementation",label:"تثبيت التاج",description:"تثبيت التاج بالإسمنت"},{value:"final_adjustment",label:"التعديل النهائي",description:"تعديل العضة والتلميع"},{value:"initial_impression",label:"الطبعة الأولية",description:"أخذ طبعة أولية للفكين"},{value:"final_impression",label:"الطبعة النهائية",description:"أخذ طبعة نهائية دقيقة"},{value:"bite_registration",label:"تسجيل العضة",description:"تحديد العلاقة بين الفكين"},{value:"try_in_wax",label:"تجربة الشمع",description:"تجربة الأسنان على الشمع"},{value:"denture_delivery",label:"تسليم الجهاز",description:"تسليم الجهاز المتحرك النهائي"},{value:"denture_adjustment",label:"تعديل الجهاز",description:"تعديل وضبط الجهاز المتحرك"},{value:"follow_up_denture",label:"متابعة الجهاز",description:"فحص ومتابعة الجهاز المتحرك"},{value:"implant_impression",label:"طبعة الزرعة",description:"أخذ طبعة للزرعة المدفونة"},{value:"abutment_placement",label:"وضع الدعامة",description:"تركيب دعامة فوق الزرعة"},{value:"implant_crown_try",label:"تجربة تاج الزرعة",description:"تجربة التاج فوق الزرعة"},{value:"implant_crown_delivery",label:"تسليم تاج الزرعة",description:"تثبيت التاج النهائي فوق الزرعة"},{value:"post_space_prep",label:"تحضير مجرى الوتد",description:"تحضير مجرى الوتد في الجذر"},{value:"post_impression",label:"طبعة الوتد",description:"أخذ طبعة لمجرى الوتد"},{value:"post_try_in",label:"تجربة الوتد",description:"تجربة القلب والوتد"},{value:"post_cementation",label:"تثبيت الوتد",description:"تثبيت القلب والوتد بالإسمنت"},{value:"veneer_prep",label:"تحضير الفينير",description:"برد طفيف للسطح الأمامي"},{value:"veneer_impression",label:"طبعة الفينير",description:"أخذ طبعة للأسنان المحضرة"},{value:"veneer_try_in",label:"تجربة الفينير",description:"تجربة قشور الفينير"},{value:"veneer_bonding",label:"لصق الفينير",description:"لصق قشور الفينير نهائياً"}],nt=[{value:"consultation",label:"استشارة",description:"فحص وتقييم الحالة"},{value:"anesthesia",label:"تخدير",description:"تخدير موضعي"},{value:"extraction",label:"القلع",description:"قلع السن"},{value:"suturing",label:"خياطة",description:"خياطة الجرح إذا لزم"},{value:"follow_up",label:"متابعة",description:"فحص الشفاء"},{value:"suture_removal",label:"إزالة الخيوط",description:"إزالة الخيوط الجراحية"}],ot=[{value:"scaling",label:"تنظيف فوق اللثة",description:"إزالة الجير فوق خط اللثة"},{value:"root_planing",label:"تنظيف تحت اللثة",description:"تنظيف الجذور تحت اللثة"},{value:"polishing",label:"تلميع",description:"تلميع الأسنان"},{value:"fluoride",label:"فلورايد",description:"تطبيق الفلورايد"},{value:"maintenance",label:"صيانة دورية",description:"تنظيف دوري للمتابعة"}],it=[{value:"examination",label:"فحص",description:"فحص أسنان الطفل"},{value:"cleaning",label:"تنظيف",description:"تنظيف أسنان الطفل"},{value:"fluoride_treatment",label:"علاج بالفلورايد",description:"تطبيق الفلورايد الوقائي"},{value:"sealant",label:"مادة سادة",description:"وضع مادة سادة للشقوق"},{value:"pulp_treatment",label:"علاج العصب",description:"علاج عصب سن لبني"},{value:"space_maintainer",label:"حافظ مسافة",description:"وضع جهاز حافظ المسافة"}],dt=[{value:"consultation",label:"استشارة تجميلية",description:"تقييم الحالة التجميلية"},{value:"teeth_whitening",label:"تبييض الأسنان",description:"جلسة تبييض"},{value:"veneer_prep",label:"تحضير للقشرة",description:"تحضير السن للقشرة التجميلية"},{value:"veneer_placement",label:"وضع القشرة",description:"تثبيت القشرة التجميلية"},{value:"polishing",label:"تلميع تجميلي",description:"تلميع وتنعيم نهائي"}];function ct({session:s,isEditing:a,availableSessionTypes:r,onEdit:l,onCancelEdit:i,onSave:d,onDelete:c,getStatusBadgeColor:m,getStatusText:h,isDarkMode:g}){const[b,j]=t.useState({session_type:s.session_type,session_title:s.session_title,session_description:s.session_description,session_date:s.session_date,session_status:s.session_status,duration_minutes:s.duration_minutes,notes:s.notes}),v=()=>{d(b)},f=()=>{j({session_type:s.session_type,session_title:s.session_title,session_description:s.session_description,session_date:s.session_date,session_status:s.session_status,duration_minutes:s.duration_minutes,cost:s.cost,notes:s.notes}),i()};return a?e.jsx(n,{className:o("border-2 transition-all duration-200",g?"border-yellow-600 bg-yellow-900/20":"border-yellow-400 bg-yellow-50"),children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"font-medium text-foreground",children:["تعديل الجلسة #",s.session_number]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{size:"sm",variant:"outline",onClick:f,children:[e.jsx(S,{className:"w-4 h-4 ml-1"}),"إلغاء"]}),e.jsxs(N,{size:"sm",onClick:v,children:[e.jsx(Ce,{className:"w-4 h-4 ml-1"}),"حفظ"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"edit_session_type",children:"نوع الجلسة"}),e.jsxs(T,{value:b.session_type||"",onValueChange:e=>{const t=r.find(t=>t.value===e);j(s=>({...s,session_type:e,session_title:t?.label||s.session_title}))},children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر نوع الجلسة"})}),e.jsx(I,{children:r.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.label}),t.description&&e.jsx("div",{className:"text-sm text-muted-foreground",children:t.description})]})},t.value))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"edit_session_title",children:"عنوان الجلسة"}),e.jsx($,{id:"edit_session_title",value:b.session_title||"",onChange:e=>j(t=>({...t,session_title:e.target.value}))})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"edit_session_date",children:"تاريخ الجلسة"}),e.jsx($,{id:"edit_session_date",type:"date",value:b.session_date||"",onChange:e=>j(t=>({...t,session_date:e.target.value}))})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"edit_duration",children:"مدة الجلسة (دقيقة)"}),e.jsx($,{id:"edit_duration",type:"number",value:b.duration_minutes||30,onChange:e=>j(t=>({...t,duration_minutes:parseInt(e.target.value)||30}))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"edit_session_description",children:"وصف الجلسة"}),e.jsx(B,{id:"edit_session_description",value:b.session_description||"",onChange:e=>j(t=>({...t,session_description:e.target.value})),rows:3})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"edit_notes",children:"ملاحظات"}),e.jsx(B,{id:"edit_notes",value:b.notes||"",onChange:e=>j(t=>({...t,notes:e.target.value})),rows:2})]})]})})}):e.jsx(n,{className:o("transition-all duration-200 hover:shadow-md",g?"bg-gray-800/50 hover:bg-gray-800/70":"bg-white hover:bg-gray-50"),children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("span",{className:o("flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold",g?"bg-blue-600 text-white":"bg-blue-100 text-blue-800"),children:s.session_number}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-foreground",children:s.session_title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.find(e=>e.value===s.session_type)?.label||s.session_type})]}),e.jsx(p,{className:m(s.session_status),children:h(s.session_status)})]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mb-3",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"w-4 h-4"}),(e=>{try{const t=new Date(e);if(isNaN(t.getTime()))return"--";const s=t.getDate(),a=t.getMonth()+1,r=t.getFullYear(),l=s.toString().padStart(2,"0");return`${l}/${a.toString().padStart(2,"0")}/${r}`}catch(t){return console.warn("Error formatting date:",t),"--"}})(s.session_date)]}),s.duration_minutes&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(_,{className:"w-4 h-4"}),s.duration_minutes," دقيقة"]}),s.cost&&s.cost>0&&e.jsxs("div",{className:"font-medium text-green-600",children:["$",s.cost]})]}),s.session_description&&e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:s.session_description}),s.notes&&e.jsxs("div",{className:o("text-xs p-2 rounded border-r-4",g?"bg-gray-700/50 border-gray-600 text-gray-300":"bg-gray-50 border-gray-300 text-gray-600"),children:[e.jsx("strong",{children:"ملاحظات:"})," ",s.notes]})]}),e.jsxs("div",{className:"flex gap-1 ml-4",children:[e.jsx(N,{size:"sm",variant:"ghost",onClick:l,className:"h-8 w-8 p-0",children:e.jsx(Pe,{className:"w-4 h-4"})}),e.jsx(N,{size:"sm",variant:"ghost",onClick:c,className:"h-8 w-8 p-0 text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20",children:e.jsx(Ee,{className:"w-4 h-4"})})]})]})})})}function mt({treatment:s,sessions:a,onAddSession:l,onUpdateSession:c,onDeleteSession:m}){const{isDarkMode:h}=r(),[p,g]=t.useState(!1),[b,j]=t.useState(null),[v,f]=t.useState({tooth_treatment_id:s.id,session_date:(new Date).toISOString().split("T")[0],session_status:"planned",duration_minutes:30}),y=(e=>{switch(e.toLowerCase()){case"علاج العصب":case"endodontic":return at;case"ترميمي/تحفظي":case"restorative":return rt;case"تركيبات":case"prosthetic":return lt;case"جراحي":case"surgical":return nt;case"لثة":case"periodontal":return ot;case"أطفال":case"pediatric":return it;case"تجميلي":case"cosmetic":return dt;default:return[{value:"consultation",label:"استشارة",description:"استشارة وفحص"},{value:"treatment",label:"علاج",description:"جلسة علاج"},{value:"follow_up",label:"متابعة",description:"جلسة متابعة"}]}})(s.treatment_category),w=e=>{switch(e){case"completed":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";case"planned":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";case"cancelled":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200";default:return"bg-gray-100 text-gray-800 dark:bg-card dark:text-gray-200"}},_=e=>{switch(e){case"completed":return"مكتملة";case"planned":return"مخططة";case"cancelled":return"ملغية";default:return e}};return e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["جلسات العلاج (",a.length,")"]}),e.jsxs(N,{onClick:()=>g(!0),size:"sm",className:o("action-btn-sessions sessions-selected","bg-blue-600 hover:bg-blue-700 text-white"),children:[e.jsx(De,{className:"w-4 h-4 ml-2"}),"إضافة جلسة"]})]}),e.jsx("div",{className:"space-y-3",children:a.map(t=>e.jsx(ct,{session:t,isEditing:b===t.id,availableSessionTypes:y,onEdit:()=>j(t.id),onCancelEdit:()=>j(null),onSave:e=>(async(e,t)=>{try{await c(e,t),j(null),Se.success("تم تحديث الجلسة بنجاح")}catch(s){Se.error("فشل في تحديث الجلسة")}})(t.id,e),onDelete:()=>(async e=>{if(window.confirm("هل أنت متأكد من حذف هذه الجلسة؟"))try{await m(e),Se.success("تم حذف الجلسة بنجاح")}catch(t){Se.error("فشل في حذف الجلسة")}})(t.id),getStatusBadgeColor:w,getStatusText:_,isDarkMode:h},t.id))}),p&&e.jsxs(n,{className:o("border-2 border-dashed transition-all duration-200",h?"border-blue-600 bg-gray-800/50":"border-blue-300 bg-blue-50/50"),children:[e.jsx(i,{children:e.jsx(d,{className:"text-lg text-foreground",children:"إضافة جلسة جديدة"})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(x,{htmlFor:"session_type",children:"نوع الجلسة *"}),e.jsxs(T,{value:v.session_type||"",onValueChange:e=>{const t=y.find(t=>t.value===e);f(s=>({...s,session_type:e,session_title:t?.label||""}))},children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر نوع الجلسة"})}),e.jsx(I,{children:y.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.label}),t.description&&e.jsx("div",{className:"text-sm text-muted-foreground",children:t.description})]})},t.value))})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"session_title",children:"عنوان الجلسة *"}),e.jsx($,{id:"session_title",value:v.session_title||"",onChange:e=>f(t=>({...t,session_title:e.target.value})),placeholder:"عنوان الجلسة"})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"session_date",children:"تاريخ الجلسة *"}),e.jsx($,{id:"session_date",type:"date",value:v.session_date||"",onChange:e=>f(t=>({...t,session_date:e.target.value}))})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"duration_minutes",children:"مدة الجلسة (دقيقة)"}),e.jsx($,{id:"duration_minutes",type:"number",value:v.duration_minutes||30,onChange:e=>f(t=>({...t,duration_minutes:parseInt(e.target.value)||30})),placeholder:"30"})]})]}),e.jsxs("div",{children:[e.jsx(x,{htmlFor:"session_description",children:"وصف الجلسة"}),e.jsx(B,{id:"session_description",value:v.session_description||"",onChange:e=>f(t=>({...t,session_description:e.target.value})),placeholder:"وصف ما تم عمله في الجلسة...",rows:3})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(N,{variant:"outline",onClick:()=>{g(!1),f({tooth_treatment_id:s.id,session_date:(new Date).toISOString().split("T")[0],session_status:"planned",duration_minutes:30})},children:[e.jsx(S,{className:"w-4 h-4 ml-2"}),"إلغاء"]}),e.jsxs(N,{onClick:async()=>{if(v.session_type&&v.session_title&&v.session_date)try{await l(v),f({tooth_treatment_id:s.id,session_date:(new Date).toISOString().split("T")[0],session_status:"planned",duration_minutes:30,cost:0}),g(!1),Se.success("تم إضافة الجلسة بنجاح")}catch(e){Se.error("فشل في إضافة الجلسة")}else Se.error("يرجى ملء جميع الحقول المطلوبة")},children:[e.jsx(Ce,{className:"w-4 h-4 ml-2"}),"حفظ الجلسة"]})]})]})]}),0===a.length&&!p&&e.jsx(n,{className:o("text-center py-8",h?"bg-gray-800/50":"bg-gray-50"),children:e.jsxs(u,{children:[e.jsx(L,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"لا توجد جلسات مسجلة لهذا العلاج"}),e.jsxs(N,{onClick:()=>g(!0),className:"mt-4 action-btn-sessions sessions-outline",variant:"outline",children:[e.jsx(De,{className:"w-4 h-4 ml-2"}),"إضافة أول جلسة"]})]})})]})}function xt({patientId:s,toothNumber:a,toothName:l,treatments:c,onAddTreatment:g,onUpdateTreatment:b,onDeleteTreatment:j,onReorderTreatments:v,onSessionStatsUpdate:f,onTreatmentUpdate:y}){const{isDarkMode:se}=r(),{createPayment:ae,updatePayment:re,getPaymentsByPatient:le}=F(),{patients:ne}=U(),{labs:oe,loadLabs:ie}=$e(),{createLabOrder:de,updateLabOrder:ce,deleteLabOrder:me,getLabOrdersByTreatment:xe}=Be(),[ue,he]=t.useState(!1),[pe,ge]=t.useState(null),[be,je]=t.useState(""),[ve,fe]=t.useState(!1),[Ne,ye]=t.useState(null),[we,_e]=t.useState(""),[ke,Ie]=t.useState(0);t.useState(""),t.useState(0);const[Ue,Ae]=t.useState({patient_id:s,tooth_number:a,tooth_name:l,treatment_status:"planned",cost:0,start_date:(new Date).toISOString().split("T")[0]}),[ze,Oe]=t.useState({}),[Ge,Me]=t.useState(null),Ve=e=>{const t="number"==typeof e?e.toString():e;if(!t)return"";const s=t.replace(/,/g,"");if(isNaN(Number(s)))return t;const a=s.split(".");return a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),a.join(".")},Re=e=>e.replace(/,/g,"");t.useEffect(()=>{ie()},[ie]);const Ke=[...c].sort((e,t)=>e.priority-t.priority),He=t=>{switch(t){case"planned":return e.jsx(_,{className:"w-4 h-4 text-blue-500"});case"in_progress":return e.jsx(tt,{className:"w-4 h-4 text-yellow-500"});case"completed":return e.jsx(w,{className:"w-4 h-4 text-green-500"});case"cancelled":return e.jsx(Te,{className:"w-4 h-4 text-gray-500"});default:return e.jsx(te,{className:"w-4 h-4 text-gray-400"})}},qe=e=>{const t=C.find(t=>t.value===e);return t?.color||"#6b7280"},Ze=async(e,t)=>{try{console.log("🦷 MultipleToothTreatments: Updating treatment:",e,t),await b(e,t),console.log("🦷 MultipleToothTreatments: onUpdateTreatment completed"),ge(null),y?.(),console.log("🦷 MultipleToothTreatments: Treatment updated successfully"),Se.success("تم تحديث العلاج بنجاح")}catch(s){console.error("🦷 MultipleToothTreatments: Error updating treatment:",s),s&&"object"==typeof s&&"message"in s&&console.error("🦷 MultipleToothTreatments: Error message:",s.message),Se.error("فشل في تحديث العلاج")}},Je=be?A(be):z,Ye=(e=>{if("التعويضات"!==be)return e;return{groups:{crowns:e.filter(e=>e.value.includes("crown")&&!e.value.includes("implant")),bridges:e.filter(e=>e.value.includes("bridge")),dentures:e.filter(e=>e.value.includes("denture")),implants:e.filter(e=>e.value.includes("implant")),posts:e.filter(e=>e.value.includes("post")||e.value.includes("core")),veneers:e.filter(e=>e.value.includes("veneer"))},isGrouped:!0}})(Je),We=async e=>{try{const t=await window.electronAPI.treatmentSessions.getByTreatment(e);Oe(s=>({...s,[e]:t}))}catch(t){console.error("Error loading treatment sessions:",t),Se.error("فشل في تحميل جلسات العلاج")}};return t.useEffect(()=>{Ge&&We(Ge)},[Ge]),e.jsxs("div",{className:"space-y-4",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-semibold",children:["علاجات السن رقم ",a]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l})]}),e.jsxs(N,{onClick:()=>he(!0),className:"bg-blue-600 hover:bg-blue-700",size:"sm",children:[e.jsx(De,{className:"w-4 h-4 ml-2"}),"إضافة علاج"]})]}),e.jsx("div",{className:"space-y-3",children:0===Ke.length?e.jsx(n,{children:e.jsx(u,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"لا توجد علاجات مسجلة لهذا السن"})})}):Ke.map((t,s)=>e.jsxs(n,{className:"relative",children:[e.jsx(i,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm font-medium text-muted-foreground",children:["#",t.priority]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>(async e=>{if(0===e)return;const t=[...Ke],s=t[e];t[e]=t[e-1],t[e-1]=s;const a=t.map(e=>e.id);await v(a)})(s),disabled:0===s,className:"h-6 w-6 p-0",children:e.jsx(Le,{className:"w-3 h-3"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>(async e=>{if(e===Ke.length-1)return;const t=[...Ke],s=t[e];t[e]=t[e+1],t[e+1]=s;const a=t.map(e=>e.id);await v(a)})(s),disabled:s===Ke.length-1,className:"h-6 w-6 p-0",children:e.jsx(Fe,{className:"w-3 h-3"})})]})]}),e.jsx("div",{className:"w-4 h-4 rounded-full border-2 border-white",style:{backgroundColor:t.treatment_color}}),e.jsxs("div",{children:[e.jsx(d,{className:"text-base",children:k(t.treatment_type)?.label||t.treatment_type}),e.jsx(m,{children:O(t.treatment_category)?.label})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"secondary",style:{backgroundColor:qe(t.treatment_status)+"20",color:qe(t.treatment_status)},children:[He(t.treatment_status),e.jsx("span",{className:"mr-1",children:C.find(e=>e.value===t.treatment_status)?.label})]}),e.jsxs(N,{variant:Ge===t.id?"default":"outline",size:"sm",onClick:()=>Me(Ge===t.id?null:t.id),className:o("action-btn-sessions gap-1.5",Ge===t.id?"sessions-selected bg-blue-600 hover:bg-blue-700 text-white shadow-md":"sessions-outline border-blue-200 text-blue-700 dark:border-blue-700 dark:text-blue-300"),title:"إدارة جلسات العلاج",children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{className:"text-xs font-medium",children:"الجلسات"})]}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>ge(t.id),children:e.jsx(Pe,{className:"w-4 h-4"})}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>(async e=>{ye(e),fe(!0)})(t.id),className:"text-red-600 hover:text-red-700",children:e.jsx(Ee,{className:"w-4 h-4"})})]})]})}),e.jsxs(u,{className:"pt-0",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[t.cost&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-4 h-4 text-muted-foreground"}),e.jsxs("span",{children:["$",t.cost]})]}),t.start_date&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{children:M(t.start_date)})]}),t.completion_date&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(w,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{children:M(t.completion_date)})]})]}),t.notes&&e.jsx("p",{className:"text-sm text-muted-foreground mt-2 p-2 bg-muted rounded",children:t.notes})]})]},t.id))}),pe&&e.jsxs(n,{className:o("border-2 shadow-lg !border-solid",se?"!border-orange-800/50 bg-orange-950/20 shadow-orange-900/20":"!border-orange-200 bg-orange-50/50 shadow-orange-100/50"),children:[e.jsx(i,{className:o("border-b",se?"border-orange-800/30":"border-orange-200/50"),children:e.jsx(d,{className:o("text-lg",se?"text-orange-200":"text-orange-900"),children:"تعديل العلاج"})}),e.jsx(u,{className:"space-y-4",children:(()=>{const t=c.find(e=>e.id===pe);return t?e.jsx(ut,{treatment:t,onSave:Ze,onCancel:()=>ge(null)}):null})()})]}),Ge&&e.jsxs(n,{className:o("border-2 shadow-lg",se?"border-blue-800/50 bg-blue-950/20 shadow-blue-900/20":"border-blue-200 bg-blue-50/50 shadow-blue-100/50"),children:[e.jsxs(i,{className:o("border-b",se?"border-blue-800/30":"border-blue-200/50"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(d,{className:o("text-lg",se?"text-blue-200":"text-blue-900"),children:"إدارة جلسات العلاج"}),e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>Me(null),children:e.jsx(S,{className:"w-4 h-4"})})]}),e.jsx(m,{children:(()=>{const e=c.find(e=>e.id===Ge);return e?`${k(e.treatment_type)?.label||e.treatment_type}`:""})()})]}),e.jsx(u,{className:"p-6",children:(()=>{const t=c.find(e=>e.id===Ge);return t?e.jsx(mt,{treatment:t,sessions:ze[Ge]||[],onAddSession:e=>(async(e,t)=>{try{await window.electronAPI.treatmentSessions.create(t),await We(e),f?.(),Se.success("تم إضافة الجلسة بنجاح")}catch(s){console.error("Error adding session:",s),Se.error("فشل في إضافة الجلسة")}})(Ge,e),onUpdateSession:(e,t)=>(async(e,t,s)=>{try{await window.electronAPI.treatmentSessions.update(t,s),await We(e),f?.(),Se.success("تم تحديث الجلسة بنجاح")}catch(a){console.error("Error updating session:",a),Se.error("فشل في تحديث الجلسة")}})(Ge,e,t),onDeleteSession:e=>(async(e,t)=>{try{await window.electronAPI.treatmentSessions.delete(t),await We(e),f?.(),Se.success("تم حذف الجلسة بنجاح")}catch(s){console.error("Error deleting session:",s),Se.error("فشل في حذف الجلسة")}})(Ge,e)}):null})()})]}),ue&&e.jsxs(n,{className:o("border-2 shadow-lg",se?"border-blue-800/50 bg-blue-950/20 shadow-blue-900/20":"border-blue-200 bg-blue-50/50 shadow-blue-100/50"),children:[e.jsx(i,{className:o("border-b",se?"border-blue-800/30":"border-blue-200/50"),children:e.jsx(d,{className:o("text-lg",se?"text-blue-200":"text-blue-900"),children:"إضافة علاج جديد"})}),e.jsxs(u,{className:o("space-y-4 p-6",se?"bg-blue-950/10":"bg-blue-50/30"),children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",se?"text-blue-200":"text-blue-800"),children:"تصنيف العلاج"}),e.jsxs(T,{value:be,onValueChange:e=>{je(e),Ae(t=>({...t,treatment_category:e}))},children:[e.jsx(P,{className:o("border-2 transition-colors",se?"border-blue-800/50 bg-blue-950/30 hover:border-blue-700 focus:border-blue-600":"border-blue-200 bg-white hover:border-blue-300 focus:border-blue-500"),children:e.jsx(E,{placeholder:"اختر التصنيف"})}),e.jsx(I,{children:h.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.icon}),e.jsx("span",{children:t.label})]})},t.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",se?"text-blue-200":"text-blue-800"),children:"نوع العلاج"}),e.jsxs(T,{value:Ue.treatment_type||"",onValueChange:e=>Ae(t=>({...t,treatment_type:e})),disabled:!be,children:[e.jsx(P,{className:o("border-2 transition-colors",!be&&"opacity-50 cursor-not-allowed",se?"border-blue-800/50 bg-blue-950/30 hover:border-blue-700 focus:border-blue-600":"border-blue-200 bg-white hover:border-blue-300 focus:border-blue-500"),children:e.jsx(E,{placeholder:"اختر نوع العلاج"})}),e.jsx(I,{className:"max-h-80",children:"التعويضات"===be&&Ye.isGrouped?e.jsxs(e.Fragment,{children:[Ye.groups.crowns.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-purple-600 dark:text-purple-400",children:"👑 التيجان"}),Ye.groups.crowns.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),Ye.groups.bridges.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-orange-600 dark:text-orange-400",children:"🌉 الجسور"}),Ye.groups.bridges.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),Ye.groups.dentures.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-blue-600 dark:text-blue-400",children:"🦷 الأجهزة المتحركة"}),Ye.groups.dentures.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),Ye.groups.implants.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-green-600 dark:text-green-400",children:"🔩 تعويضات الزرعات"}),Ye.groups.implants.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),Ye.groups.posts.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-gray-600 dark:text-gray-400",children:"🔧 القلوب والأوتاد"}),Ye.groups.posts.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),Ye.groups.veneers.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-pink-600 dark:text-pink-400",children:"✨ الفينير"}),Ye.groups.veneers.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value))]})]}):Je.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",se?"text-blue-200":"text-blue-800"),children:"حالة العلاج"}),e.jsxs(T,{value:Ue.treatment_status||"planned",onValueChange:e=>{Ae(t=>({...t,treatment_status:e})),"undefined"!=typeof window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("tooth-color-update",{detail:{type:"status-preview-new",newStatus:e,timestamp:Date.now()}}))},children:[e.jsx(P,{className:o("border-2 transition-colors",se?"border-blue-800/50 bg-blue-950/30 hover:border-blue-700 focus:border-blue-600":"border-blue-200 bg-white hover:border-blue-300 focus:border-blue-500"),children:e.jsx(E,{})}),e.jsx(I,{children:C.map(t=>e.jsx(D,{value:t.value,children:t.label},t.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",se?"text-blue-200":"text-blue-800"),children:"التكلفة ($)"}),e.jsx($,{type:"text",value:Ve((Ue.cost||0).toString()),onChange:e=>{const t=Re(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&Ae(e=>({...e,cost:""===t?0:parseFloat(t)||0}))},onBlur:e=>{const t=Re(e.target.value),s=parseFloat(t)||0;Ae(e=>({...e,cost:s}))},placeholder:"0.00",className:o("border-2 transition-colors",se?"border-blue-800/50 bg-blue-950/30 hover:border-blue-700 focus:border-blue-600":"border-blue-200 bg-white hover:border-blue-300 focus:border-blue-500")}),Ue.cost&&Ue.cost>0&&e.jsx("p",{className:o("text-xs",se?"text-blue-300":"text-blue-600"),children:"💡 سيتم إنشاء دفعة آجلة في جدول المدفوعات"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",se?"text-blue-200":"text-blue-800"),children:"تاريخ العلاج"}),e.jsx($,{type:"date",value:Ue.start_date||"",onChange:e=>Ae(t=>({...t,start_date:e.target.value})),className:o("border-2 transition-colors",se?"border-blue-800/50 bg-blue-950/30 hover:border-blue-700 focus:border-blue-600":"border-blue-200 bg-white hover:border-blue-300 focus:border-blue-500")})]})]}),"التعويضات"===be&&e.jsxs("div",{className:o("grid grid-cols-1 md:grid-cols-2 gap-4 p-5 rounded-xl border-2 shadow-sm transition-all duration-200",se?"bg-gradient-to-br from-purple-950/40 to-purple-900/30 border-purple-700/50 shadow-purple-900/20":"bg-gradient-to-br from-purple-50 to-purple-100/60 border-purple-300/70 shadow-purple-200/30"),children:[e.jsx("div",{className:"md:col-span-2 mb-3",children:e.jsxs("div",{className:o("flex items-center gap-3 text-sm font-semibold",se?"text-purple-200":"text-purple-800"),children:[e.jsx("div",{className:o("w-8 h-8 rounded-lg flex items-center justify-center text-lg",se?"bg-purple-800/50 text-purple-200":"bg-purple-200/80 text-purple-800"),children:"🏭"}),e.jsx("span",{children:"إعدادات المخبر"})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:o("font-medium flex items-center gap-2 text-sm",se?"text-purple-100":"text-purple-900"),children:"🏭 اختيار المخبر"}),e.jsxs(T,{value:we,onValueChange:_e,children:[e.jsx(P,{className:o("border-2 transition-all duration-200 h-11",se?"border-purple-700/50 bg-purple-950/40 hover:border-purple-600 focus:border-purple-500 text-purple-100":"border-purple-300/70 bg-white hover:border-purple-400 focus:border-purple-500 text-purple-900"),children:e.jsx(E,{placeholder:"اختر المخبر"})}),e.jsx(I,{className:o(se?"bg-purple-950 border-purple-700":"bg-white border-purple-200"),children:oe.map(t=>e.jsx(D,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"🏭"}),e.jsx("span",{children:t.name})]})},t.id))})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:o("font-medium flex items-center gap-2 text-sm",se?"text-purple-100":"text-purple-900"),children:"💰 تكلفة المخبر ($)"}),e.jsx($,{type:"text",value:Ve(ke.toString()),onChange:e=>{const t=Re(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&Ie(""===t?0:parseFloat(t)||0)},onBlur:e=>{const t=Re(e.target.value),s=parseFloat(t)||0;Ie(s)},placeholder:"0.00",className:o("border-2 transition-all duration-200 h-11",se?"border-purple-700/50 bg-purple-950/40 hover:border-purple-600 focus:border-purple-500 text-purple-100 placeholder:text-purple-400":"border-purple-300/70 bg-white hover:border-purple-400 focus:border-purple-500 text-purple-900 placeholder:text-purple-500")}),ke>0&&e.jsxs("div",{className:o("flex items-center gap-2 p-2 rounded-lg text-xs",se?"bg-purple-900/30 text-purple-200 border border-purple-700/30":"bg-purple-100/60 text-purple-700 border border-purple-200/50"),children:[e.jsx("span",{className:"text-sm",children:"🏭"}),e.jsx("span",{children:"سيتم إنشاء طلب مخبر تلقائياً"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",se?"text-blue-200":"text-blue-800"),children:"ملاحظات"}),e.jsx(B,{value:Ue.notes||"",onChange:e=>Ae(t=>({...t,notes:e.target.value})),placeholder:"أدخل أي ملاحظات إضافية...",rows:3,className:o("border-2 transition-colors resize-none",se?"border-blue-800/50 bg-blue-950/30 hover:border-blue-700 focus:border-blue-600":"border-blue-200 bg-white hover:border-blue-300 focus:border-blue-500")})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-blue-200/50 dark:border-blue-800/30",children:[e.jsxs(N,{variant:"outline",onClick:()=>{he(!1),je(""),Ae({patient_id:s,tooth_number:a,tooth_name:l,treatment_status:"planned",cost:0,start_date:(new Date).toISOString().split("T")[0]})},className:o("border-2 transition-all duration-200",se?"border-gray-600 text-gray-300 hover:border-gray-500 hover:bg-gray-800":"border-gray-300 text-gray-700 hover:border-gray-400 hover:bg-gray-50"),children:[e.jsx(S,{className:"w-4 h-4 ml-2"}),"إلغاء"]}),e.jsxs(N,{onClick:async()=>{if(!Ue.treatment_type||!Ue.treatment_category)return void Se.error("يرجى اختيار نوع العلاج والتصنيف");if("التعويضات"===Ue.treatment_category&&ke>0&&!we)return void Se.error("يرجى اختيار المختبر عند إدخال تكلفة المختبر للتعويضات");let e=null;try{console.log("🚀 [DEBUG] Starting treatment creation process:",{treatmentType:Ue.treatment_type,category:Ue.treatment_category,cost:Ue.cost,isProsthetic:"التعويضات"===Ue.treatment_category,hasLabData:!!we&&ke>0});const n={...Ue,treatment_color:k(Ue.treatment_type)?.color||"#22c55e"},o=await g(n);if(!o)throw new Error("فشل في إنشاء العلاج");if(e=o.id,console.log("✅ [DEBUG] Treatment created successfully:",e),Ue.cost&&Ue.cost>0){console.log("💰 [DEBUG] Creating payment for treatment:",e);try{await(async e=>{if(console.log("💰 [DEBUG] createPendingPaymentForTreatment called:",{treatmentId:e,cost:Ue.cost,patientId:s}),!e)throw console.error("❌ [DEBUG] Cannot create payment - missing treatment ID"),new Error("معرف العلاج مطلوب لإنشاء الدفعة");if(!Ue.cost||Ue.cost<=0)console.log("⚠️ [DEBUG] Skipping payment creation - no cost specified");else try{const t=ne.find(e=>e.id===s);if(!t)throw new Error("لم يتم العثور على بيانات المريض");const r=k(Ue.treatment_type),n=`علاج ${r?.label||Ue.treatment_type} - سن ${l||a}`,o={patient_id:s,tooth_treatment_id:e,amount:0,payment_method:"cash",payment_date:(new Date).toISOString().split("T")[0],description:n,status:"pending",notes:`دفعة آجلة للمريض: ${t.full_name} - السن: ${l} - العلاج: ${r?.label||Ue.treatment_type}`,total_amount_due:Ue.cost,amount_paid:0,remaining_balance:Ue.cost,treatment_total_cost:Ue.cost,treatment_total_paid:0,treatment_remaining_balance:Ue.cost};console.log("💰 [DEBUG] Creating payment with data:",o),await ae(o),console.log("✅ [DEBUG] Payment created successfully for treatment:",e),Se.success("تم إنشاء دفعة آجلة في جدول المدفوعات")}catch(t){console.error("❌ [DEBUG] Payment creation failed:",t);const e=t instanceof Error?t.message:"خطأ غير معروف";throw Se.error(`فشل في إنشاء الدفعة الآجلة: ${e}`),t}})(e),console.log("✅ [DEBUG] Payment created successfully for treatment:",e)}catch(t){console.error("❌ [DEBUG] Payment creation failed:",t),Se.warning("تم إنشاء العلاج ولكن فشل في إنشاء الدفعة")}}if("التعويضات"===Ue.treatment_category&&we&&ke>0)try{await(async e=>{if(!e)throw new Error("معرف العلاج مطلوب لإنشاء طلب المختبر");if(we&&!(ke<=0))try{const t=ne.find(e=>e.id===s),r=k(Ue.treatment_type);if(!t)throw new Error("لم يتم العثور على بيانات المريض");const n={lab_id:we,patient_id:s,tooth_treatment_id:e,tooth_number:a,service_name:`${r?.label||"علاج تعويضات"} - السن ${a}`,cost:ke,order_date:(new Date).toISOString().split("T")[0],status:"آجل",notes:`طلب مخبر للمريض: ${t.full_name} - السن: ${l} - العلاج: ${r?.label||Ue.treatment_type}`,paid_amount:0,remaining_balance:ke};await de(n),xe(e).length>0?Se.success("تم إنشاء طلب المختبر وربطه بالعلاج بنجاح"):Se.warning("تم إنشاء طلب المختبر ولكن قد تحتاج لإعادة تحميل الصفحة للتحقق من الربط")}catch(t){console.error("❌ [DEBUG] Lab order creation failed:",t);const e=t instanceof Error?t.message:"خطأ غير معروف";throw Se.error(`فشل في إنشاء طلب المختبر: ${e}`),t}})(e)}catch(r){Se.warning("تم إنشاء العلاج والدفعة ولكن فشل في إنشاء طلب المختبر")}Ae({patient_id:s,tooth_number:a,tooth_name:l,treatment_status:"planned",cost:0,start_date:(new Date).toISOString().split("T")[0]}),je(""),_e(""),Ie(0),he(!1),Se.success("تم إضافة العلاج بنجاح مع جميع المكونات المطلوبة")}catch(n){Se.error("فشل في إضافة العلاج - يرجى المحاولة مرة أخرى")}},className:o("transition-all duration-200 shadow-lg",se?"bg-blue-600 hover:bg-blue-700 text-white shadow-blue-900/30":"bg-blue-600 hover:bg-blue-700 text-white shadow-blue-500/30"),children:[e.jsx(Ce,{className:"w-4 h-4 ml-2"}),"حفظ العلاج"]})]})]})]}),e.jsx(H,{open:ve,onOpenChange:fe,children:e.jsxs(q,{className:"max-w-md",dir:"rtl",children:[e.jsx(Z,{children:e.jsxs("div",{className:"flex items-center space-x-3 space-x-reverse",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(J,{className:"w-8 h-8 text-destructive"})}),e.jsxs("div",{children:[e.jsx(Y,{children:"هل أنت متأكد من حذف هذا العلاج؟"}),e.jsx(W,{children:"هذا الإجراء لا يمكن التراجع عنه. سيتم حذف العلاج وجميع البيانات المرتبطة به نهائياً."})]})]})}),Ne&&(()=>{const t=c.find(e=>e.id===Ne);return t?e.jsxs("div",{className:"my-4",children:[e.jsxs("div",{className:"bg-muted/50 border border-border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(Ee,{className:"w-5 h-5 text-destructive"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-foreground",children:k(t.treatment_type)?.label||t.treatment_type}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["السن: ",l," (#",a,")"]})]})]}),t.notes&&e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsx("strong",{children:"الملاحظات:"})," ",t.notes]})]}),e.jsx("div",{className:"bg-destructive/10 border border-destructive/20 rounded-lg p-4 mt-4",children:e.jsxs("div",{className:"flex",children:[e.jsx(J,{className:"w-5 h-5 text-destructive mt-0.5 ml-2"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-destructive",children:"تحذير مهم"}),e.jsx("p",{className:"text-sm text-destructive/80 mt-1",children:"سيتم حذف جميع البيانات المرتبطة بهذا العلاج بما في ذلك:"}),e.jsxs("ul",{className:"text-sm text-destructive/80 mt-2 list-disc list-inside",children:[e.jsx("li",{children:"جلسات العلاج المسجلة"}),e.jsx("li",{children:"المدفوعات المرتبطة"}),e.jsx("li",{children:"طلبات المختبر (إن وجدت)"}),e.jsx("li",{children:"الصور والملفات المرفقة"})]})]})]})})]}):null})(),e.jsxs(Q,{className:"flex justify-end space-x-3 space-x-reverse",children:[e.jsx(X,{children:"إلغاء"}),e.jsxs(ee,{onClick:async()=>{if(Ne)try{await j(Ne),Se.success("تم حذف العلاج بنجاح"),fe(!1),ye(null)}catch(e){Se.error("فشل في حذف العلاج")}},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:[e.jsx(Ee,{className:"w-4 h-4 ml-2"}),"تأكيد الحذف"]})]})]})})]})}function ut({treatment:s,onSave:a,onCancel:l}){const{isDarkMode:n}=r(),{createPayment:i,updatePayment:d,getPaymentsByPatient:c}=F(),{patients:m}=U(),{labs:u,loadLabs:p}=$e(),{createLabOrder:g,getLabOrdersByTreatment:b,updateLabOrder:j,deleteLabOrder:v,loadLabOrders:f}=Be(),[y,w]=t.useState({treatment_type:s.treatment_type,treatment_category:s.treatment_category,treatment_status:s.treatment_status,cost:s.cost,start_date:s.start_date,completion_date:s.completion_date,notes:s.notes}),[_,L]=t.useState(s.treatment_category||""),[z]=t.useState(s.cost||0),[O,G]=t.useState(""),[M,H]=t.useState(0),[q,Z]=t.useState(!1);t.useState(!1);const J=e=>{const t="number"==typeof e?e.toString():e;if(!t)return"";const s=t.replace(/,/g,"");if(isNaN(Number(s)))return t;const a=s.split(".");return a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),a.join(".")},Y=e=>e.replace(/,/g,""),W=async e=>{try{const a=await(window.electronAPI?.labOrders?.getAll())||[],r=a.find(t=>t.tooth_treatment_id===e);if(r)return r;const l=a.find(e=>!e.tooth_treatment_id&&e.patient_id===s.patient_id);if(l)try{return await j(l.id,{tooth_treatment_id:e,tooth_number:s.tooth_number}),{...l,tooth_treatment_id:e}}catch(t){return l}return null}catch(a){return null}},Q=async()=>{if("التعويضات"===s.treatment_category){const e=await W(s.id);e?(G(e.lab_id||""),H(e.cost||0),Se.success("تم إعادة تحميل بيانات المختبر")):(G(""),H(0),Se.info("لا يوجد طلب مختبر لهذا العلاج"))}else Se.info("هذا العلاج ليس من فئة التعويضات")};t.useEffect(()=>{(async()=>{try{if(Z(!1),await p(),L(s.treatment_category||""),"التعويضات"===s.treatment_category){const e=await W(s.id);e?(G(e.lab_id||""),H(e.cost||0)):(G(""),H(0))}else G(""),H(0);Z(!0)}catch(e){G(""),H(0),Z(!0)}})()},[s.id,s.treatment_category,p]),t.useEffect(()=>{"التعويضات"!==_&&(G(""),H(0))},[_]),t.useEffect(()=>{console.log("🔍 Lab values changed:",{selectedLab:O,labCost:M,isLabDataLoaded:q,treatmentId:s.id,category:s.treatment_category})},[O,M,q,s.id,s.treatment_category]);const X=_?A(_):[],ee=(e=>{if("التعويضات"!==_)return e;return{groups:{crowns:e.filter(e=>e.value.includes("crown")&&!e.value.includes("implant")),bridges:e.filter(e=>e.value.includes("bridge")),dentures:e.filter(e=>e.value.includes("denture")),implants:e.filter(e=>e.value.includes("implant")),posts:e.filter(e=>e.value.includes("post")||e.value.includes("core")),veneers:e.filter(e=>e.value.includes("veneer"))},isGrouped:!0}})(X);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"تصنيف العلاج"}),e.jsxs(T,{value:_,onValueChange:e=>{L(e),w(t=>({...t,treatment_category:e}))},children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر التصنيف"})}),e.jsx(I,{children:h.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.icon}),e.jsx("span",{children:t.label})]})},t.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"نوع العلاج"}),e.jsxs(T,{value:y.treatment_type||"",onValueChange:e=>w(t=>({...t,treatment_type:e})),disabled:!_,children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر نوع العلاج"})}),e.jsx(I,{className:"max-h-80",children:"التعويضات"===_&&ee.isGrouped?e.jsxs(e.Fragment,{children:[ee.groups.crowns.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-purple-600 dark:text-purple-400",children:"👑 التيجان"}),ee.groups.crowns.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),ee.groups.bridges.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-orange-600 dark:text-orange-400",children:"🌉 الجسور"}),ee.groups.bridges.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),ee.groups.dentures.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-blue-600 dark:text-blue-400",children:"🦷 الأجهزة المتحركة"}),ee.groups.dentures.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),ee.groups.implants.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-green-600 dark:text-green-400",children:"🔩 تعويضات الزرعات"}),ee.groups.implants.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),ee.groups.posts.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-gray-600 dark:text-gray-400",children:"🔧 القلوب والأوتاد"}),ee.groups.posts.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value)),e.jsx(K,{})]}),ee.groups.veneers.length>0&&e.jsxs(V,{children:[e.jsx(R,{className:"flex items-center gap-2 text-pink-600 dark:text-pink-400",children:"✨ الفينير"}),ee.groups.veneers.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value))]})]}):X.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"حالة العلاج"}),e.jsxs(T,{value:y.treatment_status||"planned",onValueChange:e=>{w(t=>({...t,treatment_status:e,completion_date:"completed"!==e||t.completion_date?t.completion_date:(new Date).toISOString().split("T")[0]})),"undefined"!=typeof window&&window.dispatchEvent&&window.dispatchEvent(new CustomEvent("tooth-color-update",{detail:{type:"status-preview",treatmentId:s.id,newStatus:e,timestamp:Date.now()}}))},children:[e.jsx(P,{children:e.jsx(E,{})}),e.jsx(I,{children:C.map(t=>e.jsx(D,{value:t.value,children:t.label},t.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{className:o("font-medium",n?"text-orange-200":"text-orange-800"),children:"التكلفة ($)"}),e.jsx($,{type:"text",value:J((y.cost||0).toString()),onChange:e=>{e.stopPropagation();const t=Y(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&w(e=>({...e,cost:""===t?0:parseFloat(t)||0}))},onBlur:e=>{e.stopPropagation();const t=Y(e.target.value),s=parseFloat(t)||0;w(e=>({...e,cost:s}))},onInput:e=>{e.stopPropagation(),e.nativeEvent&&e.nativeEvent.stopImmediatePropagation&&e.nativeEvent.stopImmediatePropagation()},onKeyDown:e=>{if("Escape"===e.key)return e.preventDefault(),void w(e=>({...e,cost:0}));["Backspace","Delete","Tab","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End","."].includes(e.key)||e.key>="0"&&e.key<="9"||e.ctrlKey&&["a","c","v","x","z"].includes(e.key.toLowerCase())||e.preventDefault()},onFocus:e=>{e.stopPropagation()},onClick:e=>{e.stopPropagation()},placeholder:"0.00","data-prevent-shortcuts":"true",className:o("border-2 transition-colors",n?"border-orange-800/50 bg-orange-950/30 hover:border-orange-700 focus:border-orange-600":"border-orange-200 bg-white hover:border-orange-300 focus:border-orange-500")}),y.cost&&y.cost>0&&y.cost!==z&&e.jsx("p",{className:o("text-xs",n?"text-orange-300":"text-orange-600"),children:"💡 سيتم إنشاء دفعة آجلة عند تعديل التكلفة"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"تاريخ العلاج"}),e.jsx($,{type:"date",value:y.start_date||"",onChange:e=>w(t=>({...t,start_date:e.target.value})),onKeyDown:e=>{if(e.stopPropagation(),"Escape"===e.key)return e.preventDefault(),void e.stopPropagation()},onFocus:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),"data-prevent-shortcuts":"true"})]})]}),("التعويضات"===_||"التعويضات"===s.treatment_category)&&e.jsxs("div",{className:o("grid grid-cols-1 md:grid-cols-2 gap-4 p-5 rounded-xl border-2 shadow-sm transition-all duration-200",n?"bg-gradient-to-br from-purple-950/30 to-purple-900/20 border-purple-700/40 shadow-purple-900/10":"bg-gradient-to-br from-purple-50 to-purple-100/50 border-purple-300/60 shadow-purple-200/20"),children:[e.jsx("div",{className:"md:col-span-2 mb-2",children:e.jsxs("div",{className:o("flex items-center gap-3 text-sm font-semibold",n?"text-purple-200":"text-purple-800"),children:[e.jsx("div",{className:o("w-8 h-8 rounded-lg flex items-center justify-center text-lg",n?"bg-purple-800/40 text-purple-200":"bg-purple-200/60 text-purple-700"),children:"🏭"}),e.jsx("span",{children:"معلومات المخبر"}),e.jsx("button",{type:"button",onClick:Q,className:o("text-xs px-2 py-1 rounded hover:scale-105 transition-all",n?"bg-purple-700/50 text-purple-200 hover:bg-purple-600/50":"bg-purple-200 text-purple-700 hover:bg-purple-300"),title:"إعادة تحميل بيانات المخبر وربط الطلبات غير المرتبطة",children:"🔄"}),e.jsx("button",{type:"button",onClick:async()=>{await linkUnlinkedLabOrder(s.id)?await Q():Se.info("لا توجد طلبات مخبر غير مرتبطة لهذا المريض")},className:o("text-xs px-2 py-1 rounded hover:scale-105 transition-all",n?"bg-blue-700/50 text-blue-200 hover:bg-blue-600/50":"bg-blue-200 text-blue-700 hover:bg-blue-300"),title:"ربط طلبات المخبر غير المرتبطة",children:"🔗"}),e.jsx("div",{className:o("h-px flex-1 ml-2",n?"bg-purple-700/30":"bg-purple-300/50")})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(x,{className:o("font-medium flex items-center gap-2 text-sm",n?"text-purple-100":"text-purple-900"),children:["🏭 اختيار المخبر",!q&&e.jsx("span",{className:"text-xs animate-pulse",children:"⏳ جاري التحميل..."})]}),e.jsxs(T,{value:O,onValueChange:G,children:[e.jsx(P,{className:o("border-2 transition-all duration-200 h-11",n?"border-purple-700/50 bg-purple-950/40 hover:border-purple-600 focus:border-purple-500 text-purple-100":"border-purple-300/70 bg-white hover:border-purple-400 focus:border-purple-500 text-purple-900"),children:e.jsx(E,{placeholder:"اختر المخبر"})}),e.jsx(I,{className:o(n?"bg-purple-950 border-purple-700":"bg-white border-purple-200"),children:u.map(t=>e.jsx(D,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:"🏭"}),e.jsx("span",{children:t.name})]})},t.id))})]},`lab-select-${s.id}-${O}`)]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(x,{className:o("font-medium flex items-center gap-2 text-sm",n?"text-purple-100":"text-purple-900"),children:"💰 تكلفة المخبر ($)"}),e.jsx($,{type:"text",value:J(M.toString()),onChange:e=>{e.stopPropagation();const t=Y(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&H(""===t?0:parseFloat(t)||0)},onBlur:e=>{e.stopPropagation();const t=Y(e.target.value),s=parseFloat(t)||0;H(s)},onInput:e=>{e.stopPropagation(),e.nativeEvent&&e.nativeEvent.stopImmediatePropagation&&e.nativeEvent.stopImmediatePropagation()},onKeyDown:e=>{if("Escape"===e.key)return e.preventDefault(),void H(0);["Backspace","Delete","Tab","Enter","ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Home","End","."].includes(e.key)||e.key>="0"&&e.key<="9"||e.ctrlKey&&["a","c","v","x","z"].includes(e.key.toLowerCase())||e.preventDefault()},placeholder:"0.00",className:o("border-2 transition-all duration-200 h-11",n?"border-purple-700/50 bg-purple-950/40 hover:border-purple-600 focus:border-purple-500 text-purple-100 placeholder:text-purple-400":"border-purple-300/70 bg-white hover:border-purple-400 focus:border-purple-500 text-purple-900 placeholder:text-purple-500")},`lab-cost-${s.id}-${M}`),M>0&&e.jsxs("div",{className:o("flex items-center gap-2 text-xs p-2 rounded-lg",n?"bg-purple-800/30 text-purple-200 border border-purple-700/30":"bg-purple-100/70 text-purple-700 border border-purple-200/50"),children:[e.jsx("span",{className:"text-sm",children:"✨"}),e.jsx("span",{children:"سيتم تحديث طلب المخبر تلقائياً"})]})]})]}),"completed"===y.treatment_status&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"تاريخ الإنجاز"}),e.jsx($,{type:"date",value:y.completion_date||"",onChange:e=>w(t=>({...t,completion_date:e.target.value})),onKeyDown:e=>{if(e.stopPropagation(),"Escape"===e.key)return e.preventDefault(),void e.stopPropagation()},onFocus:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),"data-prevent-shortcuts":"true"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"ملاحظات"}),e.jsx(B,{value:y.notes||"",onChange:e=>w(t=>({...t,notes:e.target.value})),placeholder:"أدخل أي ملاحظات إضافية...",rows:3,onKeyDown:e=>{if(e.stopPropagation(),"Escape"===e.key)return e.preventDefault(),void e.stopPropagation()},onFocus:e=>e.stopPropagation(),onClick:e=>e.stopPropagation(),"data-prevent-shortcuts":"true"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsxs(N,{variant:"outline",onClick:l,children:[e.jsx(S,{className:"w-4 h-4 ml-2"}),"إلغاء"]}),e.jsxs(N,{onClick:async()=>{if(y.treatment_type)if("التعويضات"===_&&M>0&&!O)Se.error("يرجى اختيار المخبر عند إدخال تكلفة المخبر");else try{const t={...y,treatment_color:k(y.treatment_type)?.color||s.treatment_color};await a(s.id,t);const r=y.cost||0;if(r!==(z||0)&&await(async()=>{try{if(!m.find(e=>e.id===s.patient_id))return void Se.error("لم يتم العثور على بيانات المريض");const e=c(s.patient_id).filter(e=>e.tooth_treatment_id===s.id),t=k(y.treatment_type),a=`علاج ${t?.label||y.treatment_type} - سن ${s.tooth_name||s.tooth_number}`;if(e.length>0){const t=e.reduce((e,t)=>e+t.amount,0),r=y.cost||0,l=Math.max(0,r-t);let n;n=r<=0||l<=0&&t>0?"completed":t>0?"partial":"pending";for(const o of e){const e={tooth_treatment_id:s.id,description:a,notes:`دفعة لعلاج سن ${s.tooth_name||s.tooth_number} (تم تعديل التكلفة)`,total_amount_due:r,remaining_balance:l,treatment_total_cost:r,treatment_total_paid:t,treatment_remaining_balance:l,status:n};await d(o.id,e)}Se.success("تم تحديث المدفوعات المرتبطة بالعلاج")}else if((y.cost||0)>0){const e={patient_id:s.patient_id,tooth_treatment_id:s.id,amount:0,payment_method:"cash",payment_date:(new Date).toISOString().split("T")[0],description:a,status:"pending",notes:`دفعة آجلة لعلاج سن ${s.tooth_name||s.tooth_number} (تم تعديل التكلفة)`,total_amount_due:y.cost||0,amount_paid:0,remaining_balance:y.cost||0,treatment_total_cost:y.cost||0,treatment_total_paid:0,treatment_remaining_balance:y.cost||0};await i(e),Se.success("تم إنشاء دفعة آجلة في جدول المدفوعات")}}catch(e){console.error("خطأ في تحديث المدفوعات:",e),Se.error("فشل في تحديث المدفوعات")}})(),"التعويضات"===_)if(M>0&&O){const t=await W(s.id),a=k(y.treatment_type),r=`${a?.label||y.treatment_type||"علاج تعويضات"} - السن ${s.tooth_number}`;if(t)try{await j(t.id,{lab_id:O,cost:M,service_name:r,remaining_balance:M-(t.paid_amount||0)}),Se.success("تم تحديث طلب المختبر بنجاح")}catch(e){Se.error("فشل في تحديث طلب المختبر")}else try{await g({lab_id:O,patient_id:s.patient_id,tooth_treatment_id:s.id,tooth_number:s.tooth_number,service_name:r,cost:M,order_date:(new Date).toISOString().split("T")[0],status:"آجل",paid_amount:0,remaining_balance:M}),Se.success("تم إنشاء طلب المختبر بنجاح")}catch(e){Se.error("فشل في إنشاء طلب المختبر")}}else{const t=await W(s.id);if(t)try{await v(t.id),Se.info("تم حذف طلب المختبر")}catch(e){Se.error("فشل في حذف طلب المختبر")}}else{const t=await W(s.id);if(t)try{await v(t.id),Se.info("تم حذف طلب المختبر لتغيير تصنيف العلاج")}catch(e){Se.error("فشل في حذف طلب المختبر")}}l()}catch(e){console.error("Error updating treatment:",e),Se.error("فشل في حفظ التغييرات")}else Se.error("يرجى اختيار نوع العلاج")},className:"bg-orange-600 hover:bg-orange-700",children:[e.jsx(Ce,{className:"w-4 h-4 ml-2"}),"حفظ التغييرات"]})]})]})}const ht=({imagePath:s,alt:a="Dental image",className:l="",onLoad:n,onError:i})=>{const{isDarkMode:d}=r(),[c,m]=t.useState(null),[x,u]=t.useState(!0),[h,p]=t.useState(!1);return t.useEffect(()=>{let e=!0;return(async()=>{if(!s)return p(!0),void u(!1);try{if(u(!0),p(!1),window.electronAPI&&window.electronAPI.files&&window.electronAPI.files.getDentalImage){console.log("Loading dental image:",s);const t=await window.electronAPI.files.getDentalImage(s);e&&(m(t),u(!1),n?.())}else console.warn("Electron API not available for image loading"),e&&(p(!0),u(!1),i?.())}catch(t){console.error("Error loading dental image:",t),e&&(p(!0),u(!1),i?.())}})(),()=>{e=!1}},[s,n,i]),x?e.jsx("div",{className:o("flex items-center justify-center",d?"bg-gray-800":"bg-gray-100",l),children:e.jsx("div",{className:"animate-pulse",children:e.jsx(Ae,{className:o("w-6 h-6",d?"text-gray-500":"text-gray-400")})})}):h||!c?e.jsx("div",{className:o("flex items-center justify-center",d?"bg-gray-800":"bg-gray-100",l),children:e.jsxs("div",{className:o("text-center",d?"text-gray-500":"text-gray-400"),children:[e.jsx(Ae,{className:"w-6 h-6 mx-auto mb-1"}),e.jsx("div",{className:"text-xs",children:"فشل في تحميل الصورة"})]})}):e.jsx("img",{src:c,alt:a,className:l,onLoad:n,onError:()=>{p(!0),i?.()}})};function pt({open:s,onOpenChange:l,patientId:h,toothNumber:g,isPrimaryTeeth:b=!1,onSessionStatsUpdate:v,onTreatmentUpdate:f}){const{patients:y}=U(),{toothTreatments:C,images:$,toothTreatmentImages:B,loadToothTreatmentsByTooth:L,loadImagesByTreatment:F,loadToothTreatmentImagesByTooth:A,loadAllToothTreatmentImagesByPatient:z,createToothTreatment:O,updateToothTreatment:G,deleteToothTreatment:M,reorderToothTreatments:V,createToothTreatmentImage:R,deleteToothTreatmentImage:K,clearImages:H,clearToothTreatmentImages:q}=a(),{isDarkMode:Z}=r(),[J,Y]=t.useState(!1),[W,Q]=t.useState("treatments"),[X,ee]=t.useState([]),[ce,me]=t.useState(""),[xe,ue]=t.useState(!1),[he,pe]=t.useState(""),ge=y.find(e=>e.id===h),be=g?j(g,b):null,je=(C||[]).filter(e=>e.patient_id===h&&e.tooth_number===g);t.useEffect(()=>{s&&h&&g&&(L(h,g),A(h,g),H())},[s,h,g,L,A,H]),t.useEffect(()=>{const e=async()=>{s&&h&&g&&await L(h,g)};return window.addEventListener("tooth-color-update",e),()=>{window.removeEventListener("tooth-color-update",e)}},[s,h,g,L]);const ve=e=>{window.electronAPI&&window.electronAPI.files&&window.electronAPI.files.openImagePreview?window.electronAPI.files.openImagePreview(e):window.open(`file://${e}`,"_blank")},fe=e=>{const t=(B||[]).filter(t=>t.tooth_treatment_id===e&&t.tooth_number===g&&t.patient_id===h);return{beforeImages:t.filter(e=>"before"===e.image_type),afterImages:t.filter(e=>"after"===e.image_type)}},Ce=()=>je.filter(e=>{const{beforeImages:t,afterImages:s}=fe(e.id);return t.length>0&&s.length>0}),Te=async(e,t)=>{try{if(window.electronAPI&&window.electronAPI.files&&window.electronAPI.files.uploadDentalImage){const s=await e.arrayBuffer(),a=Date.now(),r=e.name.split(".").pop()||"jpg",l=`${e.name.split(".")[0]}_${a}.${r}`,n=await window.electronAPI.files.uploadDentalImage(s,l,h,g||0,t,ge?.full_name||"Unknown_Patient",be?.arabicName||`Tooth_${g}`);return console.log("Image uploaded successfully:",n),n}return console.warn("Electron API not available, using public/upload fallback"),await Pe(e,t)}catch(s){throw console.error("Error uploading image:",s),new Error("فشل في رفع الصورة")}},Pe=async(e,t)=>{try{const s=new FileReader;return new Promise((a,r)=>{s.onload=async()=>{try{const r=s.result;if(window.electronAPI&&window.electronAPI.files&&window.electronAPI.files.saveDentalImage){const s=Date.now(),l=e.name.split(".").pop()||"jpg",n=`${e.name.split(".")[0]}_${s}.${l}`,o=await window.electronAPI.files.saveDentalImage(r,n,h,g||0,t,ge?.full_name||"Unknown_Patient",be?.arabicName||`Tooth_${g}`);console.log("Image saved via Electron API:",o),a(o)}else{const s=Date.now(),r=e.name.split(".").pop()||"jpg",l=(ge?.full_name||"Unknown_Patient").replace(/[^a-zA-Z0-9\u0600-\u06FF\s]/g,"").replace(/\s+/g,"_"),n=((be?.arabicName||`Tooth_${g}`).replace(/[^a-zA-Z0-9\u0600-\u06FF\s]/g,"").replace(/\s+/g,"_"),`${e.name.split(".")[0]}_${s}.${r}`),o=`dental_images/${l}/${t||"other"}/${n}`;console.log("Using fallback path:",o),a(o)}}catch(l){console.error("Error in saveImageToPublicUpload:",l),r(l)}},s.onerror=()=>{console.error("Error reading file"),r(new Error("فشل في قراءة الملف"))},s.readAsDataURL(e)})}catch(s){throw console.error("Error in saveImageToPublicUpload:",s),new Error("فشل في حفظ الصورة")}},De=async e=>{if(window.confirm("هل أنت متأكد من حذف هذه الصورة؟"))try{Y(!0),await K(e),await z(h),Se.success("تم حذف الصورة بنجاح")}catch(t){Se.error("فشل في حذف الصورة"),console.error("Error deleting image:",t)}finally{Y(!1)}};if(!be)return null;const $e={total:je.length,completed:je.filter(e=>"completed"===e.treatment_status).length,inProgress:je.filter(e=>"in_progress"===e.treatment_status).length,planned:je.filter(e=>"planned"===e.treatment_status).length,cancelled:je.filter(e=>"cancelled"===e.treatment_status).length};return e.jsx(se,{open:s,onOpenChange:l,children:e.jsxs(ae,{className:"sm:max-w-[900px] max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs(re,{children:[e.jsxs(le,{className:"flex items-center gap-3 text-right",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg border-2 border-white shadow-md flex items-center justify-center",style:{backgroundColor:(()=>{if(0===je.length)return"#22c55e";if(je.every(e=>"completed"===e.treatment_status))return"#22c55e";const e=[...je].sort((e,t)=>e.priority-t.priority),t=e.find(e=>"in_progress"===e.treatment_status)||e.find(e=>"planned"===e.treatment_status)||e[0];return t?.treatment_color||"#22c55e"})()},children:e.jsx("span",{className:"text-white font-bold text-sm",children:g})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold",children:["تفاصيل السن رقم ",g]}),e.jsx("p",{className:"text-base text-muted-foreground",children:be.arabicName})]}),$e.total>0&&e.jsxs(p,{variant:"secondary",className:"mr-auto",children:[e.jsx(et,{className:"w-4 h-4 ml-1"}),$e.total," علاج"]})]}),e.jsxs(ne,{className:"text-right",children:["المريض: ",ge?.full_name]}),$e.total>0&&e.jsxs("div",{className:"flex gap-2 mt-2",children:[$e.completed>0&&e.jsxs(p,{variant:"secondary",className:"bg-green-100 text-green-800",children:[e.jsx(w,{className:"w-3 h-3 ml-1"}),$e.completed," مكتمل"]}),$e.inProgress>0&&e.jsxs(p,{variant:"secondary",className:"bg-yellow-100 text-yellow-800",children:[e.jsx(c,{className:"w-3 h-3 ml-1"}),$e.inProgress," قيد التنفيذ"]}),$e.planned>0&&e.jsxs(p,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:[e.jsx(_,{className:"w-3 h-3 ml-1"}),$e.planned," مخطط"]}),$e.cancelled>0&&e.jsxs(p,{variant:"secondary",className:"bg-gray-100 text-gray-800",children:[e.jsx(te,{className:"w-3 h-3 ml-1"}),$e.cancelled," ملغي"]})]})]}),e.jsxs(Ne,{value:W,onValueChange:Q,className:"w-full",dir:"rtl",children:[e.jsxs(ye,{className:"grid w-full grid-cols-3",children:[e.jsxs(we,{value:"treatments",className:"flex items-center gap-2",children:[e.jsx(oe,{className:"w-4 h-4"}),"العلاجات النشطة"]}),e.jsxs(we,{value:"completed",className:"flex items-center gap-2",children:[e.jsx(w,{className:"w-4 h-4"}),"العلاجات المكتملة (",$e.completed,")"]}),e.jsxs(we,{value:"images",className:"flex items-center gap-2",children:[e.jsx(Qe,{className:"w-4 h-4"}),"الصور (",(B||[]).filter(e=>e.tooth_number===g&&e.patient_id===h).length,")"]})]}),e.jsx(_e,{value:"treatments",className:"space-y-4",dir:"rtl",children:e.jsx(xt,{patientId:h,toothNumber:g,toothName:be.arabicName,treatments:je.filter(e=>"completed"!==e.treatment_status),onAddTreatment:async e=>{try{Y(!0);const t=await O(e);return Se.success("تم إضافة العلاج بنجاح"),f?.(),t}catch(t){return Se.error("فشل في إضافة العلاج"),console.error("Error adding treatment:",t),null}finally{Y(!1)}},onUpdateTreatment:async(e,t)=>{try{if(Y(!0),console.log("🦷 Dialog: Updating treatment:",e,t),await G(e,t),console.log("🦷 Dialog: Treatment updated in store"),g)try{await L(h,g),console.log("🦷 Dialog: Tooth treatments reloaded")}catch(s){console.warn("🦷 Dialog: Failed to reload tooth treatments, but update was successful:",s)}return f?.(),console.log("🦷 Dialog: Treatment updated successfully"),Se.success("تم تحديث العلاج بنجاح"),Promise.resolve()}catch(a){throw console.error("🦷 Dialog: Error updating treatment:",a),Se.error("فشل في تحديث العلاج"),a}finally{Y(!1)}},onDeleteTreatment:async e=>{try{Y(!0),await M(e),Se.success("تم حذف العلاج بنجاح"),f?.()}catch(t){Se.error("فشل في حذف العلاج"),console.error("Error deleting treatment:",t)}finally{Y(!1)}},onReorderTreatments:async e=>{if(g)try{Y(!0);const t=C.filter(e=>e.patient_id===h&&e.tooth_number===g);console.log("Reordering treatments:",{patientId:h,toothNumber:g,treatmentIds:e,currentTreatments:t.map(e=>({id:e.id,priority:e.priority}))}),await V(h,g,e),await L(h,g),Se.success("تم إعادة ترتيب العلاجات بنجاح")}catch(t){Se.error("فشل في إعادة ترتيب العلاجات"),console.error("Error reordering treatments:",t),await L(h,g)}finally{Y(!1)}},onSessionStatsUpdate:v,onTreatmentUpdate:f})}),e.jsx(_e,{value:"completed",className:"space-y-4",dir:"rtl",children:e.jsxs(n,{children:[e.jsxs(i,{children:[e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(w,{className:o("w-5 h-5",Z?"text-green-400":"text-green-600")}),"العلاجات المكتملة"]}),e.jsx(m,{children:"جميع العلاجات التي تم إكمالها لهذا السن"})]}),e.jsx(u,{children:0===je.filter(e=>"completed"===e.treatment_status).length?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(w,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد علاجات مكتملة لهذا السن"}),e.jsx("p",{className:"text-sm",children:"العلاجات المكتملة ستظهر هنا"})]}):e.jsx("div",{className:"space-y-3",children:je.filter(e=>"completed"===e.treatment_status).sort((e,t)=>e.priority-t.priority).map(t=>e.jsx(n,{className:o("transition-all duration-200 hover:shadow-md",Z?"border-green-700/50 bg-green-950/30 hover:bg-green-950/40":"border-green-200 bg-green-50 hover:bg-green-100/50"),children:e.jsxs(u,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:o("w-4 h-4 rounded-full border",Z?"border-white/30":"border-white/50"),style:{backgroundColor:t.treatment_color}}),e.jsxs("div",{children:[e.jsx("h4",{className:o("font-medium",Z?"text-green-200":"text-green-800"),children:k(t.treatment_type)?.label||t.treatment_type}),e.jsxs("p",{className:o("text-sm",Z?"text-green-300":"text-green-600"),children:["الأولوية: ",t.priority]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs(p,{variant:"secondary",className:o("transition-colors",Z?"bg-green-900/50 text-green-200 border-green-700/50":"bg-green-100 text-green-800 border-green-200"),children:[e.jsx(w,{className:"w-3 h-3 ml-1"}),"مكتمل"]}),t.completion_date&&e.jsxs("p",{className:o("text-xs mt-1",Z?"text-green-300":"text-green-600"),children:["تاريخ الإكمال: ",(()=>{const e=new Date(t.completion_date);return`${e.getDate().toString().padStart(2,"0")}/${(e.getMonth()+1).toString().padStart(2,"0")}/${e.getFullYear()}`})()]})]})]}),t.notes&&e.jsxs("div",{className:o("mt-3 p-3 rounded-lg text-sm transition-colors",Z?"bg-green-900/30 text-green-200 border border-green-700/30":"bg-green-100 text-green-700 border border-green-200"),children:[e.jsx("strong",{children:"ملاحظات:"})," ",t.notes]}),t.cost&&e.jsx("div",{className:o("mt-3 p-3 rounded-lg text-sm font-medium transition-colors",Z?"bg-blue-900/30 text-blue-200 border border-blue-700/30":"bg-blue-50 text-blue-700 border border-blue-200"),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"التكلفة:"}),e.jsx(ke,{amount:t.cost,className:"font-semibold"})]})})]})},t.id))})})]})}),e.jsxs(_e,{value:"images",className:"space-y-4",dir:"rtl",children:[e.jsxs(n,{children:[e.jsx(i,{children:e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"w-5 h-5"}),"رفع صور جديدة"]})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"treatment-select",children:"ربط الصور بعلاج محدد (اختياري)"}),e.jsxs(T,{value:ce,onValueChange:me,children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر علاج لربط الصور به (أو اتركه فارغاً)"})}),e.jsxs(I,{children:[e.jsx(D,{value:"none",children:"بدون ربط بعلاج محدد"}),(C||[]).filter(e=>e.patient_id===h&&e.tooth_number===g).map(t=>e.jsxs(D,{value:t.id,children:[k(t.treatment_type)?.label||t.treatment_type," - ","completed"===t.treatment_status?"مكتمل":"in_progress"===t.treatment_status?"قيد التنفيذ":"planned"===t.treatment_status?"مخطط":"ملغي"]},t.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"اختر نوع الصورة لرفعها"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:ie.map(t=>e.jsx(N,{variant:"outline",className:"image-type-button h-auto p-4 flex flex-col items-center gap-2 min-h-[80px] border-2 border-dashed hover:border-solid transition-all duration-200",asChild:!0,children:e.jsxs("label",{htmlFor:`image-upload-${t.value}`,className:"cursor-pointer w-full h-full flex flex-col items-center justify-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:t.icon}),e.jsx("span",{className:"text-xs font-medium text-center leading-tight",children:t.label}),e.jsx("input",{id:`image-upload-${t.value}`,type:"file",multiple:!0,accept:"image/*",className:"hidden",onChange:e=>((e,t)=>{const s=Array.from(e.target.files||[]).map(e=>({file:e,type:t,treatmentId:ce&&"none"!==ce?ce:void 0}));ee(e=>[...e,...s]),e.target.value=""})(e,t.value)})]})},t.value))})]}),X.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium",children:"الصور المحددة للرفع:"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:X.map((t,s)=>e.jsxs("div",{className:"selected-image-preview relative group",children:[e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:URL.createObjectURL(t.file),alt:`Preview ${s+1}`,className:"w-full h-24 object-cover rounded-lg border-2 border-dashed border-gray-300"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all rounded-lg"}),e.jsx(N,{variant:"destructive",size:"sm",className:"absolute -top-2 -right-2 w-6 h-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>(e=>{ee(t=>t.filter((t,s)=>s!==e))})(s),children:e.jsx(S,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"mt-1 text-xs text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("span",{children:ie.find(e=>e.value===t.type)?.icon}),e.jsx("span",{children:ie.find(e=>e.value===t.type)?.label})]}),t.treatmentId&&e.jsxs("div",{className:"text-blue-600 mt-1",children:["مربوط بعلاج: ",(()=>{const e=(C||[]).find(e=>e.id===t.treatmentId);return e?k(e.treatment_type)?.label||e.treatment_type:"علاج"})()]})]})]},s))})]}),X.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"الصور المحددة للرفع:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:X.map((t,s)=>e.jsxs("div",{className:"relative",children:[e.jsxs(p,{variant:"outline",className:"pr-6",children:[t.file.name," (",t.type,")",t.treatmentId&&e.jsxs("span",{className:"text-blue-600 ml-1",children:["- ",(()=>{const e=(C||[]).find(e=>e.id===t.treatmentId);return e?k(e.treatment_type)?.label||e.treatment_type:"علاج"})()]})]}),e.jsx(N,{size:"sm",variant:"ghost",className:"absolute -top-1 -right-1 h-4 w-4 p-0",onClick:()=>ee(e=>e.filter((e,t)=>t!==s)),children:e.jsx(S,{className:"h-3 w-3"})})]},s))}),e.jsxs(N,{onClick:async()=>{if(0!==X.length)try{Y(!0);for(const e of X){const t=await Te(e.file,e.type),s={tooth_treatment_id:e.treatmentId||null,patient_id:h,tooth_number:g,image_path:t,image_type:e.type,description:`${e.type} - السن رقم ${g}`,taken_date:(new Date).toISOString()};await R(s)}ee([]),await z(h),Se.success("تم حفظ الصور بنجاح")}catch(e){Se.error("فشل في حفظ الصور"),console.error("Error saving images:",e)}finally{Y(!1)}},disabled:J,className:"w-full",children:[e.jsx(Ie,{className:"w-4 h-4 ml-2"}),"حفظ الصور (",X.length,")"]})]})]})]}),e.jsxs(n,{children:[e.jsx(i,{children:e.jsxs(d,{className:"flex items-center gap-2 justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"w-5 h-5"}),"الصور المحفوظة (",(B||[]).filter(e=>e.tooth_number===g&&e.patient_id===h).length,")"]}),Ce().length>0&&e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>ue(!xe),className:"flex items-center gap-2",children:[e.jsx(Xe,{className:"w-4 h-4"}),xe?"إخفاء المقارنة":"مقارنة"]})]})}),e.jsxs(u,{children:[xe&&Ce().length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 dark:from-gray-900 dark:to-gray-800 rounded-lg border border-blue-200 dark:border-gray-700 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Xe,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-800 dark:text-gray-100",children:"مقارنة الصور"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 mb-4",children:[e.jsx(x,{htmlFor:"comparison-treatment",className:"text-sm font-medium text-gray-700 dark:text-gray-200 whitespace-nowrap",children:"اختر العلاج للمقارنة:"}),e.jsxs(T,{value:he,onValueChange:pe,children:[e.jsx(P,{className:"w-full sm:w-64 bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500 text-gray-900 dark:text-gray-100",children:e.jsx(E,{placeholder:"اختر العلاج..."})}),e.jsx(I,{className:"bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-500",children:Ce().map(t=>e.jsx(D,{value:t.id,className:"text-gray-900 dark:text-gray-100 dark:hover:bg-gray-600",children:k(t.treatment_type)?.label||t.treatment_type},t.id))})]})]}),!he&&e.jsx("div",{className:"text-center py-8 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600",children:e.jsxs("div",{className:"text-gray-500 dark:text-gray-400",children:[e.jsx(Xe,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"اختر علاجاً من القائمة أعلاه لعرض المقارنة"})]})}),he&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:(()=>{const{beforeImages:t,afterImages:s}=fe(he);return je.find(e=>e.id===he),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium text-center text-green-700 dark:text-green-300 flex items-center justify-center gap-2 bg-green-100 dark:bg-green-900/50 py-2 px-4 rounded-lg",children:[e.jsx("span",{className:"w-3 h-3 bg-green-500 dark:bg-green-400 rounded-full shadow-sm"}),"قبل العلاج"]}),e.jsx("div",{className:"grid grid-cols-1 gap-3",children:t.map(t=>e.jsxs("div",{className:"relative group",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border-2 border-green-300 dark:border-green-600 shadow-md hover:shadow-lg transition-shadow",children:[e.jsx(ht,{imagePath:t.image_path,alt:"قبل العلاج",className:"w-full h-48 object-cover"}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(N,{variant:"secondary",size:"sm",className:"w-8 h-8 p-0 bg-black/80 hover:bg-black/95 text-white border-2 border-white/30 hover:border-white/80 rounded-full backdrop-blur-sm shadow-lg transition-all duration-300",onClick:()=>ve(t.image_path),children:e.jsx(de,{className:"w-4 h-4"})})})]}),t.taken_date&&e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300 text-center mt-1 bg-white dark:bg-gray-700 rounded px-2 py-1 shadow-sm",children:new Date(t.taken_date).toLocaleDateString("en-GB")})]},t.id))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"font-medium text-center text-blue-700 dark:text-blue-300 flex items-center justify-center gap-2 bg-blue-100 dark:bg-blue-900/50 py-2 px-4 rounded-lg",children:[e.jsx("span",{className:"w-3 h-3 bg-blue-500 dark:bg-blue-400 rounded-full shadow-sm"}),"بعد العلاج"]}),e.jsx("div",{className:"grid grid-cols-1 gap-3",children:s.map(t=>e.jsxs("div",{className:"relative group",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border-2 border-blue-300 dark:border-blue-600 shadow-md hover:shadow-lg transition-shadow",children:[e.jsx(ht,{imagePath:t.image_path,alt:"بعد العلاج",className:"w-full h-48 object-cover"}),e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(N,{variant:"secondary",size:"sm",className:"w-8 h-8 p-0 bg-black/80 hover:bg-black/95 text-white border-2 border-white/30 hover:border-white/80 rounded-full backdrop-blur-sm shadow-lg transition-all duration-300",onClick:()=>ve(t.image_path),children:e.jsx(de,{className:"w-4 h-4"})})})]}),t.taken_date&&e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300 text-center mt-1 bg-white dark:bg-gray-700 rounded px-2 py-1 shadow-sm",children:new Date(t.taken_date).toLocaleDateString("en-GB")})]},t.id))})]})]})})()}),he&&e.jsx("div",{className:"mt-4 p-3 bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 shadow-sm",children:e.jsxs("p",{className:"text-sm text-center text-gray-700 dark:text-gray-200",children:[e.jsx("strong",{className:"text-gray-900 dark:text-white",children:"العلاج:"})," ",(()=>{const e=je.find(e=>e.id===he);return e?k(e.treatment_type)?.label||e.treatment_type:""})()]})})]}),0===(B||[]).filter(e=>e.tooth_number===g&&e.patient_id===h).length?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Qe,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"لا توجد صور محفوظة لهذا السن"}),e.jsx("p",{className:"text-sm",children:"قم برفع صور جديدة باستخدام النموذج أعلاه"})]}):e.jsxs("div",{className:"space-y-6",children:[je.map(t=>{const s=(B||[]).filter(e=>e.tooth_treatment_id===t.id&&e.tooth_number===g&&e.patient_id===h);return 0===s.length?null:e.jsxs(n,{className:"treatment-images-card border-2 border-blue-200 dark:border-blue-700",children:[e.jsx(i,{className:"pb-3 bg-blue-50 dark:bg-blue-900/20",children:e.jsxs(d,{className:"text-sm flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-blue-500 rounded-full"}),e.jsx("span",{className:"font-medium text-blue-700 dark:text-blue-300",children:k(t.treatment_type)?.label||t.treatment_type}),e.jsxs(p,{variant:"secondary",className:"mr-auto bg-blue-100 dark:bg-blue-800 text-blue-700 dark:text-blue-300",children:[s.length," صورة"]})]})}),e.jsx(u,{className:"space-y-4",children:ie.map(t=>{const a=s.filter(e=>e.image_type===t.value);return 0===a.length?null:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300",children:[e.jsx("span",{className:"image-type-icon",children:t.icon}),e.jsx("span",{className:"image-type-label",children:t.label}),e.jsx(p,{variant:"outline",className:"text-xs",children:a.length})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:a.map(s=>e.jsxs("div",{className:"saved-image-card group relative bg-card border border-border rounded-lg p-2 hover:shadow-lg transition-all duration-300",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border border-border",children:[e.jsx(ht,{imagePath:s.image_path,alt:s.description||t.label,className:"w-full h-24 object-cover transition-transform group-hover:scale-105"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all"}),e.jsxs("div",{className:"absolute top-2 right-2 flex flex-row items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20",children:[e.jsx(N,{variant:"secondary",size:"sm",className:"w-8 h-8 p-0 bg-black/80 hover:bg-black/95 text-white border-2 border-white/30 hover:border-white/80 rounded-full backdrop-blur-sm shadow-lg transition-all duration-300",onClick:()=>ve(s.image_path),children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx(N,{variant:"destructive",size:"sm",className:"w-8 h-8 p-0 bg-red-500/90 hover:bg-red-500 dark:bg-red-600/90 dark:hover:bg-red-600 rounded-full shadow-lg transition-all duration-300",onClick:()=>De(s.id),children:e.jsx(Ee,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"mt-2 space-y-1",children:s.taken_date&&e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300 text-center bg-white dark:bg-gray-700 rounded px-2 py-1 shadow-sm",children:new Date(s.taken_date).toLocaleDateString("en-GB")})})]},s.id))})]},t.value)})})]},t.id)}),(()=>{const t=(B||[]).filter(e=>!e.tooth_treatment_id&&e.tooth_number===g&&e.patient_id===h);return 0===t.length?null:e.jsxs(n,{className:"unassociated-images-card border-2 border-gray-200 dark:border-gray-600",children:[e.jsx(i,{className:"pb-3 bg-gray-50 dark:bg-gray-800",children:e.jsxs(d,{className:"text-sm flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 bg-gray-500 rounded-full"}),e.jsx("span",{className:"font-medium text-gray-700 dark:text-gray-300",children:"صور غير مرتبطة بعلاج محدد"}),e.jsxs(p,{variant:"secondary",className:"mr-auto",children:[t.length," صورة"]})]})}),e.jsx(u,{className:"space-y-4",children:ie.map(s=>{const a=t.filter(e=>e.image_type===s.value);return 0===a.length?null:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-gray-700 dark:text-gray-300",children:[e.jsx("span",{className:"image-type-icon",children:s.icon}),e.jsx("span",{className:"image-type-label",children:s.label}),e.jsx(p,{variant:"outline",className:"text-xs",children:a.length})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:a.map(t=>e.jsxs("div",{className:"saved-image-card group relative bg-card border border-border rounded-lg p-2 hover:shadow-lg transition-all duration-300",children:[e.jsxs("div",{className:"relative overflow-hidden rounded-lg border border-border",children:[e.jsx(ht,{imagePath:t.image_path,alt:t.description||s.label,className:"w-full h-24 object-cover transition-transform group-hover:scale-105"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all"}),e.jsxs("div",{className:"absolute top-2 right-2 flex flex-row items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity z-20",children:[e.jsx(N,{variant:"secondary",size:"sm",className:"w-8 h-8 p-0 bg-black/80 hover:bg-black/95 text-white border-2 border-white/30 hover:border-white/80 rounded-full backdrop-blur-sm shadow-lg transition-all duration-300",onClick:()=>ve(t.image_path),children:e.jsx(de,{className:"w-4 h-4"})}),e.jsx(N,{variant:"destructive",size:"sm",className:"w-8 h-8 p-0 bg-red-500/90 hover:bg-red-500 dark:bg-red-600/90 dark:hover:bg-red-600 rounded-full shadow-lg transition-all duration-300",onClick:()=>De(t.id),children:e.jsx(Ee,{className:"w-4 h-4"})})]})]}),e.jsx("div",{className:"mt-2 space-y-1",children:t.taken_date&&e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-300 text-center bg-white dark:bg-gray-700 rounded px-2 py-1 shadow-sm",children:new Date(t.taken_date).toLocaleDateString("en-GB")})})]},t.id))})]},s.value)})})]})})()]})]})]})]})]})]})})}function gt({patients:s,selectedPatientId:a,onPatientSelect:r,getPatientTreatmentCount:l,getLastTreatmentDate:n,getPatientImagesCount:o,isLoading:i=!1,isCompact:d=!1}){const[m,x]=t.useState(null),[u,h]=t.useState(null),[g,b]=t.useState(1),[j,v]=t.useState(d?5:10),[f,y]=t.useState(!1),w=t.useMemo(()=>d&&a&&!f?s.filter(e=>e.id===a):s,[s,d,a,f]),_=t.useMemo(()=>{let e=w;m&&u&&(e=[...w].sort((e,t)=>{let s=e[m],a=t[m];return null==s&&null==a?0:null==s?"asc"===u?1:-1:null==a?"asc"===u?-1:1:(s=String(s).toLowerCase(),a=String(a).toLowerCase(),s<a?"asc"===u?-1:1:s>a?"asc"===u?1:-1:0)}));const t=(g-1)*j,s=t+j;return{patients:e.slice(t,s),totalPages:Math.ceil(e.length/j),totalCount:e.length}},[w,m,u,g,j]),k=t=>m!==t?e.jsx(Ue,{className:"w-4 h-4 opacity-50"}):"asc"===u?e.jsx(Le,{className:"w-4 h-4"}):"desc"===u?e.jsx(Fe,{className:"w-4 h-4"}):e.jsx(Ue,{className:"w-4 h-4 opacity-50"}),C=({field:t,children:s})=>e.jsx(Ve,{className:"cursor-pointer hover:bg-muted/50 select-none text-center",onClick:()=>(e=>{m===e?"asc"===u?h("desc"):"desc"===u?(x(null),h(null)):h("asc"):(x(e),h("asc"))})(t),children:e.jsxs("div",{className:"flex items-center justify-center space-x-1 space-x-reverse",children:[e.jsx("span",{children:s}),k(t)]})});if(i)return e.jsx("div",{className:"border rounded-lg",children:e.jsxs(Oe,{className:"table-center-all",children:[e.jsx(Ge,{children:e.jsxs(Me,{className:"bg-muted/50",children:[e.jsx(Ve,{className:"text-center w-16",children:"#"}),e.jsx(Ve,{className:"text-center",children:"اسم المريض"}),e.jsx(Ve,{className:"text-center",children:"الجنس"}),e.jsx(Ve,{className:"text-center",children:"العمر"}),e.jsx(Ve,{className:"text-center",children:"رقم الهاتف"}),e.jsx(Ve,{className:"text-center",children:"عدد العلاجات"}),e.jsx(Ve,{className:"text-center",children:"آخر زيارة"}),e.jsx(Ve,{className:"text-center",children:"الإجراءات"})]})}),e.jsx(Re,{children:[...Array(5)].map((t,s)=>e.jsx(Me,{children:[...Array(8)].map((t,s)=>e.jsx(Ke,{children:e.jsx("div",{className:"h-4 bg-muted animate-pulse rounded"})},s))},s))})]})});if(0===s.length)return e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ce,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"لا توجد مرضى مطابقين لبحثك"})]});const{patients:S,totalPages:$,totalCount:B}=_,F=(g-1)*j,U=e=>{b(e)};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-slate-50 dark:bg-slate-800/60 px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-t-lg",children:e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-slate-600 dark:text-slate-300 font-medium",children:["عرض ",S.length," من أصل ",B," مريض"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[a&&e.jsxs("span",{className:"text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-blue-900/30 px-3 py-1 rounded-full",children:["المريض المحدد: ",s.find(e=>e.id===a)?.full_name]}),d&&a&&e.jsx(N,{variant:"outline",size:"sm",onClick:()=>y(!f),className:"text-xs bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 border-slate-300 dark:border-slate-600",children:f?"إخفاء المرضى الآخرين":"عرض جميع المرضى"})]})]})}),e.jsx("div",{className:"border border-slate-200 dark:border-slate-700 rounded-b-lg overflow-hidden bg-white dark:bg-slate-900 shadow-sm",children:e.jsx("div",{className:"overflow-x-auto bg-white dark:bg-slate-900",children:e.jsxs(Oe,{className:"table-center-all bg-white dark:bg-slate-900",children:[e.jsx(Ge,{className:"bg-slate-100 dark:bg-slate-800",children:e.jsxs(Me,{className:"bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800",children:[e.jsx(Ve,{className:"text-center w-16 text-slate-700 dark:text-slate-200 font-semibold",children:e.jsx("span",{className:"font-semibold",children:"#"})}),e.jsx(C,{field:"full_name",children:e.jsx("span",{className:"font-semibold text-slate-700 dark:text-slate-200",children:"اسم المريض"})}),e.jsx(C,{field:"gender",children:e.jsx("span",{className:"font-semibold text-slate-700 dark:text-slate-200",children:"الجنس"})}),e.jsx(C,{field:"age",children:e.jsx("span",{className:"font-semibold text-slate-700 dark:text-slate-200",children:"العمر"})}),e.jsx(C,{field:"phone",children:e.jsx("span",{className:"font-semibold text-slate-700 dark:text-slate-200",children:"رقم الهاتف"})}),e.jsx(Ve,{className:"text-center text-slate-700 dark:text-slate-200",children:e.jsx("span",{className:"font-semibold",children:"عدد العلاجات"})}),e.jsx(Ve,{className:"text-center text-slate-700 dark:text-slate-200",children:e.jsx("span",{className:"font-semibold",children:"آخر زيارة"})}),e.jsx(Ve,{className:"text-center text-slate-700 dark:text-slate-200",children:e.jsx("span",{className:"font-semibold",children:"الإجراءات"})})]})}),e.jsx(Re,{className:"bg-white dark:bg-slate-900",children:S.map((t,s)=>e.jsxs(Me,{className:"hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors border-b border-slate-200 dark:border-slate-700 "+(a===t.id?"bg-blue-50 dark:bg-blue-900/30 border-blue-200 dark:border-blue-700":"bg-white dark:bg-slate-900"),children:[e.jsx(Ke,{className:"font-medium text-slate-600 dark:text-slate-400",children:F+s+1}),e.jsx(Ke,{className:"font-medium table-cell-wrap-truncate-md",children:e.jsx("span",{className:"text-slate-800 dark:text-slate-200 font-medium",children:t.full_name})}),e.jsx(Ke,{children:e.jsx(p,{variant:"male"===t.gender?"default":"secondary",className:""+("male"===t.gender?"bg-blue-500 hover:bg-blue-600 text-white border-blue-500":"bg-pink-100 dark:bg-pink-900/30 text-pink-700 dark:text-pink-300 border-pink-200 dark:border-pink-700"),children:"male"===t.gender?"ذكر":"أنثى"})}),e.jsx(Ke,{children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(L,{className:"w-3 h-3 text-slate-500 dark:text-slate-400"}),e.jsxs("span",{className:"text-slate-700 dark:text-slate-300 font-medium",children:[t.age," سنة"]})]})}),e.jsx(Ke,{className:"table-cell-wrap-truncate-sm",children:t.phone?e.jsxs("a",{href:`https://wa.me/${t.phone?.replace(/\D/g,"")}`,target:"_blank",rel:"noopener noreferrer",className:"text-green-600 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 hover:underline flex items-center justify-center gap-1 font-medium",children:[e.jsx(He,{className:"w-3 h-3"}),t.phone]}):e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:"غير محدد"})}),e.jsx(Ke,{children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs(p,{variant:"outline",className:"bg-blue-50 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 border-blue-200 dark:border-blue-700 font-medium",children:[e.jsx(c,{className:"w-3 h-3 ml-1"}),l(t.id)," علاج"]}),o&&o(t.id)>0&&e.jsxs(p,{variant:"outline",className:"bg-green-50 dark:bg-green-900/40 text-green-700 dark:text-green-300 border-green-200 dark:border-green-700 font-medium",children:[e.jsx(Qe,{className:"w-3 h-3 ml-1"}),o(t.id)," صورة"]})]})}),e.jsx(Ke,{children:n(t.id)?e.jsx("span",{className:"text-xs text-slate-600 dark:text-slate-400 font-medium",children:M(n(t.id))}):e.jsx("span",{className:"text-xs text-slate-500 dark:text-slate-500",children:"لا توجد زيارات"})}),e.jsx(Ke,{children:e.jsx(N,{size:"sm",variant:a===t.id?"default":"outline",onClick:()=>r(t.id),className:"text-xs font-medium "+(a===t.id?"bg-blue-500 hover:bg-blue-600 text-white border-blue-500 shadow-sm":"bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 border-slate-300 dark:border-slate-600"),children:a===t.id?"محدد":"اختيار"})})]},t.id))})]})})}),B>j&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 bg-slate-50 dark:bg-slate-800/60 border border-slate-200 dark:border-slate-700 rounded-lg",children:[e.jsx("div",{className:"flex items-center space-x-2 space-x-reverse",children:e.jsxs("p",{className:"text-sm text-slate-600 dark:text-slate-300 font-medium",children:["عرض ",(g-1)*j+1," إلى ",Math.min(g*j,B)," من ",B," مريض"]})}),e.jsxs("div",{className:"flex items-center space-x-6 space-x-reverse lg:space-x-8",children:[e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsx("p",{className:"text-sm font-medium text-slate-700 dark:text-slate-200",children:"عدد الصفوف لكل صفحة"}),e.jsxs(T,{value:`${j}`,onValueChange:e=>{v(parseInt(e)),b(1)},children:[e.jsx(P,{className:"h-8 w-[70px] border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700",children:e.jsx(E,{placeholder:j})}),e.jsx(I,{side:"top",children:[5,10,15,20].map(t=>e.jsx(D,{value:`${t}`,children:t},t))})]})]}),e.jsxs("div",{className:"flex w-[100px] items-center justify-center text-sm font-medium text-slate-700 dark:text-slate-200",children:["صفحة ",g," من ",$]}),e.jsxs("div",{className:"flex items-center space-x-2 space-x-reverse",children:[e.jsxs(N,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300",onClick:()=>U(1),disabled:1===g,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة الأولى"}),e.jsx(qe,{className:"h-4 w-4"})]}),e.jsxs(N,{variant:"outline",className:"h-8 w-8 p-0 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300",onClick:()=>U(g-1),disabled:1===g,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة السابقة"}),e.jsx(me,{className:"h-4 w-4"})]}),e.jsxs(N,{variant:"outline",className:"h-8 w-8 p-0 bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300",onClick:()=>U(g+1),disabled:g===$,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة التالية"}),e.jsx(Je,{className:"h-4 w-4"})]}),e.jsxs(N,{variant:"outline",className:"hidden h-8 w-8 p-0 lg:flex bg-white dark:bg-slate-700 hover:bg-slate-50 dark:hover:bg-slate-600 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300",onClick:()=>U($),disabled:g===$,children:[e.jsx("span",{className:"sr-only",children:"الذهاب إلى الصفحة الأخيرة"}),e.jsx(Ze,{className:"h-4 w-4"})]})]})]})]})]})}function bt({open:s,onOpenChange:a,patientId:l,selectedTeeth:o,onAddTreatments:m}){r();const{labs:g,loadLabs:b}=$e(),{createPayment:j}=F(),{createLabOrder:v}=Be(),{patients:f}=U(),[y,w]=t.useState(""),[_,C]=t.useState(""),[S,L]=t.useState(0),[z,O]=t.useState(!1),[G,M]=t.useState({patient_id:l,treatment_status:"planned",cost:0,start_date:(new Date).toISOString().split("T")[0]}),V=e=>{const t="number"==typeof e?e.toString():e;if(!t)return"";const s=t.replace(/,/g,"");if(isNaN(Number(s)))return t;const a=s.split(".");return a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),a.join(".")},R=e=>e.replace(/,/g,"");t.useEffect(()=>{s&&b()},[s,b]);const K=async(e,t)=>{if(console.log("💰 [DEBUG] createPendingPaymentForTreatment called:",{treatmentId:e,cost:G.cost,patientId:l,toothNumber:t}),!e)throw console.error("❌ [DEBUG] Cannot create payment - missing treatment ID"),new Error("معرف العلاج مطلوب لإنشاء الدفعة");if(!G.cost||G.cost<=0)console.log("⚠️ [DEBUG] Skipping payment creation - no cost specified");else try{const s=f.find(e=>e.id===l);if(!s)throw new Error("لم يتم العثور على بيانات المريض");const a=k(G.treatment_type),r=`${a?.label||G.treatment_type} - السن ${t}`,n={patient_id:l,tooth_treatment_id:e,amount:0,payment_method:"cash",payment_date:(new Date).toISOString().split("T")[0],description:r,status:"pending",notes:`دفعة آجلة للمريض: ${s.full_name} - السن ${t} - العلاج: ${a?.label||G.treatment_type}`,total_amount_due:G.cost,amount_paid:0,remaining_balance:G.cost,treatment_total_cost:G.cost,treatment_total_paid:0,treatment_remaining_balance:G.cost};console.log("💰 [DEBUG] Creating payment with data:",n),await j(n),console.log("✅ [DEBUG] Payment created successfully for treatment:",e)}catch(s){console.error("❌ [DEBUG] Payment creation failed:",s);const e=s instanceof Error?s.message:"خطأ غير معروف";throw Se.error(`فشل في إنشاء الدفعة الآجلة للسن ${t}: ${e}`),s}},H=async(e,t)=>{console.log("🧪 [DEBUG] createLabOrderForTreatment called:",{treatmentId:e,labCost:S,selectedLab:_,patientId:l,toothNumber:t});try{const s=f.find(e=>e.id===l),a=k(G.treatment_type);if(!s)throw new Error("لم يتم العثور على بيانات المريض");const r={lab_id:_,patient_id:l,tooth_treatment_id:e,tooth_number:t,service_name:`${a?.label||"علاج تعويضات"} - السن ${t}`,cost:S,order_date:(new Date).toISOString().split("T")[0],status:"آجل",notes:`طلب مخبر للمريض: ${s.full_name} - السن ${t} - العلاج: ${a?.label||G.treatment_type}`,paid_amount:0,remaining_balance:S};await v(r),console.log("✅ [DEBUG] Lab order created successfully for treatment:",e)}catch(s){console.error("❌ [DEBUG] Lab order creation failed:",s);const e=s instanceof Error?s.message:"خطأ غير معروف";throw Se.error(`فشل في إنشاء طلب المختبر للسن ${t}: ${e}`),s}},q=()=>{M({patient_id:l,treatment_status:"planned",cost:0,start_date:(new Date).toISOString().split("T")[0]}),w(""),C(""),L(0)},Z=y?A(y):[];return e.jsx(se,{open:s,onOpenChange:a,children:e.jsxs(ae,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(re,{children:[e.jsxs(le,{className:"flex items-center gap-2 text-xl",children:[e.jsx(c,{className:"w-6 h-6 text-blue-600 dark:text-blue-400"}),"إضافة علاج للأسنان المحددة"]}),e.jsxs(ne,{children:["إضافة نفس العلاج لجميع الأسنان المحددة (",o.length," سن)"]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(n,{className:"bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800",children:[e.jsx(i,{className:"pb-3",children:e.jsx(d,{className:"text-sm text-blue-700 dark:text-blue-300",children:"الأسنان المحددة"})}),e.jsx(u,{className:"pt-0",children:e.jsx("div",{className:"flex flex-wrap gap-2",children:o.sort((e,t)=>e-t).map(t=>e.jsxs(p,{variant:"secondary",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",children:["السن ",t]},t))})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"تصنيف العلاج"}),e.jsxs(T,{value:y,onValueChange:e=>{w(e),M(t=>({...t,treatment_category:e,treatment_type:""}))},children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر تصنيف العلاج"})}),e.jsx(I,{children:h.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.icon}),e.jsx("span",{children:t.label})]})},t.value))})]})]}),y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"نوع العلاج"}),e.jsxs(T,{value:G.treatment_type||"",onValueChange:e=>{const t=k(e);M(s=>({...s,treatment_type:e,treatment_color:t?.color||"#22c55e"}))},children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر نوع العلاج"})}),e.jsx(I,{children:Z.map(t=>e.jsx(D,{value:t.value,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{children:t.label})]})},t.value))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"التكلفة"}),e.jsx($,{type:"text",value:V((G.cost||0).toString()),onChange:e=>{const t=R(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&M(e=>({...e,cost:""===t?0:parseFloat(t)||0}))},onBlur:e=>{const t=R(e.target.value),s=parseFloat(t)||0;M(e=>({...e,cost:s}))},placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"تاريخ البدء"}),e.jsx($,{type:"date",value:G.start_date||"",onChange:e=>M(t=>({...t,start_date:e.target.value}))})]})]}),"التعويضات"===G.treatment_category&&e.jsxs(n,{className:"bg-purple-50 dark:bg-purple-950/20 border-purple-200 dark:border-purple-800",children:[e.jsx(i,{className:"pb-3",children:e.jsx(d,{className:"text-sm text-purple-700 dark:text-purple-300",children:"معلومات المختبر"})}),e.jsx(u,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"المختبر"}),e.jsxs(T,{value:_,onValueChange:C,children:[e.jsx(P,{children:e.jsx(E,{placeholder:"اختر المختبر"})}),e.jsx(I,{children:g.map(t=>e.jsx(D,{value:t.id,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"تكلفة المختبر"}),e.jsx($,{type:"text",value:V(S.toString()),onChange:e=>{const t=R(e.target.value);(""===t||/^\d*\.?\d*$/.test(t))&&L(""===t?0:parseFloat(t)||0)},onBlur:e=>{const t=R(e.target.value),s=parseFloat(t)||0;L(s)},placeholder:"0.00"})]})]})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"ملاحظات"}),e.jsx(B,{value:G.notes||"",onChange:e=>M(t=>({...t,notes:e.target.value})),placeholder:"ملاحظات إضافية...",rows:3})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx(N,{variant:"outline",onClick:()=>a(!1),disabled:z,children:"إلغاء"}),e.jsx(N,{onClick:async()=>{if(G.treatment_type&&G.treatment_category)if("التعويضات"===G.treatment_category&&S>0&&!_)Se.error("يرجى اختيار المختبر عند إدخال تكلفة المختبر للتعويضات");else{O(!0);try{let r=0,n=0,i=0;for(const a of o)try{console.log(`🦷 [DEBUG] Processing tooth ${a}`);const s={...G,patient_id:l,tooth_number:a,tooth_name:`السن ${a}`,treatment_type:G.treatment_type,treatment_category:G.treatment_category,treatment_color:G.treatment_color||"#22c55e",treatment_status:G.treatment_status||"planned",cost:G.cost||0,start_date:G.start_date,notes:G.notes,priority:1},o=await m([s]);if(!(o&&o.length>0))throw new Error(`فشل في إنشاء العلاج للسن ${a}`);{const s=o[0].id;if(r++,console.log(`✅ [DEBUG] Treatment created successfully for tooth ${a}:`,s),G.cost&&G.cost>0){console.log(`💰 [DEBUG] Creating payment for tooth ${a}`);try{await K(s,a),n++,console.log(`✅ [DEBUG] Payment created successfully for tooth ${a}`)}catch(e){console.error(`❌ [DEBUG] Payment creation failed for tooth ${a}:`,e),Se.warning(`تم إنشاء العلاج للسن ${a} ولكن فشل في إنشاء الدفعة`)}}if("التعويضات"===G.treatment_category&&_&&S>0){console.log(`🧪 [DEBUG] Creating lab order for tooth ${a}`);try{await H(s,a),i++,console.log(`✅ [DEBUG] Lab order created successfully for tooth ${a}`)}catch(t){console.error(`❌ [DEBUG] Lab order creation failed for tooth ${a}:`,t),Se.warning(`تم إنشاء العلاج والدفعة للسن ${a} ولكن فشل في إنشاء طلب المختبر`)}}}}catch(s){console.error(`❌ [DEBUG] Failed to process tooth ${a}:`,s),Se.error(`فشل في معالجة السن ${a}`)}if(r>0){let e=`تم إضافة العلاج بنجاح لـ ${r} سن`;n>0&&(e+=` مع ${n} دفعة آجلة`),i>0&&(e+=` و ${i} طلب مختبر`),Se.success(e)}r===o.length?(q(),a(!1)):Se.warning(`تم معالجة ${r} من أصل ${o.length} أسنان بنجاح`)}catch(r){console.error("Error adding multiple treatments:",r),Se.error("فشل في إضافة العلاجات")}finally{O(!1)}}else Se.error("يرجى اختيار نوع العلاج والتصنيف")},disabled:z||!G.treatment_type,className:"bg-blue-600 hover:bg-blue-700 text-white",children:z?"جاري الإضافة...":`إضافة العلاج لـ ${o.length} سن`})]})]})]})})}function jt(){xe();const{patients:s,loadPatients:r}=U(),{toothTreatments:l,toothTreatmentImages:o,loadToothTreatments:x,loadAllToothTreatmentImages:h,loadToothTreatmentsByPatient:g,loadAllToothTreatmentImagesByPatient:b,createToothTreatment:j}=a(),{prescriptions:v,loadPrescriptions:f}=ue();he();const[y,w]=t.useState(""),[_,k]=t.useState(null),[C,S]=t.useState([]),[T,P]=t.useState(!1),[E,I]=t.useState(!1),[D,B]=t.useState(!1),[F,A]=t.useState(!1),[z,O]=t.useState(null),[G,V]=t.useState(""),[R,K]=t.useState(!1),[H,q]=t.useState(!1),[Z,J]=t.useState(!1),[Y,W]=t.useState({});pe(),t.useEffect(()=>{r(),f(),x(),h()},[r,f,x,h]),t.useEffect(()=>{(()=>{try{const e=localStorage.getItem("selectedPatientForTreatment");if(e){const t=JSON.parse(e);console.log("Found pre-selected patient for treatment:",t);const a=t.selectedPatientId,r=t.patientName,l=t.showAddTreatmentGuidance;localStorage.removeItem("selectedPatientForTreatment");const n=async()=>{console.log("Attempting to select patient:",a),console.log("Available patients:",s.length),r&&(V(r),Se.success(`تم تحديد المريض: ${r}`),l&&setTimeout(()=>{Se.info("اختر السن المراد علاجه من الرسم البياني أدناه لإضافة علاج جديد",void 0,{duration:5e3})},1e3)),w(a),console.log("Patient selected:",a),g(a),loadImages();const e=await te(a);W(t=>({...t,[a]:e})),setTimeout(()=>{const e=document.getElementById("dental-chart-section");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},500)};s.length>0?n():setTimeout(n,200)}}catch(e){console.error("Error reading pre-selected patient for treatment:",e)}})()},[s.length]),t.useEffect(()=>{const e=localStorage.getItem("selectedTreatmentForDetails");if(e)try{const{treatment:t,patientId:s,openDetailsModal:a}=JSON.parse(e);a&&t&&s&&(w(s),g(s),te(s).then(e=>{W(t=>({...t,[s]:e}))}),k(t.tooth_number),I(!0),localStorage.removeItem("selectedTreatmentForDetails"))}catch(s){console.error("Error parsing search result data:",s),localStorage.removeItem("selectedTreatmentForDetails")}const t=localStorage.getItem("selectedPrescriptionForDetails");if(t)try{const{prescription:e,openDetailsModal:s}=JSON.parse(t);s&&e&&(O(e),A(!0),localStorage.removeItem("selectedPrescriptionForDetails"))}catch(s){console.error("Error parsing prescription search result data:",s),localStorage.removeItem("selectedPrescriptionForDetails")}},[]);const Q=s.filter(e=>e.full_name.toLowerCase().includes(G.toLowerCase())||e.phone?.includes(G)||e.serial_number.includes(G)),X=s.find(e=>e.id===y),ee=v.filter(e=>e.patient_id===y),te=async e=>{try{const t=await window.electronAPI.toothTreatments.getByPatient(e);let s=[];for(const e of t){const t=await window.electronAPI.treatmentSessions.getByTreatment(e.id);s=[...s,...t]}return{total:s.length,completed:s.filter(e=>"completed"===e.session_status).length,planned:s.filter(e=>"planned"===e.session_status).length,cancelled:s.filter(e=>"cancelled"===e.session_status).length}}catch(t){return console.error("Error getting patient session stats:",t),{total:0,completed:0,planned:0,cancelled:0}}},se=async()=>{if(y){const e=await te(y);W(t=>({...t,[y]:e}))}},ae=e=>o.filter(t=>t.patient_id===e).length,re=e=>{P(!0),k(null),S(t=>{if(t.includes(e)){const s=t.filter(t=>t!==e);return 0===s.length&&P(!1),s}return[...t,e]})},le=()=>{S([]),P(!1)};return e.jsxs("div",{className:"space-y-6",dir:"rtl",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-foreground flex items-center gap-3",children:[e.jsx(ge,{className:"w-8 h-8 text-blue-600 dark:text-slate-300"}),"العلاجات السنية"]}),e.jsx("p",{className:"text-muted-foreground mt-2",children:"إدارة شاملة للعلاجات السنية مع مخطط الأسنان التفاعلي"})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(N,{onClick:async()=>{q(!0);try{if(await Promise.all([r(),f(),x(),h()]),y){await Promise.all([g(y),b(y)]);const e=await te(y);W(t=>({...t,[y]:e}))}Se.success("تم تحديث البيانات بنجاح")}catch(e){Se.error("حدث خطأ أثناء تحديث البيانات")}finally{q(!1)}},disabled:H,variant:"outline",children:[e.jsx(be,{className:"w-4 h-4 ml-2 "+(H?"animate-spin":"")}),"تحديث البيانات"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(n,{children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 dark:bg-blue-900 rounded-lg",children:e.jsx(ce,{className:"w-5 h-5 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي المرضى"}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:s.length})]})]})})}),e.jsx(n,{children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 dark:bg-green-900 rounded-lg",children:e.jsx(c,{className:"w-5 h-5 text-green-600 dark:text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي العلاجات"}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:l.length})]})]})})}),e.jsx(n,{children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-orange-100 dark:bg-orange-900 rounded-lg",children:e.jsx(Qe,{className:"w-5 h-5 text-orange-600 dark:text-orange-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"إجمالي الصور"}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:o.length})]})]})})}),e.jsx(n,{children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 dark:bg-purple-900 rounded-lg",children:e.jsx(Ye,{className:"w-5 h-5 text-purple-600 dark:text-purple-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"الوصفات الطبية"}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:v.length})]})]})})})]}),e.jsxs(n,{children:[e.jsxs(i,{children:[e.jsxs(d,{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),"اختيار المريض"]}),e.jsx(m,{children:"ابحث واختر المريض لعرض مخطط الأسنان والعلاجات"})]}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(je,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx($,{placeholder:"البحث السريع: اسم المريض، رقم الهاتف، أو #...",value:G,onChange:e=>V(e.target.value),className:"pr-10",autoComplete:"off"}),G&&e.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2",children:e.jsxs(p,{variant:"secondary",className:"text-xs",children:[Q.length," نتيجة"]})})]}),e.jsx(gt,{patients:Q,selectedPatientId:y,onPatientSelect:async e=>{if(w(e),k(null),S([]),P(!1),e){await g(e),b(e);const t=await te(e);W(s=>({...s,[e]:t})),setTimeout(()=>{const e=document.getElementById("dental-chart-section");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},100)}},getPatientTreatmentCount:e=>l.filter(t=>t.patient_id===e).length,getLastTreatmentDate:e=>{const t=l.filter(t=>t.patient_id===e);if(0===t.length)return null;return t.sort((e,t)=>new Date(t.created_at).getTime()-new Date(e.created_at).getTime())[0].created_at},getPatientImagesCount:ae,isLoading:H,isCompact:!!X}),X&&e.jsx(n,{className:"bg-muted/30 dark:bg-muted/20 border-border",children:e.jsxs(u,{className:"pt-4 bg-muted/30 dark:bg-muted/20",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"font-medium text-foreground",children:X.full_name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"الجنس:"}),e.jsx(p,{variant:"secondary",children:"male"===X.gender?"ذكر":"أنثى"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsxs("span",{className:"text-foreground",children:[X.age," سنة"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("a",{href:`https://wa.me/${X.phone?.replace(/\D/g,"")}`,target:"_blank",rel:"noopener noreferrer",className:"text-green-600 dark:text-green-400 hover:underline",children:X.phone})]})]}),(()=>{const t=(e=>{const t=l.filter(t=>t.patient_id===e);return{total:t.length,completed:t.filter(e=>"completed"===e.treatment_status).length,inProgress:t.filter(e=>"in_progress"===e.treatment_status).length,planned:t.filter(e=>"planned"===e.treatment_status).length}})(y),s=ae(y),a=Y[y]||{total:0,completed:0,planned:0,cancelled:0};return e.jsxs("div",{className:"border-t border-border pt-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-foreground mb-3",children:"إحصائيات العلاجات"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-blue-50 dark:bg-blue-900 text-blue-700 dark:text-blue-300",children:[e.jsx(c,{className:"w-3 h-3 ml-1"}),t.total," إجمالي"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-green-50 dark:bg-green-900 text-green-700 dark:text-green-300",children:["✓ ",t.completed," مكتمل"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-orange-50 dark:bg-orange-900 text-orange-700 dark:text-orange-300",children:["⏳ ",t.inProgress," قيد التنفيذ"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-gray-50 dark:bg-card text-gray-700 dark:text-gray-300",children:["📋 ",t.planned," مخطط"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-purple-50 dark:bg-purple-900 text-purple-700 dark:text-purple-300",children:[e.jsx(Qe,{className:"w-3 h-3 ml-1"}),s," صورة"]})})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-foreground mb-3",children:"إحصائيات الجلسات"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-indigo-50 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300",children:[e.jsx(L,{className:"w-3 h-3 ml-1"}),a.total," إجمالي"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-emerald-50 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-300",children:["✅ ",a.completed," مكتملة"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-amber-50 dark:bg-amber-900 text-amber-700 dark:text-amber-300",children:["📅 ",a.planned," مخططة"]})}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:"outline",className:"bg-red-50 dark:bg-red-900 text-red-700 dark:text-red-300",children:["❌ ",a.cancelled," ملغية"]})})]})]})]})})()]})})]})]}),X&&e.jsx(n,{className:"mb-4",children:e.jsx(u,{className:"p-4",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"نظام العلاجات المتعددة"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"النظام المحسن: يدعم عدة علاجات للسن الواحد مع الألوان العالمية"})]})})})}),X&&T&&C.length>0&&e.jsx(n,{className:"bg-orange-50 dark:bg-orange-950/20 border-orange-200 dark:border-orange-800",children:e.jsx(u,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 rounded-full bg-orange-500"}),e.jsxs("span",{className:"text-sm font-medium text-orange-700 dark:text-orange-300",children:["تم تحديد ",C.length," سن"]})]}),e.jsxs("div",{className:"text-xs text-orange-600 dark:text-orange-400",children:["الأسنان المحددة: ",C.sort((e,t)=>e-t).join(", ")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{size:"sm",onClick:()=>{0!==C.length?B(!0):Se.warning("يرجى تحديد أسنان أولاً")},className:"bg-orange-600 hover:bg-orange-700 text-white",children:"إضافة علاج للأسنان المحددة"}),e.jsx(N,{size:"sm",variant:"outline",onClick:le,className:"border-orange-300 text-orange-700 hover:bg-orange-100 dark:border-orange-700 dark:text-orange-300 dark:hover:bg-orange-900/20",children:"إلغاء التحديد"})]})]})})}),X&&!T&&e.jsx(n,{className:"bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800",children:e.jsx(u,{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-700 dark:text-blue-300",children:[e.jsx(ve,{className:"w-4 h-4"}),e.jsxs("span",{children:[e.jsx("strong",{children:"نصيحة:"})," اضغط CTRL + النقر لتحديد عدة أسنان وإضافة نفس العلاج لها"]})]})})}),X&&e.jsx("div",{id:"dental-chart-section",children:e.jsx(st,{patientId:y,onToothClick:(e,t=!1)=>{y?t?re(e):(S([]),P(!1),k(e),I(!0)):Se.warning("يرجى اختيار مريض أولاً")},selectedTooth:_,selectedTeeth:C,isMultiSelectMode:T,isPrimaryTeeth:R,onPrimaryTeethChange:K})}),X&&ee.length>0&&e.jsxs(n,{className:"bg-card dark:bg-card border-border",children:[e.jsx(i,{className:"bg-card dark:bg-card",children:e.jsxs(d,{className:"flex items-center gap-2 text-foreground",children:[e.jsx(Ye,{className:"w-5 h-5"}),"الوصفات الطبية"]})}),e.jsx(u,{className:"bg-card dark:bg-card",children:e.jsx("div",{className:"space-y-2",children:ee.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-accent/50 transition-colors",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"font-medium",children:["وصفة طبية - ",M(t.prescription_date)]}),t.notes&&e.jsx("div",{className:"text-sm text-muted-foreground",children:t.notes})]}),e.jsxs(N,{variant:"outline",size:"sm",onClick:()=>(e=>{O(e),A(!0)})(t),children:[e.jsx(We,{className:"w-4 h-4 ml-2"}),"طباعة"]})]},t.id))})})]}),!X&&!Z&&e.jsx(n,{children:e.jsxs(u,{className:"text-center py-12",children:[e.jsx(ge,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"اختر مريض لبدء العلاج"}),e.jsx("p",{className:"text-muted-foreground",children:"استخدم البحث أعلاه لاختيار مريض وعرض مخطط الأسنان التفاعلي"})]})}),e.jsx(pt,{open:E,onOpenChange:async e=>{I(e),!e&&y&&(g(y),b(y),await se())},patientId:y,toothNumber:_,isPrimaryTeeth:R,onSessionStatsUpdate:se,onTreatmentUpdate:async()=>{y&&(await Promise.all([g(y),b(y)]),k(e=>e),setTimeout(()=>{k(e=>e)},100))}}),z&&e.jsx(ze,{open:F,onOpenChange:A,prescription:z}),e.jsx(bt,{open:D,onOpenChange:B,patientId:y,selectedTeeth:C,onAddTreatments:async e=>{try{q(!0);const t=[];for(const s of e){const e=await j(s);e&&t.push(e)}return y&&await Promise.all([g(y),b(y)]),le(),t}catch(t){throw console.error("Error adding multiple treatments:",t),Se.error("فشل في إضافة العلاجات"),t}finally{q(!1)}}})]})}export{jt as default};
