import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{ak as i,a_ as s,b as a,c as r,D as n,f as d,g as o,h as c,i as l,L as m,S as p,m as x,n as h,o as u,p as g,U as j,M as f,I as _,w as N,T as b,x as v,ah as w}from"./index-3a8dc84c.js";import{c as y}from"./utils-ec524415.js";import{S as M,n as L}from"./notificationService-09cb27cc.js";import{F as S}from"./file-text-861b9f90.js";import{P as C}from"./plus-1eab3b5b.js";import{T as k}from"./upload-4df8a268.js";import{P as E}from"./pill-2f66511d.js";const P=y()(i((e,t)=>({medications:[],selectedMedication:null,isLoading:!1,error:null,searchQuery:"",filteredMedications:[],loadMedications:async()=>{e({isLoading:!0,error:null});try{const i=await(window.electronAPI?.medications?.getAll())||[];e({medications:i,filteredMedications:i,isLoading:!1}),t().filterMedications()}catch(i){console.error("Error loading medications:",i),e({error:i instanceof Error?i.message:"Failed to load medications",isLoading:!1})}},createMedication:async i=>{e({isLoading:!0,error:null});try{const s=await(window.electronAPI?.medications?.create(i));if(s){const i=[...t().medications,s];e({medications:i,filteredMedications:i,isLoading:!1}),t().filterMedications()}}catch(s){throw console.error("Error creating medication:",s),e({error:s instanceof Error?s.message:"Failed to create medication",isLoading:!1}),s}},updateMedication:async(i,s)=>{e({isLoading:!0,error:null});try{const a=await(window.electronAPI?.medications?.update(i,s));if(a){const s=t().medications.map(e=>e.id===i?{...e,...a}:e);e({medications:s,filteredMedications:s,isLoading:!1}),t().filterMedications()}}catch(a){throw console.error("Error updating medication:",a),e({error:a instanceof Error?a.message:"Failed to update medication",isLoading:!1}),a}},deleteMedication:async i=>{e({isLoading:!0,error:null});try{if(await(window.electronAPI?.medications?.delete(i))){const s=t().medications.filter(e=>e.id!==i);e({medications:s,filteredMedications:s,selectedMedication:t().selectedMedication?.id===i?null:t().selectedMedication,isLoading:!1}),t().filterMedications()}}catch(s){throw console.error("Error deleting medication:",s),e({error:s instanceof Error?s.message:"Failed to delete medication",isLoading:!1}),s}},setSelectedMedication:t=>{e({selectedMedication:t})},setSearchQuery:i=>{e({searchQuery:i}),t().filterMedications()},filterMedications:()=>{const{medications:i,searchQuery:s}=t();if(!s.trim())return void e({filteredMedications:i});const a=i.filter(e=>e.name.toLowerCase().includes(s.toLowerCase())||e.instructions&&e.instructions.toLowerCase().includes(s.toLowerCase()));e({filteredMedications:a})},clearError:()=>{e({error:null})}}),{name:"medication-store"}));function F({open:i,onOpenChange:y,editingPrescription:F,preSelectedPatientId:$}){const{createPrescription:I,updatePrescription:O,isLoading:A}=s(),{medications:T,loadMedications:D}=P(),{patients:z,loadPatients:Q}=a(),{appointments:V,loadAppointments:H}=r(),[U,q]=t.useState({patient_id:"",appointment_id:"",prescription_date:(new Date).toISOString().split("T")[0],notes:""}),[B,G]=t.useState([]),[J,K]=t.useState({});t.useEffect(()=>{i&&(D(),Q(),H())},[i,D,Q,H]),t.useEffect(()=>{if(i){if(F&&F.id){q({patient_id:F.patient_id||"",appointment_id:F.appointment_id||"",prescription_date:F.prescription_date||(new Date).toISOString().split("T")[0],notes:F.notes||""});const e=F.medications?.map(e=>({medication_id:e.medication_id,dose:e.dose||"",medication_name:e.medication_name}))||[];G(e)}else q({patient_id:$||"",appointment_id:"",prescription_date:(new Date).toISOString().split("T")[0],notes:""}),G([]);K({})}},[i,F]);const R=V.filter(e=>e.patient_id===U.patient_id),W=(e,t)=>{q(i=>({...i,[e]:t})),"patient_id"===e&&q(e=>({...e,appointment_id:""})),J[e]&&K(t=>({...t,[e]:""}))},X=()=>{G(e=>[...e,{medication_id:"",dose:""}])},Y=(e,t,i)=>{G(s=>s.map((s,a)=>{if(a===e){const e={...s,[t]:i};if("medication_id"===t){const t=T.find(e=>e.id===i);e.medication_name=t?.name}return e}return s}));const s=[`medication_${e}`,`dose_${e}`];K(e=>{const t={...e};return s.forEach(e=>delete t[e]),t})},Z=()=>{A||y(!1)};return e.jsx(n,{open:i,onOpenChange:Z,children:e.jsxs(d,{className:"sm:max-w-[700px] max-h-[90vh] overflow-y-auto",dir:"rtl",children:[e.jsxs(o,{children:[e.jsxs(c,{className:"flex items-center gap-2 text-right",children:[e.jsx(S,{className:"w-5 h-5 text-green-600"}),F&&F.id?"تعديل الوصفة الطبية":"إنشاء وصفة طبية جديدة"]}),e.jsx(l,{className:"text-right",children:F&&F.id?"قم بتعديل معلومات الوصفة الطبية أدناه":"أدخل معلومات الوصفة الطبية الجديدة أدناه"})]}),e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),(()=>{const e={};return U.patient_id||(e.patient_id="يجب اختيار مريض"),U.prescription_date||(e.prescription_date="تاريخ الوصفة مطلوب"),0===B.length&&(e.medications="يجب إضافة دواء واحد على الأقل"),B.forEach((t,i)=>{t.medication_id||(e[`medication_${i}`]="يجب اختيار دواء"),t.dose.trim()||(e[`dose_${i}`]="الجرعة مطلوبة")}),K(e),0===Object.keys(e).length})())try{const e={patient_id:U.patient_id,appointment_id:U.appointment_id||void 0,prescription_date:U.prescription_date,notes:U.notes.trim()||void 0,medications:B.map(e=>({medication_id:e.medication_id,dose:e.dose.trim()}))};F&&F.id?(await O(F.id,e),L.success("تم تحديث الوصفة الطبية بنجاح")):(await I(e),L.success("تم إنشاء الوصفة الطبية بنجاح")),y(!1)}catch(t){console.error("Error saving prescription:",t),L.error(F&&F.id?"فشل في تحديث الوصفة الطبية":"فشل في إنشاء الوصفة الطبية")}},className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{htmlFor:"patient_id",className:"text-right block",children:["المريض ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(p,{value:U.patient_id,onValueChange:e=>W("patient_id",e),children:[e.jsx(x,{className:"text-right bg-background border-input text-foreground "+(J.patient_id?"border-red-500":""),dir:"rtl",children:e.jsx(h,{placeholder:"اختر مريض",className:"text-muted-foreground"})}),e.jsx(u,{children:z.map(t=>e.jsx(g,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{className:"w-4 h-4"}),t.full_name]})},t.id))})]}),J.patient_id&&e.jsx("p",{className:"text-sm text-red-500 text-right",children:J.patient_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"appointment_id",className:"text-right block",children:"الموعد (اختياري)"}),e.jsxs(p,{value:U.appointment_id,onValueChange:e=>W("appointment_id",e),disabled:!U.patient_id,children:[e.jsx(x,{className:"text-right bg-background border-input text-foreground",dir:"rtl",children:e.jsx(h,{placeholder:U.patient_id?"اختر موعد":"اختر مريض أولاً",className:"text-muted-foreground"})}),e.jsx(u,{children:R.map(t=>e.jsx(g,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(f,{className:"w-4 h-4"}),t.title]})},t.id))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{htmlFor:"prescription_date",className:"text-right block",children:["تاريخ الوصفة ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(_,{id:"prescription_date",type:"date",value:U.prescription_date,onChange:e=>W("prescription_date",e.target.value),className:"text-right "+(J.prescription_date?"border-red-500":""),dir:"rtl",disabled:A}),J.prescription_date&&e.jsx("p",{className:"text-sm text-red-500 text-right",children:J.prescription_date})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(m,{className:"text-right text-lg font-medium",children:["الأدوية ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(N,{type:"button",variant:"outline",size:"sm",onClick:X,disabled:A,children:[e.jsx(C,{className:"w-4 h-4 ml-2"}),"إضافة دواء"]})]}),J.medications&&e.jsx("p",{className:"text-sm text-red-500 text-right",children:J.medications}),e.jsxs("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:[B.map((t,i)=>e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-sm font-medium",children:["دواء ",i+1]}),B.length>1&&e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:()=>(e=>{G(t=>t.filter((t,i)=>i!==e))})(i),className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:e.jsx(k,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{className:"text-right block text-sm",children:["اسم الدواء ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs(p,{value:t.medication_id,onValueChange:e=>Y(i,"medication_id",e),children:[e.jsx(x,{className:"text-right bg-background border-input text-foreground "+(J[`medication_${i}`]?"border-red-500":""),dir:"rtl",children:e.jsx(h,{placeholder:"اختر دواء",className:"text-muted-foreground"})}),e.jsx(u,{children:T.map(t=>e.jsx(g,{value:t.id,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:"w-4 h-4"}),t.name]})},t.id))})]}),J[`medication_${i}`]&&e.jsx("p",{className:"text-sm text-red-500 text-right",children:J[`medication_${i}`]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(m,{className:"text-right block text-sm",children:["الجرعة ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(_,{value:t.dose,onChange:e=>Y(i,"dose",e.target.value),placeholder:"مثال: قرص واحد كل 8 ساعات",className:"text-right "+(J[`dose_${i}`]?"border-red-500":""),dir:"rtl",disabled:A}),J[`dose_${i}`]&&e.jsx("p",{className:"text-sm text-red-500 text-right",children:J[`dose_${i}`]})]})]}),t.medication_id&&(()=>{const i=T.find(e=>e.id===t.medication_id);return i?.instructions?e.jsxs("div",{className:"bg-blue-50 p-2 rounded text-sm",children:[e.jsx("span",{className:"font-medium text-blue-800",children:"تعليمات الدواء: "}),e.jsx("span",{className:"text-blue-700",children:i.instructions})]}):null})()]},i)),0===B.length&&e.jsxs("div",{className:"text-center py-8 border-2 border-dashed border-muted-foreground/25 rounded-lg",children:[e.jsx(E,{className:"w-12 h-12 mx-auto mb-2 text-muted-foreground opacity-50"}),e.jsx("p",{className:"text-muted-foreground",children:"لم يتم إضافة أي أدوية بعد"}),e.jsxs(N,{type:"button",variant:"outline",size:"sm",onClick:X,className:"mt-2",children:[e.jsx(C,{className:"w-4 h-4 ml-2"}),"إضافة دواء"]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(m,{htmlFor:"notes",className:"text-right block",children:"ملاحظات إضافية"}),e.jsx(b,{id:"notes",value:U.notes,onChange:e=>W("notes",e.target.value),placeholder:"أدخل أي ملاحظات إضافية للوصفة الطبية (اختياري)",className:"text-right min-h-[80px]",dir:"rtl",disabled:A})]}),e.jsxs(v,{className:"flex justify-end space-x-2 space-x-reverse",children:[e.jsxs(N,{type:"button",variant:"outline",onClick:Z,disabled:A,children:[e.jsx(w,{className:"w-4 h-4 ml-2"}),"إلغاء"]}),e.jsx(N,{type:"submit",disabled:A,className:"bg-green-600 hover:bg-green-700 text-white",children:A?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"}),"جاري الحفظ..."]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 ml-2"}),F?"تحديث الوصفة":"إنشاء الوصفة"]})})]})]})]})})}const $=Object.freeze(Object.defineProperty({__proto__:null,default:F},Symbol.toStringTag,{value:"Module"}));export{F as A,$ as a,P as u};
