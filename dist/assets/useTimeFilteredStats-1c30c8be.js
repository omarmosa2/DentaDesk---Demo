import{j as e}from"./ui-cacc1eea.js";import{r as t}from"./vendor-696af5bd.js";import{w as a,bz as r,a5 as n,C as s,l,S as o,m as i,n as u,o as c,p as d,I as m,ah as h,bA as g}from"./index-3a8dc84c.js";import{C as p,a as D,b as x}from"./collapsible-d3d2b240.js";function f({value:f,onChange:w,onClear:j,className:y="",showTitle:v=!0,title:b="فلترة زمنية",defaultOpen:_=!1}){const[N,F]=t.useState(_),A=f||{preset:"all",startDate:"",endDate:""},k=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,S=(e,t)=>{w({...A,[e]:t,preset:"custom"})};return e.jsx("div",{className:`${y}`,dir:"rtl",children:e.jsxs(p,{open:N,onOpenChange:F,children:[e.jsx(D,{asChild:!0,children:e.jsxs(a,{variant:"outline",className:"w-full justify-between text-sm h-9",size:"sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(r,{className:"w-4 h-4"}),e.jsx("span",{children:b})]}),e.jsx(n,{className:"w-4 h-4 transition-transform "+(N?"rotate-180":"")})]})}),e.jsx(x,{className:"mt-3",children:e.jsx(s,{className:"border-muted",dir:"rtl",children:e.jsxs(l,{className:"p-4 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-xs font-medium text-right block text-muted-foreground",children:"اختر الفترة الزمنية للفلترة"}),e.jsxs(o,{value:A.preset,onValueChange:e=>{const t=new Date;let a="",r=k(t);switch(e){case"all":a="",r="";break;case"today":a=k(t);break;case"week":const e=g(t);a=k(e);break;case"month":const n=new Date(t.getFullYear(),t.getMonth(),1);a=k(n);break;case"year":const s=new Date(t.getFullYear(),0,1);a=k(s);break;case"custom":a=A.startDate||"",r=A.endDate||""}w({preset:e,startDate:a,endDate:r})},children:[e.jsx(i,{className:"text-right h-8 text-sm",dir:"rtl",children:e.jsx(u,{placeholder:"اختر الفترة الزمنية"})}),e.jsxs(c,{dir:"rtl",children:[e.jsx(d,{value:"all",children:"جميع البيانات"}),e.jsx(d,{value:"today",children:"اليوم"}),e.jsx(d,{value:"week",children:"هذا الأسبوع"}),e.jsx(d,{value:"month",children:"هذا الشهر"}),e.jsx(d,{value:"year",children:"هذه السنة"}),e.jsx(d,{value:"custom",children:"فترة مخصصة"})]})]})]}),"custom"===A.preset&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-right block text-muted-foreground",children:"من تاريخ (بداية الفترة)"}),e.jsx(m,{type:"date",value:A.startDate||"",onChange:e=>S("startDate",e.target.value),className:"text-right h-8 text-sm",dir:"rtl"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-medium text-right block text-muted-foreground",children:"إلى تاريخ (نهاية الفترة)"}),e.jsx(m,{type:"date",value:A.endDate||"",onChange:e=>S("endDate",e.target.value),className:"text-right h-8 text-sm",dir:"rtl"})]})]}),e.jsxs("div",{className:"bg-muted/30 p-2 rounded text-right",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"الفترة المحددة:"}),e.jsxs("div",{className:"text-sm font-medium",children:[(e=>{switch(e){case"all":default:return"جميع البيانات";case"today":return"اليوم";case"week":return"هذا الأسبوع";case"month":return"هذا الشهر";case"year":return"هذه السنة";case"custom":return"فترة مخصصة"}})(A.preset),A.startDate&&A.endDate&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["من ",new Date(A.startDate).toLocaleDateString("en-GB"),"إلى ",new Date(A.endDate).toLocaleDateString("en-GB")]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(a,{variant:"outline",size:"sm",onClick:()=>{w({preset:"all",startDate:"",endDate:""}),j?.()},className:"h-7 text-xs",children:[e.jsx(h,{className:"w-3 h-3 ml-1"}),"إعادة تعيين"]})})]})})})]})})}function w({data:e,dateField:a="created_at",initialFilter:r}){const[n,s]=t.useState(r||{preset:"all",startDate:"",endDate:""}),l=t.useMemo(()=>{if(!e||!Array.isArray(e))return[];if(!n.startDate||!n.endDate||""===n.startDate||""===n.endDate)return e;const t=new Date(n.startDate),r=new Date(t.getFullYear(),t.getMonth(),t.getDate(),0,0,0,0),s=new Date(n.endDate),l=new Date(s.getFullYear(),s.getMonth(),s.getDate(),23,59,59,999);return e.filter(e=>{const t=e[a];if(!t)return!1;const n=t,s=new Date(n);let o;return o=n.includes("T")||n.includes(" ")?s:new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0,0),o>=r&&o<=l})},[e,n,a]),o=t.useMemo(()=>{const t=l.length;if(!e||!Array.isArray(e))return{total:0,filtered:0,today:0,week:0,month:0,year:0};const r=new Date,n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),s=g(r),o=new Date(r.getFullYear(),r.getMonth(),1),i=new Date(r.getFullYear(),0,1),u=e.filter(e=>{const t=e[a];if(!t)return!1;return new Date(t)>=n}).length,c=e.filter(e=>{const t=e[a];if(!t)return!1;const n=new Date(t);return n>=s&&n<=r}).length,d=e.filter(e=>{const t=e[a];if(!t)return!1;return new Date(t)>=o}).length,m=e.filter(e=>{const t=e[a];if(!t)return!1;return new Date(t)>=i}).length;return{total:t,filtered:l.length,today:u,week:c,month:d,year:m}},[e,l,a]),i=t.useMemo(()=>{if(!l||0===l.length)return{totalRevenue:0,pendingAmount:0,overdueAmount:0,completedAmount:0};if(!l.some(e=>"amount"in e||"total_amount"in e||"cost"in e||"price"in e))return{totalRevenue:0,pendingAmount:0,overdueAmount:0,completedAmount:0};const e=l.filter(e=>"completed"===e.status||"partial"===e.status).reduce((e,t)=>{const a=t.amount||t.total_amount||t.cost||t.price||0;return e+("number"==typeof a?a:parseFloat(a)||0)},0),t=l.filter(e=>"pending"===e.status).reduce((e,t)=>{const a=t.amount||t.total_amount||t.cost||t.price||0,r=t.total_amount_due||0;let n=a;if(t.tooth_treatment_id){n=t.treatment_total_cost||r||0}else if(r>0)n=r;else{const e=t.remaining_balance||0;e>0&&(n=e)}return e+("number"==typeof n?n:parseFloat(n)||0)},0),a=l.filter(e=>{if("pending"!==e.status)return!1;const t=new Date(e.payment_date||e.date||e.created_at),a=new Date;return a.setDate(a.getDate()-30),t<a}).reduce((e,t)=>{const a=t.amount||t.total_amount||t.cost||t.price||0,r=t.total_amount_due||0,n=t.remaining_balance||0;let s=a;return r>0?s=r:n>0&&(s=n),e+("number"==typeof s?s:parseFloat(s)||0)},0),r=new Map,n=new Map;let s=0;l.forEach(e=>{if("partial"===e.status)if(e.tooth_treatment_id){const t=e.tooth_treatment_id,a=e.treatment_total_cost||e.total_amount_due||0,r=e.amount||0;n.has(t)||n.set(t,{totalDue:"number"==typeof a?a:parseFloat(a)||0,totalPaid:0});n.get(t).totalPaid+="number"==typeof r?r:parseFloat(r)||0}else if(e.appointment_id){const t=e.appointment_id,a=e.total_amount_due||e.appointment_total_cost||0,n=e.amount||0;r.has(t)||r.set(t,{totalDue:"number"==typeof a?a:parseFloat(a)||0,totalPaid:0});r.get(t).totalPaid+="number"==typeof n?n:parseFloat(n)||0}else{const t=e.total_amount_due||e.amount||0,a=e.amount_paid||e.amount||0,r="number"==typeof t?t:parseFloat(t)||0,n="number"==typeof a?a:parseFloat(a)||0;s+=Math.max(0,r-n)}});return{totalRevenue:e,pendingAmount:t,overdueAmount:a,completedAmount:e,totalRemainingBalance:Array.from(r.values()).reduce((e,t)=>e+Math.max(0,t.totalDue-t.totalPaid),0)+Array.from(n.values()).reduce((e,t)=>e+Math.max(0,t.totalDue-t.totalPaid),0)+s}},[l]),u=t.useMemo(()=>{const e={};return l.forEach(t=>{const r=new Date(t[a]);let s="";switch(n.preset){case"today":s=r.toLocaleTimeString("ar-SA",{hour:"2-digit"});break;case"week":s=r.toLocaleDateString("ar-SA",{weekday:"short"});break;case"month":s=r.getDate().toString();break;case"year":s=r.toLocaleDateString("ar-SA",{month:"short"});break;default:s=r.toLocaleDateString("ar-SA")}e[s]||(e[s]=[]),e[s].push(t)}),e},[l,n.preset,a]),c=t.useMemo(()=>{if(!(e&&Array.isArray(e)&&n.startDate&&n.endDate))return null;const t=new Date(n.startDate),r=new Date(n.endDate).getTime()-t.getTime(),s=new Date(t.getTime()-r),o=new Date(t.getTime()-1),i=e.filter(e=>{const t=new Date(e[a]);return t>=s&&t<=o}),u=l.length,c=i.length;if(0===c)return null;const d=(u-c)/c*100;return{current:u,previous:c,change:u-c,changePercent:Math.round(100*d)/100,isPositive:d>=0}},[e,l,n,a]);return{timeFilter:n,filteredData:l,stats:o,financialStats:i,groupedData:u,trend:c,handleFilterChange:e=>{s(e)},resetFilter:()=>{s({preset:"all",startDate:"",endDate:""})}}}export{f as T,w as u};
